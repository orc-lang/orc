<html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>3.4.&nbsp; site Sites</title><meta content="DocBook XSL Stylesheets V1.74.0" name="generator"><link rel="home" href="index.html" title="Orc User Guide v2.0.0"><link rel="up" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Accessing and Creating External Services"><link rel="prev" href="ch03s03.html" title="3.3.&nbsp;Cooperative Scheduling and Concurrency"><link rel="next" href="ch03s05.html" title="3.5.&nbsp;Web Services"><link href="/orchard/orc.css" type="text/css" rel="stylesheet"><link href="style.css" type="text/css" rel="stylesheet"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table summary="Navigation header" width="100%"><tr><th align="center" colspan="3">3.4.&nbsp;
                site Sites</th></tr><tr><td align="left" width="20%"><a accesskey="p" href="ch03s03.html">Prev</a>&nbsp;</td><th align="center" width="60%">Chapter&nbsp;3.&nbsp;Accessing and Creating External Services</th><td align="right" width="20%">&nbsp;<a accesskey="n" href="ch03s05.html">Next</a></td></tr></table><hr></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section.services.site"></a>3.4.&nbsp;
                <code class="code"><span class="hl-keyword">site</span></code> Sites</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11806"></a>3.4.1.&nbsp;Fundamentals</h3></div></div></div><p>
Orc sites imported with the <code class="code"><span class="hl-keyword">site</span></code> declaration are implemented as
Scala classes which extend <code class="code">orc.values.sites.Sites</code>.
Here we will summarize the most important features of this and related classes;

</p><p>
Sites must implement a single method: <code class="code">callSite(Args args,
Token token)</code>.  The Orc engine calls this method whenever the site is
called by the Orc program.
</p><p>
The <code class="code">args</code> argument (of type <code class="code">Args</code>) is used to get the arguments which were passed to
the site call by the Orc program. It has the following important methods:
</p><div class="variablelist"><dl><dt><span class="term">
                            <code class="code">getArg(<span class="hl-keyword">int</span>
n)</code>
                        </span></dt><dd>returns the value of the (n+1)th argument, as an
<code class="code">Object</code>.  For example, to get the value of the
first argument, call <code class="code">args.getArg(<span class="hl-number">0</span>)</code>.</dd><dt><span class="term">
                            <code class="code">intArg(<span class="hl-keyword">int</span> n)</code>, <code class="code">stringArg(<span class="hl-keyword">int</span> n)</code>, <code class="code">boolArg(<span class="hl-keyword">int</span>
n)</code>, etc.</span></dt><dd>returns the value of the (n+1)th argument cast
to the appropriate type. If the argument is not the appropriate type, throws an
<code class="code">ArgumentTypeMismatchException</code>.</dd></dl></div><p>
The <code class="code">token</code> argument (of type <code class="code">Token</code>) is a sort of callback which is used by the site
to return a value or signal that it has halted. It has the following important
methods:
</p><div class="variablelist"><dl><dt><span class="term">
                            <code class="code">resume(Object
value)</code>
                        </span></dt><dd>return the value <code class="code">value</code> from the site call. For example, to return the
number 5, call <code class="code">token.resume(<span class="hl-number">5</span>)</code>.  To publish a
signal without returning any specific value, call <code class="code">token.resume()</code>.</dd><dt><span class="term">
                            <code class="code">error(TokenException
problem)</code>
                        </span></dt><dd>halt without publishing a value and report an
error.  This method is an appropriate way to report Scala or Java exceptions encountered
during a site call.  Alternatively, a site can simply throw a checked exception
from the <code class="code">callSite</code> method; the engine will call
<code class="code">token.error</code> on its behalf. To convert a Java
exception to the necessary <code class="code">TokenException</code> type,
wrap it in an instance of <code class="code">orc.error.runtime.JavaException</code>.</dd><dt><span class="term">
                            <code class="code">die()</code>
                        </span></dt><dd>halt,
without publishing a value or reporting an error. For example, the built-in
site <code class="code"><span class="hl-variable">If</span></code> uses this method to halt when called with a
<code class="code"><span class="hl-literal">false</span></code> argument.</dd></dl></div><p>
The <code class="code">callSite</code> method must return control to its
caller within a short, deterministic amount of time.  To implement a site which
blocks or waits for some condition, <code class="code">callSite</code> must
save the <code class="code">token</code> and return without calling any of
the above methods.  Then when it is time for the site call to return, call the
appropriate method on the <code class="code">token</code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N118A3"></a>3.4.2.&nbsp;More Site Classes</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N118A6"></a>3.4.2.1.&nbsp;EvalSite</h4></div></div></div><p>
Many sites are deterministic, always returning a value immediately when called.
Such sites can be implemented easily by extending <code class="code">orc.values.sites.compatability.EvalSite</code> and implementing the method
<code class="code">evaluate(Args args)</code>.  This method should read the
arguments from <code class="code">args</code> as usual, and then return the
value to be returned from the site call, or throw a checked exception to
indicate an error.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="section.services.sites.ThreadedSite"></a>3.4.2.2.&nbsp;ThreadedSite</h4></div></div></div><p>
Some sites need to perform blocking IO or use other Scala/Java blocking methods like
<code class="code">Object#wait()</code>.  This cannot be done directly in
the <code class="code">callSite</code> or <code class="code">EvalSite#evaluate</code>  methods because that might block the
Orc engine. Instead, extend <code class="code">orc.values.sites.compatability.ThreadedSite</code> and implement the method
<code class="code">evaluate(Args args)</code>.  This method should read the
arguments from <code class="code">args</code> as usual, and then return the
value to be returned from the site call, or throw a checked exception to
indicate an error.  Your <code class="code">evaluate</code> method will be
automatically run asynchronously in a new thread so that it does not interfere
with the Orc engine.
</p><p>
Beware that the Orc engine may be configured to only allow a fixed number of
site threads. If too many sites need to use threads simultaneously, some will
block until threads become available.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N118DB"></a>3.4.2.3.&nbsp;DotSite</h4></div></div></div><p>
Recall that the notation <code class="code"><span class="hl-variable">x</span>.<span class="hl-variable">msg</span></code> corresponds to calling the site
<code class="code"><span class="hl-variable">x</span></code> with the special message value <code class="code"><span class="hl-variable">msg</span></code>.  To implement a
site which responds to such messages, extend <code class="code">orc.values.sites.compatability.DotSite</code>.
</p><p>
In the site's constructor, call the method <code class="code">addMember(String message, Object value)</code> once for each
message you wish the site to respond to. The call <code class="code">addMember(m, v)</code> instructs the site to return the value
<code class="code">v</code> when it is called with the message <code class="code">m</code>.
</p><p>
Any object can be used as a member value, even another site.  Anonymous inner
classes extending <code class="code">Site</code> are often used as member
values which behave like  methods of the enclosing <code class="code">DotSite</code>.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11909"></a>3.4.3.&nbsp;Tutorial Example</h3></div></div></div><p>
We will implement a simplified version of Orc's <code class="code"><span class="hl-variable">Buffer</span></code> site,
called <code class="code">ExampleBuffer</code>. The goal will be to be able
to run this Orc program:
</p><pre class="programlisting">
<span class="hl-comment">-- Import the site definition</span>
<span class="hl-keyword">site</span> <span class="hl-variable">ExampleBuffer</span> = <span class="hl-variable">ExampleBuffer</span>
<span class="hl-comment">-- Create a new buffer site</span>
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">ExampleBuffer</span>()
<span class="hl-comment">-- wait for a value in the buffer</span>
<span class="hl-variable">b</span>.<span class="hl-site">get</span>()
<span class="hl-comment">-- put a value in the buffer</span>
<span class="hl-combinator">|</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-literal">3</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-comment">-- Publishes: 3</span></pre><p>
The first step is to create <code class="filename">ExampleBuffer.java</code>. The <code class="code">ExampleBuffer</code> site is actually a <em class="firstterm">discovery site</em>: all
it does when called is create and return a reference to a new site (the buffer
instance).
</p><pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBuffer <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ExampleBufferInstance();
  }
}</pre><p>
Next we must implement <code class="code">ExampleBufferInstance</code>,
which defines the behavior of an individual buffer. We can put this class
either in its own file or in <code class="filename">ExampleBuffer.java</code>, since
that is the only class which refers to it directly. How does an instance
behave? If we write <code class="code"><span class="hl-variable">b</span>.<span class="hl-site">get</span>()</code>, that means that <code class="code"><span class="hl-variable">b</span></code>
responds to the message <code class="code"><span class="hl-variable">get</span></code> with a site which we call to get a
value from the buffer. So we'll extend <code class="code">DotSite</code>,
telling it to respond to the message "get" with a <code class="code">GetMethod</code> site, and likewise for "put". We'll use a
linked list to store the actual contents of the buffer.
</p><pre class="programlisting">
<span class="hl-keyword">class</span> ExampleBufferInstance <span class="hl-keyword">extends</span> DotSite {
  <span class="hl-keyword">private</span> LinkedList&lt;Object&gt; contents = <span class="hl-keyword">new</span> LinkedList&lt;Object&gt;();
  <span class="hl-keyword">public</span> ExampleBufferInstance() {
    addMember(<span class="hl-string">"get"</span>, <span class="hl-keyword">new</span> GetMethod());
    addMember(<span class="hl-string">"put"</span>, <span class="hl-keyword">new</span> PutMethod());
  }
}</pre><p>
The <code class="code">GetMethod</code> site is implemented as an inner
class so it has easy access to the contents of the buffer. In the
implementation we first check if there is an item in the buffer. If so, we
return it. Otherwise, we must store the token in a queue to be notified when
the next item is put in the buffer. We synchronize on the outer object to
protect against concurrent modification.
</p><pre class="programlisting">
<span class="hl-keyword">private</span> LinkedList&lt;Token&gt; waiters = <span class="hl-keyword">new</span> LinkedList&lt;Token&gt;();
<span class="hl-keyword">private</span> <span class="hl-keyword">class</span> GetMethod <span class="hl-keyword">extends</span> Site {
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> callSite(Args args, Token token) {
    <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) {
      <span class="hl-keyword">if</span> (!contents.isEmpty()) {
        token.resume(contents.removeFirst());
      } <span class="hl-keyword">else</span> {
        waiters.add(token);
      } 
    }
  }
}</pre><p>
<code class="code">PutMethod</code> is even simpler since it doesn't need to
block. If there is a token waiting for an item, we give it the item. Otherwise
we put the item in the buffer. We synchronize on the outer object to protect
against concurrent modification. When done we return a dummy "signal" value.
</p><pre class="programlisting">
<span class="hl-keyword">private</span> <span class="hl-keyword">class</span> PutMethod <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    Object item = args.getArg(<span class="hl-number">0</span>);
    <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) { 
      <span class="hl-keyword">if</span> (!waiters.isEmpty()) {
        waiters.removeFirst().resume(item);
      } <span class="hl-keyword">else</span> {
        contents.add(item);
      } 
    }
    <span class="hl-keyword">return</span> signal();
  }
}</pre><p>
Putting it all together, here is the entire implementation:
</p><pre class="programlisting">
<span class="hl-keyword">import</span> java.util.LinkedList;

<span class="hl-keyword">import</span> orc.values.sites.compatability.EvalSite;
<span class="hl-keyword">import</span> orc.values.sites.compatability.DotSite;
<span class="hl-keyword">import</span> orc.values.sites.Sites;
<span class="hl-keyword">import</span> orc.runtime.Token;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBuffer <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ExampleBufferInstance();
  }
}

<span class="hl-keyword">class</span> ExampleBufferInstance <span class="hl-keyword">extends</span> DotSite {
  <span class="hl-keyword">private</span> LinkedList&lt;Object&gt; contents = <span class="hl-keyword">new</span> LinkedList&lt;Object&gt;();
  <span class="hl-keyword">private</span> LinkedList&lt;Token&gt; waiters = <span class="hl-keyword">new</span> LinkedList&lt;Token&gt;();
    
  <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> GetMethod <span class="hl-keyword">extends</span> Site {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> callSite(Args args, Token token) {
      <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) {
        <span class="hl-keyword">if</span> (!contents.isEmpty()) {
          token.resume(contents.removeFirst());
        } <span class="hl-keyword">else</span> {
          waiters.add(token);
        } 
      }
    }
  }

  <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> PutMethod <span class="hl-keyword">extends</span> EvalSite {
    <span class="hl-keyword">public</span> Object evaluate(Args args) {
      Object item = args.getArg(<span class="hl-number">0</span>);
      <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) { 
        <span class="hl-keyword">if</span> (!waiters.isEmpty()) {
          waiters.removeFirst().resume(item);
        } <span class="hl-keyword">else</span> {
          contents.add(item);
        } 
      }
      <span class="hl-keyword">return</span> signal();
    }
  }

  <span class="hl-keyword">public</span> ExampleBufferInstance() {
    addMember(<span class="hl-string">"get"</span>, <span class="hl-keyword">new</span> GetMethod());
    addMember(<span class="hl-string">"put"</span>, <span class="hl-keyword">new</span> PutMethod());
  }
}</pre></div></div><script type="text/javascript" src="/orchard/orc.js"></script><div class="navfooter"><hr><table summary="Navigation footer" width="100%"><tr><td align="left" width="40%"><a accesskey="p" href="ch03s03.html">Prev</a>&nbsp;</td><td align="center" width="20%"><a accesskey="u" href="ch03.html">Up</a></td><td align="right" width="40%">&nbsp;<a accesskey="n" href="ch03s05.html">Next</a></td></tr><tr><td valign="top" align="left" width="40%">3.3.&nbsp;Cooperative Scheduling and Concurrency&nbsp;</td><td align="center" width="20%"><a accesskey="h" href="index.html">Home</a></td><td valign="top" align="right" width="40%">&nbsp;3.5.&nbsp;Web Services</td></tr></table></div></body></html>