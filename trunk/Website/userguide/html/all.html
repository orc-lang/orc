<html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Orc User Guide v1.1.0</title><meta content="DocBook XSL Stylesheets V1.74.0" name="generator"><link href="/orchard/orc.css" type="text/css" rel="stylesheet"><link href="style.css" type="text/css" rel="stylesheet"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="N10001"></a>Orc User Guide v1.1.0
</h1></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="preface"><a href="#N10007">Introduction</a></span></dt><dt><span class="chapter"><a href="#chapter.language">1. The Orc Programming Language</a></span></dt><dd><dl><dt><span class="section"><a href="#N10019">1.1. Introduction</a></span></dt><dt><span class="section"><a href="#N10022">1.2. Cor: A Functional Subset</a></span></dt><dd><dl><dt><span class="section"><a href="#cor.constants">1.2.1. Constants</a></span></dt><dt><span class="section"><a href="#language.base.operators">1.2.2. Operators</a></span></dt><dt><span class="section"><a href="#N1034B">1.2.3. Conditionals</a></span></dt><dt><span class="section"><a href="#cor.variables">1.2.4. Variables</a></span></dt><dt><span class="section"><a href="#cor.data">1.2.5. Data Structures</a></span></dt><dt><span class="section"><a href="#N104CC">1.2.6. Patterns</a></span></dt><dt><span class="section"><a href="#cor.functions">1.2.7. Functions</a></span></dt><dt><span class="section"><a href="#N10626">1.2.8. Comments</a></span></dt></dl></dd><dt><span class="section"><a href="#N1063B">1.3. Orc: Orchestrating services</a></span></dt><dd><dl><dt><span class="section"><a href="#N1071A">1.3.1. Communicating with external services</a></span></dt><dt><span class="section"><a href="#N10774">1.3.2. The concurrency combinators of Orc</a></span></dt><dt><span class="section"><a href="#N108F0">1.3.3. Revisiting Cor expressions</a></span></dt><dt><span class="section"><a href="#N109FA">1.3.4. Time</a></span></dt></dl></dd><dt><span class="section"><a href="#N10A26">1.4. Advanced Features of Orc</a></span></dt><dd><dl><dt><span class="section"><a href="#N10B4A">1.4.1. Special call forms</a></span></dt><dt><span class="section"><a href="#N10BFD">1.4.2. Extensions to pattern matching</a></span></dt><dt><span class="section"><a href="#section.orc.datatypes">1.4.3. Datatypes</a></span></dt><dt><span class="section"><a href="#N10C6D">1.4.4. New forms of declarations</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter.methodology">2. Programming Methodology</a></span></dt><dd><dl><dt><span class="section"><a href="#N10CE1">2.1. Syntactic and Stylistic Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#N10CE6">2.1.1. Parallel combinator</a></span></dt><dt><span class="section"><a href="#N10D22">2.1.2. Sequential combinator</a></span></dt><dt><span class="section"><a href="#style.pruning">2.1.3. Pruning combinator</a></span></dt><dt><span class="section"><a href="#N10DD5">2.1.4. Declarations</a></span></dt></dl></dd><dt><span class="section"><a href="#N10E0E">2.2. Programming Idioms</a></span></dt><dd><dl><dt><span class="section"><a href="#N10E13">2.2.1. Channels</a></span></dt><dt><span class="section"><a href="#N10E5A">2.2.2. Lists</a></span></dt><dt><span class="section"><a href="#methodology.streams">2.2.3. Streams</a></span></dt><dt><span class="section"><a href="#N10EA6">2.2.4. Mutable References</a></span></dt><dt><span class="section"><a href="#N10F70">2.2.5. Loops</a></span></dt><dt><span class="section"><a href="#N10F89">2.2.6. Parallel Matching</a></span></dt><dt><span class="section"><a href="#N10FC6">2.2.7. Fork-join</a></span></dt><dt><span class="section"><a href="#N11053">2.2.8. Sequential Fork-Join</a></span></dt><dt><span class="section"><a href="#N1106E">2.2.9. Priority Poll</a></span></dt><dt><span class="section"><a href="#N11091">2.2.10. Parallel Or</a></span></dt><dt><span class="section"><a href="#N110CE">2.2.11. Timeout</a></span></dt><dt><span class="section"><a href="#N11178">2.2.12. Priority</a></span></dt><dt><span class="section"><a href="#N11188">2.2.13. Metronome</a></span></dt><dt><span class="section"><a href="#N1119E">2.2.14. Routing</a></span></dt><dt><span class="section"><a href="#N1124A">2.2.15. Interruption</a></span></dt><dt><span class="section"><a href="#N1127C">2.2.16. Lifting</a></span></dt><dt><span class="section"><a href="#N1128D">2.2.17. Fold</a></span></dt></dl></dd><dt><span class="section"><a href="#N112E5">2.3. Larger Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#N112ED">2.3.1. Dining Philosophers</a></span></dt><dt><span class="section"><a href="#methodology.examples.hygenic">2.3.2. Hygienic Dining Philosophers</a></span></dt><dt><span class="section"><a href="#N11384">2.3.3. Readers-Writers</a></span></dt><dt><span class="section"><a href="#N113B2">2.3.4. Quicksort</a></span></dt><dt><span class="section"><a href="#N11411">2.3.5. Meeting Scheduler</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter.services">3. Accessing and Creating External Services</a></span></dt><dd><dl><dt><span class="section"><a href="#section.services.intro">3.1. Introduction</a></span></dt><dt><span class="section"><a href="#section.services.java">3.2. 

                class Sites</a></span></dt><dd><dl><dt><span class="section"><a href="#section.services.java.dot">3.2.1. Dot Operator</a></span></dt><dt><span class="section"><a href="#N114B7">3.2.2. Direct Calls</a></span></dt><dt><span class="section"><a href="#N114D1">3.2.3. Pattern Matching</a></span></dt><dt><span class="section"><a href="#section.services.java.method">3.2.4. Method Resolution</a></span></dt><dt><span class="section"><a href="#N1150D">3.2.5. Orc values in Java</a></span></dt><dt><span class="section"><a href="#N11549">3.2.6. Java Values in Orc</a></span></dt><dt><span class="section"><a href="#section.services.kilim">3.2.7. Cooperative Scheduling and Concurrency</a></span></dt></dl></dd><dt><span class="section"><a href="#N1160D">3.3. 
                site Sites</a></span></dt><dd><dl><dt><span class="section"><a href="#N11613">3.3.1. Fundamentals</a></span></dt><dt><span class="section"><a href="#N116B4">3.3.2. More Site Classes</a></span></dt><dt><span class="section"><a href="#N1171A">3.3.3. Tutorial Example</a></span></dt></dl></dd><dt><span class="section"><a href="#N1176B">3.4. Web Services</a></span></dt><dd><dl><dt><span class="section"><a href="#N1176E">3.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#N11773">3.4.2. Downloading and Running Examples</a></span></dt><dt><span class="section"><a href="#N1178E">3.4.3. Protocols Supported</a></span></dt><dt><span class="section"><a href="#N117D0">3.4.4. REST</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter.typechecker">4. Type Checking</a></span></dt><dd><dl><dt><span class="section"><a href="#N11821">4.1. Simple Typing</a></span></dt><dd><dl><dt><span class="section"><a href="#N11825">4.1.1. Values and Operators</a></span></dt><dt><span class="section"><a href="#N11864">4.1.2. 
                    Top and Bot
                </a></span></dt><dt><span class="section"><a href="#N1189F">4.1.3. Tuples</a></span></dt><dt><span class="section"><a href="#N118AC">4.1.4. Combinators</a></span></dt><dt><span class="section"><a href="#N11917">4.1.5. Conditionals</a></span></dt><dt><span class="section"><a href="#N11928">4.1.6. Defined Functions</a></span></dt><dt><span class="section"><a href="#N11984">4.1.7. Ascriptions</a></span></dt><dt><span class="section"><a href="#N11996">4.1.8. Aliasing</a></span></dt><dt><span class="section"><a href="#N119A4">4.1.9. Datatypes</a></span></dt><dt><span class="section"><a href="#N119B5">4.1.10. Interacting with External Services</a></span></dt><dt><span class="section"><a href="#N119DE">4.1.11. Assertions</a></span></dt></dl></dd><dt><span class="section"><a href="#N119EF">4.2. Polymorphism</a></span></dt><dd><dl><dt><span class="section"><a href="#N119F6">4.2.1. Parametric types</a></span></dt><dt><span class="section"><a href="#N11A30">4.2.2. Parametric functions</a></span></dt><dt><span class="section"><a href="#N11A42">4.2.3. Generic calls</a></span></dt><dt><span class="section"><a href="#N11A65">4.2.4. Polymorphic aliases</a></span></dt><dt><span class="section"><a href="#N11A77">4.2.5. Polymorphic datatypes</a></span></dt></dl></dd><dt><span class="section"><a href="#N11A86">4.3. Interacting with Java</a></span></dt><dt><span class="section"><a href="#N11AA7">4.4. Syntax of Typed Orc</a></span></dt></dl></dd><dt><span class="appendix"><a href="#N11CAC">A. Complete Syntax of Orc</a></span></dt><dt><span class="appendix"><a href="#appendix.library">B. Standard Library</a></span></dt><dd><dl><dt><span class="section"><a href="#N12140">B.1. Overview</a></span></dt><dt><span class="section"><a href="#N1214A">B.2. Types and Notation</a></span></dt><dt><span class="section"><a href="#N12166">B.3. Reference</a></span></dt><dd><dl><dt><span class="section"><a href="#N1216A">B.3.1. core.inc: Fundamental sites and operators.</a></span></dt><dt><span class="section"><a href="#N123F9">B.3.2. state.inc: General-purpose supplemental data structures.</a></span></dt><dt><span class="section"><a href="#N12AA2">B.3.3. idioms.inc: Higher-order Orc programming idioms.</a></span></dt><dt><span class="section"><a href="#N12CD7">B.3.4. list.inc: Operations on lists.</a></span></dt><dt><span class="section"><a href="#N130B9">B.3.5. reflect.inc: Metalanguage operations.</a></span></dt><dt><span class="section"><a href="#N130E5">B.3.6. text.inc: Operations on strings.</a></span></dt><dt><span class="section"><a href="#N131E6">B.3.7. time.inc: Real and logical time.</a></span></dt><dt><span class="section"><a href="#N1326B">B.3.8. util.inc: Miscellaneous utility functions.</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#N13389">C. Experimental Features</a></span></dt><dd><dl><dt><span class="section"><a href="#N1338C">C.1. Exceptions in Orc</a></span></dt><dd><dl><dt><span class="section"><a href="#N133FC">C.1.1. Catching Java exceptions</a></span></dt><dt><span class="section"><a href="#N1340F">C.1.2. Catching Orc Engine Errors</a></span></dt><dt><span class="section"><a href="#N1342A">C.1.3. Exceptions in Practice</a></span></dt><dt><span class="section"><a href="#N1343C">C.1.4. Typechecking Exceptions</a></span></dt></dl></dd></dl></dd></dl></div><div class="list-of-tables"><p><b>List of Tables</b></p><dl><dt>1.1. <a href="#cor-ebnf-table">Syntax of the Functional Subset of Orc (Cor)</a></dt><dt>1.2. <a href="#ops-table">Operators of Cor</a></dt><dt>1.3. <a href="#orc-ebnf-table">Basic Syntax of Orc</a></dt><dt>1.4. <a href="#advanced-ebnf-table">Advanced Syntax of Orc</a></dt><dt>4.1. <a href="#types-ebnf-table">Typed Orc</a></dt><dt>A.1. <a href="#full-ebnf-grammar">Complete Syntax of Orc</a></dt></dl></div><div class="preface" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="N10007"></a>Introduction</h2></div></div></div><p>
Orc is a programming language designed to make distributed and
concurrent programs simple and intuitive to write. Orc expresses
orchestration, a type of structured concurrency. It emphasizes the
flow of control and gives a global view of a concurrent system. Orc
is well-suited for task orchestration, a form of
concurrent programming with applications in workflow, business process
management, and web service orchestration. Orc provides constructs to
orchestrate the concurrent invocation of services while managing
time-outs, priorities, and failures of services or communication.  To
learn more about Orc and run your own Orc programs, visit the website:
<a class="link" href="http://orc.csres.utexas.edu/" target="_top">
                <code class="code"><span class="hl-variable">http</span>://<span class="hl-variable">orc</span>.<span class="hl-variable">csres</span>.<span class="hl-variable">utexas</span>.<span class="hl-variable">edu</span>/</code>

            </a>.
</p><p>
Unless otherwise noted, all material in this document pertains to the
Orc language implementation version
1.1.0
.
</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="chapter.language"></a>Chapter&nbsp;1.&nbsp;The Orc Programming Language</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#N10019">1.1. Introduction</a></span></dt><dt><span class="section"><a href="#N10022">1.2. Cor: A Functional Subset</a></span></dt><dd><dl><dt><span class="section"><a href="#cor.constants">1.2.1. Constants</a></span></dt><dt><span class="section"><a href="#language.base.operators">1.2.2. Operators</a></span></dt><dt><span class="section"><a href="#N1034B">1.2.3. Conditionals</a></span></dt><dt><span class="section"><a href="#cor.variables">1.2.4. Variables</a></span></dt><dt><span class="section"><a href="#cor.data">1.2.5. Data Structures</a></span></dt><dt><span class="section"><a href="#N104CC">1.2.6. Patterns</a></span></dt><dt><span class="section"><a href="#cor.functions">1.2.7. Functions</a></span></dt><dt><span class="section"><a href="#N10626">1.2.8. Comments</a></span></dt></dl></dd><dt><span class="section"><a href="#N1063B">1.3. Orc: Orchestrating services</a></span></dt><dd><dl><dt><span class="section"><a href="#N1071A">1.3.1. Communicating with external services</a></span></dt><dt><span class="section"><a href="#N10774">1.3.2. The concurrency combinators of Orc</a></span></dt><dt><span class="section"><a href="#N108F0">1.3.3. Revisiting Cor expressions</a></span></dt><dt><span class="section"><a href="#N109FA">1.3.4. Time</a></span></dt></dl></dd><dt><span class="section"><a href="#N10A26">1.4. Advanced Features of Orc</a></span></dt><dd><dl><dt><span class="section"><a href="#N10B4A">1.4.1. Special call forms</a></span></dt><dt><span class="section"><a href="#N10BFD">1.4.2. Extensions to pattern matching</a></span></dt><dt><span class="section"><a href="#section.orc.datatypes">1.4.3. Datatypes</a></span></dt><dt><span class="section"><a href="#N10C6D">1.4.4. New forms of declarations</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N10019"></a>1.1.&nbsp;Introduction</h2></div></div></div><p>
This chapter describes the Orc programming language in three steps. In Section 1.2, we
discuss a small subset of Orc called Cor. Cor is a pure functional language,
which has no features for concurrency, has no state, and does not communicate 
with external services. Cor introduces us to the parts of Orc that are most familiar 
from existing programming languages, such as arithmetic operations, variables,
conditionals, and functions.
</p><p>
In Section 1.3, we consider Orc itself, which in addition to Cor, comprises 
external services and combinators for concurrent orchestration of those services. 
We show how Orc interacts with these external services, how the combinators can be
used to build up complex orchestrations from simple base expressions, and how the 
functional constructs of Cor take on new, subtler behaviors in the concurrent 
context of Orc.
</p><p>
In Section 1.4, we discuss some additional features of Orc that extend 
the basic syntax. These are useful for creating large-scale Orc programs, but 
they are not essential to the understanding of the language.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N10022"></a>1.2.&nbsp;Cor: A Functional Subset</h2></div></div></div><p>
In this section we introduce Cor, a pure functional subset of the Orc language.
Users of functional programming languages such as Haskell and ML will already be 
familiar with many of the key concepts of Cor.  
</p><p>
A Cor program is an <em class="firstterm">expression</em>. Cor expressions are built
up recursively from smaller expressions. Cor <em class="firstterm">evaluates</em> an expression
to reduce it to some simple <em class="firstterm">value</em> which cannot be evaluated further, 
for example a list of numbers or a Boolean truth value. This value is called the <em class="firstterm">
result</em> of the expression.
</p><p>
In the following subsections we introduce the concepts of Cor. First, we talk about
simple constants, such as numbers and truth values, and the operations that we can perform
on those values. Then we introduce conditionals (<code class="code"><span class="hl-keyword">if</span> <span class="hl-keyword">then</span> <span class="hl-keyword">else</span></code>). Then we 
introduce variables and binding, as a way to give a name to the value of an expression. 
After that, we talk about constructing data structures, and examining those structures
using patterns. Lastly, we introduce functions.
</p><p>
Table 1.1 describes the syntax of Cor. Each part of the syntax is explained 
in a subsequent section.
</p><p>
<div class="table"><a name="cor-ebnf-table"></a><p class="title"><b>Table&nbsp;1.1.&nbsp;Syntax of the Functional Subset of Orc (Cor)</b></p><div class="table-contents"><table summary="Syntax of the Functional Subset of Orc (Cor)" border="0" width="80%"><colgroup><col align="right"><col align="center"><col align="left"><col align="left"><col align="left"></colgroup><tbody><tr><td align="right">E</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Expression</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">C</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>constant value</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>variable</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>tuple</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">[</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">]</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>list</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X<code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>function call</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <span class="emphasis"><em>op</em></span> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>operator</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> E <code class="code"><span class="hl-keyword">else</span></code> E </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>conditional</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">lambda</span> (</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code> <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>closure</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">D E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>scoped declaration</em></span>
                                </td></tr><tr><td align="right">C</td><td align="center">::=</td><td align="left">
                                    <span class="emphasis"><em>Boolean</em></span> | <span class="emphasis"><em>Number</em></span> | <span class="emphasis"><em>String</em></span>
                                </td><td align="left">
                                    <span class="emphasis"><em>Constant</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">X</td><td align="center">::=</td><td align="left">
                                    <span class="emphasis"><em>Identifier</em></span>
                                </td><td align="left">
                                    <span class="emphasis"><em>Identifier</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">D</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Declaration</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">
                                    <code class="code"><span class="hl-keyword">val</span></code> P <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>value declaration</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">def</span></code> X<code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code> <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>function declaration</em></span>
                                </td></tr><tr><td align="right">P</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Pattern</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>variable</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">C</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>constant</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-variable">_</span></code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>wildcard</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>tuple</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">[</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">]</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>list</em></span>

                                </td></tr></tbody></table></div></div><br class="table-break">
</p><p>
Where relevant, syntactic constructs are ordered by precedence, from highest to lowest. For example, among expressions, calls have higher precedence than
operators, which in turn have higher precedence than conditionals.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="cor.constants"></a>1.2.1.&nbsp;Constants</h3></div></div></div><p>
The simplest expression one can write is a constant. It evaluates trivially
to that constant value. 
</p><p>

Cor has three types of constants, and thus for the moment three types of values:

<div class="itemizedlist"><ul type="disc"><li>
Boolean: <code class="code"><span class="hl-literal">true</span></code> and <code class="code"><span class="hl-literal">false</span></code></li><li>
Number: <code class="code"> <span class="hl-literal">5</span>, -<span class="hl-literal">1</span>, <span class="hl-literal">2.71828</span>, ... </code></li><li>
String: <code class="code"><span class="hl-literal">"orc"</span></code>, <code class="code"><span class="hl-literal">"ceci n'est pas une |"</span></code></li></ul></div>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="language.base.operators"></a>1.2.2.&nbsp;Operators</h3></div></div></div><p>
Cor has a standard set of arithmetic, logical, and comparison operators.
As in most other programming languages, they are written in the usual 
infix style. They have Java-like operator precedence, which can be
overridden by adding parentheses.  
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code"><span class="hl-literal">1</span>+<span class="hl-literal">2</span></code> evaluates to <code class="code"><span class="hl-literal">3</span></code>.</li><li><code class="code">(<span class="hl-literal">98</span>+<span class="hl-literal">2</span>)*<span class="hl-literal">17</span></code> evaluates to <code class="code"><span class="hl-literal">1700</span></code>.</li><li><code class="code"><span class="hl-literal">4</span> = <span class="hl-literal">20</span> / <span class="hl-literal">5</span></code> evaluates to <code class="code"><span class="hl-literal">true</span></code>.</li><li><code class="code"><span class="hl-literal">3</span>-<span class="hl-literal">5</span> <span class="hl-site">&gt;=</span> <span class="hl-literal">5</span>-<span class="hl-literal">3</span> </code> evaluates to <code class="code"><span class="hl-literal">false</span></code>.</li><li><code class="code"><span class="hl-literal">true</span> &amp;&amp; (<span class="hl-literal">false</span> <span class="hl-site">||</span> <span class="hl-literal">true</span>)</code> evaluates to <code class="code"><span class="hl-literal">true</span></code>.</li><li><code class="code"><span class="hl-literal">"leap"</span> + <span class="hl-literal">"frog"</span></code> evaluates to <code class="code"><span class="hl-literal">"leapfrog"</span></code>.</li></ul></div>
</p><p>
Here is the full set of operators that Cor supports:

<div class="table"><a name="ops-table"></a><p class="title"><b>Table&nbsp;1.2.&nbsp;Operators of Cor</b></p><div class="table-contents"><table summary="Operators of Cor" border="0" width="80%"><colgroup><col align="left"><col align="left"><col align="left"><col align="left"><col align="left"><col align="left"><col align="left"><col align="left"></colgroup><thead><tr><th colspan="2" align="left">Arithmetic</th><th colspan="2" align="left">Comparison</th><th colspan="2" align="left">Logical</th><th colspan="2" align="left">String</th></tr></thead><tbody><tr><td align="left">
                                    <code class="code">+</code>
                                    </td><td align="left">addition</td><td align="left">
                                    <code class="code">=</code>
                                    </td><td align="left">equality</td><td align="left">
                                    <code class="code">&amp;&amp;</code>
                                    </td><td align="left">logical and</td><td align="left">
                                    <code class="code">+</code>
                                    </td><td align="left">concatenation</td></tr><tr><td align="left">
                                    <code class="code">-</code>
                                    </td><td align="left">subtraction</td><td align="left">
                                    <code class="code">/=</code>
                                    </td><td align="left">inequality</td><td align="left">
                                    <code class="code"><span class="hl-site">||</span></code>

                                    </td><td align="left">logical or</td><td colspan="2" align="left">&nbsp;</td></tr><tr><td align="left">
                                    <code class="code">*</code>
                                    </td><td align="left">multiplication</td><td align="left">
                                    <code class="code">&lt;</code>
                                    </td><td align="left">less than</td><td align="left">
                                    <code class="code">~</code>

                                    </td><td align="left">logical not</td><td colspan="2" align="left">&nbsp;</td></tr><tr><td align="left">
                                    <code class="code">/</code>
                                    </td><td align="left">division</td><td align="left">
                                    <code class="code">&gt;</code>

                                    </td><td align="left">greater than</td><td colspan="2" align="left">&nbsp;</td><td colspan="2" align="left">&nbsp;</td></tr><tr><td align="left">
                                    <code class="code">%</code>
                                    </td><td align="left">modulus</td><td align="left">
                                    <code class="code"><span class="hl-site">&lt;=</span></code>

                                    </td><td align="left">less than or equal</td><td colspan="2" align="left">&nbsp;</td><td colspan="2" align="left">&nbsp;</td></tr><tr><td align="left">
                                    <code class="code">**</code>
                                    </td><td align="left">exponent</td><td align="left">
                                    <code class="code"><span class="hl-site">&gt;=</span></code>

                                    </td><td align="left">greater than or equal</td><td colspan="2" align="left">&nbsp;</td><td colspan="2" align="left">&nbsp;</td></tr></tbody></table></div></div><br class="table-break">

</p><p>
There is also a unary negation operator, written <code class="code">-</code>, for example <code class="code">-(<span class="hl-literal">2</span> ** <span class="hl-literal">5</span>)</code>.
</p><p>
The <code class="code">=</code> operator can compare values of any type. Values of different type are always unequal; for example,
<code class="code"><span class="hl-literal">10</span> = <span class="hl-literal">true</span></code> evaluates to <code class="code"><span class="hl-literal">false</span></code>.
</p><p>
Numbers with no decimal part, such as <code class="code"><span class="hl-literal">3</span></code>, are treated as integers. Arithmetic operators with two integer arguments will perform
an integer operation and return an integer result; for example, <code class="code"><span class="hl-literal">5</span> / <span class="hl-literal">2</span></code> performs integer division and evaluates to <code class="code"><span class="hl-literal">2</span></code>.
However, if either argument to an operator has a decimal part (even if it is trivial, as in <code class="code"><span class="hl-literal">3.0</span></code>), the other argument will
be promoted, and a decimal operation will be peformed. For example, <code class="code"><span class="hl-literal">5</span> / <span class="hl-literal">2.0</span></code> and <code class="code"><span class="hl-literal">5.0</span> / <span class="hl-literal">2</span></code> both perform decimal
division and evaluate to <code class="code"><span class="hl-literal">2.5</span></code>.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10333"></a>1.2.2.1.&nbsp;Silent Expression</h4></div></div></div><p>
There are situations where an expression evaluation is stuck, because it is attempting to perform 
some impossible operation and cannot compute a value. In that case, the expression is <em class="firstterm">silent</em>. 
An expression is also silent if it depends on the result of a silent subexpression. For example, the following
expressions are silent: <code class="code"><span class="hl-literal">10</span>/<span class="hl-literal">0</span></code>, <code class="code"><span class="hl-literal">6</span> + <span class="hl-literal">false</span></code>, <code class="code"><span class="hl-literal">3</span> + <span class="hl-literal">1</span>/<span class="hl-literal">0</span></code>, <code class="code"><span class="hl-literal">4</span> + <span class="hl-literal">true</span> = <span class="hl-literal">5</span></code>.
</p><p>
Cor is a dynamically typed language. A Cor implementation does not statically
check the type correctness of an expression; instead, an expression with a type
error is simply silent when it is evaluated.
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
Silent expressions can produce side effects.  For example, on encountering a
type error, Orc will print an error message to the console.  However the
expression containing the type error will not publish a value, and in this
respect it is silent.
</div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1034B"></a>1.2.3.&nbsp;Conditionals</h3></div></div></div><p>
A conditional expression in Cor is of the form 
<code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> F <code class="code"><span class="hl-keyword">else</span></code> G. 
Its meaning is similar to that in other languages: the value
of the expression is the value of F if and only if E evaluates to true, 
or the value of G if and only if E evaluates to false. Note that G is not
evaluated at all if E evaluates to true, and similarly F is not evaluated
at all if E evaluates to false. Thus, for example, evaluation of 
<code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">true</span> <span class="hl-keyword">then</span> <span class="hl-literal">2</span>+<span class="hl-literal">3</span> <span class="hl-keyword">else</span> <span class="hl-literal">1</span>/<span class="hl-literal">0</span></code> does not evaluate <code class="code"><span class="hl-literal">1</span>/<span class="hl-literal">0</span></code>;
it only evaluates <code class="code"><span class="hl-literal">2</span>+<span class="hl-literal">3</span></code>.
</p><p>
Unlike other languages, expressions in Cor may be silent. If E is
silent, then the entire expression is silent. And if E evaluates to true 
but F is silent (or if E evaluates to false and G is silent) then the 
expression is silent.
</p><p>
Note that conditionals have lower precedence than any of the operators.
For example, <code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">false</span> <span class="hl-keyword">then</span> <span class="hl-literal">1</span> <span class="hl-keyword">else</span> <span class="hl-literal">2</span> + <span class="hl-literal">3</span></code> is equivalent to
<code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">false</span> <span class="hl-keyword">then</span> <span class="hl-literal">1</span> <span class="hl-keyword">else</span> (<span class="hl-literal">2</span> + <span class="hl-literal">3</span>)</code>, not <code class="code">(<span class="hl-keyword">if</span> <span class="hl-literal">false</span> <span class="hl-keyword">then</span> <span class="hl-literal">1</span> <span class="hl-keyword">else</span> <span class="hl-literal">2</span>) + <span class="hl-literal">3</span></code>.
</p><p>
The behavior of conditionals is summarized by the following table
(<span class="emphasis"><em>v</em></span> denotes a value).

<div class="informaltable"><a name="cond-table"></a><table border="0" width="60%"><colgroup><col align="center"><col align="center"><col align="center"><col align="center"></colgroup><thead><tr><th align="center">E</th><th align="center">F</th><th align="center">G</th><th align="center">
                                    <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> F <code class="code"><span class="hl-keyword">else</span></code> G</th></tr></thead><tbody><tr><td align="center">
                                    <code class="code"><span class="hl-literal">true</span></code>
                                    </td><td align="center">
                                    <span class="emphasis"><em>v</em></span>
                                    </td><td align="center">-</td><td align="center">
                                    <span class="emphasis"><em>v</em></span>
                                    </td></tr><tr><td align="center">
                                    <code class="code"><span class="hl-literal">true</span></code>
                                    </td><td align="center">silent</td><td align="center">-</td><td align="center">silent</td></tr><tr><td align="center">
                                    <code class="code"><span class="hl-literal">false</span></code>
                                    </td><td align="center">-</td><td align="center">
                                    <span class="emphasis"><em>v</em></span>
                                    </td><td align="center">
                                    <span class="emphasis"><em>v</em></span>
                                    </td></tr><tr><td align="center">
                                    <code class="code"><span class="hl-literal">false</span></code>
                                    </td><td align="center">-</td><td align="center">silent</td><td align="center">silent</td></tr><tr><td align="center">silent</td><td align="center">-</td><td align="center">-</td><td align="center">silent</td></tr></tbody></table></div>

</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">true</span> <span class="hl-keyword">then</span> <span class="hl-literal">4</span> <span class="hl-keyword">else</span> <span class="hl-literal">5</span></code> evaluates to <code class="code"><span class="hl-literal">4</span></code>.</li><li><code class="code"><span class="hl-keyword">if</span>  <span class="hl-literal">2</span> &lt; <span class="hl-literal">3</span> &amp;&amp; <span class="hl-literal">5</span> &lt; <span class="hl-literal">4</span>  <span class="hl-keyword">then</span> <span class="hl-literal">"blue"</span> <span class="hl-keyword">else</span> <span class="hl-literal">"green"</span></code> evaluates to "green".</li><li><code class="code"><span class="hl-keyword">if</span>  <span class="hl-literal">true</span> <span class="hl-site">||</span> <span class="hl-literal">"fish"</span>  <span class="hl-keyword">then</span> <span class="hl-literal">"yes"</span> <span class="hl-keyword">else</span> <span class="hl-literal">"no"</span></code> is silent.</li><li><code class="code"><span class="hl-keyword">if</span>  <span class="hl-literal">false</span> <span class="hl-site">||</span> <span class="hl-literal">false</span>  <span class="hl-keyword">then</span> <span class="hl-literal">4</span>+<span class="hl-literal">5</span> <span class="hl-keyword">else</span> <span class="hl-literal">4</span>+<span class="hl-literal">true</span></code> is silent.</li><li><code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">0</span> &lt; <span class="hl-literal">5</span> <span class="hl-keyword">then</span> <span class="hl-literal">0</span>/<span class="hl-literal">5</span> <span class="hl-keyword">else</span> <span class="hl-literal">5</span>/<span class="hl-literal">0</span></code> evaluates to 0.</li></ul></div>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="cor.variables"></a>1.2.4.&nbsp;Variables</h3></div></div></div><p>
A <em class="firstterm">variable</em> can be bound to a value. A <em class="firstterm">declaration</em> binds one or
more variables to values. The simplest form of declaration is <code class="code"><span class="hl-keyword">val</span></code>, which 
evaluates an expression and binds its result to a variable. Declarations follow the rules of 
<a class="link" href="http://en.wikipedia.org/wiki/Lexical_scope" target="_top">lexical scoping</a>.
</p><p>
<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="hl-literal">1</span> + <span class="hl-literal">2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="hl-variable">x</span> + <span class="hl-variable">x</span>
</pre>

These declarations bind variable <code class="code"><span class="hl-variable">x</span></code> to 3 and variable <code class="code"><span class="hl-variable">y</span></code> to 6.
</p><p>
If the expression on the right side of a <code class="code"><span class="hl-keyword">val</span></code> is silent, then the variable is not bound, but 
evaluation of other declarations and expressions continues. If an evaluated expression depends on that
variable, that expression is silent.

<pre class="orc">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="hl-literal">1</span>/<span class="hl-literal">0</span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="hl-literal">4</span>+<span class="hl-literal">5</span>
<span class="hl-keyword">if</span> <span class="hl-literal">false</span> <span class="hl-keyword">then</span> <span class="hl-variable">x</span> <span class="hl-keyword">else</span> <span class="hl-variable">y</span></pre>

Evaluation of the declaration <code class="code"><span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="hl-literal">4</span>+<span class="hl-literal">5</span></code> and the expression <code class="code"><span class="hl-keyword">if</span> <span class="hl-literal">false</span> <span class="hl-keyword">then</span> <span class="hl-variable">x</span> <span class="hl-keyword">else</span> <span class="hl-variable">y</span></code>
may continue even though <code class="code"><span class="hl-variable">x</span></code> is not bound. The expression evaluates to 9.

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="cor.data"></a>1.2.5.&nbsp;Data Structures</h3></div></div></div><p>
Cor supports two basic data structures, <em class="firstterm">tuples</em> and <em class="firstterm">lists</em>.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10445"></a>1.2.5.1.&nbsp;Tuples</h4></div></div></div><p>
A <em class="firstterm">tuple expression</em> is a comma-separated sequence of at least two 
expressions, enclosed by parentheses. Each expression is evaluated; the value of the whole 
tuple expression is a tuple containing each of these values in order. 
If any of the expressions is silent, then the whole tuple expression is silent.
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code">(<span class="hl-literal">1</span>+<span class="hl-literal">2</span>, <span class="hl-literal">7</span>)</code> evaluates to <code class="code">(<span class="hl-literal">3</span>,<span class="hl-literal">7</span>)</code>.</li><li><code class="code"> (<span class="hl-literal">"true"</span> + <span class="hl-literal">"false"</span>, <span class="hl-literal">true</span> <span class="hl-site">||</span> <span class="hl-literal">false</span>, <span class="hl-literal">true</span> &amp;&amp; <span class="hl-literal">false</span>) </code> evaluates to <code class="code">(<span class="hl-literal">"truefalse"</span>, <span class="hl-literal">true</span>, <span class="hl-literal">false</span>)</code>.</li><li><code class="code">(<span class="hl-literal">2</span>/<span class="hl-literal">2</span>, <span class="hl-literal">2</span>/<span class="hl-literal">1</span>, <span class="hl-literal">2</span>/<span class="hl-literal">0</span>)</code> is silent.</li></ul></div>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10465"></a>1.2.5.2.&nbsp;Lists</h4></div></div></div><p>
A <em class="firstterm">list expression</em> is a comma-separated sequence of expressions enclosed by
square brackets. It may be of any length, including zero. Each expression is evaluated; the value 
of the whole list expression is a list containing each of these values in order.   
If any of the expressions is silent, then the whole list expression is silent.
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">2</span>+<span class="hl-literal">3</span>] </code> evaluates to <code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">5</span>]</code>.</li><li><code class="code"> [<span class="hl-literal">true</span> &amp;&amp; <span class="hl-literal">true</span>]  </code> evaluates to <code class="code">[<span class="hl-literal">true</span>]</code>.</li><li><code class="code">[]</code> evaluates vacuously to <code class="code">[]</code>, the empty list.</li><li><code class="code">[<span class="hl-literal">5</span>, <span class="hl-literal">5</span> + <span class="hl-literal">true</span>, <span class="hl-literal">5</span>]</code> is silent.</li></ul></div>
</p><p>
There is also a concatenation (<em class="firstterm">cons</em>) operation on lists,
written F<code class="code">:</code>G, where F and G are expressions. Its result is a new list whose first element is the 
value of F and whose remaining elements are the list value of G. The <code class="code">:</code> operator is right associative,
so F<code class="code">:</code>G<code class="code">:</code>H is F<code class="code">:(</code>G<code class="code">:</code>H<code class="code">)</code>.
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code">(<span class="hl-literal">1</span>+<span class="hl-literal">3</span>):[<span class="hl-literal">2</span>+<span class="hl-literal">5</span>,<span class="hl-literal">6</span>]</code> evaluates to <code class="code">[<span class="hl-literal">4</span>,<span class="hl-literal">7</span>,<span class="hl-literal">6</span>]</code>.</li><li><code class="code"><span class="hl-literal">2</span>:<span class="hl-literal">2</span>:<span class="hl-literal">5</span>:[] </code> evaluates to <code class="code">[<span class="hl-literal">2</span>,<span class="hl-literal">2</span>,<span class="hl-literal">5</span>]</code>.</li><li>Suppose <code class="code"><span class="hl-variable">t</span></code> is bound to [3,5]. Then <code class="code"><span class="hl-literal">1</span>:<span class="hl-variable">t</span></code> evaluates to <code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">3</span>,<span class="hl-literal">5</span>]</code>.</li><li><code class="code"><span class="hl-literal">2</span>:<span class="hl-literal">3</span></code> is silent, because <code class="code"><span class="hl-literal">3</span></code> is not a list.</li></ul></div>
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N104CC"></a>1.2.6.&nbsp;Patterns</h3></div></div></div><p>
We have seen how to construct data structures. But how do we examine them, and use them? We use <em class="firstterm">patterns</em>.
</p><p>
A pattern is a powerful way to bind variables. When writing <code class="code"><span class="hl-keyword">val</span></code> declarations, instead of just
binding one variable, we can replace the variable name with a more complex pattern that follows the structure of the
value, and matches its components. A pattern's structure is called its <em class="firstterm">shape</em>; a
pattern may take the shape of any structured value. A pattern can hierarchically match a value, going deep into its 
structure. It can also bind an entire structure to a variable.

</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code"><span class="hl-keyword">val</span> (<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = (<span class="hl-literal">2</span>+<span class="hl-literal">3</span>,<span class="hl-literal">2</span>*<span class="hl-literal">3</span>)</code> binds <code class="code"><span class="hl-variable">x</span></code> to 5 and <code class="code"><span class="hl-variable">y</span></code> to 6.</li><li><code class="code"><span class="hl-keyword">val</span> [<span class="hl-variable">a</span>,<span class="hl-variable">b</span>,<span class="hl-variable">c</span>] = [<span class="hl-literal">"one"</span>, <span class="hl-literal">"two"</span>, <span class="hl-literal">"three"</span>]</code> binds <code class="code"><span class="hl-variable">a</span></code> to "one", 
<code class="code"><span class="hl-variable">b</span></code> to "two", and <code class="code"><span class="hl-variable">c</span></code> to "three".
</li><li><code class="code"><span class="hl-keyword">val</span> ((<span class="hl-variable">a</span>,<span class="hl-variable">b</span>),<span class="hl-variable">c</span>) = ((<span class="hl-literal">1</span>, <span class="hl-literal">true</span>), (<span class="hl-literal">2</span>, <span class="hl-literal">false</span>))</code> binds <code class="code"><span class="hl-variable">a</span></code> to 1, <code class="code"><span class="hl-variable">b</span></code> to <code class="code"><span class="hl-literal">true</span></code>,
and <code class="code"><span class="hl-variable">c</span></code> to <code class="code">(<span class="hl-literal">2</span>,<span class="hl-literal">false</span>)</code>.
</li></ul></div>
</p><p>
Patterns are <em class="firstterm">linear</em>; that is, a pattern may mention a variable name at most once. 
For example, <code class="code">(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>,<span class="hl-variable">x</span>)</code> is not a valid pattern.
</p><p>
Note that a pattern may fail to match a value, if it does not have the same shape as that value. In a <code class="code"><span class="hl-keyword">val</span></code>
declaration, this has the same effect as evaluating a silent expression. No variable in the pattern is bound, and
if any one of those variables is later evaluated, it is silent.
</p><p>
It is often useful to ignore parts of the value that are not relevant. We can use the
wildcard pattern, written <code class="code"><span class="hl-variable">_</span></code>, to do this; it matches any shape and binds no
variables.
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code"><span class="hl-keyword">val</span> (<span class="hl-variable">x</span>,<span class="hl-variable">_</span>,<span class="hl-variable">_</span>) = (<span class="hl-literal">1</span>,(<span class="hl-literal">2</span>,<span class="hl-literal">2</span>),[<span class="hl-literal">3</span>,<span class="hl-literal">3</span>,<span class="hl-literal">3</span>])</code> binds <code class="code"><span class="hl-variable">x</span></code> to 1.</li><li><code class="code"><span class="hl-keyword">val</span> [[<span class="hl-variable">_</span>,<span class="hl-variable">x</span>],[<span class="hl-variable">_</span>,<span class="hl-variable">y</span>]] = [[<span class="hl-literal">1</span>,<span class="hl-literal">3</span>],[<span class="hl-literal">2</span>,<span class="hl-literal">4</span>]]</code> binds <code class="code"><span class="hl-variable">x</span></code> to 3 and <code class="code"><span class="hl-variable">y</span></code> to 4.</li></ul></div>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="cor.functions"></a>1.2.7.&nbsp;Functions</h3></div></div></div><p>
Like most other programming languages, Cor provides the capability to define <em class="firstterm">functions</em>,
which are expressions that have a defined name, and have some number of parameters. Functions are declared 
using the keyword <code class="code"><span class="hl-keyword">def</span></code>, in the following way.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">add</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-variable">x</span>+<span class="hl-variable">y</span>
</pre>

The expression on the right of the <code class="code">=</code> is called the <em class="firstterm">body</em> of the function.
</p><p>
After defining the function, we can <em class="firstterm">call</em> it. A call looks just like the left side of
the declaration except that the variable names (the <em class="firstterm">formal parameters</em>) have been 
replaced by expressions (the <em class="firstterm">actual parameters</em>). 
</p><p>
To evaluate a call, we treat it as a sequence of <code class="code"><span class="hl-keyword">val</span></code> declarations associating the formal
parameters with the actual parameters, followed by the body of the function. 

<pre class="programlisting">
<span class="hl-comment">{- Evaluation of add(1+2,3+4) -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="hl-literal">1</span>+<span class="hl-literal">2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="hl-literal">3</span>+<span class="hl-literal">4</span>
<span class="hl-variable">x</span>+<span class="hl-variable">y</span>
</pre>
</p><p>
<div class="itemizedlist"><p class="title"><b>Examples</b></p><ul type="disc"><li><code class="code"><span class="hl-site">add</span>(<span class="hl-literal">10</span>,<span class="hl-literal">10</span>*<span class="hl-literal">10</span>)</code> evaluates to <code class="code"><span class="hl-literal">110</span></code>.</li><li><code class="code"><span class="hl-site">add</span>(<span class="hl-site">add</span>(<span class="hl-literal">5</span>,<span class="hl-literal">3</span>),<span class="hl-literal">5</span>)</code> evaluates to <code class="code"><span class="hl-literal">13</span></code>.</li></ul></div>
</p><p>
Notice that the evaluation strategy of functions allows a call to proceed even if some of the actual
parameters are silent, so long as the values of those actual parameters are not used in the evaluation
of the body.

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">cond</span>(<span class="hl-variable">b</span>,<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">b</span> <span class="hl-keyword">then</span> <span class="hl-variable">x</span> <span class="hl-keyword">else</span> <span class="hl-variable">y</span>
<span class="hl-site">cond</span>(<span class="hl-literal">true</span>, <span class="hl-literal">3</span>, <span class="hl-literal">5</span>/<span class="hl-literal">0</span>)
</pre>

This evaluates to <code class="code"><span class="hl-literal">3</span></code> even though <code class="code"><span class="hl-literal">5</span>/<span class="hl-literal">0</span></code> is silent, because <code class="code"><span class="hl-variable">y</span></code> is not
needed.

</p><p>
A function definition or call may have zero arguments, in which case we write <code class="code">()</code> for the arguments.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">Zero</span>() = <span class="hl-literal">0</span>
</pre>
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10588"></a>1.2.7.1.&nbsp;Recursion</h4></div></div></div><p>
Functions can be recursive; that is, the name of a function may be used in its own body.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">sumto</span>(<span class="hl-variable">n</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">n</span> &lt; <span class="hl-literal">1</span> <span class="hl-keyword">then</span> <span class="hl-literal">0</span> <span class="hl-keyword">else</span> <span class="hl-variable">n</span> + <span class="hl-site">Sumto</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)
</pre>

Then, <code class="code"><span class="hl-site">sumto</span>(<span class="hl-literal">5</span>)</code> evaluates to 15.
</p><p>
Mutual recursion is also supported.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">even</span>(<span class="hl-variable">n</span>) = 
  <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-site">odd</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)
  <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-site">odd</span>(<span class="hl-variable">n</span>+<span class="hl-literal">1</span>)
  <span class="hl-keyword">else</span> <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">odd</span>(<span class="hl-variable">n</span>) = 
  <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-site">even</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)
  <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-site">even</span>(<span class="hl-variable">n</span>+<span class="hl-literal">1</span>)
  <span class="hl-keyword">else</span> <span class="hl-literal">false</span>
</pre>

There is no special keyword for mutual recursion; any contiguous sequence of function declarations is assumed to be 
mutually recursive.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="cor.closures"></a>1.2.7.2.&nbsp;Closures</h4></div></div></div><p>
Functions are actually values, just like any other value. Defining a function creates a special value called a 
<em class="firstterm">closure</em>; the name of the function is a variable and its bound value is the closure. Thus, 
a closure can be put into a data structure, or bound to some other variable, just like any other value.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">a</span>(<span class="hl-variable">x</span>) = <span class="hl-variable">x</span>-<span class="hl-literal">3</span>
<span class="hl-keyword">def</span> <span class="hl-site">b</span>(<span class="hl-variable">y</span>) = <span class="hl-variable">y</span>*<span class="hl-literal">4</span>
<span class="hl-keyword">val</span> <span class="hl-variable">funs</span> = (<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)
</pre>
</p><p>
Like any other value, a closure can be passed as an argument to another function. This means that Cor
supports <span class="emphasis"><em>higher-order</em></span> functions.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">onetwosum</span>(<span class="hl-variable">f</span>) = <span class="hl-site">f</span>(<span class="hl-literal">1</span>) + <span class="hl-site">f</span>(<span class="hl-literal">2</span>)
<span class="hl-keyword">def</span> <span class="hl-site">triple</span>(<span class="hl-variable">x</span>) = <span class="hl-variable">x</span> * <span class="hl-literal">3</span>
</pre>

Then, <code class="code"><span class="hl-site">onetwosum</span>(<span class="hl-variable">triple</span>)</code> is <code class="code"><span class="hl-site">triple</span>(<span class="hl-literal">1</span>) + <span class="hl-site">triple</span>(<span class="hl-literal">2</span>)</code>, which is <code class="code"><span class="hl-literal">1</span> * <span class="hl-literal">3</span> + <span class="hl-literal">2</span> * <span class="hl-literal">3</span></code> which evaluates to <code class="code"><span class="hl-literal">9</span></code>.

</p><p>
Since all declarations (including function declarations) in Cor are lexically scoped, these closures are
<span class="emphasis"><em>lexical closures</em></span>. This means that when a closure is created, if the body of the
function contains any variables other than the formal parameters, the bindings for those variables are
stored in the closure. Then, when the closure is called, the evaluation of the function body uses those 
stored variable bindings.  
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N105BD"></a>1.2.7.3.&nbsp;Lambda</h4></div></div></div><p>
Sometimes one would like to create a closure directly, without bothering to give it a name. 
There is a special keyword <code class="code"><span class="hl-keyword">lambda</span></code> for this purpose. By writing a function
definition without the keyword <code class="code"><span class="hl-keyword">def</span></code> and replacing the function name with
the keyword <code class="code"><span class="hl-keyword">lambda</span></code>, that definition becomes an expression which evaluates to a closure. 

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">onetwosum</span>(<span class="hl-variable">f</span>) = <span class="hl-site">f</span>(<span class="hl-literal">1</span>) + <span class="hl-site">f</span>(<span class="hl-literal">2</span>)

<span class="hl-site">onetwosum</span>( <span class="hl-keyword">lambda</span>(<span class="hl-variable">x</span>) = <span class="hl-variable">x</span> * <span class="hl-literal">3</span> )
<span class="hl-comment">{- 
  identical to:
  def triple(x) = x * 3
  onetwosum(triple)
-}</span></pre>

Then, <code class="code"><span class="hl-site">onetwosum</span>( <span class="hl-keyword">lambda</span>(<span class="hl-variable">x</span>) = <span class="hl-variable">x</span> * <span class="hl-literal">3</span> )</code> evaluates to 9. 

</p><p>
Since a function defined using <code class="code"><span class="hl-keyword">lambda</span></code> has no name, it is not possible to define 
a recursive function in this way. Only <code class="code"><span class="hl-keyword">def</span></code> can create a recursive function.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N105DA"></a>1.2.7.4.&nbsp;Clauses</h4></div></div></div><p>
The combination of functions and pattern matching offers a powerful capability: 
<em class="firstterm">clausal</em> definition of functions. We can define expressions which execute 
different code depending on the structure of their arguments. 
</p><p>
Here's an example.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-variable">h</span> + <span class="hl-site">sum</span>(<span class="hl-variable">t</span>)
</pre>

<code class="code"><span class="hl-site">sum</span>(<span class="hl-variable">l</span>)</code> publishes the sum of the numbers in the list <code class="code"><span class="hl-variable">l</span></code>. It has two clauses: 
one which matches the empty list, and one which matches any nonempty list. If its argument is an empty 
list, it returns 0, the appropriate sum for an empty list. If the argument is a nonempty list, it adds 
the first element of that list to the sum of all of the other elements. In this way, it recursively finds 
the sum of the list.
</p><p>
A function may have multiple clauses, each of which has a sequence of patterns to match each argument, 
and a body expression. Naturally, all clauses of a function must have the same number of arguments. Any 
contiguous sequence of definitions with the same name and different arguments is interpreted as a clausal 
definition, where each individual declaration is a clause of the larger function. 
</p><p>
When the function is called, the clauses are tried in the order in which they appear until a match is found. 
If no clause matches, the call remains silent.
</p><p>
We allow a new form of pattern which is very useful in clausal definition of functions: a constant pattern.
A constant pattern is a match only for the same constant value. We can use this to define the "base case"
of a recursive function in a straightforward way.

<pre class="programlisting">
<span class="hl-comment">{- Fibonacci numbers -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">fib</span>(<span class="hl-literal">0</span>) = <span class="hl-literal">1</span>
<span class="hl-keyword">def</span> <span class="hl-site">fib</span>(<span class="hl-literal">1</span>) = <span class="hl-literal">1</span>
<span class="hl-keyword">def</span> <span class="hl-site">fib</span>(<span class="hl-variable">n</span>) = <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-literal">0</span> <span class="hl-keyword">else</span> <span class="hl-site">fib</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>) + <span class="hl-site">fib</span>(<span class="hl-variable">n</span>-<span class="hl-literal">2</span>)
</pre>

This definition of the Fibonacci function is straightforward, but slow, due to the repeated work in recursive
calls to <code class="code"><span class="hl-variable">fib</span></code>. We can define a linear-time version, again with the help of pattern matching:

<pre class="programlisting">
<span class="hl-comment">{- Alternate definition of the Fibonacci function -}</span>

<span class="hl-comment">{- A helper function: find the pair (Fibonacci(n-1), Fibonacci(n)) -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">H</span>(<span class="hl-literal">0</span>) = (<span class="hl-literal">1</span>,<span class="hl-literal">1</span>)
<span class="hl-keyword">def</span> <span class="hl-site">H</span>(<span class="hl-variable">n</span>) = 
  <span class="hl-keyword">val</span> (<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-site">H</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)
  (<span class="hl-variable">y</span>,<span class="hl-variable">x</span>+<span class="hl-variable">y</span>)

<span class="hl-keyword">def</span> <span class="hl-site">fib</span>(<span class="hl-variable">n</span>) = 
  <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-literal">0</span> 
  <span class="hl-keyword">else</span> (
    <span class="hl-keyword">val</span> (<span class="hl-variable">x</span>,<span class="hl-variable">_</span>) = <span class="hl-site">H</span>(<span class="hl-variable">n</span>) 
    <span class="hl-variable">x</span>
  )
     
    
</pre>
</p><p>
As a more complex example of matching, consider the following function which takes
a list argument and returns a new list containing only the first <code class="code"><span class="hl-variable">n</span></code> 
elements of the argument list. 

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">take</span>(<span class="hl-literal">0</span>,<span class="hl-variable">_</span>) = []
<span class="hl-keyword">def</span> <span class="hl-site">take</span>(<span class="hl-variable">n</span>,<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> <span class="hl-variable">h</span>:(<span class="hl-site">take</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>,<span class="hl-variable">t</span>)) <span class="hl-keyword">else</span> []
</pre>
</p><p>
Mutual recursion and clausal definitions are allowed to occur together. Here are two functions,
<code class="code"><span class="hl-variable">stutter</span></code> and <code class="code"><span class="hl-variable">mutter</span></code>, which are each mutually recursive, and each have
multiple clauses. <code class="code"><span class="hl-site">stutter</span>(<span class="hl-variable">l</span>)</code> returns <code class="code"><span class="hl-variable">l</span></code> with every odd element repeated.
<code class="code"><span class="hl-site">mutter</span>(<span class="hl-variable">l</span>)</code> returns <code class="code"><span class="hl-variable">l</span></code> with every even element repeated.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">stutter</span>([]) = []
<span class="hl-keyword">def</span> <span class="hl-site">stutter</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-variable">h</span>:<span class="hl-variable">h</span>:<span class="hl-site">mutter</span>(<span class="hl-variable">t</span>)
<span class="hl-keyword">def</span> <span class="hl-site">mutter</span>([]) = []
<span class="hl-keyword">def</span> <span class="hl-site">mutter</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-variable">h</span>:<span class="hl-site">stutter</span>(<span class="hl-variable">t</span>)
</pre>

<code class="code"><span class="hl-site">stutter</span>([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>])</code> evaluates to <code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>,<span class="hl-literal">3</span>]</code>.
</p><p>
Clauses of mutually recursive functions may also be interleaved, to make
them easier to read.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">even</span>(<span class="hl-literal">0</span>) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">odd</span>(<span class="hl-literal">0</span>) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">even</span>(<span class="hl-variable">n</span>) = <span class="hl-site">odd</span>(<span class="hl-keyword">if</span> <span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-variable">n</span>-<span class="hl-literal">1</span> <span class="hl-keyword">else</span> <span class="hl-variable">n</span>+<span class="hl-literal">1</span>)
<span class="hl-keyword">def</span> <span class="hl-site">odd</span>(<span class="hl-variable">n</span>) = <span class="hl-site">even</span>(<span class="hl-keyword">if</span> <span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-variable">n</span>-<span class="hl-literal">1</span> <span class="hl-keyword">else</span> <span class="hl-variable">n</span>+<span class="hl-literal">1</span>)
</pre>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10626"></a>1.2.8.&nbsp;Comments</h3></div></div></div><p>
Cor has two kinds of comments.   

</p><p>
A line which begins with two dashes (<code class="code"><span class="hl-comment">--</span></code>), preceded only by whitespace, is a single line comment.
The region from the two dashes to the next encountered newline, inclusive, is ignored.  
<pre class="programlisting">
<span class="hl-comment">-- This is a single line comment.</span>
	 <span class="hl-comment">-- This is also a single line comment.</span>
</pre>
</p><p>
Multi-line comments are enclosed by matching braces of the form <code class="code"><span class="hl-comment">{- -}</span></code>. 
Multi-line comments may be nested. They may appear anywhere, even in the middle of an expression.

<pre class="programlisting">
<span class="hl-comment">{- 
   This is a
   multiline comment.
-}</span>
   
<span class="hl-comment">{- Multiline comments {- can be nested -}</span> -}

<span class="hl-comment">{- They may appear anywhere, -}</span> 
<span class="hl-literal">1</span> + <span class="hl-comment">{- even in the middle of an expression. -}</span> <span class="hl-literal">2</span> + <span class="hl-literal">3</span>
</pre>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N1063B"></a>1.3.&nbsp;Orc: Orchestrating services</h2></div></div></div><p>
Cor is a pure declarative language. It has no state, since variables are bound at most once 
and cannot be reassigned. Evaluation of an expression results in at most one value.
It cannot communicate with the outside world except by producing a value. The full 
Orc language transcends these limitations by incorporating the orchestration of external services.
We introduce the term <em class="firstterm">site</em> to denote an external service which can be
called from an Orc program.
</p><p>
As in Cor, an Orc program is an  <em class="firstterm">expression</em>; Orc expressions are built 
up recursively from smaller expressions. Orc is a superset of Cor, i.e., all Cor expressions are 
also Orc expressions. Orc expressions are <em class="firstterm">executed</em>, rather than evaluated; 
an execution may call external services and <em class="firstterm">publish</em> some number of 
values (possibly zero). Different executions of the same expression may have completely different
behaviors; they may call different services, may receive different responses from the same site,
and may publish different values. Expressions in the functional subset, though, will display
the same behavior in all executions.
</p><p>
In the following sections we discuss the features of Orc. First, we discuss how Orc
communicates with external services. Then we introduce Orc's concurrency <em class="firstterm">combinators</em>,
which combine expressions into larger orchestrations and manage concurrent executions. 
We have already discussed the functional subset of Orc in our coverage of Cor, but we
reprise some of those topics; some Cor constructs exhibit new behaviors in the 
concurrent, stateful context of Orc.
</p><p>
The following figure summarizes the syntax of Orc as an extension of the syntax of Cor. 
The original Cor grammar rules are abbreviated by ellipses (...). 
</p><p>
<div class="table"><a name="orc-ebnf-table"></a><p class="title"><b>Table&nbsp;1.3.&nbsp;Basic Syntax of Orc</b></p><div class="table-contents"><table summary="Basic Syntax of Orc" border="0" width="80%"><colgroup><col align="right"><col align="center"><col align="left"><col align="left"><col align="left"></colgroup><tbody><tr><td align="right">D</td><td align="center">::=</td><td align="left"> ... </td><td align="left">
                                    <span class="emphasis"><em>Declaration</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">site</span></code> X <code class="code">=</code> <span class="emphasis"><em>address</em></span>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>site declaration</em></span>
                                </td></tr><tr><td align="right">C</td><td align="center">::=</td><td align="left"> ... </td><td align="left">
                                    <span class="emphasis"><em>Constant</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">signal</span></code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>signal value</em></span>
                                </td></tr><tr><td align="right">E</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Expression</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">stop</span></code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>silent expression</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E<code class="code"> <span class="hl-combinator">&gt;</span></code>P<code class="code"><span class="hl-combinator">&gt;</span> </code>E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>sequential combinator</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code"><span class="hl-combinator">|</span></code> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>parallel combinator</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E<code class="code"> <span class="hl-combinator">&lt;</span></code>P<code class="code"><span class="hl-combinator">&lt;</span> </code>E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>pruning combinator</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code"><span class="hl-combinator">;</span></code> E</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>otherwise combinator</em></span>
                                </td></tr></tbody></table></div></div><br class="table-break">
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1071A"></a>1.3.1.&nbsp;Communicating with external services</h3></div></div></div><p>
An Orc expression may be a site call. Sites are called using the same syntax as a 
function call, but with a slightly different meaning. Sites are introduced and bound 
to variables by a special declaration.  
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1071F"></a>1.3.1.1.&nbsp;Calling a site</h4></div></div></div><p>
Suppose that the variable <code class="code"><span class="hl-variable">Google</span></code> is bound to a site which invokes the
Google search engine service in "I'm Feeling Lucky" mode. A call to <code class="code"><span class="hl-variable">Google</span></code> 
looks just like a function call. Calling <code class="code"><span class="hl-variable">Google</span></code> requests the URL of the top 
result for the given search term.

<pre class="programlisting">
<span class="hl-comment">{- Get the top search result for "computation orchestration" -}</span>
<span class="hl-site">Google</span>(<span class="hl-literal">"computation orchestration"</span>)
</pre>

Once the Google search service determines the top result, it sends a response. The site 
call then publishes that response. Note that the service might not respond: Google's 
servers might be down, the network might be down, or the search might yield no result URL.  
</p><p>
A site call sends only a single request to an external service and receives at most one
response. These restrictions have two important consequences. First, all of the information needed 
for the call must be present before contacting the service. Thus, site calls are strict; all 
arguments must be bound before the call can proceed. If any argument is silent, the call never occurs.
Second, a site call publishes at most one value, since at most one response is received.
</p><p>
A call to a site has exactly one of the following effects: 

<div class="orderedlist"><ol type="1"><li>The site returns a value, called its <em class="firstterm">response</em>.</li><li>The site communicates that it will never respond to the call; we say that the call has <em class="firstterm">halted</em></li><li>The site neither returns a value nor indicates that the call has halted; we say that the call is <em class="firstterm">pending</em>.</li></ol></div>
</p><p>
In the last two cases, the site call is said to be silent. However, unlike a silent expression in Cor, 
a silent site call in Orc might perform some meaningful computation or communication; silence does 
not necessarily indicate an error. Since halted site calls and pending site calls are both silent,
they cannot usually be distinguished from each other; only the <a class="link" href="#combinator.otherwise" title="1.3.2.4.&nbsp;The otherwise combinator">
otherwise combinator</a> can tell the difference. 
</p><p>
A site is a value, just like an integer or a list. It may be bound to a variable, passed 
as an argument, or published by an execution, just like any other value.
</p><p>
<pre class="programlisting">
<span class="hl-comment">{-
  Create a search site from a search engine URL,
  bind the variable Search to that site,
  then use that site to search for a term.
-}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">Search</span> = <span class="hl-site">SearchEngine</span>(<span class="hl-literal">"http://www.google.com/"</span>)
<span class="hl-site">Search</span>(<span class="hl-literal">"first class value"</span>)
</pre>
</p><p>
A site is sometimes called only for its effect on the external world; its return
value is irrelevant. Many sites which do not need to return a meaningful value will
instead return a <em class="firstterm">signal</em>: a special value which carries no 
information (analogous to the unit value <code class="code">()</code> in ML). The signal value
can be written as <code class="code"><span class="hl-keyword">signal</span></code> within Orc programs.


<pre class="orc">
<span class="hl-comment">{- 
  Use the 'println' site to print a string, followed by
  a newline, to an output console.
  The return value of this site call is a signal.
-}</span>
<span class="hl-site">println</span>(<span class="hl-literal">"Hello, World!"</span>)
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="orc-declaring-a-site"></a>1.3.1.2.&nbsp;Declaring a site</h4></div></div></div><p>
A <code class="code"><span class="hl-keyword">site</span></code> declaration makes some service available as a site and
binds it to a variable. The service might be an object in the host language 
(e.g. a class instance in Java), or an external service on the web which is accessed 
through some protocol like SOAP or REST, or even a primitive operation like addition. 



Many useful sites are already defined in the Orc standard library, documented
in <a class="link" href="#appendix.library" title="Appendix&nbsp;B.&nbsp;Standard Library">Appendix B</a>. For now, we present a simple 
type of site declaration: using an object in the host language as a site.  
</p><p>
The following example instantiates a Java object to be used as a site in an Orc program, specifically
a Java object which provides an asynchronous buffer service. The declaration uses a
fully qualified Java class name to find and load a class, and creates an instance of that
class to provide the service. 

<pre class="programlisting">
<span class="hl-comment">{-  Define the Buffer site  -}</span>
<span class="hl-keyword">site</span> <span class="hl-variable">Buffer</span> = <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">state</span>.<span class="hl-variable">Buffer</span>
</pre>  
</p><p>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10774"></a>1.3.2.&nbsp;The concurrency combinators of Orc</h3></div></div></div><p>
Orc has four <em class="firstterm">combinators</em>: parallel, sequential, pruning, and otherwise. 
A combinator forms an expression from two component expressions. Each combinator captures a 
different aspect of concurrency. Syntactically, the combinators are written infix, and have
lower precedence than operators, but higher precedence than conditionals or declarations.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1077C"></a>1.3.2.1.&nbsp;The parallel combinator</h4></div></div></div><p>
Orc's simplest combinator is <code class="code"><span class="hl-combinator">|</span></code>, the parallel combinator. Orc executes
the expression F <code class="code"><span class="hl-combinator">|</span></code> G, where F and G are Orc expressions, by executing 
F and G concurrently. Whenever F or G communicates with a service or publishes a value, 
F <code class="code"><span class="hl-combinator">|</span></code> G does so as well. 
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 1 and 2 in parallel  </span>
<span class="hl-literal">1</span> <span class="hl-combinator">|</span> <span class="hl-literal">1</span>+<span class="hl-literal">1</span>
</pre>
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- 
  Access two search sites, Google and Yahoo, in parallel.

  Publish any results they return.
  
  Since each call may publish a value, the expression
  may publish up to two values.
-}</span>  
<span class="hl-site">Google</span>(<span class="hl-literal">"cupcake"</span>) <span class="hl-combinator">|</span> <span class="hl-site">Yahoo</span>(<span class="hl-literal">"cupcake"</span>)
</pre>
</p><p>
The parallel combinator is fully associative: (F <code class="code"><span class="hl-combinator">|</span></code> G) <code class="code"><span class="hl-combinator">|</span></code> H and
F <code class="code"><span class="hl-combinator">|</span></code> (G <code class="code"><span class="hl-combinator">|</span></code> H) and F <code class="code"><span class="hl-combinator">|</span></code> G <code class="code"><span class="hl-combinator">|</span></code> H are all
equivalent.
</p><p>
It is also commutative: F <code class="code"><span class="hl-combinator">|</span></code> G is equivalent to G <code class="code"><span class="hl-combinator">|</span></code> F.  
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 1, 2, and 3 in parallel  </span>
<span class="hl-literal">1</span>+<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-literal">1</span>+<span class="hl-literal">1</span> <span class="hl-combinator">|</span> <span class="hl-literal">1</span>+<span class="hl-literal">2</span>
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N107B7"></a>1.3.2.2.&nbsp;The sequential combinator</h4></div></div></div><p>
Now that we have expressions which publish multiple values, what can we do with those
publications? The sequential combinator, written F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G, 
combines the expression F, which may publish some values, with another expression G, 
which will use the values as they are published; <code class="code"><span class="hl-variable">x</span></code> transmits the values
from F to G.
</p><p>
The execution of F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G starts by executing F. Whenever F publishes a value, 
a new copy of G is executed in parallel with F (and with any previous copies of G); in that
copy of G, variable <code class="code"><span class="hl-variable">x</span></code> is bound to the value published by F. Values published by copies
of G are published by the whole expression, but the values published by F are not published
by the whole expression; they are consumed by the variable binding.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 1 and 2 in parallel  </span>
(<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-literal">1</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">n</span>+<span class="hl-literal">1</span>
</pre>
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 3 and 4 in parallel  </span>
<span class="hl-literal">2</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">n</span>+<span class="hl-literal">1</span> <span class="hl-combinator">|</span> <span class="hl-variable">n</span>+<span class="hl-literal">2</span>)
</pre>
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 0, 1, 2 and 3 in parallel  </span>
(<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">n</span> <span class="hl-combinator">|</span> <span class="hl-variable">n</span>+<span class="hl-literal">1</span>)
</pre>
</p><p>
<pre class="programlisting">
<span class="hl-comment">-- Prepend the site name to each published search result</span>
<span class="hl-comment">-- The cat site concatenates any number of arguments into one string  </span>
  <span class="hl-site">Google</span>(<span class="hl-literal">"cupcake"</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">s</span><span class="hl-combinator">&gt;</span> <span class="hl-site">cat</span>(<span class="hl-literal">"Google: "</span>, <span class="hl-variable">s</span>)
<span class="hl-combinator">|</span> <span class="hl-site">Yahoo</span>(<span class="hl-literal">"cupcake"</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">s</span><span class="hl-combinator">&gt;</span> <span class="hl-site">cat</span>(<span class="hl-literal">"Yahoo: "</span>, <span class="hl-variable">s</span>)
</pre>
</p><p>
The sequential combinator may be written as F<code class="code"> <span class="hl-combinator">&gt;</span></code>P<code class="code"><span class="hl-combinator">&gt;</span> </code>G, 
where P is a pattern instead of just a variable name. Any value published by F is matched against the 
pattern P. If this match is successful, a new copy of G is started with all of the bindings from the match. 
Otherwise, the published value is simply ignored, and no new copy of G is executed.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish 3, 6, and 9 in arbitrary order.</span>
(<span class="hl-literal">3</span>,<span class="hl-literal">6</span>,<span class="hl-literal">9</span>)  <span class="hl-combinator">&gt;</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>,<span class="hl-variable">z</span>)<span class="hl-combinator">&gt;</span>  ( <span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-variable">y</span> <span class="hl-combinator">|</span> <span class="hl-variable">z</span> )
</pre>
</p><p>
<pre class="orc">
<span class="hl-comment">-- Filter out values of the form (_,false)</span>
( (<span class="hl-literal">4</span>,<span class="hl-literal">true</span>) <span class="hl-combinator">|</span> (<span class="hl-literal">5</span>,<span class="hl-literal">false</span>) <span class="hl-combinator">|</span> (<span class="hl-literal">6</span>,<span class="hl-literal">true</span>) )  <span class="hl-combinator">&gt;</span>(<span class="hl-variable">x</span>,<span class="hl-literal">true</span>)<span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>
<span class="hl-comment">-- Publishes 4 and 6 </span>
</pre>
</p><p>
We may also omit the variable entirely, writing <code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> </code>. This
is equivalent to using a wildcard pattern: <code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">_</span><span class="hl-combinator">&gt;</span> </code>
</p><p>
We may want to execute an expression just for its effects, and hide all of its publications.
We can do this using <code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> </code> together with the special expression 
<code class="code"><span class="hl-keyword">stop</span></code>, which is always silent.  
</p><p>
<pre class="orc">
<span class="hl-comment">{- 
  Print two strings to the console,
  but don't publish the return values of the calls.
-}</span>
( <span class="hl-site">println</span>(<span class="hl-literal">"goodbye"</span>) <span class="hl-combinator">|</span> <span class="hl-site">println</span>(<span class="hl-literal">"world"</span>) ) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
</pre>
</p><p>
The sequential combinator is right associative: F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> </code>H
is equivalent to F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (</code>G<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> </code>H<code class="code">)</code>. It has higher
precedence than the parallel combinator: F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G <code class="code"><span class="hl-combinator">|</span></code> H is equivalent to
<code class="code">(</code>F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G <code class="code">) <span class="hl-combinator">|</span></code> H.
</p><p>
The right associativity of the sequential combinator makes it easy to bind variables in sequence and use
them together.
</p><p>
<pre class="orc">
<span class="hl-comment">{- 
  Publish the cross product of {1,2} and {3,4}:
  (1,3), (1,4), (2,3), and (2,4).
-}</span>
(<span class="hl-literal">1</span> <span class="hl-combinator">|</span> <span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">4</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10833"></a>1.3.2.3.&nbsp;The pruning combinator</h4></div></div></div><p>
The pruning combinator, written F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G, allows us to block 
a computation waiting for a result, or terminate a computation. The execution of 
F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G starts by executing F and G in parallel. Whenever
F publishes a value, that value is published by the entire execution. When G publishes
its first value, that value is bound to x in F, and then the execution of G is immediately 
<em class="firstterm">terminated</em>. A terminated expression cannot call any sites or 
publish any values.
</p><p>
During the execution of F, any part of the execution that depends on <code class="code"><span class="hl-variable">x</span></code> 
will be suspended until <code class="code"><span class="hl-variable">x</span></code> is bound (to the first value published by G). If G
never publishes a value, that part of the execution is suspended forever. 
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish either 5 or 6, but not both</span>
<span class="hl-variable">x</span>+<span class="hl-literal">2</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> (<span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">4</span>)
</pre>
</p><p>
<pre class="programlisting">
<span class="hl-comment">-- Query Google and Yahoo for a search result</span>
<span class="hl-comment">-- Print out the result that arrives first; ignore the other result</span>
<span class="hl-site">println</span>(<span class="hl-variable">result</span>) <span class="hl-combinator">&lt;</span><span class="hl-variable">result</span><span class="hl-combinator">&lt;</span> ( <span class="hl-site">Google</span>(<span class="hl-literal">"cupcake"</span>) <span class="hl-combinator">|</span> <span class="hl-site">Yahoo</span>(<span class="hl-literal">"cupcake"</span>) )
</pre>
</p><p>
Though a terminated execution may not make any new calls, the calls
that it has already made will continue normally; their responses are simply
ignored. This may have surprising consequences when a call has side effects,
as in the following example.

<pre class="orc">
<span class="hl-comment">{- 
  This example actually prints both "true" and "false" to the
  console, regardless of which call responds first.
-}</span>
<span class="hl-keyword">stop</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"true"</span>) <span class="hl-combinator">|</span> <span class="hl-site">println</span>(<span class="hl-literal">"false"</span>)
</pre>

Both of the <code class="code"><span class="hl-variable">println</span></code> calls are initiated before either one of
them publishes a value and terminates the expression. Once the expression
is terminated, no new calls occur, but the other <code class="code"><span class="hl-variable">println</span></code> call
still proceeds and still has the effect of printing its message to the
console.
</p><p>
The pruning combinator may include a full pattern P instead of just a variable name. Any
value published by G is matched against the pattern P. If this match is successful, then G
terminates and all of the bindings of the pattern P are made in F. Otherwise, the published 
value is simply ignored and G continues to execute.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish either 9 or 25, but not 16.</span>
<span class="hl-variable">x</span>*<span class="hl-variable">x</span> <span class="hl-combinator">&lt;</span>(<span class="hl-variable">x</span>,<span class="hl-literal">true</span>)<span class="hl-combinator">&lt;</span> ( (<span class="hl-literal">3</span>,<span class="hl-literal">true</span>) <span class="hl-combinator">|</span> (<span class="hl-literal">4</span>,<span class="hl-literal">false</span>) <span class="hl-combinator">|</span> (<span class="hl-literal">5</span>,<span class="hl-literal">true</span>) )
</pre>
</p><p>
Note that even if <code class="code">(<span class="hl-literal">4</span>,<span class="hl-literal">false</span>)</code> is published before <code class="code">(<span class="hl-literal">3</span>,<span class="hl-literal">true</span>)</code> or <code class="code">(<span class="hl-literal">5</span>,<span class="hl-literal">true</span>)</code>, 
it is ignored. The right side continues to execute and will publish one of <code class="code">(<span class="hl-literal">3</span>,<span class="hl-literal">true</span>)</code> or 
<code class="code">(<span class="hl-literal">5</span>,<span class="hl-literal">true</span>)</code>.
</p><p>
The pruning combinator is left associative: F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">y</span><span class="hl-combinator">&lt;</span> </code>H
is equivalent to <code class="code">(</code>F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G<code class="code">) <span class="hl-combinator">&lt;</span><span class="hl-variable">y</span><span class="hl-combinator">&lt;</span> </code>H. It has lower
precedence than the parallel combinator: F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G <code class="code"><span class="hl-combinator">|</span></code> H is equivalent to
F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> (</code>G <code class="code"><span class="hl-combinator">|</span></code> H<code class="code">)</code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="combinator.otherwise"></a>1.3.2.4.&nbsp;The otherwise combinator</h4></div></div></div><p>
Orc has a fourth concurrency combinator: the <em class="firstterm">otherwise</em> combinator,
written F<code class="code"> <span class="hl-combinator">;</span> </code>G. The execution of F<code class="code"> <span class="hl-combinator">;</span> </code> G proceeds as follows.
First, F is executed. If F <em class="firstterm">completes</em>, and has not published any values, 
then G executes. If F did publish one or more values, then G is ignored. The publications of 
F <code class="code"><span class="hl-combinator">;</span></code> G are those of F if F publishes, or those of G otherwise.
</p><p>
We determine when an expression completes using the following rules.

<div class="itemizedlist"><ul type="disc"><li>A Cor expression completes when it is fully evaluated; if it is silent, it completes immediately.</li><li>A site call completes when it has published a value or halted.</li><li>F <code class="code"><span class="hl-combinator">|</span></code> G completes when its subexpressions F and G have both completed.</li><li>F<code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code>G completes when F has completed and all instantiated copies of G have completed.</li><li>F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G completes when F has completed, and G has either completed or
published a value. Also, if G completes without publishing a value, then all expressions in F which
use <code class="code"><span class="hl-variable">x</span></code> also complete, since they will never be able to proceed.</li><li>F <code class="code"><span class="hl-combinator">;</span></code> G completes either when F has published a value and subsequently completed,
or when F and G have both completed.</li><li><code class="code"><span class="hl-keyword">stop</span></code> completes immediately.</li></ul></div>

</p><p>
The otherwise combinator is fully associative, so F <code class="code"><span class="hl-combinator">;</span></code> G <code class="code"><span class="hl-combinator">;</span></code> H and
(F <code class="code"><span class="hl-combinator">;</span></code> G) <code class="code"><span class="hl-combinator">;</span></code> H and F <code class="code"><span class="hl-combinator">;</span></code> (G <code class="code"><span class="hl-combinator">;</span></code> H) are
all equivalent. It has lower precedence than the other three combinators. 
</p><p>
The otherwise combinator was not present in the original formulation of the Orc concurrency 
calculus; it has been added to support computation and iteration over strictly finite data. 
Sequential programs conflate the concept of producing a value with the concept of completion. 
Orc separates these two concepts; variable binding combinators like <code class="code"> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> </code> 
and <code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code> handle values, whereas <code class="code"><span class="hl-combinator">;</span></code> detects the completion 
of an execution.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N108F0"></a>1.3.3.&nbsp;Revisiting Cor expressions</h3></div></div></div><p>
Some Cor expressions have new behaviors in the context of Orc, due to the introduction
of concurrency and of sites.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N108F5"></a>1.3.3.1.&nbsp;Operators</h4></div></div></div><p>
The arithmetic, logical, and comparison operators are actually calls to sites, simply
written in infix style with the expected operator symbols. For example, <code class="code"><span class="hl-literal">2</span>+<span class="hl-literal">3</span></code>
is actually <code class="code">(+)(<span class="hl-literal">2</span>,<span class="hl-literal">3</span>)</code>, where <code class="code">(+)</code> is a primitive site provided
by the language itself. All of the operators can be used directly as sites in this way;
the name of the site is the operator enclosed by parentheses, e.g. <code class="code">(**)</code>,
<code class="code">(<span class="hl-site">&gt;=</span>)</code>, etc. Negation (unary minus) is named <code class="code">(<span class="hl-literal">0</span>-)</code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1090C"></a>1.3.3.2.&nbsp;Conditionals</h4></div></div></div><p>
The conditional expression <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> F <code class="code"><span class="hl-keyword">else</span></code> G
is actually a derived form based on a site named <code class="code"><span class="hl-keyword">if</span></code>. The <code class="code"><span class="hl-keyword">if</span></code>
site takes a boolean argument; it returns a signal if that argument is <code class="code"><span class="hl-literal">true</span></code>,
or remains silent if the argument is <code class="code"><span class="hl-literal">false</span></code>.
</p><p>
<code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> F <code class="code"><span class="hl-keyword">else</span></code> G is equivalent 
to <code class="code">( <span class="hl-keyword">if</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> </code>F<code class="code"> <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(~<span class="hl-variable">b</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> </code>G<code class="code">) <span class="hl-combinator">&lt;</span><span class="hl-variable">b</span><span class="hl-combinator">&lt;</span> </code>E.
</p><p>
 When the <code class="code"><span class="hl-keyword">else</span></code> branch of a conditional is unneeded, we can write <code class="code"><span class="hl-keyword">if</span></code> F <code class="code"><span class="hl-keyword">then</span></code> G,
 with no <code class="code"><span class="hl-keyword">else</span></code> branch. This is equivalent to <code class="code"><span class="hl-keyword">if</span>(</code>E<code class="code">) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> </code>F.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1094E"></a>1.3.3.3.&nbsp;
                        <code class="code"><span class="hl-keyword">val</span></code>
                    </h4></div></div></div><p>
The declaration <code class="code"><span class="hl-keyword">val</span> <span class="hl-variable">x</span> = </code>G, followed by expression F, is 
actually just a different way of writing the expression F<code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code>G.
Thus, <code class="code"><span class="hl-keyword">val</span></code> shares all of the behavior of the pruning combinator,
which we have already described. (This is also true when a pattern is used instead
of variable name <code class="code"><span class="hl-variable">x</span></code>).
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10962"></a>1.3.3.4.&nbsp;Nesting Orc expressions</h4></div></div></div><p>
The execution of an Orc expression may publish many values. What does such an expression 
mean in a context where only one value is expected? For example, what does <code class="code"><span class="hl-literal">2</span> + (<span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">4</span>)</code> 
publish? 
</p><p>
The specific contexts in which we are interested are as follows (where E is any Orc expression):

<div class="informaltable"><a name="value-context-table"></a><table border="0" width="40%"><colgroup><col align="left"><col align="right"></colgroup><tbody><tr><td align="left">E <span class="emphasis"><em>op</em></span> E</td><td align="right">
                                    <span class="emphasis"><em>operand</em></span>
                                    </td></tr><tr><td align="left">
                                    <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> ...</td><td align="right">
                                    <span class="emphasis"><em>conditional test</em></span>
                                    </td></tr><tr><td align="left">X<code class="code">(</code> ... <code class="code">,</code> E <code class="code">,</code> ... <code class="code">)</code>
                                    </td><td align="right">
                                    <span class="emphasis"><em>call argument</em></span>
                                    </td></tr><tr><td align="left">
                                    <code class="code">(</code> ... <code class="code">,</code> E <code class="code">,</code> ... <code class="code">)</code>
                                    </td><td align="right">
                                    <span class="emphasis"><em>tuple element</em></span>
                                    </td></tr><tr><td align="left">
                                    <code class="code">[</code> ... <code class="code">,</code> E <code class="code">,</code> ... <code class="code">]</code>
                                    </td><td align="right">
                                    <span class="emphasis"><em>list element</em></span>

                                    </td></tr></tbody></table></div>
</p><p>
Whenever an Orc expression appears in such a context, it executes until it publishes its first value, 
and then it is terminated. The published value is used in the context as if it were the result of evaluating
the expression.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish either 5 or 6</span>
<span class="hl-literal">2</span> + (<span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">4</span>)
</pre>
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish exactly one of 0, 1, 2 or 3</span>
(<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-literal">2</span>) + (<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-literal">1</span>)
</pre>
</p><p>
To be precise, whenever an Orc expression appears in such a context, it is treated as if it was 
on the right side of a pruning combinator, using a fresh variable name to fill in the hole. 
Thus, C[E] (where E is the Orc expression and C is the context) is equivalent to the expression 
C[<code class="code"><span class="hl-variable">x</span></code>] <code class="code"> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> </code> E. 
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N109EB"></a>1.3.3.5.&nbsp;Functions</h4></div></div></div><p>
The body of a function in Orc may be any Orc expression; thus, function
bodies in Orc are executed rather than evaluated, and may engage in communication
and publish multiple values.
</p><p>
A function call in Orc, as in Cor, binds the values of its actual parameters
to its formal parameters, and then executes the function body with those bindings.
Whenever the function body publishes a value, the function call publishes that
value. Thus, unlike a site call, or a pure functional Cor call, an Orc function
call may publish many values.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Publish all integers in the interval 1..n, in arbitrary order. </span>
<span class="hl-keyword">def</span> <span class="hl-site">range</span>(<span class="hl-variable">n</span>) = <span class="hl-keyword">if</span> (<span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span>) <span class="hl-keyword">then</span> (<span class="hl-variable">n</span> <span class="hl-combinator">|</span> <span class="hl-site">range</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)) <span class="hl-keyword">else</span> <span class="hl-keyword">stop</span> 

<span class="hl-comment">-- Publish 1, 2, and 3 in arbitrary order.</span>
<span class="hl-site">range</span>(<span class="hl-literal">3</span>)
</pre>
</p><p>
In the context of Orc, function calls are not strict. When a function call executes,
it begins to execute the function body immediately, and also executes the argument
expressions in parallel. When an argument expression publishes a value, it is terminated,
and the corresponding formal parameter is bound to that value in the execution of
the function body. Any part of the function body which uses a formal parameter
that has not yet been bound suspends until that parameter is bound to a value.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N109FA"></a>1.3.4.&nbsp;Time</h3></div></div></div><p>
Orc is designed to communicate with the external world, and one of the
most important characteristics of the external world is the passage of
time. Orc implicitly interacts with the passage of time by calling external
services which take time to respond. However, Orc can also explicitly
wait for some amount of time, using the special site <code class="code"><span class="hl-variable">Rtimer</span></code>. 
</p><p>
The site <code class="code"><span class="hl-variable">Rtimer</span></code> is a relative timer. It takes as an argument
a number of milliseconds to wait. It waits for exactly that amount of time,
and then responds with a signal.
</p><p>
<pre class="orc">
<span class="hl-comment">-- Print "red", wait for 3 seconds (3000 ms), and then print "green" </span>
<span class="hl-site">println</span>(<span class="hl-literal">"red"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">3000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"green"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
</pre>
</p><p>
The following example defines a metronome, which publishes a signal once 
every <code class="code"><span class="hl-variable">t</span></code> milliseconds, indefinitely.
</p><p>
<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">metronome</span>(<span class="hl-variable">t</span>) = <span class="hl-keyword">signal</span> <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">metronome</span>(<span class="hl-variable">t</span>)
</pre>
</p><p>
We can also use <code class="code"><span class="hl-variable">Rtimer</span></code> together with the pruning combinator 
to enforce a timeout.
</p><p>
<pre class="programlisting">
<span class="hl-comment">{-
  Publish the result of a Google search.
  If it takes more than 5 seconds, time out.
-}</span>
<span class="hl-variable">result</span> 
  <span class="hl-combinator">&lt;</span><span class="hl-variable">result</span><span class="hl-combinator">&lt;</span> ( <span class="hl-site">Google</span>(<span class="hl-literal">"impatience"</span>) 
           <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">5000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Search timed out."</span>)
</pre>
</p>



We present many more examples of programming techniques using real time in <a class="link" href="#chapter.methodology" title="Chapter&nbsp;2.&nbsp;Programming Methodology">Chapter 2</a>.

</div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N10A26"></a>1.4.&nbsp;Advanced Features of Orc</h2></div></div></div><p>
In this section we introduce some advanced features of Orc. These include curried
function definitions and curried calls, writing an arbitrary expression as the
target of a call, a special syntax for writing calls in an object-oriented style, 
extensions to pattern matching, and new forms of declarations, and ML-style
datatypes.
</p><p>
<div class="table"><a name="advanced-ebnf-table"></a><p class="title"><b>Table&nbsp;1.4.&nbsp;Advanced Syntax of Orc</b></p><div class="table-contents"><table summary="Advanced Syntax of Orc" border="0" width="80%"><colgroup><col align="right"><col align="center"><col align="left"><col align="left"><col align="left"></colgroup><tbody><tr><td align="right">E</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Expression</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E G+</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>generalized call</em></span>
                                </td></tr><tr><td align="right">G</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Argument group</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left"> <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code> </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>curried arguments</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left"> <code class="code">.</code>
                                    <span class="emphasis"><em>field</em></span> </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>field access</em></span>
                                </td></tr><tr><td align="right">P</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Pattern</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">P <code class="code"><span class="hl-keyword">as</span></code> X</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>as pattern</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">=</code>X</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>equality pattern</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X<code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>datatype pattern</em></span>
                                </td></tr><tr><td align="right">D</td><td align="center">::=</td><td align="left"> ... </td><td align="left">
                                    <span class="emphasis"><em>Declaration</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">class</span></code> X <code class="code">=</code> <span class="emphasis"><em>classname</em></span>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>class declaration</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">type</span></code> X <code class="code">=</code> DT <code class="code"><span class="hl-combinator">|</span></code> ... <code class="code"><span class="hl-combinator">|</span></code> DT</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>datatype declaration</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">include</span></code> <code class="code"><span class="hl-literal">"</span></code> <span class="emphasis"><em>filename</em></span> <code class="code"><span class="hl-literal">"</span></code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>inclusion</em></span>
                                </td></tr><tr><td align="right">DT</td><td align="center">::=</td><td align="left"> X<code class="code">(<span class="hl-variable">_</span>,</code> ... <code class="code">,<span class="hl-variable">_</span>)</code> </td><td align="left">
                                    <span class="emphasis"><em>Datatype</em></span>
                                </td><td align="left">&nbsp;</td></tr></tbody></table></div></div><br class="table-break">
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10B4A"></a>1.4.1.&nbsp;Special call forms</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10B4D"></a>1.4.1.1.&nbsp;The <code class="code">.</code> notation</h4></div></div></div><p>
In many object-oriented programming languages, one calls a method or accesses a field of an
object using the dot operator; for example, <code class="code"><span class="hl-variable">obj</span>.<span class="hl-site">m</span>()</code> calls the method
<code class="code"><span class="hl-variable">m</span></code> of the object <code class="code"><span class="hl-variable">obj</span></code>. 
</p><p>
There is a special kind of site call in Orc which serves a similar purpose. One may write
<code class="code"><span class="hl-variable">x</span>.<span class="hl-variable">msg</span></code>, for any identifiers <code class="code"><span class="hl-variable">x</span></code> and <code class="code"><span class="hl-variable">msg</span></code>. This treats
 the value bound to <code class="code"><span class="hl-variable">x</span></code> as a site, and calls it with a special 
<em class="firstterm">message</em> value <code class="code"><span class="hl-variable">msg</span></code>. 
If the site understands the message <code class="code"><span class="hl-variable">msg</span></code> (for example, if <code class="code"><span class="hl-variable">x</span></code> is 
bound to a Java object with a field called <code class="code"><span class="hl-variable">msg</span></code>), the site interprets the message 
and responds with some appropriate value. If the site does not 
understand the message sent to it, it does not respond, and no publication occurs. 
If <code class="code"><span class="hl-variable">x</span></code> cannot be interpreted as a site, no call is made. 
</p><p>
Typically this capability is used so that sites may be syntactically treated like objects, 
with multiple methods and fields. For example, a channel <code class="code"><span class="hl-variable">c</span></code> might understand the messages
<code class="code"><span class="hl-variable">get</span></code> and <code class="code"><span class="hl-variable">put</span></code>, to get values from and put values on that channel,
respectively. Such calls would be written <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">get</span>()</code>, or <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">6</span>)</code>.
</p><p>
A call such as <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">6</span>)</code> actually occurs in two steps. First <code class="code"><span class="hl-variable">c</span>.<span class="hl-variable">put</span></code> sends the message
<code class="code"><span class="hl-variable">put</span></code> to the site <code class="code"><span class="hl-variable">c</span></code>; this publishes a site whose only purpose
is to put values on the channel. Next, that site is called on the argument
<code class="code"><span class="hl-literal">6</span></code>, sending 6 on the channel. Readers familiar with functional programming
will recognize this technique as <span class="emphasis"><em>currying</em></span>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10BA3"></a>1.4.1.2.&nbsp;Currying</h4></div></div></div><p>
It is sometimes useful to <span class="emphasis"><em>stage</em></span> the arguments to a function; that is,
rather than writing a function on two arguments, one instead writes a function on one
argument which returns a function taking the second argument and performing the remainder
of the evaluation. 
</p><p>
This technique is known as <span class="emphasis"><em>currying</em></span> and it is common in functional
programming languages. We can write curried functions using <a class="link" href="#cor.closures" title="1.2.7.2.&nbsp;Closures">closures</a>. Suppose we want to 
define a curried addition function on two arguments, and later apply that function to the 
arguments 3 and 4. We could write such a program in the following way:

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">Sum</span>(<span class="hl-variable">a</span>) = ( <span class="hl-keyword">lambda</span>(<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>+<span class="hl-variable">b</span> )  
<span class="hl-keyword">val</span> <span class="hl-variable">f</span> = <span class="hl-site">Sum</span>(<span class="hl-literal">3</span>)
<span class="hl-site">f</span>(<span class="hl-literal">4</span>)
</pre>

This defines a function <code class="code"><span class="hl-variable">Sum</span></code> which, given an argument <code class="code"><span class="hl-variable">a</span></code>, creates a function
which will take an argument <code class="code"><span class="hl-variable">b</span></code> and add <code class="code"><span class="hl-variable">a</span></code> to <code class="code"><span class="hl-variable">b</span></code>. It then creates the
function which adds <code class="code"><span class="hl-literal">3</span></code> to its argument, binds that to <code class="code"><span class="hl-variable">f</span></code>, and then invokes
<code class="code"><span class="hl-variable">f</span></code> on <code class="code"><span class="hl-literal">4</span></code> to yield <code class="code"><span class="hl-literal">3</span>+<span class="hl-literal">4</span></code>.

</p><p>
When defining a curried function, we have abstracted it in two steps, and when
applying it we have written two separate calls. However, this is verbose and
not very clear. Orc has a special syntax for curried function definitions and curried 
applications that will simplify both of these steps. Function definitions may have multiple 
argument sequences; they are enclosed in parentheses and concatenated. Curried function calls 
chain together multiple applications in a similar way. Here is the previous program, written 
in this simplified syntax:

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">Sum</span>(<span class="hl-variable">a</span>)(<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>+<span class="hl-variable">b</span>
<span class="hl-site">Sum</span>(<span class="hl-literal">3</span>)(<span class="hl-literal">4</span>)
</pre>

Naturally, this syntax is backwards compatible; e.g. both of the following programs are also
equivalent:  

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">Sum</span>(<span class="hl-variable">a</span>) = ( <span class="hl-keyword">lambda</span>(<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>+<span class="hl-variable">b</span> )  
<span class="hl-site">Sum</span>(<span class="hl-literal">3</span>)(<span class="hl-literal">4</span>)
</pre>

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">Sum</span>(<span class="hl-variable">a</span>)(<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>+<span class="hl-variable">b</span>  
<span class="hl-keyword">val</span> <span class="hl-variable">f</span> = <span class="hl-site">Sum</span>(<span class="hl-literal">3</span>)
<span class="hl-site">f</span>(<span class="hl-literal">4</span>)
</pre>

</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
Clauses of a function may be defined with both curried arguments and patterns in arguments.
However, the combination of these two features can produce unintuitive behavior. Consider
the following clausal, curried function definition:

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">x</span>)(<span class="hl-literal">0</span>) = <span class="hl-variable">x</span>
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">x</span>)(<span class="hl-variable">y</span>) = <span class="hl-variable">x</span> + <span class="hl-variable">y</span>
<span class="hl-site">sum</span>(<span class="hl-literal">2</span>)(<span class="hl-literal">3</span>)
</pre>

One might expect <code class="code"><span class="hl-site">sum</span>(<span class="hl-literal">2</span>)(<span class="hl-literal">3</span>)</code> to evaluate to <code class="code"><span class="hl-literal">5</span></code>. However, this is not
the case; instead <code class="code"><span class="hl-site">sum</span>(<span class="hl-literal">2</span>)(<span class="hl-literal">3</span>)</code> remains silent due to a pattern matching failure.
This is because the compiler always expands curried definitions before considering patterns,
so the above program is in fact equivalent to:

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">x</span>) = ( <span class="hl-keyword">lambda</span>(<span class="hl-literal">0</span>) = <span class="hl-variable">x</span> )
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">x</span>) = ( <span class="hl-keyword">lambda</span>(<span class="hl-variable">y</span>) = <span class="hl-variable">x</span> + <span class="hl-variable">y</span> )
<span class="hl-site">sum</span>(<span class="hl-literal">2</span>)(<span class="hl-literal">3</span>)
</pre>

Now the problem becomes apparent. The first clause will always match when the function is
applied to its first argument, and then only one clause is available when the second
argument is available: the clause with succeeds only on <code class="code"><span class="hl-literal">0</span></code>.
</p><p>
Therefore, use caution when writing function definitions that use both currying and clauses.
</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10BFD"></a>1.4.2.&nbsp;Extensions to pattern matching</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10C00"></a>1.4.2.1.&nbsp;As pattern</h4></div></div></div><p>
In taking apart a value with a pattern, it is often useful to capture intermediate results.

<pre class="programlisting">
<span class="hl-keyword">val</span> (<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = ((<span class="hl-literal">1</span>,<span class="hl-literal">2</span>),(<span class="hl-literal">3</span>,<span class="hl-literal">4</span>))
<span class="hl-keyword">val</span> (<span class="hl-variable">ax</span>,<span class="hl-variable">ay</span>) = <span class="hl-variable">a</span>
<span class="hl-keyword">val</span> (<span class="hl-variable">bx</span>,<span class="hl-variable">by</span>) = <span class="hl-variable">b</span>
</pre>

We can use the <code class="code"><span class="hl-keyword">as</span></code> keyword to simplify this program fragment, giving a name to an entire
sub-pattern. Here is an equivalent version of the above code.

<pre class="programlisting">
<span class="hl-keyword">val</span> ((<span class="hl-variable">ax</span>,<span class="hl-variable">ay</span>) <span class="hl-keyword">as</span> <span class="hl-variable">a</span>, (<span class="hl-variable">bx</span>,<span class="hl-variable">by</span>) <span class="hl-keyword">as</span> <span class="hl-variable">b</span>) = ((<span class="hl-literal">1</span>,<span class="hl-literal">2</span>),(<span class="hl-literal">3</span>,<span class="hl-literal">4</span>))
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10C0E"></a>1.4.2.2.&nbsp;Equality pattern</h4></div></div></div><p>
When a variable occurs in a pattern, it is bound to the value being matched against that pattern. What
if instead we would like to use the value of a bound variable as a test pattern, in a way similar to
a literal value like <code class="code"><span class="hl-literal">0</span></code>? 
</p><p>
We can use an equality pattern to do this. An equality pattern is a variable name preceded by <code class="code">=</code>.
Consider the following definition, which compares its argument to the value bound to variable <code class="code"><span class="hl-variable">x</span></code>,
returning <code class="code"><span class="hl-literal">true</span></code> if they are equal and <code class="code"><span class="hl-literal">false</span></code> otherwise.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">isx</span>(=<span class="hl-variable">x</span>) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">isx</span>(<span class="hl-variable">_</span>) = <span class="hl-literal">false</span>
</pre>

</p><p>
The equality pattern becomes much more useful when it is embedded within other patterns. For example, consider
this definition <code class="code"><span class="hl-variable">withz</span></code>. If one of the arguments passed to it is equal to <code class="code"><span class="hl-variable">z</span></code>, then the function
returns its other argument. Otherwise it remains silent.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">withz</span>(=<span class="hl-variable">z</span>,<span class="hl-variable">y</span>) = <span class="hl-variable">y</span>
<span class="hl-keyword">def</span> <span class="hl-site">withz</span>(<span class="hl-variable">x</span>,=<span class="hl-variable">z</span>) = <span class="hl-variable">x</span>
</pre>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="section.orc.datatypes"></a>1.4.3.&nbsp;Datatypes</h3></div></div></div><p>
We have seen Orc's predefined data structures: tuples and lists. Orc also provides the capability
for programmers to define their own data structures, using a feature adopted from the ML/Haskell
language family called <em class="firstterm">datatypes</em> (also called variants or tagged sums).
</p><p>
Datatypes are defined using the <code class="code"><span class="hl-keyword">type</span></code> declaration:

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-variable">Tree</span> = <span class="hl-site">Node</span>(<span class="hl-variable">_</span>,<span class="hl-variable">_</span>,<span class="hl-variable">_</span>) <span class="hl-combinator">|</span> <span class="hl-site">Empty</span>()
</pre>

</p><p>
This declaration defines two new sites named <code class="code"><span class="hl-variable">Node</span></code> and <code class="code"><span class="hl-variable">Empty</span></code>.
<code class="code"><span class="hl-variable">Node</span></code> takes three arguments, and publishes a <span class="emphasis"><em>tagged value</em></span>
wrapping those arguments. <code class="code"><span class="hl-variable">Empty</span></code> takes no arguments and does the same.
</p><p>
Once we have created these tagged values, we use a new pattern called a datatype pattern
to match them and unwrap the arguments:

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-variable">Tree</span> = <span class="hl-site">Node</span>(<span class="hl-variable">_</span>,<span class="hl-variable">_</span>,<span class="hl-variable">_</span>) <span class="hl-combinator">|</span> <span class="hl-site">Empty</span>()
<span class="hl-comment">{- Build up a small binary tree -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">l</span> = <span class="hl-site">Node</span>(<span class="hl-site">Empty</span>(), <span class="hl-literal">0</span>, <span class="hl-site">Empty</span>())
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Node</span>(<span class="hl-site">Empty</span>(), <span class="hl-literal">2</span>, <span class="hl-site">Empty</span>())
<span class="hl-keyword">val</span> <span class="hl-variable">t</span> = <span class="hl-site">Node</span>(<span class="hl-variable">l</span>,<span class="hl-literal">1</span>,<span class="hl-variable">r</span>)

<span class="hl-comment">{- And then match it to extract its contents -}</span>
<span class="hl-variable">t</span> <span class="hl-combinator">&gt;</span><span class="hl-site">Node</span>(<span class="hl-variable">l</span>,<span class="hl-variable">j</span>,<span class="hl-variable">r</span>)<span class="hl-combinator">&gt;</span>
<span class="hl-variable">l</span> <span class="hl-combinator">&gt;</span><span class="hl-site">Node</span>(<span class="hl-variable">_</span>,<span class="hl-variable">i</span>,<span class="hl-variable">_</span>)<span class="hl-combinator">&gt;</span>
<span class="hl-variable">r</span> <span class="hl-combinator">&gt;</span><span class="hl-site">Node</span>(<span class="hl-variable">_</span>,<span class="hl-variable">k</span>,<span class="hl-variable">_</span>)<span class="hl-combinator">&gt;</span>
( <span class="hl-variable">i</span> <span class="hl-combinator">|</span> <span class="hl-variable">j</span> <span class="hl-combinator">|</span> <span class="hl-variable">k</span> )
</pre>
</p><p>
One pair of datatypes is so commonly used that it is already predefined in the standard library:
<code class="code"><span class="hl-site">Some</span>(<span class="hl-variable">_</span>)</code> and <code class="code"><span class="hl-site">None</span>()</code>. These are used as return values for calls that
need to distinguish between successfully returning a value (<code class="code"><span class="hl-site">Some</span>(<span class="hl-variable">v</span>)</code>), and successfully
completing but having no meaningful value to return (<code class="code"><span class="hl-site">None</span>()</code>). For example, a lookup
function might return <code class="code"><span class="hl-site">Some</span>(<span class="hl-variable">result</span>)</code> if it found a result, or return <code class="code"><span class="hl-site">None</span>()</code>
if it successfully performed the lookup but found no suitable result.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10C6D"></a>1.4.4.&nbsp;New forms of declarations</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="section.orc.class"></a>1.4.4.1.&nbsp;

                        <code class="code"><span class="hl-keyword">class</span></code> declaration</h4></div></div></div><p>
When Orc is run on top of an object-oriented programming language, classes
from that language may be used as sites in Orc itself, via the <code class="code"><span class="hl-keyword">class</span></code>
declaration. 
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- Use the String class from Java's standard library as a site -}</span>
<span class="hl-keyword">class</span> <span class="hl-variable">String</span> = <span class="hl-variable">java</span>.<span class="hl-variable">lang</span>.<span class="hl-variable">String</span>
<span class="hl-keyword">val</span> <span class="hl-variable">s</span> = <span class="hl-site">String</span>(<span class="hl-literal">"foo"</span>)
<span class="hl-variable">s</span>.<span class="hl-site">concat</span>(<span class="hl-literal">"bar"</span>)
</pre>
</p><p>
This program binds the variable <code class="code"><span class="hl-variable">String</span></code> to Java's String class.
When it is called as a site, it constructs a new instance of String, passing
the given arguments to the constructor.
</p><p>
This instance of String is a Java object; its methods are called and its fields
are accessed using the dot (<code class="code">.</code>) notation, just as one would expect
in Java.  For complete details of how Orc interacts with Java, see
<a class="link" href="#section.services.java" title="3.2.&nbsp; class Sites">Java Integration</a>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10C8F"></a>1.4.4.2.&nbsp;
                        <code class="code"><span class="hl-keyword">include</span></code> declaration</h4></div></div></div><p>
It is often convenient to group related declarations into units that can be
shared between programs. The <code class="code"><span class="hl-keyword">include</span></code> declaration offers a simple
way to do this. It names a source file containing a sequence of Orc declarations;
those declarations are incorporated into the program as if they had textually
replaced the include declaration. An included file may itself contain 
<code class="code"><span class="hl-keyword">include</span></code> declarations. 
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- Contents of fold.inc -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,[],<span class="hl-variable">s</span>) = <span class="hl-variable">s</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-variable">h</span>:<span class="hl-variable">t</span>,<span class="hl-variable">s</span>) = <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-variable">t</span>,<span class="hl-site">f</span>(<span class="hl-variable">h</span>,<span class="hl-variable">s</span>))

<span class="hl-keyword">def</span> <span class="hl-site">foldr</span>(<span class="hl-variable">f</span>,<span class="hl-variable">l</span>,<span class="hl-variable">s</span>) = <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-site">rev</span>(<span class="hl-variable">l</span>),<span class="hl-variable">s</span>)
</pre>
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- This is the same as inserting the contents of fold.inc here -}</span>
<span class="hl-keyword">include</span> <span class="hl-literal">"fold.inc"</span>

<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">L</span>) = <span class="hl-site">foldl</span>(<span class="hl-keyword">lambda</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>+<span class="hl-variable">b</span>, <span class="hl-variable">L</span>, <span class="hl-literal">0</span>)

<span class="hl-site">sum</span>([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>])
</pre>
</p><p>
Note that these declarations still obey the rules of lexical scope. Also, Orc 
does not detect shared declarations; if the same file is included twice, its 
declarations occur twice.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10CA9"></a>1.4.4.3.&nbsp;

                        <code class="code"><span class="hl-variable">capsule</span></code> declaration</h4></div></div></div><p>
The concept of Object in computing refers to an entity which can encapsulate 
data and enables the manipulation of the data through some functions or methods. 
These objects are usually referred to as passive objects. This means that they 
do not have their own thread of control. Whenever a thread calls one of the 
object's methods it will activate the object and give the control to the object
 and as soon as it returns from the method call object will be deactivated.
</p><p>
Active objects are another form of object. Unlike passive objects, active 
objects have their own thread of control. They can initiate a computation 
without receiving a method call (in procedural languages) or a message 
(in languages with message passing model). Note that this definition of 
active objects subsumes reactive objects and actors.
</p><p>
Orc Capsules are the way to build active objects in Orc. A subset of Orc 
language is called Cor which is an ML like functional language. Programmers 
can specify the computation in terms of expressions in Cor. Cor does not 
have any notion of object. A computation entity is a function that is 
defined by def keyword. There is no encapsulation. It is all function definition.
</p><p>
Let us motivate the problem by an example. Suppose you want to have a sequence 
number generator. The normal way to do that in a functional language is to 
define a mutable variable and a function to increase and return the sequence 
number every time we call it. The following shows the code for this sequence 
number generator in Orc. 			
<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">seq_num</span> = <span class="hl-site">Ref</span>(<span class="hl-literal">0</span>)
<span class="hl-keyword">def</span> <span class="hl-site">gen_seq</span>() =
  <span class="hl-variable">seq_num</span><span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">seq_num</span> <span class="hl-site">:=</span> <span class="hl-variable">seq_num</span><span class="hl-site">?</span>+<span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>
  
<span class="hl-site">gen_seq</span>() <span class="hl-combinator">|</span> <span class="hl-site">gen_seq</span>()
</pre>
</p><p>
What is the problem with the above code? The first problem is that the 
seq_num is exposed to all the expressions which come after it. This 
means that all those expressions can possibly read and write the 
value of seq_num. This is not always desirable. The second issue 
with this code is that it is not flexible enough. What if we want 
to have different sequence number generator different initial seed? 
For example, we may want a sequence number starting at 0 and another 
one starting at 1000. The third issue is activeness. We need something 
that gives us the power to create services. We need computational entities 
that have state and retain in the environment and can not only respond to 
events but also can create events and spawns activities.
</p><p>
Orc capsules enables us to address all the above issues. The idea is to 
turn a definition (def) which contains a number of internal definitions 
and defined values into a Site such that the execution of this site is 
protected from the rest of the program. It also requires that the internal 
functions definitions can be called on the site just like method calls 
on the objects. 
</p><p>
For example it is desirable to have the following interface for the above 
defined sequence number generator. 
<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">sequence_generator1</span> = <span class="hl-site">gen_seq</span>(<span class="hl-literal">0</span>)
<span class="hl-keyword">val</span> <span class="hl-variable">sequence_generator2</span> = <span class="hl-site">gen_seq</span>(<span class="hl-literal">1000</span>)

<span class="hl-variable">sequence_generator1</span>.<span class="hl-site">next</span>() <span class="hl-combinator">|</span> <span class="hl-variable">sequence_generator2</span>.<span class="hl-site">next</span>() 
</pre>
As the above example suggests we don't want to expose the sequence number 
generator seed.
</p><p>
Orc capsules provides this facility for programmer to define active objects 
in Orc. The following part will illustrate the use of capsules with a couple 
of examples. Further on, we explain how do we implement capsules in Orc. 
</p><p>
Here is an example of defining a capsule and its usage. 
<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-variable">capsule</span> <span class="hl-site">channel</span>() = 
  <span class="hl-keyword">val</span> <span class="hl-variable">ch</span> = <span class="hl-site">Buffer</span>[<span class="hl-variable">Integer</span>]()
  <span class="hl-keyword">val</span> <span class="hl-variable">chlen</span> = <span class="hl-site">Ref</span>[<span class="hl-variable">Integer</span>](<span class="hl-literal">0</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">s</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">_</span> = <span class="hl-site">Rtimer</span>(<span class="hl-literal">3000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"time up in channel!"</span>)
  <span class="hl-keyword">def</span> <span class="hl-site">put</span>(<span class="hl-variable">x</span> :: <span class="hl-variable">Integer</span>) = 
    <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">ch</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">chlen</span> <span class="hl-site">:=</span> <span class="hl-variable">chlen</span><span class="hl-site">?</span>+<span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">get</span>() =
    <span class="hl-variable">ch</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
    <span class="hl-variable">chlen</span><span class="hl-site">:=</span> <span class="hl-variable">chlen</span><span class="hl-site">?</span>-<span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>  <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>  
  <span class="hl-keyword">def</span> <span class="hl-site">len</span>() = 
    <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">chlen</span><span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">n</span>  
  <span class="hl-keyword">signal</span>

<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">channel</span>()

<span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">2000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-variable">c</span>.<span class="hl-site">len</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
<span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-variable">c</span>.<span class="hl-site">len</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> 
</pre>
</p><p>
As can be seen in the above code, defining a capsule is very similar to 
defining a normal function. However, there is a fundamental difference between 
them. Capsules does not publish values upon their call. Instead, they publish a 
site. The published site exposes all the internal definitions of the capsule. 
One can imagine calling of the capsule as calling the constructor of an object.
</p><p>
The interesting point about the above example is that the creation and 
existence of the capsule is protected from the rest of program execution. 
Notice the line:
</p><p>
<pre class="programlisting">
  <span class="hl-keyword">val</span> <span class="hl-variable">_</span> = <span class="hl-site">Rtimer</span>(<span class="hl-literal">3000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"time up in channel!"</span>)
</pre>
</p><p>
This line of the code is supposed to print the string "time up in channel!" 
after 3 seconds into the console. The creation of the capsule returns 
immediately. However, since the capsule is protected by a Site, it continues 
to execute.
</p><p>
Note that the goal expression of the capsule definition is designated to just 
initialize the capsule and not publishing any values. 
</p></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="chapter.methodology"></a>Chapter&nbsp;2.&nbsp;Programming Methodology</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#N10CE1">2.1. Syntactic and Stylistic Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#N10CE6">2.1.1. Parallel combinator</a></span></dt><dt><span class="section"><a href="#N10D22">2.1.2. Sequential combinator</a></span></dt><dt><span class="section"><a href="#style.pruning">2.1.3. Pruning combinator</a></span></dt><dt><span class="section"><a href="#N10DD5">2.1.4. Declarations</a></span></dt></dl></dd><dt><span class="section"><a href="#N10E0E">2.2. Programming Idioms</a></span></dt><dd><dl><dt><span class="section"><a href="#N10E13">2.2.1. Channels</a></span></dt><dt><span class="section"><a href="#N10E5A">2.2.2. Lists</a></span></dt><dt><span class="section"><a href="#methodology.streams">2.2.3. Streams</a></span></dt><dt><span class="section"><a href="#N10EA6">2.2.4. Mutable References</a></span></dt><dt><span class="section"><a href="#N10F70">2.2.5. Loops</a></span></dt><dt><span class="section"><a href="#N10F89">2.2.6. Parallel Matching</a></span></dt><dt><span class="section"><a href="#N10FC6">2.2.7. Fork-join</a></span></dt><dt><span class="section"><a href="#N11053">2.2.8. Sequential Fork-Join</a></span></dt><dt><span class="section"><a href="#N1106E">2.2.9. Priority Poll</a></span></dt><dt><span class="section"><a href="#N11091">2.2.10. Parallel Or</a></span></dt><dt><span class="section"><a href="#N110CE">2.2.11. Timeout</a></span></dt><dt><span class="section"><a href="#N11178">2.2.12. Priority</a></span></dt><dt><span class="section"><a href="#N11188">2.2.13. Metronome</a></span></dt><dt><span class="section"><a href="#N1119E">2.2.14. Routing</a></span></dt><dt><span class="section"><a href="#N1124A">2.2.15. Interruption</a></span></dt><dt><span class="section"><a href="#N1127C">2.2.16. Lifting</a></span></dt><dt><span class="section"><a href="#N1128D">2.2.17. Fold</a></span></dt></dl></dd><dt><span class="section"><a href="#N112E5">2.3. Larger Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#N112ED">2.3.1. Dining Philosophers</a></span></dt><dt><span class="section"><a href="#methodology.examples.hygenic">2.3.2. Hygienic Dining Philosophers</a></span></dt><dt><span class="section"><a href="#N11384">2.3.3. Readers-Writers</a></span></dt><dt><span class="section"><a href="#N113B2">2.3.4. Quicksort</a></span></dt><dt><span class="section"><a href="#N11411">2.3.5. Meeting Scheduler</a></span></dt></dl></dd></dl></div><p>
In <a class="link" href="#chapter.language" title="Chapter&nbsp;1.&nbsp;The Orc Programming Language">Chapter 1</a>, we described the syntax and semantics of the Orc language. 
Now, we turn our attention to how the language is used in practice, with guidelines on style and programming 
methodology, including a number of common concurrency patterns.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N10CE1"></a>2.1.&nbsp;Syntactic and Stylistic Conventions</h2></div></div></div><p>
In this section we suggest some syntactic conventions for writing Orc programs. None of these 
conventions are required by the parser; newlines are used only to disambiguate certain corner
cases in parsing, and other whitespace is ignored. However, following programming convention 
helps to improve the readability of programs, so that the programmer's intent is more readily apparent.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10CE6"></a>2.1.1.&nbsp;Parallel combinator</h3></div></div></div><p>
When the combined expressions are small, write them all on one line.

<pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>G</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>H</strong></span>
</pre>

Note that we do not need parentheses here, since <code class="code"><span class="hl-combinator">|</span></code> is fully associative and commutative.
</p><p>
When the combined expressions are large enough to take up a full line, write one expression
per line, with each subsequent expression aligned with the first and preceded by <code class="code"><span class="hl-combinator">|</span></code>. 
Indent the first expression to improve readability.

<pre class="programlisting">
  <span class="bold"><strong>long expression</strong></span> 
<span class="hl-combinator">|</span> <span class="bold"><strong>long expression</strong></span>
<span class="hl-combinator">|</span> <span class="bold"><strong>long expression</strong></span>
</pre>
 
</p><p>
A sequence of parallel expressions often form the left hand side of a sequential combinator. 
Since the sequential combinator has higher precedence, use parentheses to group the
combined parallel expressions together. 


<pre class="programlisting">
( <span class="bold"><strong>expression</strong></span> 
<span class="hl-combinator">|</span> <span class="bold"><strong>expression</strong></span>
) <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> 
<span class="bold"><strong>another expression</strong></span>
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10D22"></a>2.1.2.&nbsp;Sequential combinator</h3></div></div></div><p>
When the combined expressions are small, write a cascade of sequential combinators
all on the same line.
</p><pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="bold"><strong>G</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> <span class="bold"><strong>H</strong></span>
</pre><p>
Remember that sequential is right associative; in this example, <code class="code"><span class="hl-variable">x</span></code> is bound in both G and H, and <code class="code"><span class="hl-variable">y</span></code> is
bound in H.
</p><p>
When the combined expressions are large enough to take up a full line, write one expression
per line; each line ends with the combinator which binds the publications
produced by that line.

<pre class="programlisting">
<span class="bold"><strong>long expression</strong></span>  <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>  
<span class="bold"><strong>long expression</strong></span>  <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> 
<span class="bold"><strong>long expression</strong></span>
</pre>
 
</p><p>
For very long-running expressions, or expressions that span multiple lines, write
the combinators on separate lines, indented, between each expression. 

<pre class="programlisting">
<span class="bold"><strong>very long expression</strong></span> 
  <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>  
<span class="bold"><strong>very long expression</strong></span> 
  <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> 
<span class="bold"><strong>very long expression</strong></span>
</pre>
 
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="style.pruning"></a>2.1.3.&nbsp;Pruning combinator</h3></div></div></div><p>
When the combined expressions are small, write them on the same line:

<pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="bold"><strong>G</strong></span>
</pre>

When multiple pruning combinators are used to bind multiple variables
(especially when the scoped expression is long), start each line with a 
combinator, aligned and indented, and continue with the expression.

<pre class="programlisting">
<span class="bold"><strong>long expression</strong></span> 
  <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="bold"><strong>G</strong></span>
  <span class="hl-combinator">&lt;</span><span class="hl-variable">y</span><span class="hl-combinator">&lt;</span> <span class="bold"><strong>H</strong></span>
</pre>

</p><p>
The pruning combinator is not often written in its explicit form
in Orc programs. Instead, the <code class="code"><span class="hl-keyword">val</span></code> declaration is often more
convenient, since it is semantically equivalent and mentions the variable
<code class="code"><span class="hl-variable">x</span></code> before its use in scope, rather than after.

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="bold"><strong>G</strong></span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="bold"><strong>H</strong></span>
<span class="bold"><strong>long expression</strong></span> 
</pre>

</p><p>
Additionally, when the variable is used in only one place, and the
expression is small, it is often easier to use a nested expression.
For example,

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="bold"><strong>G</strong></span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="bold"><strong>H</strong></span>
<span class="hl-site">M</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
</pre>

is equivalent to

<pre class="programlisting">
<span class="hl-site">M</span>(<span class="bold"><strong>G</strong></span>,<span class="bold"><strong>H</strong></span>)
</pre>

</p><p>
Sometimes, we use the pruning combinator simply for its capability to terminate
expressions and get a single publication; binding a variable is irrelevant. This
is a special case of nested expressions. We use the identity site <code class="code"><span class="hl-variable">let</span></code>
to put the expression in the context of a function call.
</p><p>
For example,

<pre class="programlisting">
<span class="hl-variable">x</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>G</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>H</strong></span>
</pre>

is equivalent to

<pre class="programlisting">
<span class="hl-site">let</span>(<span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>G</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>H</strong></span>)
</pre>
</p><p>
The translation uses a pruning combinator, but we don't need to write the combinator, 
name an irrelevant variable, or worry about precedence (since the expression is enclosed
in parentheses as part of the call).
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10DD5"></a>2.1.4.&nbsp;Declarations</h3></div></div></div><p>
Declarations should always end with a newline. 

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">add</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-variable">x</span> + <span class="hl-variable">y</span>
<span class="hl-keyword">val</span> <span class="hl-variable">z</span> = <span class="hl-literal">7</span>
<span class="hl-site">add</span>(<span class="hl-variable">z</span>,<span class="hl-variable">z</span>)
</pre>

While the parser does not require a newline to end a declaration, it uses the 
newline to disambiguate certain corner cases in parsing, such as function application.
</p><p>
When the body of a declaration spans multiple lines, start the body on a new line
after the <code class="code">=</code> symbol, and indent the entire body.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) =
    <span class="bold"><strong>declaration</strong></span>
    <span class="bold"><strong>declaration</strong></span>
    <span class="bold"><strong>body expression</strong></span>
</pre>

</p><p>
Apply this style recursively; if a def appears within a def, indent its contents even further.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) =
    <span class="bold"><strong>declaration</strong></span>
    <span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">z</span>) =
    	<span class="bold"><strong>declaration in helper</strong></span>
    	<span class="bold"><strong>declaration in helper</strong></span>
    	<span class="bold"><strong>body of helper</strong></span>
    <span class="bold"><strong>declaration</strong></span>
    <span class="bold"><strong>body expression</strong></span>
</pre>


</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N10E0E"></a>2.2.&nbsp;Programming Idioms</h2></div></div></div><p>
In this section we give Orc implementations of some standard idioms from
concurrent and functional programming. Despite the austerity of Orc's four
combinators, we are able to encode a variety of idioms straightforwardly.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10E13"></a>2.2.1.&nbsp;Channels</h3></div></div></div><p>
Orc has no communication primitives like pi-calculus
channels<sup>[<a href="#ftn.N10E18" name="N10E18" class="footnote">1</a>]</sup> or Erlang mailboxes<sup>[<a href="#ftn.N10E1F" name="N10E1F" class="footnote">2</a>]</sup>. Instead, it makes use of sites
to create channels of communication. 
</p><p>
The most frequently used of these sites is <code class="code"><span class="hl-variable">Buffer</span></code>. When called, it
publishes a new asynchronous FIFO channel. That channel is a site with two
methods: <code class="code"><span class="hl-variable">get</span></code> and <code class="code"><span class="hl-variable">put</span></code>.  The call <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">get</span>()</code>
takes the first value from channel <code class="code"><span class="hl-variable">c</span></code> and publishes it, or blocks
waiting for a value if none is available. The call <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">v</span>)</code> puts
<code class="code"><span class="hl-variable">v</span></code> as the last item of <code class="code"><span class="hl-variable">c</span></code> and publishes a signal.
</p><p>
A channel may be closed to indicate that it will not be sent any more values.
If the channel <code class="code"><span class="hl-variable">c</span></code> is closed, <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">v</span>)</code> always halts
(without modifying the state of the channel), and <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">get</span>()</code> halts
once <code class="code"><span class="hl-variable">c</span></code> becomes empty. The channel <code class="code"><span class="hl-variable">c</span></code> may be closed by
calling either <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">close</span>()</code>, which returns a signal once
<code class="code"><span class="hl-variable">c</span></code> becomes empty, or <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</code>, which returns a
signal immediately.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10E5A"></a>2.2.2.&nbsp;Lists</h3></div></div></div><p>
In the section on Cor, we were introduced to lists: how to construct them,
and how to match them against patterns. While it is certainly feasible to
write a specific function with an appropriate pattern match every time we
want to access a list, it is helpful to have a handful of common operations
on lists and reuse them.
</p><p>
One of the most common uses for a list is to send each of its elements through
a sequential combinator. Since the list itself is a single value, we want
to walk through the list and publish each one of its elements in parallel
as a value. The library function <code class="code"><span class="hl-variable">each</span></code> does exactly that.
</p><p>
Suppose we want to send the message <code class="code"><span class="hl-variable">invite</span></code> to each email
address in the list <code class="code"><span class="hl-variable">inviteList</span></code>:

<pre class="programlisting">
<span class="hl-site">each</span>(<span class="hl-variable">inviteList</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">address</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Email</span>(<span class="hl-variable">address</span>, <span class="hl-variable">invite</span>)
</pre>

</p><p>
Orc also adopts many of the list idioms of functional programming. The Orc library contains definitions
for most of the standard list functions, such as <code class="code"><span class="hl-variable">map</span></code> and <code class="code"><span class="hl-variable">fold</span></code>. Many of the
list functions internally take advantage of concurrency to make use of any available parallelism; for
example, the <code class="code"><span class="hl-variable">map</span></code> function dispatches all of the mapped calls concurrently, and assembles
the result list once they all return using a fork-join.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="methodology.streams"></a>2.2.3.&nbsp;Streams</h3></div></div></div><p>
Sometimes a source of data is not explicitly represented by a list or other data structure. Instead,
it is made available through a site, which returns the values one at a time, each time it is called.
We call such a site a <em class="firstterm">stream</em>. It is analogous to an iterator in a language 
like Java. Functions can also be used as streams, though typically they will not be pure functions,
and should only return one value. A call to a stream may halt, to indicate that the end of the data
has been reached, and no more values will become available. It is often useful to detect the
end of a stream using the otherwise combinator. 
</p><p>
Streams are common enough in Orc programming that there is a library function to take all of the
available publications from a stream; it is called <code class="code"><span class="hl-variable">repeat</span></code>, and it is analogous to
<code class="code"><span class="hl-variable">each</span></code> for lists.
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">repeat</span>(<span class="hl-variable">f</span>) = <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">repeat</span>(<span class="hl-variable">f</span>))
</pre><p>
The <code class="code"><span class="hl-variable">repeat</span></code> function calls the site or function <code class="code"><span class="hl-variable">f</span></code> with no arguments,
publishes its return value, and recurses to query for more values. <code class="code"><span class="hl-variable">repeat</span></code> should
be used with sites or functions that block until a value is available. Notice that if any
call to <code class="code"><span class="hl-variable">f</span></code> halts, then <code class="code"><span class="hl-site">repeat</span>(<span class="hl-variable">f</span>)</code> consequently halts. 
</p><p>
For example, it is very easy to treat a channel <code class="code"><span class="hl-variable">c</span></code> as a stream, reading any 
values put on the channel as they become available:

<pre class="programlisting">
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>)
</pre>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10EA6"></a>2.2.4.&nbsp;Mutable References</h3></div></div></div><p>
Variables in Orc are immutable. There is no assignment operator, and there is no way to
change the value of a bound variable. However, it is often useful to have mutable state
when writing certain algorithms. The Orc library contains two sites that offer simple 
mutable storage: <code class="code"><span class="hl-variable">Ref</span></code> and <code class="code"><span class="hl-variable">Cell</span></code>. It also provides the site <code class="code"><span class="hl-variable">Array</span></code>
to create mutable arrays.
</p><p>
A word of caution: References, cells, and other mutable objects may be accessed concurrently
by many different parts of an Orc program, so race conditions may arise. 
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10EB6"></a>2.2.4.1.&nbsp;Rewritable references</h4></div></div></div><p>
The <code class="code"><span class="hl-variable">Ref</span></code> site creates rewritable reference cells.

<pre class="orc">
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Ref</span>(<span class="hl-literal">0</span>)
<span class="hl-site">println</span>(<span class="hl-variable">r</span>.<span class="hl-site">read</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
<span class="hl-site">println</span>(<span class="hl-variable">r</span>.<span class="hl-site">read</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-keyword">stop</span>
</pre>

</p><p>
These are very similar to ML's <code class="code"><span class="hl-variable">ref</span></code> cells. <code class="code"><span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-variable">v</span>)</code> stores
the value <code class="code"><span class="hl-variable">v</span></code> in the reference <code class="code"><span class="hl-variable">r</span></code>, overwriting any previous
value, and publishes a signal. <code class="code"><span class="hl-variable">r</span>.<span class="hl-site">read</span>()</code> publishes the current value stored
in <code class="code"><span class="hl-variable">r</span></code>.
</p><p>
However, unlike in ML, a reference cell can be left initially empty by calling <code class="code"><span class="hl-variable">Ref</span></code>
with no arguments. A read operation on an empty cell blocks until the cell is written.

<pre class="orc">
<span class="hl-comment">{- Create a cell, and wait 1 second before initializing it. -}</span>
<span class="hl-comment">{- The read operation blocks until the write occurs. -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Ref</span>()
<span class="hl-variable">r</span>.<span class="hl-site">read</span>() <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-literal">1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
</pre>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10EDF"></a>2.2.4.2.&nbsp;Write-once references</h4></div></div></div><p>
The Orc library also offers write-once reference cells, using the <code class="code"><span class="hl-variable">Cell</span></code> site.
A write-once cell has no initial value. Read operations block until the cell has been
written. A write operation succeeds only if the cell is empty; subsequent write operations
simply halt.

<pre class="orc">
<span class="hl-comment">{- Create a cell, try to write to it twice, and read it -}</span>
<span class="hl-comment">{- The read will block until a write occurs
   and only one write will succeed. -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Cell</span>()
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"Wrote 2"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-literal">3</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"Wrote 3"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-variable">r</span>.<span class="hl-site">read</span>()
</pre>

Write-once cells are very useful for concurrent programming, and they are often safer
than rewritable reference cells, since the value cannot be changed once it has been
written. The use of write-once cells for concurrent programming is not a new idea;
they have been studied extensively in the context of the 
<a class="link" href="http://en.wikipedia.org/wiki/Oz_programming_language" target="_top">Oz programming language</a>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10EEF"></a>2.2.4.3.&nbsp;Reference syntax</h4></div></div></div><p>Orc provides syntactic sugar for reading and writing mutable storage:</p><div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-variable">x</span><span class="hl-site">?</span></code> is equivalent to <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">read</span>()</code>. This operator
is of equal precedence with the dot operator and function application, so
you can write things like <code class="code"><span class="hl-variable">x</span>.<span class="hl-variable">y</span><span class="hl-site">?</span>.<span class="hl-variable">v</span><span class="hl-site">?</span></code>. This operator is very similar
to the C languages's <code class="code">*</code> operator, but is postfix instead of prefix.
	</li><li><code class="code"><span class="hl-variable">x</span> <span class="hl-site">:=</span> <span class="hl-variable">y</span></code> is equivalent to <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">write</span>(<span class="hl-variable">y</span>)</code>.
This operator has higher precedence than the concurrency combinators and if/then/else,
but lower precedence than any of the other operators.</li></ul></div><p>Here is a previous example rewritten using this syntactic sugar:</p><pre class="orc">
<span class="hl-comment">{- Create a cell, try to write to it twice, and read it -}</span>
<span class="hl-comment">{- The read will block until a write occurs
   and only one write will succeed. -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Cell</span>()
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span> <span class="hl-site">:=</span> <span class="hl-literal">2</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"Wrote 2"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span> <span class="hl-site">:=</span> <span class="hl-literal">3</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"Wrote 3"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-variable">r</span><span class="hl-site">?</span>
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10F0E"></a>2.2.4.4.&nbsp;Arrays</h4></div></div></div><p>
While lists are a very useful data structure, they are not mutable, and they are not indexed. However, 
these properties are often needed in practice, so the Orc standard library provides a function 
<code class="code"><span class="hl-variable">Array</span></code> to create mutable arrays. 
</p><p>
<code class="code"><span class="hl-site">Array</span>(<span class="hl-variable">n</span>)</code> creates an array of size <code class="code"><span class="hl-variable">n</span></code> whose elements are all initially <code class="code"><span class="hl-literal">null</span></code>. 
The array is used like a function; the call <code class="code"><span class="hl-site">A</span>(<span class="hl-variable">i</span>)</code> returns the <code class="code"><span class="hl-variable">i</span></code>th element of the array 
<code class="code"><span class="hl-variable">A</span></code>, which is then treated as a reference, just like the references created by <code class="code"><span class="hl-variable">Ref</span></code>. A call 
with an out-of-bounds index halts, possibly reporting an error. 
</p><p>

The following program creates an array of size 10, and initializes each index i with the
ith power of 2. It then reads the array values at indices 3, 6, and 10. The read at index 10
halts because it is out of bounds (arrays are indexed from 0).

<pre class="orc">
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">Array</span>(<span class="hl-literal">10</span>)
<span class="hl-keyword">def</span> <span class="hl-site">initialize</span>(<span class="hl-variable">i</span>) = 
  <span class="hl-keyword">if</span> (<span class="hl-variable">i</span> &lt; <span class="hl-literal">10</span>) 
    <span class="hl-keyword">then</span> <span class="hl-site">a</span>(<span class="hl-variable">i</span>) <span class="hl-site">:=</span> <span class="hl-literal">2</span> ** <span class="hl-variable">i</span>  <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>  <span class="hl-site">initialize</span>(<span class="hl-variable">i</span>+<span class="hl-literal">1</span>)
    <span class="hl-keyword">else</span> <span class="hl-keyword">signal</span>
<span class="hl-site">initialize</span>(<span class="hl-literal">0</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> (<span class="hl-site">a</span>(<span class="hl-literal">3</span>)<span class="hl-site">?</span> <span class="hl-combinator">|</span> <span class="hl-site">a</span>(<span class="hl-literal">6</span>)<span class="hl-site">?</span> <span class="hl-combinator">|</span> <span class="hl-site">a</span>(<span class="hl-literal">10</span>)<span class="hl-site">?</span>)

</pre>

</p><p>

The standard library also provides a helper function <code class="code"><span class="hl-variable">fillArray</span></code> which makes array initialization
easier. <code class="code"><span class="hl-site">fillArray</span>(<span class="hl-variable">a</span>, <span class="hl-variable">f</span>)</code> initializes array <code class="code"><span class="hl-variable">a</span></code> using function <code class="code"><span class="hl-variable">f</span></code> by setting
element <code class="code"><span class="hl-site">a</span>(<span class="hl-variable">i</span>)</code> to the first value published by <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">i</span>)</code>. When the array is fully
initialized, <code class="code"><span class="hl-variable">fillArray</span></code> returns the array <code class="code"><span class="hl-variable">a</span></code> that was passed (which makes it easier to
simultaneously create and initialize an array). Here are a few examples:

<pre class="orc">
<span class="hl-comment">{- Create an array of 10 elements; element i is the ith power of 2 -}</span>
<span class="hl-site">fillArray</span>(<span class="hl-site">Array</span>(<span class="hl-literal">10</span>), <span class="hl-keyword">lambda</span>(<span class="hl-variable">i</span>) = <span class="hl-literal">2</span> ** <span class="hl-variable">i</span>)
</pre>

<pre class="orc">
<span class="hl-comment">{- Create an array of 5 elements; each element is a newly created buffer -}</span>
<span class="hl-site">fillArray</span>(<span class="hl-site">Array</span>(<span class="hl-literal">5</span>), <span class="hl-keyword">lambda</span>(<span class="hl-variable">_</span>) = <span class="hl-site">Buffer</span>())
</pre>

<pre class="orc">
<span class="hl-comment">{- Create an array of 2 channels -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">A</span> = <span class="hl-site">fillArray</span>(<span class="hl-site">Array</span>(<span class="hl-literal">2</span>), <span class="hl-keyword">lambda</span>(<span class="hl-variable">_</span>) = <span class="hl-site">Buffer</span>())

<span class="hl-comment">{- 
   Send true on channel 0,
   listen for a value on channel 0 and forward it to channel 1, 
   and listen for a value on channel 1 and publish it. 
-}</span>
  <span class="hl-site">A</span>(<span class="hl-literal">0</span>)<span class="hl-site">?</span>.<span class="hl-site">put</span>(<span class="hl-literal">true</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">A</span>(<span class="hl-literal">0</span>)<span class="hl-site">?</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-site">A</span>(<span class="hl-literal">1</span>)<span class="hl-site">?</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">A</span>(<span class="hl-literal">1</span>)<span class="hl-site">?</span>.<span class="hl-site">get</span>()
</pre>
</p><p>
Since arrays are accessed by index, there is a library function specifically
designed to make programming with indices easier. The function <code class="code"><span class="hl-site">upto</span>(<span class="hl-variable">n</span>)</code> 
publishes all of the numbers from <code class="code"><span class="hl-literal">0</span></code> to
<code class="code"><span class="hl-variable">n</span>-<span class="hl-literal">1</span></code> simultaneously; thus, it is very easy to access all of the elements of
an array simultaneously. Suppose we have an array <code class="code"><span class="hl-variable">A</span></code> of <code class="code"><span class="hl-variable">n</span></code> email 
addresses and would like to send the message <code class="code"><span class="hl-variable">m</span></code> to each one.

<pre class="programlisting">
<span class="hl-site">upto</span>(<span class="hl-variable">n</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">i</span><span class="hl-combinator">&gt;</span> <span class="hl-site">A</span>(<span class="hl-variable">i</span>)<span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">address</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Email</span>(<span class="hl-variable">address</span>, <span class="hl-variable">m</span>)
</pre>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10F70"></a>2.2.5.&nbsp;Loops</h3></div></div></div><p>
Orc does not have any explicit looping constructs. Most of the time, where a loop
might be used in other languages, Orc programs use one of two strategies: 
</p><div class="orderedlist"><ol type="1"><li>When the iterations of the loops can occur in parallel, write an expression
that expands the data into a sequence of publications, and
use a sequential operator to do something for each publication. This is the strategy
that uses functions like <code class="code"><span class="hl-variable">each</span></code>, <code class="code"><span class="hl-variable">repeat</span></code>, and <code class="code"><span class="hl-variable">upto</span></code>.
</li><li>When the iterations of the loops must occur in sequence, write a tail
recursive function that iterates over the data. Any loop can be rewritten as a 
tail recursion. Typically the data of interest is in a list, so one of the standard
list functions, such as <code class="code"><span class="hl-variable">foldl</span></code>, applies. The library also defines a
function <code class="code"><span class="hl-variable">while</span></code>, which handles many of the common use cases of
while loops.
</li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10F89"></a>2.2.6.&nbsp;Parallel Matching</h3></div></div></div><p>
Matching a value against multiple patterns, as we have seen it so far, is a linear
process, and requires a <code class="code"><span class="hl-keyword">def</span></code> whose clauses have patterns in their
argument lists. Such a match is linear; each pattern is tried in order until
one succeeds.
</p><p>
What if we want to match a value against multiple patterns in parallel, executing
every clause that succeeds? Fortunately, this is very easy to do in Orc. Suppose
we have an expression F which publishes pairs of integers, and we want to publish
a signal for each 3 that occurs. 
</p><p>
We could write:

<pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)<span class="hl-combinator">&gt;</span>
  ( <span class="hl-keyword">if</span>(<span class="hl-variable">x</span>=<span class="hl-literal">3</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>
  <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-variable">y</span>=<span class="hl-literal">3</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span> ) 

</pre>

But there is a more general alternative:

<pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>
  ( <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>(<span class="hl-literal">3</span>,<span class="hl-variable">_</span>)<span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>
  <span class="hl-combinator">|</span> <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>(<span class="hl-variable">_</span>,<span class="hl-literal">3</span>)<span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span> ) 

</pre>

The interesting case is the pair <code class="code">(<span class="hl-literal">3</span>,<span class="hl-literal">3</span>)</code>, which is counted twice
because both patterns match it in parallel.
</p><p>
This parallel matching technique is sometimes used as an alternative to pattern matching using function
clauses, but only when the patterns are mutually exclusive.
</p><p>

For example,

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>([<span class="hl-variable">_</span>]) = <span class="hl-literal">1</span>
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">_</span>:<span class="hl-variable">_</span>:<span class="hl-variable">_</span>) = <span class="hl-literal">2</span>
<span class="hl-site">helper</span>([<span class="hl-literal">4</span>,<span class="hl-literal">6</span>])
</pre>

is equivalent to

<pre class="orc">
[<span class="hl-literal">4</span>,<span class="hl-literal">6</span>] <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>[]<span class="hl-combinator">&gt;</span> <span class="hl-literal">0</span>
<span class="hl-combinator">|</span> <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>[<span class="hl-variable">_</span>]<span class="hl-combinator">&gt;</span> <span class="hl-literal">1</span>
<span class="hl-combinator">|</span> <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">_</span>:<span class="hl-variable">_</span>:<span class="hl-variable">_</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">2</span>
</pre>

whereas

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>([<span class="hl-variable">_</span>]) = <span class="hl-literal">1</span>
<span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">_</span>) = <span class="hl-literal">2</span>
<span class="hl-site">helper</span>([<span class="hl-literal">5</span>])
</pre>

is <span class="emphasis"><em>not</em></span> equivalent to

<pre class="orc">
[<span class="hl-literal">5</span>] <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>[]<span class="hl-combinator">&gt;</span> <span class="hl-literal">0</span>
<span class="hl-combinator">|</span> <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span>[<span class="hl-variable">_</span>]<span class="hl-combinator">&gt;</span> <span class="hl-literal">1</span>
<span class="hl-combinator">|</span> <span class="hl-variable">x</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">_</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">2</span>
</pre>

because the clauses are not mutually exclusive. Function clauses must attempt to match in linear order, whereas
this expression matches all of the patterns in parallel. Here, it will match <code class="code">[<span class="hl-literal">5</span>]</code> two different ways,
publishing both <code class="code"><span class="hl-literal">1</span></code> and <code class="code"><span class="hl-literal">2</span></code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N10FC6"></a>2.2.7.&nbsp;Fork-join</h3></div></div></div><p>
One of the most common concurrent idioms is a <em class="firstterm">fork-join</em>: run two processes concurrently,
and wait for a result from each one. This is very easy to express in Orc. Whenever we write a <code class="code"><span class="hl-keyword">val</span></code>
declaration, the process computing that value runs in parallel with the rest of the program. So if we write
two <code class="code"><span class="hl-keyword">val</span></code> declarations, and then form a tuple of their results, this performs a fork-join.
</p><p>
<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="bold"><strong>F</strong></span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="bold"><strong>G</strong></span>
(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
</pre>
</p><p>
Fork-joins are a fundamental part of all Orc programs, since they are created by all nested expression
translations. In fact, the fork-join we wrote above could be expressed even more simply as just:
</p><p>
<pre class="programlisting">
(<span class="bold"><strong>F</strong></span>,<span class="bold"><strong>G</strong></span>)
</pre>
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N10FF0"></a>2.2.7.1.&nbsp;Example: Machine initialization</h4></div></div></div><p>
In Orc programs, we often use fork-join and recursion together to dispatch many tasks in parallel and wait
for all of them to complete. Suppose that given a machine <code class="code"><span class="hl-variable">m</span></code>, calling <code class="code"><span class="hl-variable">m</span>.<span class="hl-site">init</span>()</code> 
initializes <code class="code"><span class="hl-variable">m</span></code> and then publishes a signal when initialization is complete. The function 
<code class="code"><span class="hl-variable">initAll</span></code> initializes a list of machines.
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">initAll</span>([]) = <span class="hl-keyword">signal</span>
<span class="hl-keyword">def</span> <span class="hl-site">initAll</span>(<span class="hl-variable">m</span>:<span class="hl-variable">ms</span>) = ( <span class="hl-variable">m</span>.<span class="hl-site">init</span>() , <span class="hl-site">initAll</span>(<span class="hl-variable">ms</span>) ) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>
</pre><p>
For each machine, we fork-join the initialization of that machine (<code class="code"><span class="hl-variable">m</span>.<span class="hl-site">init</span>()</code>) with the initialization
of the remaining machines (<code class="code"><span class="hl-site">initAll</span>(<span class="hl-variable">ms</span>)</code>). Thus, all of the initializations proceed in parallel, and
the function returns a signal only when every machine in the list has completed its initialization. 
</p><p>
Note that if some machine fails to initialize, and does not return a signal, then the initialization procedure
will never complete. 
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="example.auction"></a>2.2.7.2.&nbsp;Example: Simple parallel auction</h4></div></div></div><p>
We can also use a recursive fork-join to obtain a value, rather than just signaling completion. Suppose we
have a list of bidders in a sealed-bid, single-round auction. Calling <code class="code"><span class="hl-variable">b</span>.<span class="hl-site">ask</span>()</code> requests a bid
from the bidder <code class="code"><span class="hl-variable">b</span></code>. We want to ask for one bid from each bidder, and then return the highest
bid. The function <code class="code"><span class="hl-variable">auction</span></code> performs such an auction for a list of bidders (<code class="code"><span class="hl-variable">max</span></code> 
finds the maximum of its arguments):
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">auction</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">auction</span>(<span class="hl-variable">b</span>:<span class="hl-variable">bs</span>) = <span class="hl-site">max</span>(<span class="hl-variable">b</span>.<span class="hl-site">ask</span>(), <span class="hl-site">auction</span>(<span class="hl-variable">bs</span>))
</pre></div><p>
Note that all bidders are called simultaneously. Also note that if some bidder fails 
to return a bid, then the auction will never complete.  Later we will see
a <a class="link" href="#example.auction-with-timeout" title="2.2.11.1.&nbsp;Auction with timeout">different solution</a> that addresses the issue of non-termination.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N11027"></a>2.2.7.3.&nbsp;Example: Barrier synchronization</h4></div></div></div><p>
Consider an expression of the following form, where F and G are expressions and M and N are sites:

<pre class="programlisting">
<span class="hl-site">M</span>()  <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>  <span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="hl-site">N</span>()  <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span>  <span class="bold"><strong>G</strong></span>
</pre>

</p><p>
Suppose we would like to <span class="emphasis"><em>synchronize</em></span> F and G, so that both start
executing at the same time, after both <code class="code"><span class="hl-site">M</span>()</code> and <code class="code"><span class="hl-site">N</span>()</code> respond.  This is easily done
using the fork-join idiom. In the following, we assume that <code class="code"><span class="hl-variable">x</span></code> does not occur
free in G, nor <code class="code"><span class="hl-variable">y</span></code> in F.

<pre class="programlisting">
( <span class="hl-site">M</span>() , <span class="hl-site">N</span>() )  <span class="hl-combinator">&gt;</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)<span class="hl-combinator">&gt;</span>  ( <span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="bold"><strong>G</strong></span> )
</pre>

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11053"></a>2.2.8.&nbsp;Sequential Fork-Join</h3></div></div></div><p>
Previous sections illustrate how Orc can use the fork-join idiom to process a
fixed set of expressions or a list of values.  Suppose that instead we wish to
process all the publications of an expression F, and once this processing is
complete, execute some expression G.  For example, F publishes the contents
of a text file, one line at a time, and we wish to print each line to the
console using the site <code class="code"><span class="hl-variable">println</span></code>, then publish a signal after all lines
have been printed.
</p><p>
Sequential composition alone is not sufficient, because we have no way to
detect when all of the lines have been processed.  A recursive fork-join
solution would require that the lines be stored in a traversable data structure
like a list, rather than streamed as publications from F.  A better solution
uses the <code class="code"><span class="hl-combinator">;</span></code> combinator to detect when processing is complete:
</p><pre class="programlisting">
<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">;</span> <span class="hl-keyword">signal</span>
</pre><p>
Since <code class="code"><span class="hl-combinator">;</span></code> only evaluates its right side if the left side does not publish,
we suppress the publications on the left side using <code class="code"><span class="hl-keyword">stop</span></code>. Here, we
assume that we can detect when F halts. If, for example,
F is publishing the lines of the file as it receives them over a socket,
and the sending party never closes the socket, then F never halts and no
signal is published.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1106E"></a>2.2.9.&nbsp;Priority Poll</h3></div></div></div><p>
The otherwise combinator is also useful for trying alternatives in sequence. Consider an expression of
the form <code class="code"><span class="hl-variable">F</span><sub>0</sub> <span class="hl-combinator">;</span> <span class="hl-variable">F</span><sub>1</sub> <span class="hl-combinator">;</span> <span class="hl-variable">F</span><sub>2</sub> <span class="hl-combinator">;</span> ...</code>. If F<sub>i</sub> does not publish 
and halts, then F<sub>i+1</sub> is executed. We can think of the F<sub>i</sub>'s as a series of 
alternatives that are explored until a publication occurs.
</p><p>
Suppose that we would like to poll a list of buffers for available data.  The
list of buffers is ordered by priority. The first buffer in the list has the
highest priority, so it is polled first.  If it has no data, then the
next buffer is polled, and so on.
</p><p>
Here is a function which polls a prioritized list of buffers in this way. It
publishes the first item that it finds, removing it from the originating
buffer. If all buffers are empty, the function halts.  We use the <code class="code"><span class="hl-variable">getnb</span></code> ("get non-blocking") method of the buffer, which retrieves the first
available item if there is one, and halts otherwise.
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">priorityPoll</span>([]) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">priorityPoll</span>(<span class="hl-variable">b</span>:<span class="hl-variable">bs</span>) = <span class="hl-variable">b</span>.<span class="hl-site">getnb</span>() <span class="hl-combinator">;</span> <span class="hl-site">priorityPoll</span>(<span class="hl-variable">bs</span>)
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11091"></a>2.2.10.&nbsp;Parallel Or</h3></div></div></div><p>
``Parallel or'' is a classic idiom of parallel programming.  The ``parallel or'' operation executes two
expressions F and G in parallel, each of which may publish a single boolean,
and returns the disjunction of their publications as soon as possible. 
If one of the expressions publishes <code class="code"><span class="hl-literal">true</span></code>, then the disjunction is <code class="code"><span class="hl-literal">true</span></code>, 
so it is not necessary to wait for the other expression to publish a value. 
This holds even if one of the expressions is silent.
</p><p>
The ``parallel or'' of expressions F and G may be expressed in Orc as
follows:
</p><pre class="programlisting">
<span class="hl-site">let</span>(
    <span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="bold"><strong>F</strong></span>
    <span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="bold"><strong>G</strong></span>

      (<span class="hl-variable">a</span> <span class="hl-site">||</span> <span class="hl-variable">b</span>)
    <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-variable">a</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> 
    <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> 
)
</pre><p>
The expression <code class="code">(<span class="hl-variable">a</span> <span class="hl-site">||</span> <span class="hl-variable">b</span>)</code> waits for both <code class="code"><span class="hl-variable">a</span></code> and <code class="code"><span class="hl-variable">b</span></code> to become
available and then publishes their disjunction.  However if either <code class="code"><span class="hl-variable">a</span></code> or
<code class="code"><span class="hl-variable">b</span></code> is true we can publish <code class="code"><span class="hl-literal">true</span></code> immediately regardless of whether the
other variable is available.  Therefore we run <code class="code"><span class="hl-keyword">if</span>(<span class="hl-variable">a</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span></code> and <code class="code"><span class="hl-keyword">if</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span></code>
in parallel to wait for either variable to become <code class="code"><span class="hl-literal">true</span></code> and immediately
publish the result <code class="code"><span class="hl-literal">true</span></code>.  Since more than one of these expressions may
publish <code class="code"><span class="hl-literal">true</span></code>, the surrounding <code class="code"><span class="hl-site">let</span>(...)</code> is necessary to select and
publish only the first result.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N110CE"></a>2.2.11.&nbsp;Timeout</h3></div></div></div><p>
<em class="firstterm">Timeout</em>, the ability to execute an expression for at most a specified
amount of time, is an essential ingredient of fault-tolerant and distributed
programming.  Orc accomplishes timeout using pruning and the <code class="code"><span class="hl-variable">Rtimer</span></code> site.
The following program runs F for at most one second, publishing its result if
available and the value <code class="code"><span class="hl-literal">0</span></code> otherwise.
</p><pre class="programlisting">
<span class="hl-site">let</span>( <span class="bold"><strong>F</strong></span> <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">0</span> )
</pre><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="example.auction-with-timeout"></a>2.2.11.1.&nbsp;Auction with timeout</h4></div></div></div><p>
In the <a class="link" href="#example.auction" title="2.2.7.2.&nbsp;Example: Simple parallel auction">auction example</a> given previously, the auction may never complete if 
one of the bidders does not respond. We can add a timeout so that a bidder has at most 8 seconds to provide a bid:
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">auction</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">auction</span>(<span class="hl-variable">b</span>:<span class="hl-variable">bs</span>) = 
  <span class="hl-keyword">val</span> <span class="hl-variable">bid</span> = <span class="hl-variable">b</span>.<span class="hl-site">ask</span>() <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">8000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">0</span>
  <span class="hl-site">max</span>(<span class="hl-variable">bid</span>, <span class="hl-site">auction</span>(<span class="hl-variable">bs</span>))
</pre><p>
This version of the auction is guaranteed to complete within 8 seconds.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N110F0"></a>2.2.11.2.&nbsp;Detecting timeout</h4></div></div></div><p>
Sometimes, rather than just yielding a default value, we would like to
determine whether an expression has timed out, and if so, perform some other
computation.  To detect the timeout, we pair the result of the original
expression with <code class="code"><span class="hl-literal">true</span></code> and the result of the timer with <code class="code"><span class="hl-literal">false</span></code>.
Thus, if the expression does time out, then we can distinguish that case
using the boolean value.
</p><p>
Here, we run expression F with a time limit <code class="code"><span class="hl-variable">t</span></code>. If it publishes
within the time limit, we bind its result to <code class="code"><span class="hl-variable">r</span></code> and execute G.
Otherwise, we execute H.

<pre class="programlisting">
<span class="hl-keyword">val</span> (<span class="hl-variable">r</span>, <span class="hl-variable">b</span>) = (<span class="bold"><strong>F</strong></span>, <span class="hl-literal">true</span>) <span class="hl-combinator">|</span> (<span class="hl-site">Rtimer</span>(<span class="hl-variable">t</span>), <span class="hl-literal">false</span>)
<span class="hl-keyword">if</span> <span class="hl-variable">b</span> <span class="hl-keyword">then</span> <span class="bold"><strong>G</strong></span> <span class="hl-keyword">else</span> <span class="bold"><strong>H</strong></span>
</pre>

Instead of using a boolean and conditional, we could use pattern matching:

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">s</span> = <span class="hl-site">Some</span>(<span class="bold"><strong>F</strong></span>) <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">None</span>()
  <span class="hl-variable">s</span> <span class="hl-combinator">&gt;</span><span class="hl-site">Some</span>(<span class="hl-variable">r</span>)<span class="hl-combinator">&gt;</span> <span class="bold"><strong>G</strong></span>
<span class="hl-combinator">|</span> <span class="hl-variable">s</span> <span class="hl-combinator">&gt;</span><span class="hl-site">None</span>()<span class="hl-combinator">&gt;</span>  <span class="bold"><strong>H</strong></span>
</pre>

</p><p>

It is even possible to encapsulate timeout as a function.

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">timeout</span>(<span class="hl-variable">x</span>, <span class="hl-variable">t</span>) = <span class="hl-site">let</span>(<span class="hl-site">Some</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">None</span>())
</pre>

<code class="code"><span class="hl-site">timeout</span>(<span class="bold"><strong>F</strong></span>, <span class="hl-variable">t</span>)</code> waits 
<code class="code"><span class="hl-variable">t</span></code> milliseconds for F to publish a value. If F publishes <code class="code"><span class="hl-variable">v</span></code> within
the time limit, <code class="code"><span class="hl-variable">timeout</span></code> returns <code class="code"><span class="hl-site">Some</span>(<span class="hl-variable">v</span>)</code>. Otherwise, it returns
<code class="code"><span class="hl-site">None</span>()</code> when the time limit is reached.

</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="N1113C"></a>2.2.11.2.1.&nbsp;Timeout streams</h5></div></div></div><p>
We can also apply timeout to <a class="link" href="#methodology.streams" title="2.2.3.&nbsp;Streams">streams</a>. Let's
define a modified version of the <code class="code"><span class="hl-variable">repeat</span></code> function as follows:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">repeatWithTimeout</span>(<span class="hl-variable">f</span>, <span class="hl-variable">t</span>) = 
  <span class="hl-site">timeout</span>(<span class="hl-site">f</span>(), <span class="hl-variable">t</span>) 
    <span class="hl-combinator">&gt;</span><span class="hl-site">Some</span>(<span class="hl-variable">x</span>)<span class="hl-combinator">&gt;</span> 
  (<span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">repeatWithTimeout</span>(<span class="hl-variable">f</span>, <span class="hl-variable">t</span>))

</pre>
</p><p>
We call <code class="code"><span class="hl-site">f</span>()</code> as before, but apply a timeout of <code class="code"><span class="hl-variable">t</span></code> to the call.
If a value becomes available from <code class="code"><span class="hl-variable">f</span></code> before the timeout, then the call to
<code class="code"><span class="hl-variable">timeout</span></code> publishes <code class="code"><span class="hl-site">Some</span>(<span class="hl-variable">x</span>)</code>, which we match, and then publish
<code class="code"><span class="hl-variable">x</span></code> and recursively wait for further values from the stream.
</p><p>
However, if no value is available from <code class="code"><span class="hl-variable">f</span></code> within the timeout, the call 
to <code class="code"><span class="hl-variable">timeout</span></code> publishes <code class="code"><span class="hl-site">None</span>()</code>. Since <code class="code"><span class="hl-site">None</span>()</code> does 
not match the pattern, the entire expression halts, indicating that the end of the
stream has been reached.
</p><p>
It is also possible to achieve this behavior with the existing <code class="code"><span class="hl-variable">repeat</span></code> function,
simply by changing the function passed to <code class="code"><span class="hl-variable">repeat</span></code>:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-variable">f</span>'() = <span class="hl-site">timeout</span>(<span class="hl-site">f</span>(), <span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-site">Some</span>(<span class="hl-variable">x</span>)<span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>
<span class="hl-site">repeat</span>(<span class="hl-variable">f</span>')
</pre>

</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11178"></a>2.2.12.&nbsp;Priority</h3></div></div></div><p>
We can use a timer to give a window of priority to one computation over
another.  In this example, we run expressions F and G concurrently.  For
one second, F has priority; F's result is published immediately,
but G's result is held until the time interval has elapsed.  If neither F nor
G publishes a result within one second, then the first result from either
is published.

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">x</span> = <span class="bold"><strong>F</strong></span>
<span class="hl-keyword">val</span> <span class="hl-variable">y</span> = <span class="bold"><strong>G</strong></span>
<span class="hl-site">let</span>( <span class="hl-variable">y</span> <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span> )
</pre>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11188"></a>2.2.13.&nbsp;Metronome</h3></div></div></div><p>
A timer can be used to execute an expression repeatedly at regular
intervals, for example to poll a service.
Recall the definition of <code class="code"><span class="hl-variable">metronome</span></code> from the previous chapter:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">metronome</span>(<span class="hl-variable">t</span>) = <span class="hl-keyword">signal</span> <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">metronome</span>()
</pre>
</p><p>
The following example publishes "tick" once per second and "tock" once per
second after an initial half-second delay.  The publications alternate: "tick
tock tick tock ...". Note that this program is not defined recursively;
the recursion is entirely contained within <code class="code"><span class="hl-variable">metronome</span></code>.
</p><p>
<pre class="orc">
  <span class="hl-site">metronome</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"tick"</span>
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">500</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">metronome</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"tock"</span>
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1119E"></a>2.2.14.&nbsp;Routing</h3></div></div></div><p>
The Orc combinators restrict the passing of values among their component
expressions. However, some programs will require greater
flexibility.  For example, <code class="code"><span class="hl-variable">F</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="hl-variable">G</span></code> provides F with the first 
publication of G, but what if F needs the first n publications of G?  
In cases like this we use channels or other stateful sites to redirect or 
store publications.  We call this technique <em class="firstterm">routing</em>
because it involves routing values from one execution to another.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N111A9"></a>2.2.14.1.&nbsp;Generalizing Termination</h4></div></div></div><p>
The pruning combinator terminates an expression after it publishes its first
value. We have <a class="link" href="#style.pruning" title="2.1.3.&nbsp;Pruning combinator">already seen</a> how to use 
pruning just for its termination capability, without binding a variable, using 
the <code class="code"><span class="hl-variable">let</span></code> site. Now, we use routing to terminate an expression
under different conditions, not just when it publishes a value; it may
publish many values, or none, before being terminated.
</p><p>
Our implementation strategy is to route the publications of the expression
through a channel, so that we can put the expression inside a pruning combinator
and still see its publications without those publications terminating the
expression. 
</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="N111B7"></a>2.2.14.1.1.&nbsp;Enhanced Timeout</h5></div></div></div><p>
As a simple demonstration of this concept, we construct a more powerful form 
of timeout: allow an expression to execute, publishing arbitrarily many values 
(not just one), until a time limit is reached.
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>) <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> 
    <span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> 
  <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</pre><p>
This program allows F to execute for one second and then terminates it. Each
value published by F is routed through channel <code class="code"><span class="hl-variable">c</span></code> so that it does
not terminate F. After one second, <code class="code"><span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>)</code> responds,
triggering the call <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</code>.  The call
<code class="code"><span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</code> closes <code class="code"><span class="hl-variable">c</span></code> and publishes a signal,
terminating F.  The library function <code class="code"><span class="hl-variable">repeat</span></code> is used to repeatedly
take and publish values from <code class="code"><span class="hl-variable">c</span></code> until it is closed.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="N111D9"></a>2.2.14.1.2.&nbsp;Test Pruning</h5></div></div></div><p>
We can also decide to terminate based on the values published. This expression
executes F until it publishes a negative number, and then terminates it:
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>) <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> 
  <span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> 
    (<span class="hl-keyword">if</span> <span class="hl-variable">x</span> <span class="hl-site">&gt;=</span> <span class="hl-literal">0</span> 
        <span class="hl-keyword">then</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
        <span class="hl-keyword">else</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>())
</pre><p>
Each value published by F is tested. If it is non-negative, it is placed on
channel <code class="code"><span class="hl-variable">c</span></code> (silently) and read by <code class="code"><span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>)</code>. 
If it is negative, the channel is closed, publishing a signal and causing
the termination of F.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="N111EC"></a>2.2.14.1.3.&nbsp;Interrupt</h5></div></div></div><p>
We can use routing to interrupt an expression based on a signal from
elsewhere in the program.  We set up the expression like a timeout, but instead
of waiting for a timer, we wait for the semaphore <code class="code"><span class="hl-variable">done</span></code> to be released. Any
call to <code class="code"><span class="hl-variable">done</span>.<span class="hl-variable">release</span></code> will terminate the expression (because it will
cause <code class="code"><span class="hl-variable">done</span>.<span class="hl-site">acquire</span>()</code> to publish), but otherwise F executes as normal and
may publish any number of values.
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
<span class="hl-keyword">val</span> <span class="hl-variable">done</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>)
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>) <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span>
    <span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
  <span class="hl-combinator">|</span> <span class="hl-variable">done</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="N11200"></a>2.2.14.1.4.&nbsp;Publication Limit</h5></div></div></div><p>
We can limit an expression to <span class="emphasis"><em>n</em></span> publications,
rather than just one. Here is an expression which executes F until
it publishes 5 values, and then terminates it.
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
<span class="hl-keyword">val</span> <span class="hl-variable">done</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>)
<span class="hl-keyword">def</span> <span class="hl-site">allow</span>(<span class="hl-literal">0</span>) = <span class="hl-variable">done</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">allow</span>(<span class="hl-variable">n</span>) = <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">allow</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>))
<span class="hl-site">allow</span>(<span class="hl-literal">5</span>) <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> 
    <span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> 
  <span class="hl-combinator">|</span> <span class="hl-variable">done</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()

</pre><p>
We use the auxiliary function <code class="code"><span class="hl-variable">allow</span></code> to get only the first 5
publications from the channel <code class="code"><span class="hl-variable">c</span></code>.  When no more publications are allowed,
<code class="code"><span class="hl-variable">allow</span></code> uses the interrupt idiom to halt F and close <code class="code"><span class="hl-variable">c</span></code>.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1121C"></a>2.2.14.2.&nbsp;Non-Terminating Pruning</h4></div></div></div><p>
We can use routing to create a modified version of the pruning combinator.
As in <code class="code"><span class="hl-variable">F</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="hl-variable">G</span></code>, we'll run F and G in parallel and make the first
value published by G available to F.  However instead of terminating G after
it publishes a value, we will continue running it, ignoring its remaining
publications.
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Ref</span>()
(<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="hl-variable">r</span>.<span class="hl-site">read</span>()) <span class="hl-combinator">|</span> (<span class="bold"><strong>G</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-variable">x</span>))

</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1122E"></a>2.2.14.3.&nbsp;Publication-Agnostic Otherwise</h4></div></div></div><p>
We can also use routing to create a modified version of the otherwise combinator. We'll
run F until it halts, and then run G, regardless of whether F published any values
or not.
</p><pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">get</span>) <span class="hl-combinator">|</span> (<span class="bold"><strong>F</strong></span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">;</span> <span class="hl-variable">c</span>.<span class="hl-site">close</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="bold"><strong>G</strong></span>)  
</pre>

We use <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">close</span>()</code> instead of the more common <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()</code>
to ensure that G does not execute until all the publications of F have been
routed. Recall that <code class="code"><span class="hl-variable">c</span>.<span class="hl-site">close</span>()</code> does not return until <code class="code"><span class="hl-variable">c</span></code> is
empty.

</div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1124A"></a>2.2.15.&nbsp;Interruption</h3></div></div></div><p>
We can write a function <code class="code"><span class="hl-variable">interruptible</span></code> that implements the interrupt idiom
to execute any function in an interruptible way.  <code class="code"><span class="hl-site">interruptible</span>(<span class="hl-variable">g</span>)</code>
calls the function <code class="code"><span class="hl-variable">g</span></code>, which is assumed to take no arguments, and
silences its publications. It immediately publishes another function, which we
can call at any time to terminate the execution of <code class="code"><span class="hl-variable">g</span></code>. For simplicity,
we assume that <code class="code"><span class="hl-variable">g</span></code> itself publishes no values.
</p><p>
Here is a naive implementation that doesn't quite work:
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">interruptible</span>(<span class="hl-variable">f</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">done</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>)
  <span class="hl-variable">done</span>.<span class="hl-variable">release</span>
    <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> 
     <span class="hl-combinator">|</span> <span class="hl-variable">done</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()

<span class="hl-comment">{- wrong! -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">stopper</span> = <span class="hl-site">interruptible</span>(<span class="hl-variable">g</span>)
...

</pre><p>
The function <code class="code"><span class="hl-variable">interruptible</span></code> is correct, but the way it is used causes a strange error.
The function <code class="code"><span class="hl-variable">g</span></code> executes, but is always immediately terminated! This happens because the
<code class="code"><span class="hl-keyword">val</span></code> declaration which binds <code class="code"><span class="hl-variable">stopper</span></code> also kills all of the remaining
computation in <code class="code"><span class="hl-site">interruptible</span>(<span class="hl-variable">g</span>)</code>, including the execution of <code class="code"><span class="hl-variable">g</span></code> itself.
</p><p>
The solution is to bind the variable differently:
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">interruptible</span>(<span class="hl-variable">f</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">done</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>)
  <span class="hl-variable">done</span>.<span class="hl-variable">release</span>
    <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> 
     <span class="hl-combinator">|</span> <span class="hl-variable">done</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">closenb</span>()

<span class="hl-site">interruptible</span>(<span class="hl-variable">g</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">stopper</span><span class="hl-combinator">&gt;</span>
...

</pre><p>
This idiom, wherein a function publishes some value that can be used to monitor or control its 
execution, arises occasionally in Orc programming. When using this idiom, always remember to
avoid terminating that execution accidentally. Since Orc is a structured concurrent language,
every process is contained with some other process; kill the containing process, and the
contained processes die too.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1127C"></a>2.2.16.&nbsp;Lifting</h3></div></div></div>

It is often useful to explicitly lift an execution, so that it is in some sense protected from
being terminated. We can do this by running a "lifter" process, to which we can send functions
that will be executed by the lifter and thus will not be terminated unless the lifter itself
is terminated.

Such a lifter is written by creating a channel, and running a loop which listens for functions to
be sent on the channel and executes those functions as they arrive. The lifter publishes only
the put method for the channel; the loop itself publishes no values, since the values published by the 
lifted functions are silenced.

Here, we write such a lifter, and then use it to protect a function call from a timeout.

<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">lifter</span>() =
  <span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">loop</span>() = <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">f</span><span class="hl-combinator">&gt;</span> ( <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">loop</span>() )
  <span class="hl-variable">c</span>.<span class="hl-variable">put</span> <span class="hl-combinator">|</span> <span class="hl-site">loop</span>()

<span class="hl-keyword">def</span> <span class="hl-site">delayedPrint</span>() = <span class="hl-site">Rtimer</span>(<span class="hl-literal">1500</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"Delayed 1.5 seconds"</span>)

<span class="hl-site">lifter</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">lift</span><span class="hl-combinator">&gt;</span>
(
<span class="hl-site">println</span>(<span class="hl-literal">"Running..."</span>) 
  <span class="hl-combinator">&lt;</span><span class="hl-combinator">&lt;</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">|</span> <span class="hl-site">delayedPrint</span>() <span class="hl-combinator">|</span> <span class="hl-site">lift</span>(<span class="hl-variable">delayedPrint</span>)
)

</pre>

The timeout stops the execution of <code class="code"><span class="hl-site">delayedPrint</span>()</code>, so it does not print a result.
However, the lifted execution of <code class="code"><span class="hl-variable">delayedPrint</span></code> does succeed, since it is executing
within the loop of <code class="code"><span class="hl-site">lifter</span>()</code>, unaffected by the timeout.

</div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1128D"></a>2.2.17.&nbsp;Fold</h3></div></div></div><p>
We consider various concurrent implementations of the classic "list fold"
function from functional programming:
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">fold</span>(<span class="hl-variable">_</span>, [<span class="hl-variable">x</span>])  = <span class="hl-variable">x</span>
<span class="hl-keyword">def</span> <span class="hl-site">fold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>, <span class="hl-site">fold</span>(<span class="hl-variable">xs</span>))</pre><p>
This is a seedless fold (sometimes called <code class="code"><span class="hl-variable">fold1</span></code>) which requires that the
list be nonempty and uses its first element as a seed.  This implementation is
short-circuiting --- it may finish early if the reduction operator <code class="code"><span class="hl-variable">f</span></code> does
not use its second argument --- but it is not concurrent; no two calls to <code class="code"><span class="hl-variable">f</span></code>
can proceed in parallel.  However, if <code class="code"><span class="hl-variable">f</span></code> is associative, we can overcome this restriction 
and implement fold concurrently. If <code class="code"><span class="hl-variable">f</span></code> is also commutative, we can further increase concurrency.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N112A5"></a>2.2.17.1.&nbsp;Associative Fold</h4></div></div></div><p>
We first consider the case when the reduction operator is associative.  We
define <code class="code"><span class="hl-site">afold</span>(<span class="hl-variable">f</span>,<span class="hl-variable">xs</span>)</code> where <code class="code"><span class="hl-variable">f</span></code> is a binary associative function and
<code class="code"><span class="hl-variable">xs</span></code> is a non-empty list.  The implementation iteratively reduces <code class="code"><span class="hl-variable">xs</span></code>
to a single value.  Each step of the iteration applies the auxiliary function
<code class="code"><span class="hl-variable">step</span></code>, which halves the size of <code class="code"><span class="hl-variable">xs</span></code> by reducing disjoint pairs of
adjacent items. 
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">afold</span>(<span class="hl-variable">_</span>, [<span class="hl-variable">x</span>]) = <span class="hl-variable">x</span>
<span class="hl-keyword">def</span> <span class="hl-site">afold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>) =
  <span class="hl-keyword">def</span> <span class="hl-site">step</span>([]) = []
  <span class="hl-keyword">def</span> <span class="hl-site">step</span>([<span class="hl-variable">x</span>]) = [<span class="hl-variable">x</span>]
  <span class="hl-keyword">def</span> <span class="hl-site">step</span>(<span class="hl-variable">x</span>:<span class="hl-variable">y</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>):<span class="hl-site">step</span>(<span class="hl-variable">xs</span>)
  <span class="hl-site">afold</span>(<span class="hl-variable">f</span>, <span class="hl-site">step</span>(<span class="hl-variable">xs</span>))
</pre><p>
Notice that <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>):<span class="hl-site">step</span>(<span class="hl-variable">xs</span>)</code> is an implicit
fork-join. Thus, the call <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)</code>
executes in parallel with the recursive call <code class="code"><span class="hl-site">step</span>(<span class="hl-variable">xs</span>)</code>. 
As a result, all calls to <code class="code"><span class="hl-variable">f</span></code> execute concurrently within
each iteration of <code class="code"><span class="hl-variable">afold</span></code>.   
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N112CF"></a>2.2.17.2.&nbsp;Associative, Commutative Fold</h4></div></div></div><p>
We can make the implementation even more concurrent when the fold operator 
is both associative and commutative. We define <code class="code"><span class="hl-site">cfold</span>(<span class="hl-variable">f</span>,<span class="hl-variable">xs</span>)</code>, where 
<code class="code"><span class="hl-variable">f</span></code> is a associative and commutative binary function and <code class="code"><span class="hl-variable">xs</span></code> is a non-empty list. 
The implementation initially copies all list items into a buffer in arbitrary
order using the auxiliary function <code class="code"><span class="hl-variable">xfer</span></code>, counting the total
number of items copied. The auxiliary function <code class="code"><span class="hl-variable">combine</span></code> repeatedly 
pulls pairs of items from the buffer, reduces
them, and places the result back in the buffer. Each pair of items is reduced
in parallel as they become available. The last item in the buffer is the
result of the overall fold.
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">cfold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>()
  
  <span class="hl-keyword">def</span> <span class="hl-site">xfer</span>([])    = <span class="hl-literal">0</span>
  <span class="hl-keyword">def</span> <span class="hl-site">xfer</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>)  = <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">xfer</span>(<span class="hl-variable">xs</span>)+<span class="hl-literal">1</span>

  <span class="hl-keyword">def</span> <span class="hl-site">combine</span>(<span class="hl-literal">0</span>) = <span class="hl-keyword">stop</span>
  <span class="hl-keyword">def</span> <span class="hl-site">combine</span>(<span class="hl-literal">1</span>) =  <span class="hl-variable">c</span>.<span class="hl-site">get</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">combine</span>(<span class="hl-variable">m</span>) =  <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span> 
                    ( <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">combine</span>(<span class="hl-variable">m</span>-<span class="hl-literal">1</span>))

  <span class="hl-site">xfer</span>(<span class="hl-variable">xs</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> <span class="hl-site">combine</span>(<span class="hl-variable">n</span>)
</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N112E5"></a>2.3.&nbsp;Larger Examples</h2></div></div></div>

In this section we show a few larger Orc programs to demonstrate programming techniques. 
There are many more such examples available at the Orc website, on the
<a class="link" href="http://orc.csres.utexas.edu/wiki/Wiki.jsp?page=WikiLab" target="_top">community wiki</a>.


<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N112ED"></a>2.3.1.&nbsp;Dining Philosophers</h3></div></div></div><p>
The dining philosophers problem is a well known and intensely studied problem
in concurrent programming. Five philosophers sit around a circular table. Each
philosopher has two forks that she shares with her neighbors (giving five forks
in total).  Philosophers think until they become hungry.  A hungry philosopher
picks up both forks, one at a time, eats, puts down both forks, and then
resumes thinking.  Without further refinement, this scenario allows deadlock;
if all philosophers become hungry and pick up their left-hand forks
simultaneously, no philosopher will be able to pick up her right-hand fork to
eat.  Lehmann and Rabin's solution<sup>[<a href="#ftn.N112F2" name="N112F2" class="footnote">3</a>]</sup>, which we implement,
requires that each philosopher pick up her forks in a random order.  If the
second fork is not immediately available, the philosopher must set down both
forks and try again.  While livelock is still possible if all philosophers
take forks in the same order, randomization makes this possibility vanishingly
unlikely.
</p><pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">shuffle</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = <span class="hl-keyword">if</span> (<span class="hl-site">random</span>(<span class="hl-literal">2</span>) = <span class="hl-literal">1</span>) <span class="hl-keyword">then</span> (<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) <span class="hl-keyword">else</span> (<span class="hl-variable">b</span>,<span class="hl-variable">a</span>)

<span class="hl-keyword">def</span> <span class="hl-site">take</span>((<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)) =    
  <span class="hl-variable">a</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">b</span>.<span class="hl-site">acquirenb</span>() <span class="hl-combinator">;</span>
  <span class="hl-variable">a</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">take</span>(<span class="hl-site">shuffle</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>))
    
<span class="hl-keyword">def</span> <span class="hl-site">drop</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = (<span class="hl-variable">a</span>.<span class="hl-site">release</span>(), <span class="hl-variable">b</span>.<span class="hl-site">release</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>

<span class="hl-keyword">def</span> <span class="hl-site">phil</span>(<span class="hl-variable">n</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) =
  <span class="hl-keyword">def</span> <span class="hl-site">thinking</span>() = 
    <span class="hl-site">println</span>(<span class="hl-variable">n</span> + <span class="hl-literal">" thinking"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
    <span class="hl-keyword">if</span> (<span class="hl-site">random</span>(<span class="hl-literal">10</span>) &lt; <span class="hl-literal">9</span>)
      <span class="hl-keyword">then</span> <span class="hl-site">Rtimer</span>(<span class="hl-site">random</span>(<span class="hl-literal">1000</span>))
      <span class="hl-keyword">else</span> <span class="hl-keyword">stop</span>
  <span class="hl-keyword">def</span> <span class="hl-site">hungry</span>() = <span class="hl-site">take</span>((<span class="hl-variable">a</span>,<span class="hl-variable">b</span>))
  <span class="hl-keyword">def</span> <span class="hl-site">eating</span>() = 
    <span class="hl-site">println</span>(<span class="hl-variable">n</span> + <span class="hl-literal">" eating"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
    <span class="hl-site">Rtimer</span>(<span class="hl-site">random</span>(<span class="hl-literal">1000</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
    <span class="hl-site">println</span>(<span class="hl-variable">n</span> + <span class="hl-literal">" done eating"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> 
    <span class="hl-site">drop</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)
  <span class="hl-site">thinking</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">hungry</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">eating</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">phil</span>(<span class="hl-variable">n</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)

<span class="hl-keyword">def</span> <span class="hl-site">philosophers</span>(<span class="hl-literal">1</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = <span class="hl-site">phil</span>(<span class="hl-literal">1</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)
<span class="hl-keyword">def</span> <span class="hl-site">philosophers</span>(<span class="hl-variable">n</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>)
  <span class="hl-site">philosophers</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>,<span class="hl-variable">a</span>,<span class="hl-variable">c</span>) <span class="hl-combinator">|</span> <span class="hl-site">phil</span>(<span class="hl-variable">n</span>,<span class="hl-variable">c</span>,<span class="hl-variable">b</span>)

<span class="hl-keyword">val</span> <span class="hl-variable">fork</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>)
<span class="hl-site">philosophers</span>(<span class="hl-literal">5</span>,<span class="hl-variable">fork</span>,<span class="hl-variable">fork</span>)</pre><p>
The <code class="code"><span class="hl-variable">phil</span></code> function simulates a single philosopher.  It takes as arguments
two binary semaphores representing the philosopher's forks, and calls
the <code class="code"><span class="hl-variable">thinking</span></code>, <code class="code"><span class="hl-variable">hungry</span></code>, and <code class="code"><span class="hl-variable">eating</span></code> functions in a continuous
loop. A <code class="code"><span class="hl-variable">thinking</span></code> philosopher waits for a random amount of time, with a
10% chance of thinking forever. A <code class="code"><span class="hl-variable">hungry</span></code> philosopher uses the <code class="code"><span class="hl-variable">take</span></code>
function to acquire two forks. An <code class="code"><span class="hl-variable">eating</span></code> philosopher waits for a random
time interval and then uses the <code class="code"><span class="hl-variable">drop</span></code> function to relinquish ownership of
her forks.
</p><p>
Calling <code class="code"><span class="hl-site">take</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)</code> attempts to acquire a pair of forks <code class="code">(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)</code> in two steps:
wait for fork <code class="code"><span class="hl-variable">a</span></code> to become available, then immediately attempt to acquire fork <code class="code"><span class="hl-variable">b</span></code>.
The call <code class="code"><span class="hl-variable">b</span>.<span class="hl-site">acquirenb</span>()</code> either acquires <code class="code"><span class="hl-variable">b</span></code> and responds immediately, or halts if <code class="code"><span class="hl-variable">b</span></code> is not available.
If <code class="code"><span class="hl-variable">b</span></code> is acquired, signal success; otherwise, release <code class="code"><span class="hl-variable">a</span></code>, and
then try again, randomly changing the order in which the forks are acquired
using the auxiliary function <code class="code"><span class="hl-variable">shuffle</span></code>.
</p><p>
The function call <code class="code"><span class="hl-site">philosophers</span>(<span class="hl-variable">n</span>,<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)</code> recursively creates a chain of <code class="code"><span class="hl-variable">n</span></code>
philosophers, bounded by fork <code class="code"><span class="hl-variable">a</span></code> on the left and <code class="code"><span class="hl-variable">b</span></code> on the right. The
goal expression of the program calls <code class="code"><span class="hl-variable">philosophers</span></code> to create a chain of
five philosophers bounded on the left and right by the same fork; hence, a
ring.
</p><p>
This Orc solution has several nice properties.  The overall structure of the
program is functional, with each behavior encapsulated in its own function,
making the program easy to understand and modify.  Mutable state is isolated to
the "fork" semaphores and associated <code class="code"><span class="hl-variable">take</span></code> and <code class="code"><span class="hl-variable">get</span></code> functions,
simplifying the implementation of the philosophers.  The program never
manipulates threads explicitly, but instead expresses relationships between
activities using Orc's combinators.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="methodology.examples.hygenic"></a>2.3.2.&nbsp;Hygienic Dining Philosophers</h3></div></div></div><p>
Here we implement a different solution to the Dining Philosophers problem,
described in "The Drinking Philosophers Problem", by K. M. Chandy and J. Misra.
Briefly, this algorithm efficiently and fairly solves the dining philosophers
problem for philosophers connected in an arbitrary graph (as opposed to a
simple ring).  The algorithm works by augmenting each fork with a clean/dirty
state.  Initially, all forks are dirty.  A philosopher is only obliged to
relinquish a fork to its neighbor if the fork is dirty. On receiving a fork,
the philosopher cleans it. On eating, the philosopher dirties all forks.  For
full details of the algorithm, consult the original paper.
</p><pre class="orc">
<span class="hl-comment">{-
Start a philosopher actor; never publishes.
Messages sent between philosophers include:
- ("fork", p): philosopher p relinquishes the fork
- ("request", p): philosopher p requests the fork
- ("rumble", p): sent by a philosopher to itself when it should
  become hungry

name: identify this process in status messages
mbox: our mailbox; the "address" of this philosopher is mbox.put
missing: set of neighboring philosophers holding our forks
-}</span>
<span class="hl-keyword">def</span> <span class="hl-site">philosopher</span>(<span class="hl-variable">name</span>, <span class="hl-variable">mbox</span>, <span class="hl-variable">missing</span>) =
  <span class="hl-comment">{- deferred requests for forks -}</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">deferred</span> = <span class="hl-site">Buffer</span>()
  <span class="hl-comment">{- forks we hold which are clean -}</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">clean</span> = <span class="hl-site">Set</span>()

  <span class="hl-keyword">def</span> <span class="hl-site">sendFork</span>(<span class="hl-variable">p</span>) =
    <span class="hl-comment">{- remember that we no longer hold the fork -}</span>
    <span class="hl-variable">missing</span>.<span class="hl-site">add</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-site">p</span>((<span class="hl-literal">"fork"</span>, <span class="hl-variable">mbox</span>.<span class="hl-variable">put</span>))
 
  <span class="hl-keyword">def</span> <span class="hl-site">requestFork</span>(<span class="hl-variable">p</span>) =
    <span class="hl-site">p</span>((<span class="hl-literal">"request"</span>, <span class="hl-variable">mbox</span>.<span class="hl-variable">put</span>))
  
  <span class="hl-comment">{- Start a timer which will tell us when we're hungry. -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">digesting</span>() =
      <span class="hl-site">println</span>(<span class="hl-variable">name</span> + <span class="hl-literal">" thinking"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-site">thinking</span>()
    <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-site">random</span>(<span class="hl-literal">1000</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-variable">mbox</span>.<span class="hl-site">put</span>((<span class="hl-literal">"rumble"</span>, <span class="hl-variable">mbox</span>.<span class="hl-variable">put</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-keyword">stop</span>

  <span class="hl-comment">{- Wait to become hungry -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">thinking</span>() =
    <span class="hl-keyword">def</span> <span class="hl-site">on</span>((<span class="hl-literal">"rumble"</span>, <span class="hl-variable">_</span>)) =
      <span class="hl-site">println</span>(<span class="hl-variable">name</span> + <span class="hl-literal">" hungry"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-site">map</span>(<span class="hl-variable">requestFork</span>, <span class="hl-variable">missing</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-site">hungry</span>()
    <span class="hl-keyword">def</span> <span class="hl-site">on</span>((<span class="hl-literal">"request"</span>, <span class="hl-variable">p</span>)) =
      <span class="hl-site">sendFork</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">thinking</span>()
    <span class="hl-site">on</span>(<span class="hl-variable">mbox</span>.<span class="hl-site">get</span>())

  <span class="hl-comment">{- Eat once we receive all forks -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">hungry</span>() =
    <span class="hl-keyword">def</span> <span class="hl-site">on</span>((<span class="hl-literal">"fork"</span>, <span class="hl-variable">p</span>)) =
      <span class="hl-variable">missing</span>.<span class="hl-site">remove</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-variable">clean</span>.<span class="hl-site">add</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-keyword">if</span> <span class="hl-variable">missing</span>.<span class="hl-site">isEmpty</span>()
      <span class="hl-keyword">then</span> <span class="hl-site">println</span>(<span class="hl-variable">name</span> + <span class="hl-literal">" eating"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">eating</span>()
      <span class="hl-keyword">else</span> <span class="hl-site">hungry</span>()
    <span class="hl-keyword">def</span> <span class="hl-site">on</span>((<span class="hl-literal">"request"</span>, <span class="hl-variable">p</span>)) =
      <span class="hl-keyword">if</span> <span class="hl-variable">clean</span>.<span class="hl-site">contains</span>(<span class="hl-variable">p</span>)
      <span class="hl-keyword">then</span> <span class="hl-variable">deferred</span>.<span class="hl-site">put</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">hungry</span>()
      <span class="hl-keyword">else</span> <span class="hl-site">sendFork</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">requestFork</span>(<span class="hl-variable">p</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">hungry</span>()
    <span class="hl-site">on</span>(<span class="hl-variable">mbox</span>.<span class="hl-site">get</span>())

  <span class="hl-comment">{- Dirty forks, process deferred requests, then digest -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">eating</span>() =
    <span class="hl-variable">clean</span>.<span class="hl-site">clear</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-site">Rtimer</span>(<span class="hl-site">random</span>(<span class="hl-literal">1000</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-site">map</span>(<span class="hl-variable">sendFork</span>, <span class="hl-variable">deferred</span>.<span class="hl-site">getAll</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-site">digesting</span>()

  <span class="hl-comment">{- All philosophers start out digesting -}</span>
  <span class="hl-site">digesting</span>()

<span class="hl-comment">{-
Create an NxN 4-connected grid of philosophers.  Each philosopher
holds the fork for the connections below and to the right (so the
top left philosopher holds both its forks).
-}</span>
<span class="hl-keyword">def</span> <span class="hl-site">philosophers</span>(<span class="hl-variable">n</span>) =
  <span class="hl-comment">{- A set with 1 item -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">Set1</span>(<span class="hl-variable">item</span>) = <span class="hl-site">Set</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">s</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">add</span>(<span class="hl-variable">item</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>
  <span class="hl-comment">{- A set with 2 items -}</span>
  <span class="hl-keyword">def</span> <span class="hl-site">Set2</span>(<span class="hl-variable">i1</span>, <span class="hl-variable">i2</span>) = <span class="hl-site">Set</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">s</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">add</span>(<span class="hl-variable">i1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">add</span>(<span class="hl-variable">i2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>

  <span class="hl-comment">{- create an NxN matrix of mailboxes -}</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">cs</span> = <span class="hl-site">uncurry</span>(<span class="hl-site">IArray</span>(<span class="hl-variable">n</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">_</span>) = <span class="hl-site">IArray</span>(<span class="hl-variable">n</span>, <span class="hl-site">ignore</span>(<span class="hl-variable">Buffer</span>))))

  <span class="hl-comment">{- create the first row of philosophers -}</span>
  <span class="hl-site">philosopher</span>((<span class="hl-literal">0</span>,<span class="hl-literal">0</span>), <span class="hl-site">cs</span>(<span class="hl-literal">0</span>,<span class="hl-literal">0</span>), <span class="hl-site">Set</span>())
  <span class="hl-combinator">|</span> <span class="hl-site">for</span>(<span class="hl-literal">1</span>, <span class="hl-variable">n</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">j</span><span class="hl-combinator">&gt;</span>
    <span class="hl-site">philosopher</span>((<span class="hl-literal">0</span>,<span class="hl-variable">j</span>), <span class="hl-site">cs</span>(<span class="hl-literal">0</span>,<span class="hl-variable">j</span>), <span class="hl-site">Set1</span>(<span class="hl-site">cs</span>(<span class="hl-literal">0</span>,<span class="hl-variable">j</span>-<span class="hl-literal">1</span>).<span class="hl-variable">put</span>))

  <span class="hl-comment">{- create remaining rows -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">for</span>(<span class="hl-literal">1</span>, <span class="hl-variable">n</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">i</span><span class="hl-combinator">&gt;</span> (
      <span class="hl-site">philosopher</span>((<span class="hl-variable">i</span>,<span class="hl-literal">0</span>), <span class="hl-site">cs</span>(<span class="hl-variable">i</span>,<span class="hl-literal">0</span>), <span class="hl-site">Set1</span>(<span class="hl-site">cs</span>(<span class="hl-variable">i</span>-<span class="hl-literal">1</span>,<span class="hl-literal">0</span>).<span class="hl-variable">put</span>))
      <span class="hl-combinator">|</span> <span class="hl-site">for</span>(<span class="hl-literal">1</span>, <span class="hl-variable">n</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">j</span><span class="hl-combinator">&gt;</span>
        <span class="hl-site">philosopher</span>((<span class="hl-variable">i</span>,<span class="hl-variable">j</span>), <span class="hl-site">cs</span>(<span class="hl-variable">i</span>,<span class="hl-variable">j</span>), <span class="hl-site">Set2</span>(<span class="hl-site">cs</span>(<span class="hl-variable">i</span>-<span class="hl-literal">1</span>,<span class="hl-variable">j</span>).<span class="hl-variable">put</span>, <span class="hl-site">cs</span>(<span class="hl-variable">i</span>,<span class="hl-variable">j</span>-<span class="hl-literal">1</span>).<span class="hl-variable">put</span>))
    )

<span class="hl-comment">{- Simulate a 3x3 grid of philosophers for 10 seconds -}</span>
<span class="hl-site">let</span>(
  <span class="hl-site">philosophers</span>(<span class="hl-literal">3</span>)
  <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">10000</span>)
) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"HALTED"</span></pre><p>
Our implementation is based on the <a class="link" href="http://en.wikipedia.org/wiki/Actor_model" target="_top">actor model</a> of
concurrency.  An actor is a state machine which reacts to messages.  On
receiving a message, an actor can send asynchronous messages to other actors,
change its state, or create new actors.  Each actor is single-threaded and
processes messages sequentially, which makes some concurrent programs easier to
reason about and avoids explicit locking. <a class="link" href="http://www.erlang.org/" target="_top">Erlang</a> is one popular
language based on the actor model.
</p><p>
Orc emulates the actor model very naturally.  In Orc, an actor is an Orc thread
of execution, together with a <code class="code"><span class="hl-variable">Buffer</span></code> which serves as a mailbox.  To send a
message to an actor, you place it in the actor's mailbox, and to receive a
message, the actor gets the next item from the mailbox.  The internal states of
the actor are represented by functions: while an actor's thread of execution is
evaluating a function, it is considered to be in the corresponding state.
Because Orc implements <a class="link" href="http://en.wikipedia.org/wiki/Tail_call" target="_top">tail-call optimization</a>,
state transitions can be encoded as function calls without running out of stack
space.
</p><p>
In this program, a philosopher is implemented by an actor with three primary
states: <code class="code"><span class="hl-variable">eating</span></code>, <code class="code"><span class="hl-variable">thinking</span></code>, and <code class="code"><span class="hl-variable">hungry</span></code>.
An additional transient state, <code class="code"><span class="hl-variable">digesting</span></code>, is used to start a timer
which will trigger the state change from <code class="code"><span class="hl-variable">thinking</span></code> to
<code class="code"><span class="hl-variable">hungry</span></code>.  Each state is implemented by a function which reads a
message from the mailbox, selects the appropriate action using pattern
matching, performs the action, and finally transitions to the next state
(possibly the same as the current state) by calling the corresponding function.
</p><p>
Forks are never represented explicitly.  Instead each philosopher identifies a
fork with the "address" (sending end of a mailbox) of the neighbor who shares
the fork.  Every message sent includes the sender's address.  Therefore when a
philosopher receives a request for a fork, it knows who requested it and
therefore which fork to relinquish.  Likewise when a philosopher receives a
fork, it knows who sent it and therefore which fork was received.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11384"></a>2.3.3.&nbsp;Readers-Writers</h3></div></div></div><p>
Here we present an Orc solution to the <a class="link" href="http://en.wikipedia.org/wiki/Readers-writers_problem" target="_top">readers-writers
problem</a>.  Briefly, the readers-writers problem involves concurrent
access to a mutable resource.  Multiple readers can access the resource
concurrently, but writers must have exclusive access.  When readers and writers
conflict, different solutions may resolve the conflict in favor of one or the
other, or fairly.  In the following solution, when a writer tries to acquire
the lock, current readers are allowed to finish but new readers are postponed
until after the writer finishes.  Lock requests are granted in the order
received, guaranteeing fairness.  Normally, such a service would be provided to
Orc programs by a site, but it is educational to see how it can be implemented
directly in Orc.
</p><pre class="orc">
<span class="hl-comment">-- Queue of lock requests</span>
<span class="hl-keyword">val</span> <span class="hl-variable">m</span> = <span class="hl-site">Buffer</span>()
<span class="hl-comment">-- Count of active readers/writers</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Counter</span>()

<span class="hl-comment">{-- Process requests in sequence --}</span>
<span class="hl-keyword">def</span> <span class="hl-site">process</span>() =
  <span class="hl-comment">-- Grant read request</span>
  <span class="hl-keyword">def</span> <span class="hl-site">grant</span>((<span class="hl-literal">false</span>,<span class="hl-variable">s</span>)) = <span class="hl-variable">c</span>.<span class="hl-site">inc</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>()
  <span class="hl-comment">-- Grant write request</span>
  <span class="hl-keyword">def</span> <span class="hl-site">grant</span>((<span class="hl-literal">true</span>,<span class="hl-variable">s</span>)) =
    <span class="hl-variable">c</span>.<span class="hl-site">onZero</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">inc</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">onZero</span>()
  <span class="hl-comment">-- Goal expression of process()</span>
  <span class="hl-variable">m</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">r</span><span class="hl-combinator">&gt;</span> <span class="hl-site">grant</span>(<span class="hl-variable">r</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">process</span>()

<span class="hl-comment">{-- Acquire the lock: argument is "true" if writing --}</span>
<span class="hl-keyword">def</span> <span class="hl-site">acquire</span>(<span class="hl-variable">write</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">s</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>)
  <span class="hl-variable">m</span>.<span class="hl-site">put</span>((<span class="hl-variable">write</span>, <span class="hl-variable">s</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>()

<span class="hl-comment">{-- Release the lock --}</span>
<span class="hl-keyword">def</span> <span class="hl-site">release</span>() = <span class="hl-variable">c</span>.<span class="hl-site">dec</span>()

<span class="hl-comment">-------------------------------------------------</span>

<span class="hl-comment">{-- These definitions are for testing only --}</span>
<span class="hl-keyword">def</span> <span class="hl-site">reader</span>(<span class="hl-variable">start</span>) = <span class="hl-site">Rtimer</span>(<span class="hl-variable">start</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">acquire</span>(<span class="hl-literal">false</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"START READ"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"END READ"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">writer</span>(<span class="hl-variable">start</span>) = <span class="hl-site">Rtimer</span>(<span class="hl-variable">start</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">acquire</span>(<span class="hl-literal">true</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"START WRITE"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">println</span>(<span class="hl-literal">"END WRITE"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>

<span class="hl-site">let</span>(
    <span class="hl-site">process</span>()  <span class="hl-comment">{- Output:     -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">reader</span>(<span class="hl-literal">10</span>) <span class="hl-comment">{- START READ  -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">reader</span>(<span class="hl-literal">20</span>) <span class="hl-comment">{- START READ  -}</span>
               <span class="hl-comment">{- END READ    -}</span>
               <span class="hl-comment">{- END READ    -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">writer</span>(<span class="hl-literal">30</span>) <span class="hl-comment">{- START WRITE -}</span>
               <span class="hl-comment">{- END WRITE   -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">reader</span>(<span class="hl-literal">40</span>) <span class="hl-comment">{- START READ  -}</span>
  <span class="hl-combinator">|</span> <span class="hl-site">reader</span>(<span class="hl-literal">50</span>) <span class="hl-comment">{- START READ  -}</span>
               <span class="hl-comment">{- END READ    -}</span>
               <span class="hl-comment">{- END READ    -}</span>
  <span class="hl-comment">-- halt after the last reader finishes</span>
  <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">60</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">acquire</span>(<span class="hl-literal">true</span>)
)</pre><p>
The lock receives requests over the channel <code class="code"><span class="hl-variable">m</span></code> and processes them
sequentially with the function <code class="code"><span class="hl-variable">grant</span></code>. Each request includes a
boolean flag which is true for write requests and false for read requests, and a
<code class="code"><span class="hl-variable">Semaphore</span></code> which the requester blocks on.  The lock grants access
by releasing the semaphore, unblocking the requester.
</p><p>
The counter <code class="code"><span class="hl-variable">c</span></code> tracks the number of readers or writers currently
holding the lock.  Whenever the lock is granted, <code class="code"><span class="hl-variable">grant</span></code> increments
<code class="code"><span class="hl-variable">c</span></code>, and when the lock is released, <code class="code"><span class="hl-variable">c</span></code> is decremented.
To ensure that a writer has exclusive access, <code class="code"><span class="hl-variable">grant</span></code> waits for the
<code class="code"><span class="hl-variable">c</span></code> to become zero before granting the lock to the writer, and then
waits for <code class="code"><span class="hl-variable">c</span></code> to become zero again before granting any more requests.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N113B2"></a>2.3.4.&nbsp;Quicksort</h3></div></div></div><p>
The original quicksort algorithm
<sup>[<a href="#ftn.N113B7" name="N113B7" class="footnote">4</a>]</sup>
was designed for efficient execution on a uniprocessor.
Encoding it as a functional program typically ignores its efficient
rearrangement of the elements of an array.
Further, no known implementation highlights its concurrent aspects.
The following program attempts to overcome these two limitations.
The program is mostly functional in its structure, though it manipulates the
array elements in place.
We encode parts of the algorithm as concurrent activities where sequentiality
is unneeded.
</p><p>
The following listing gives the implementation of the <code class="code"><span class="hl-variable">quicksort</span></code>
function which sorts the array <code class="code"><span class="hl-variable">a</span></code> in place.
The auxiliary function <code class="code"><span class="hl-variable">sort</span></code> sorts the subarray given by indices
<code class="code"><span class="hl-variable">s</span></code> through <code class="code"><span class="hl-variable">t</span></code> by calling <code class="code"><span class="hl-variable">part</span></code> to partition
the subarray and then recursively sorting the partitions.
</p><pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">quicksort</span>(<span class="hl-variable">a</span>) =

  <span class="hl-keyword">def</span> <span class="hl-site">swap</span>(<span class="hl-variable">x</span>, <span class="hl-variable">y</span>) = <span class="hl-site">a</span>(<span class="hl-variable">x</span>)<span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">z</span><span class="hl-combinator">&gt;</span> <span class="hl-site">a</span>(<span class="hl-variable">x</span>) <span class="hl-site">:=</span> <span class="hl-site">a</span>(<span class="hl-variable">y</span>)<span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">a</span>(<span class="hl-variable">y</span>) <span class="hl-site">:=</span> <span class="hl-variable">z</span>

  <span class="hl-keyword">def</span> <span class="hl-site">part</span>(<span class="hl-variable">p</span>, <span class="hl-variable">s</span>, <span class="hl-variable">t</span>) =
    <span class="hl-keyword">def</span> <span class="hl-site">lr</span>(<span class="hl-variable">i</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">i</span> &lt; <span class="hl-variable">t</span> &amp;&amp; <span class="hl-site">a</span>(<span class="hl-variable">i</span>)<span class="hl-site">?</span> <span class="hl-site">&lt;=</span> <span class="hl-variable">p</span> <span class="hl-keyword">then</span> <span class="hl-site">lr</span>(<span class="hl-variable">i</span>+<span class="hl-literal">1</span>) <span class="hl-keyword">else</span> <span class="hl-variable">i</span>
    <span class="hl-keyword">def</span> <span class="hl-site">rl</span>(<span class="hl-variable">i</span>) = <span class="hl-keyword">if</span> <span class="hl-site">a</span>(<span class="hl-variable">i</span>)<span class="hl-site">?</span> &gt; <span class="hl-variable">p</span> <span class="hl-keyword">then</span> <span class="hl-site">rl</span>(<span class="hl-variable">i</span>-<span class="hl-literal">1</span>) <span class="hl-keyword">else</span> <span class="hl-site">i</span>

    (<span class="hl-site">lr</span>(<span class="hl-variable">s</span>), <span class="hl-site">rl</span>(<span class="hl-variable">t</span>)) <span class="hl-combinator">&gt;</span>(<span class="hl-variable">s</span>', <span class="hl-variable">t</span>')<span class="hl-combinator">&gt;</span>
    ( <span class="hl-keyword">if</span> (<span class="hl-variable">s</span>' + <span class="hl-literal">1</span> &lt; <span class="hl-variable">t</span>') <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">swap</span>(<span class="hl-variable">s</span>', <span class="hl-variable">t</span>') <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">part</span>(<span class="hl-variable">p</span>, <span class="hl-variable">s</span>'+<span class="hl-literal">1</span>, <span class="hl-variable">t</span>'-<span class="hl-literal">1</span>)
    <span class="hl-combinator">|</span> <span class="hl-keyword">if</span> (<span class="hl-variable">s</span>' + <span class="hl-literal">1</span> = <span class="hl-variable">t</span>') <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">swap</span>(<span class="hl-variable">s</span>', <span class="hl-variable">t</span>') <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>'
    <span class="hl-combinator">|</span> <span class="hl-keyword">if</span> (<span class="hl-variable">s</span>' + <span class="hl-literal">1</span> &gt; <span class="hl-variable">t</span>') <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">t</span>'
    )

  <span class="hl-keyword">def</span> <span class="hl-site">sort</span>(<span class="hl-variable">s</span>, <span class="hl-variable">t</span>) =
     <span class="hl-keyword">if</span> <span class="hl-variable">s</span> <span class="hl-site">&gt;=</span> <span class="hl-variable">t</span> <span class="hl-keyword">then</span> <span class="hl-keyword">signal</span>
     <span class="hl-keyword">else</span> <span class="hl-site">part</span>(<span class="hl-site">a</span>(<span class="hl-variable">s</span>)<span class="hl-site">?</span>, <span class="hl-variable">s</span>+<span class="hl-literal">1</span>, <span class="hl-variable">t</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">m</span><span class="hl-combinator">&gt;</span>
          <span class="hl-site">swap</span>(<span class="hl-variable">m</span>, <span class="hl-variable">s</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
          (<span class="hl-site">sort</span>(<span class="hl-variable">s</span>, <span class="hl-variable">m</span>-<span class="hl-literal">1</span>), <span class="hl-site">sort</span>(<span class="hl-variable">m</span>+<span class="hl-literal">1</span>, <span class="hl-variable">t</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
          <span class="hl-keyword">signal</span>

  <span class="hl-site">sort</span>(<span class="hl-literal">0</span>, <span class="hl-variable">a</span>.<span class="hl-site">length</span>()-<span class="hl-literal">1</span>)</pre><p>
The function <code class="code"><span class="hl-variable">part</span></code> partitions the subarray given by indices
<code class="code"><span class="hl-variable">s</span></code> through <code class="code"><span class="hl-variable">t</span></code> into two partitions, one containing values
less than or equal to <code class="code"><span class="hl-variable">p</span></code> and the other containing values &gt; <code class="code"><span class="hl-variable">p</span></code>.  The last index of the lower partition is returned.
The value at <code class="code"><span class="hl-site">a</span>(<span class="hl-variable">s</span>-<span class="hl-literal">1</span>)</code> is assumed to be less than or equal to <code class="code"><span class="hl-variable">p</span></code> --- this is satisfied
by choosing <code class="code"><span class="hl-variable">p</span> = <span class="hl-site">a</span>(<span class="hl-variable">s</span>-<span class="hl-literal">1</span>)<span class="hl-site">?</span></code> initially.  To create the partitions, <code class="code"><span class="hl-variable">part</span></code>
calls two auxiliary functions <code class="code"><span class="hl-variable">lr</span></code> and <code class="code"><span class="hl-variable">rl</span></code> concurrently.  These
functions scan from the left and right of the subarray respectively, looking
for out-of-place elements.  Once two such elements have been found, they are
swapped using the auxiliary function <code class="code"><span class="hl-variable">swap</span></code>, and then the unscanned portion
of the subarray is partitioned further.  Partitioning is complete when the
entire subarray has been scanned.
</p><p>
This program uses the syntactic sugar <code class="code"><span class="hl-variable">x</span><span class="hl-site">?</span></code> for <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">read</span>()</code>
and <code class="code"><span class="hl-variable">x</span> <span class="hl-site">:=</span> <span class="hl-variable">y</span></code> for <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">write</span>(<span class="hl-variable">y</span>)</code>.  Also note that the expression
<code class="code"><span class="hl-site">a</span>(<span class="hl-variable">i</span>)</code> returns a reference to the element of array <code class="code"><span class="hl-variable">a</span></code> at index
<code class="code"><span class="hl-variable">i</span></code>, counting from 0.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11411"></a>2.3.5.&nbsp;Meeting Scheduler</h3></div></div></div><p>
Orc makes very few assumptions about the behaviors of services it uses. Therefore
it is straightforward to write programs which interact with human agents and
network services.  This makes Orc especially suitable for encoding
<em class="firstterm">workflows</em>, the coordination of multiple activities
involving multiple participants.  The following program illustrates a simple
workflow for scheduling a business meeting.  Given a list of people and a date
range, the program asks each person when they are available for a meeting.  It
then combines all the responses, selects a meeting time which is acceptable to
everyone, and notifies everyone of the selected time.
</p><pre class="programlisting">
<span class="hl-keyword">include</span> <span class="hl-literal">"net.inc"</span>
<span class="hl-keyword">val</span> <span class="hl-variable">during</span> = <span class="hl-site">Interval</span>(<span class="hl-site">LocalDate</span>(<span class="hl-literal">2009</span>, <span class="hl-literal">9</span>, <span class="hl-literal">10</span>),
                      <span class="hl-site">LocalDate</span>(<span class="hl-literal">2009</span>, <span class="hl-literal">10</span>, <span class="hl-literal">17</span>))
<span class="hl-keyword">val</span> <span class="hl-variable">invitees</span> = [<span class="hl-literal">"john@example.com"</span>, <span class="hl-literal">"jane@example.com"</span>]

<span class="hl-keyword">def</span> <span class="hl-site">invite</span>(<span class="hl-variable">invitee</span>) =
  <span class="hl-site">Form</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">f</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">f</span>.<span class="hl-site">addPart</span>(<span class="hl-site">DateTimeRangesField</span>(<span class="hl-literal">"times"</span>,
    <span class="hl-literal">"When are you available for a meeting?"</span>, <span class="hl-variable">during</span>, <span class="hl-literal">9</span>, <span class="hl-literal">17</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">f</span>.<span class="hl-site">addPart</span>(<span class="hl-site">Button</span>(<span class="hl-literal">"submit"</span>, <span class="hl-literal">"Submit"</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">SendForm</span>(<span class="hl-variable">f</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">receiver</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">SendMail</span>(<span class="hl-variable">invitee</span>, <span class="hl-literal">"Meeting Request"</span>, <span class="hl-variable">receiver</span>.<span class="hl-site">getURL</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">receiver</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">response</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">response</span>.<span class="hl-site">get</span>(<span class="hl-literal">"times"</span>)

<span class="hl-keyword">def</span> <span class="hl-site">notify</span>([]) =
  <span class="hl-site">each</span>(<span class="hl-variable">invitees</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">invitee</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">SendMail</span>(<span class="hl-variable">invitee</span>, <span class="hl-literal">"Meeting Request Failed"</span>,
                    <span class="hl-literal">"No meeting time found."</span>)
<span class="hl-keyword">def</span> <span class="hl-site">notify</span>(<span class="hl-variable">first</span>:<span class="hl-variable">_</span>) =
  <span class="hl-site">each</span>(<span class="hl-variable">invitees</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">invitee</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">SendMail</span>(<span class="hl-variable">invitee</span>, <span class="hl-literal">"Meeting Request Succeeded"</span>,
                    <span class="hl-variable">first</span>.<span class="hl-site">getStart</span>())

<span class="hl-site">map</span>(<span class="hl-variable">invite</span>, <span class="hl-variable">invitees</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">responses</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">afold</span>(<span class="hl-keyword">lambda</span> (<span class="hl-variable">a</span>,<span class="hl-variable">b</span>) = <span class="hl-variable">a</span>.<span class="hl-site">intersect</span>(<span class="hl-variable">b</span>), <span class="hl-variable">responses</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">times</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">notify</span>(<span class="hl-variable">times</span>)</pre><p>
This program begins with declarations of <code class="code"><span class="hl-variable">during</span></code> (the date range for the
proposed meeting) and <code class="code"><span class="hl-variable">invitees</span></code> (the list of people to invite represented
by email addresses).
</p><p>
The <code class="code"><span class="hl-variable">invite</span></code> function obtains possible meeting times from a given invitee, as
follows.  First it uses library sites (<code class="code"><span class="hl-variable">Form</span></code>, <code class="code"><span class="hl-variable">DateTimeRangesField</span></code>,
<code class="code"><span class="hl-variable">Button</span></code>, and <code class="code"><span class="hl-variable">SendForm</span></code>) to construct a web form which may be used to
submit possible meeting times.  Then it emails the URL of this form to the
invitee and blocks waiting for a response.  When the invitee receives the
email, he or she will use a web browser to visit the URL, complete the form,
and submit it.  The corresponding execution of <code class="code"><span class="hl-variable">invite</span></code> receives the
response in the variable <code class="code"><span class="hl-variable">response</span></code> and extracts the chosen meeting times.
</p><p>
The <code class="code"><span class="hl-variable">notify</span></code> function takes a list of possible meeting times, selects the
first meeting time in the list, and emails everyone with this time.  If the
list of possible meeting times is empty, it emails everyone indicating that no
meeting time was found.
</p><p>
The goal expression of the program uses the library function <code class="code"><span class="hl-variable">map</span></code> to
apply <code class="code"><span class="hl-variable">notify</span></code> to each invitee and collect the responses in a list. It
then uses the library function <code class="code"><span class="hl-variable">afold</span></code> to intersect all of the responses.
The result is a set of meeting times which are acceptable to everyone. Finally,
<code class="code"><span class="hl-variable">notify</span></code> is called to select one of these times and notify everyone of the result.
</p><p>
This program may be extended to add more sophisticated features, such as a
quorum (to select a meeting as soon as some subset of invitees responds) or
timeouts (to remind invitees if they don't respond in a timely manner).  These
modifications are local and do not affect the overall structure of the program.
For complete details, see <a class="link" href="http://orc.csres.utexas.edu/tryorc.shtml" target="_top">examples on our website</a>.
</p></div></div><div class="footnotes"><br><hr align="left" width="100"><div class="footnote"><p><sup>[<a href="#N10E18" name="ftn.N10E18" class="para">1</a>] </sup>R. Milner. <span class="emphasis"><em>Communicating and Mobile Systems:
the &#960;-Calculus</em></span>. Cambridge University Press, May
1999.</p></div><div class="footnote"><p><sup>[<a href="#N10E1F" name="ftn.N10E1F" class="para">2</a>] </sup>J. Armstrong, R.
Virding, C. Wikstr&uml;om, and M. Williams. <span class="emphasis"><em>Concurrent programming in
ERLANG (2nd ed.)</em></span>. Prentice Hall International (UK) Ltd.,
Hertfordshire, UK, UK, 1996.</p></div><div class="footnote"><p><sup>[<a href="#N112F2" name="ftn.N112F2" class="para">3</a>] </sup>D. J. Lehmann and M. O. Rabin. On the advantages of free choice: A symmetric
and fully distributed solution to the dining philosophers problem. In <span class="emphasis"><em>POPL</em></span>, pages
133&ndash;138, 1981.</p></div><div class="footnote"><p><sup>[<a href="#N113B7" name="ftn.N113B7" class="para">4</a>] </sup>C. A. R. Hoare. Partition: Algorithm 63, Quicksort: Algorithm 64, and
Find: Algorithm 65. <span class="emphasis"><em>Communications of the ACM</em></span>,
4(7):321&ndash;322, 1961.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="chapter.services"></a>Chapter&nbsp;3.&nbsp;Accessing and Creating External Services</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#section.services.intro">3.1. Introduction</a></span></dt><dt><span class="section"><a href="#section.services.java">3.2. 

                class Sites</a></span></dt><dd><dl><dt><span class="section"><a href="#section.services.java.dot">3.2.1. Dot Operator</a></span></dt><dt><span class="section"><a href="#N114B7">3.2.2. Direct Calls</a></span></dt><dt><span class="section"><a href="#N114D1">3.2.3. Pattern Matching</a></span></dt><dt><span class="section"><a href="#section.services.java.method">3.2.4. Method Resolution</a></span></dt><dt><span class="section"><a href="#N1150D">3.2.5. Orc values in Java</a></span></dt><dt><span class="section"><a href="#N11549">3.2.6. Java Values in Orc</a></span></dt><dt><span class="section"><a href="#section.services.kilim">3.2.7. Cooperative Scheduling and Concurrency</a></span></dt></dl></dd><dt><span class="section"><a href="#N1160D">3.3. 
                site Sites</a></span></dt><dd><dl><dt><span class="section"><a href="#N11613">3.3.1. Fundamentals</a></span></dt><dt><span class="section"><a href="#N116B4">3.3.2. More Site Classes</a></span></dt><dt><span class="section"><a href="#N1171A">3.3.3. Tutorial Example</a></span></dt></dl></dd><dt><span class="section"><a href="#N1176B">3.4. Web Services</a></span></dt><dd><dl><dt><span class="section"><a href="#N1176E">3.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#N11773">3.4.2. Downloading and Running Examples</a></span></dt><dt><span class="section"><a href="#N1178E">3.4.3. Protocols Supported</a></span></dt><dt><span class="section"><a href="#N117D0">3.4.4. REST</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section.services.intro"></a>3.1.&nbsp;Introduction</h2></div></div></div><p>
There are two primary ways to create sites which can be used in Orc:
</p><div class="orderedlist"><ol type="1"><li>Implement sites as regular Java classes.
	Orc programs can import and use these classes directly with the
	<code class="code"><span class="hl-keyword">class</span></code> declaration. This approach is easy for anyone
	already familiar with Java, and such sites are straightforward to share
	between Orc and Java code.  However such sites are limited in how they
	can interact with the Orc engine.
</li><li>Implement sites using Orc's low-level site API.  Orc programs can
	import and use these sites with the <code class="code"><span class="hl-keyword">site</span></code> declaration.
	This approach provides full access to the features of the Orc engine.
	However such sites are difficult to use from Java code.
</li></ol></div><p>
External services (including web services) are handled using the <a class="link" href="http://en.wikipedia.org/wiki/Proxy_pattern" target="_top">Proxy
	pattern</a>.  A site implemented in Java (using one of the two
techniques above) must act as the local proxy for the service, translating Orc
site calls into the appropriate requests and translating responses into site
return values, halts, or errors.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section.services.java"></a>3.2.&nbsp;

                <code class="code"><span class="hl-keyword">class</span></code> Sites</h2></div></div></div><p>
Java classes can be imported into Orc as sites using the <a class="link" href="#section.orc.class" title="1.4.4.1.&nbsp; class declaration">

                    <code class="code"><span class="hl-keyword">class</span></code> declaration</a>.
Imported classes must be in the classpath of the JVM running the Orc
interpreter.  The following sections describe in detail how such imported
classes behave in Orc programs.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="section.services.java.dot"></a>3.2.1.&nbsp;Dot Operator</h3></div></div></div><p>
<code class="code"><span class="hl-variable">x</span>.<span class="hl-variable">member</span></code>, where <code class="code"><span class="hl-variable">x</span></code> evaluates to a Java class or object, is evaluated as follows:
<div class="itemizedlist"><ul type="disc"><li>If <code class="code"><span class="hl-variable">x</span></code> has one or more methods named <code class="code"><span class="hl-variable">member</span></code>,
a "method handle" site is returned which may be called like any other Orc site.
When a method handle is actually called with arguments, the appropriate Java
method is selected and called depending on the number and type of arguments, as
described in <a class="link" href="#section.services.java.method" title="3.2.4.&nbsp;Method Resolution">Method Resolution</a>
below.</li><li>Otherwise, if <code class="code"><span class="hl-variable">x</span></code> has a field named <code class="code"><span class="hl-variable">member</span></code>,
the object's field is returned, encapsulated in a <a class="link" href="#orc.lib.state.Ref">
                                <code class="code"><span class="hl-variable">Ref</span></code> object</a>. The
<code class="code"><span class="hl-variable">Ref</span></code> object has <code class="code"><span class="hl-variable">read</span></code> and <code class="code"><span class="hl-variable">write</span></code> methods
which are used to get and set the value of the field.</li></ul></div>
</p><p>
Note that no distinction is made between static and non-static members; it is
an error to reference a non-static member through a class, but this does not
change how members are resolved.  Note also that if a field shares a name with
one or more methods, there is no way to access the field directly.
</p><p>
The following (rather useless) example illustrates how the dot operator can be
used to access both static and non-static methods and fields:
<pre class="programlisting">
<span class="hl-comment">{- bind Integer to a Java class -}</span>
<span class="hl-keyword">class</span> <span class="hl-variable">Integer</span> = <span class="hl-variable">java</span>.<span class="hl-variable">lang</span>.<span class="hl-variable">Integer</span>

<span class="hl-comment">{- call a static method -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">i</span> = <span class="hl-variable">Integer</span>.<span class="hl-site">decode</span>(<span class="hl-literal">"5"</span>)
<span class="hl-comment">{- read a field -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">m</span> = <span class="hl-variable">Integer</span>.<span class="hl-variable">MIN_VALUE</span>.<span class="hl-site">read</span>()
<span class="hl-comment">{- write a field -}</span>
<span class="hl-variable">Integer</span>.<span class="hl-variable">MIN_VALUE</span>.<span class="hl-site">write</span>(<span class="hl-literal">5</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-comment">{- call a non-static method -}</span>
<span class="hl-variable">i</span>.<span class="hl-site">toString</span>()
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N114B7"></a>3.2.2.&nbsp;Direct Calls</h3></div></div></div><p>
When <code class="code"><span class="hl-variable">x</span></code> evaluates to a Java object (but not a Java class), the syntax
<code class="code"><span class="hl-site">x</span>(...)</code> is equivalent to <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">apply</span>(...)</code>.
</p><p>
When <code class="code"><span class="hl-variable">x</span></code> evaluates to a Java class, the syntax <code class="code"><span class="hl-site">x</span>(...)</code>
calls the class's constructor.  In case of overloaded constructors, the
appropriate constructor is chosen based on the number and types of arguments as
described in <a class="link" href="#section.services.java.method" title="3.2.4.&nbsp;Method Resolution">Method Resolution</a>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N114D1"></a>3.2.3.&nbsp;Pattern Matching</h3></div></div></div><p>
If <code class="code"><span class="hl-variable">C</span></code> is bound to a Java class, it can be used as a pattern.
A pattern <code class="code"><span class="hl-site">C</span>(<span class="hl-variable">x</span>)</code> matches any Java object of that class or
any of its subclasses. The variable <code class="code"><span class="hl-variable">x</span></code> is simply bound
to the object again; thus the matcher is just a partial identity function.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="section.services.java.method"></a>3.2.4.&nbsp;Method Resolution</h3></div></div></div><p>
When a method handle is called, the actual Java method called is chosen based
on the runtime types of the arguments, as follows:
<div class="orderedlist"><ol type="1"><li>If only one method has the appropriate number of arguments, that method is called.</li><li>Otherwise, each method taking the appropriate number of arguments is
	tested for type compatibility as follows, and the first matching method
	is called.
	<div class="orderedlist"><ol type="a"><li>Every argument is compared to the corresponding formal
		parameter type as follows. All arguments must match for the
		method to match.
		<div class="orderedlist"><ol type="i"><li>If the argument is null, then the argument matches</li><li>If the formal parameter type is primitive (int, char,
			float, ...) and the argument is an instance of a
			wrapper class, then the argument is unboxed (unwrapped)
			and coerced to the type of the formal parameter
			according to Java's standard rules for implicit
			widening coercions.</li><li>If the formal parameter type is a primitive numeric type
			and the argument is an instance of <code class="code">BigDecimal</code>,
			the argument is implicitly narrowed to the formal parameter type.</li><li>If the formal parameter type is a primitive integral type
			and the argument is an instance of <code class="code">BigInteger</code>,
			the argument is implicitly narrowed to the formal parameter type.</li><li>Otherwise, the argument must be a subtype of the formal parameter type.</li></ol></div></li></ol></div></li></ol></div>
</p><p>
The reason for the unusual implicit narrowing of <code class="code">BigDecimal</code> and
<code class="code">BigInteger</code> is that Orc numeric literals have these types, and it
would be awkward to have to perform an explicit conversion every time such a
value is passed to a Java method expecting a primitive.
</p><p>
Currently we do not implement specificity rules for choosing the best matching
method; the first matching method (according to some unspecified order) is
chosen.  Note also that we do not support varargs methods explicitly, but
instead varargs may be passed as an array of the appropriate type.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1150D"></a>3.2.5.&nbsp;Orc values in Java</h3></div></div></div><p>
Orc values are implemented by Java objects, so in general any Orc value may be
passed to a site implemented in Java.  Standard Orc values have the following
Java types:
</p><div class="variablelist"><dl><dt><span class="term">string</span></dt><dd><code class="code">java.lang.String</code></dd><dt><span class="term">boolean</span></dt><dd><code class="code">java.lang.Boolean</code></dd><dt><span class="term">number</span></dt><dd><code class="code">java.lang.Number</code></dd><dt><span class="term">tuple</span></dt><dd><code class="code">orc.runtime.values.TupleValue</code></dd><dt><span class="term">list</span></dt><dd><code class="code">orc.runtime.values.ListValue</code></dd><dt><span class="term">function</span></dt><dd><code class="code">orc.runtime.values.Closure</code><p>Currently it is not possible to call Orc functions from Java code.</p></dd><dt><span class="term">site</span></dt><dd><code class="code">orc.runtime.values.Site</code><p>Currently it is not possible to directly call Orc sites from Java
code.  However if you are implementing a site yourself, you may provide methods
which can be called from Java code to invoke the behavior of the site.</p></dd></dl></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11549"></a>3.2.6.&nbsp;Java Values in Orc</h3></div></div></div><p>
Java objects may be used directly as values anywhere in an Orc program.
Primitive Java values cannot be used directly in an Orc program, but are
automatically boxed (and unboxed) as necessary.
</p><p>
When both arguments of an arithmetic or comparison operator are Java numeric
types, the arguments are implicitly coerced to the widest of the two argument
types.  "Widest" is defined by the following relation, where "&gt;" means "is
wider than": BigDecimal &gt; Double &gt; Float &gt; BigInteger &gt; Long &gt; Integer &gt; Short
&gt; Byte
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="section.services.kilim"></a>3.2.7.&nbsp;Cooperative Scheduling and Concurrency</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N11554"></a>3.2.7.1.&nbsp;Overview</h4></div></div></div><p>
In order to support massive concurrency efficiently in Java, Orc uses
cooperative threading.  Orc programs are broken into discrete steps which
are executed by a fixed-size thread pool.  This approach works for Orc
expressions, but the internals of an Orc site written in Java cannot be easily
broken down.  So Orc has two choices when it needs to call a local Java site:
</p><div class="itemizedlist"><ul type="disc"><li>Run the site call in a new thread.  This means site calls never
	unnecessarily block the Orc engine, but it introduces the
	potentially-unnecessary overhead of creating and context-switching
	threads.</li><li>Run the site call in the same thread as the Orc engine, which
is efficient and conserves thread resources but may block the engine from
making further progress until the site call finishes.</li></ul></div><p>
Fortunately, in practice most Orc site calls take a short, deterministic amount
of time to complete. Of those that don't, it's usually only because they are
blocked waiting for some external event, like another site call.  In this case,
instead of blocking the site can return control to the Orc engine, asking to
be run again when the external event occurs.  In typical Java applications this
kind of non-blocking behavior is implemented using callbacks (or in its most
general form, continuation passing).  Unfortunately this creates convoluted and
verbose code: what if you need to block in the middle of a <code class="code"><span class="hl-keyword">for</span></code> loop, for example?
</p><p>
<a class="link" href="http://kilim.malhar.net/" target="_top">Kilim</a> resolves this issue by
allowing programmers to write code in a natural blocking style and then
rewriting the bytecode to perform a form of CPS conversion, so that instead
of blocking the code actually returns control to a scheduler. Orc supports
Kilim, allowing site authors to write sites with internal concurrency and
blocking behavior which don't use Java threads and cooperate with the Orc
engine.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1156A"></a>3.2.7.2.&nbsp;Kilim Fundamentals</h4></div></div></div><p>
For a full introduction to <a class="link" href="http://kilim.malhar.net/" target="_top">Kilim</a>, see <a class="link" href="http://www.malhar.net/sriram/kilim/thread_of_ones_own.pdf" target="_top">A Thread of
One's Own</a>, by Sriram Srinivasan. In the following, we will cover just
enough to get you started writing Orc sites using Kilim.
</p><p>
Kilim introduces three key primitives:
<div class="variablelist"><dl><dt><span class="term">
<code class="code">Pausable</code>
</span></dt><dd><p>
This checked exception marks methods which may block. You should never catch
this exception, and you should always declare it even if you have already
declared <code class="code"><span class="hl-keyword">throws</span> Exception</code> or <code class="code"><span class="hl-keyword">throws</span> Throwable</code>.  In all other respects it follows the
normal rules for checked exceptions: an override can only throw it if the
superclass method throws it, and you must throw it if you call any method which
throws it.
</p><p>Originally Kilim used annotations to mark pausable methods. It turned
out that <span class="command"><strong>javac</strong></span> would sometimes manipulate code in ways which violate the
invariants regarding use of the annotation. Annotations also have the
disadvantage that the invariants on their use are not checked automatically by
tools like Eclipse.</p></dd><dt><span class="term">
<code class="code">Mailbox</code>
</span></dt><dd><p>
A multiple-producer, single-consumer queue used to communicate
between tasks. The most important methods are <code class="code">put(Object)</code>, which places an item in the
mailbox, and <code class="code">get()</code>, which blocks until the mailbox
is non-empty and then returns the first item.
</p></dd><dt><span class="term">
<code class="code">Task</code>
</span></dt><dd>
Kilim analogue of a <code class="code">Thread</code>. Every <code class="code">Pausable</code>
method must be run within a task. To create and run a task:

<pre class="programlisting">
<span class="hl-keyword">new</span> Task() {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> execute() <span class="hl-keyword">throws</span> Pausable {
        <span class="hl-comment">// do some stuff</span>
    }
}.start();
</pre></dd></dl></div>
</p><p>
Together, these primitives allow you to write highly-concurrent Java programs
in a familiar threaded style.  Under the hood, Kilim can schedule any number of
concurrent tasks on a fixed number of physical threads, providing better
scalability and performance than possible with Java threads.
</p><p>
When writing Orc sites you rarely need to use tasks explicitly because every Orc
site call is implicitly run inside a Kilim task if necessary. Therefore all you need to do is mark
<code class="code">Pausable</code> methods. Here's a short example of a
buffer site written using Kilim <code class="code">Mailbox</code>es:

<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> KilimBuffer&lt;V&gt; {
	<span class="hl-keyword">private</span> LinkedList&lt;Mailbox&lt;V&gt;&gt; waiters =
		<span class="hl-keyword">new</span> LinkedList&lt;Mailbox&lt;V&gt;&gt;();
	<span class="hl-keyword">private</span> LinkedList&lt;V&gt; buffer = <span class="hl-keyword">new</span> LinkedList&lt;V&gt;();
	<span class="hl-keyword">public</span> <span class="hl-keyword">synchronized</span> <span class="hl-keyword">void</span> put(V o) {
		Mailbox&lt;V&gt; waiter = waiters.poll();
		<span class="hl-keyword">if</span> (waiter != null) waiter.putnb(o);
		<span class="hl-keyword">else</span> buffer.add(o);
	}
	<span class="hl-keyword">public</span> <span class="hl-keyword">synchronized</span> V get() <span class="hl-keyword">throws</span> Pausable {
		V out = buffer.poll();
		<span class="hl-keyword">if</span> (out != null) <span class="hl-keyword">return</span> out;
		<span class="hl-keyword">else</span> {
			Mailbox&lt;V&gt; waiter = <span class="hl-keyword">new</span> Mailbox&lt;V&gt;();
			waiters.add(waiter);
			<span class="hl-keyword">return</span> waiter.get();
		}
	}
}</pre>
</p><p>Classes using Kilim can be imported like other Java classes using the Orc
<code class="code"><span class="hl-keyword">class</span></code> declaration.  For example, we can use the
<code class="code">KilimBuffer</code> class defined above:
<pre class="programlisting">
<span class="hl-keyword">class</span> <span class="hl-variable">Buffer</span> = <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">state</span>.<span class="hl-variable">KilimBuffer</span>
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">Buffer</span>()
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-literal">"1 second later"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">null</span>
<span class="hl-combinator">|</span> <span class="hl-variable">b</span>.<span class="hl-site">get</span>()</pre>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
The version of Kilim bundled with Orc does not support calls to pausable
methods in constructor arguments. For example, this does not work:
<pre class="programlisting">
<span class="hl-keyword">new</span> Foo(bar.pausable());
</pre>
The workaround is to use a temporary variable:
<pre class="programlisting">
Object tmp = bar.pausable();
<span class="hl-keyword">new</span> Foo(tmp);
</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N115DD"></a>3.2.7.3.&nbsp;When you must block</h4></div></div></div><p>
Sometimes blocking is unavoidable, for example if a site must perform blocking
IO.  For such cases, Orc provides a utility method <code class="code">orc.runtime.Kilim#runThreaded(Callable)</code> which farms work
out to a thread pool.  The advantage of doing this over spawning your own
thread is that there is no chance of using too many threads; if no thread is
available, the method pauses until one becomes available.  The disadvantage is
that if you have too many Java methods which must communicate with each other
concurrently and can't use Mailboxes, there won't be enough threads for them
all and execution will deadlock.  This situation is sufficiently rare that
<code class="code">runThreaded</code> is usually the correct approach.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N115EA"></a>3.2.7.4.&nbsp;Compiling Kilim Sites</h4></div></div></div><p>
Code which uses Kilim must be processed with the Kilim "weaver" after compiling
and before running.  The weaver is bundled with the Orc source code, or may be
downloaded separately from the <a class="link" href="http://www.malhar.net/sriram/kilim/" target="_top">Kilim project
	site</a>.
</p><p>
To process compiled classes, run <code class="code">kilim.tools.Weaver</code>.
If your <code class="filename">.class</code> files are in the
<code class="filename">build/</code> directory, you would run the weaver like this:
<span class="command"><strong>java -cp kilim.jar:build/ kilim.tools.Weaver -d build/ build/</strong></span>
</p><p>
The Orc source distribution includes an ant <span class="command"><strong>kilim</strong></span>
task (in <code class="filename">build.xml</code>) which weaves compiled classes in the
<code class="filename">build</code> directory.  If you are compiling Orc in Eclipse, an
Eclipse "Builder" is included which does this automatically whenever any source
files change.
</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N1160D"></a>3.3.&nbsp;
                <code class="code"><span class="hl-keyword">site</span></code> Sites</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11613"></a>3.3.1.&nbsp;Fundamentals</h3></div></div></div><p>
Orc sites imported with the <code class="code"><span class="hl-keyword">site</span></code> declaration are implemented as
Java classes which extend <code class="code">orc.runtime.sites.Site</code>.
Here we will summarize the most important features of this and related classes;
for a detailed description, refer to the <a class="link" href="http://orc.csres.utexas.edu/javadoc/STABLE/index.html" target="_top">Javadoc</a>.
</p><p>
Sites must implement a single method: <code class="code">callSite(Args args,
Token token)</code>.  The Orc engine calls this method whenever the site is
called by the Orc program.
</p><p>
The <code class="code">args</code> argument (of type <code class="code">Args</code>) is used to get the arguments which were passed to
the site call by the Orc program. It has the following important methods:
</p><div class="variablelist"><dl><dt><span class="term">
                            <code class="code">getArg(<span class="hl-keyword">int</span>
n)</code>
                        </span></dt><dd>returns the value of the (n+1)th argument, as an
<code class="code">Object</code>.  For example, to get the value of the
first argument, call <code class="code">args.getArg(<span class="hl-number">0</span>)</code>.</dd><dt><span class="term">
                            <code class="code">intArg(<span class="hl-keyword">int</span> n)</code>, <code class="code">stringArg(<span class="hl-keyword">int</span> n)</code>, <code class="code">boolArg(<span class="hl-keyword">int</span>
n)</code>, etc.</span></dt><dd>returns the value of the (n+1)th argument cast
to the appropriate type. If the argument is not the appropriate type, throws an
<code class="code">ArgumentTypeMismatchException</code>.</dd></dl></div><p>
The <code class="code">token</code> argument (of type <code class="code">Token</code>) is a sort of callback which is used by the site
to return a value or signal that it has halted. It has the following important
methods:
</p><div class="variablelist"><dl><dt><span class="term">
                            <code class="code">resume(Object
value)</code>
                        </span></dt><dd>return the value <code class="code">value</code> from the site call. For example, to return the
number 5, call <code class="code">token.resume(<span class="hl-number">5</span>)</code>.  To publish a
signal without returning any specific value, call <code class="code">token.resume()</code>.</dd><dt><span class="term">
                            <code class="code">error(TokenException
problem)</code>
                        </span></dt><dd>halt without publishing a value and report an
error.  This method is an appropriate way to report Java exceptions encountered
during a site call.  Alternatively, a site can simply throw a checked exception
from the <code class="code">callSite</code> method; the engine will call
<code class="code">token.error</code> on its behalf. To convert a Java
exception to the necessary <code class="code">TokenException</code> type,
wrap it in an instance of <code class="code">orc.error.runtime.JavaException</code>.</dd><dt><span class="term">
                            <code class="code">die()</code>
                        </span></dt><dd>halt,
without publishing a value or reporting an error. For example, the built-in
site <code class="code"><span class="hl-keyword">if</span></code> uses this method to halt when called with a
<code class="code"><span class="hl-literal">false</span></code> argument.</dd></dl></div><p>
The <code class="code">callSite</code> method must return control to its
caller within a short, deterministic amount of time.  To implement a site which
blocks or waits for some condition, <code class="code">callSite</code> must
save the <code class="code">token</code> and return without calling any of
the above methods.  Then when it is time for the site call to return, call the
appropriate method on the <code class="code">token</code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N116B4"></a>3.3.2.&nbsp;More Site Classes</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N116B7"></a>3.3.2.1.&nbsp;EvalSite</h4></div></div></div><p>
Many sites are deterministic, always returning a value immediately when called.
Such sites can be implemented easily by extending <code class="code">orc.runtime.sites.EvalSite</code> and implementing the method
<code class="code">evaluate(Args args)</code>.  This method should read the
arguments from <code class="code">args</code> as usual, and then return the
value to be returned from the site call, or throw a checked exception to
indicate an error.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="section.services.sites.ThreadedSite"></a>3.3.2.2.&nbsp;ThreadedSite</h4></div></div></div><p>
Some sites need to perform blocking IO or use other Java blocking methods like
<code class="code">Object#wait()</code>.  This cannot be done directly in
the <code class="code">callSite</code> or <code class="code">EvalSite#evaluate</code>  methods because that might block the
Orc engine. Instead, extend <code class="code">orc.runtime.sites.ThreadedSite</code> and implement the method
<code class="code">evaluate(Args args)</code>.  This method should read the
arguments from <code class="code">args</code> as usual, and then return the
value to be returned from the site call, or throw a checked exception to
indicate an error.  Your <code class="code">evaluate</code> method will be
automatically run asynchronously in a new thread so that it does not interfere
with the Orc engine.
</p><p>
Beware that the Orc engine may be configured to only allow a fixed number of
site threads. If too many sites need to use threads simultaneously, some will
block until threads become available.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N116EC"></a>3.3.2.3.&nbsp;DotSite</h4></div></div></div><p>
Recall that the notation <code class="code"><span class="hl-variable">x</span>.<span class="hl-variable">msg</span></code> corresponds to calling the site
<code class="code"><span class="hl-variable">x</span></code> with the special message value <code class="code"><span class="hl-variable">msg</span></code>.  To implement a
site which responds to such messages, extend <code class="code">orc.runtime.sites.DotSite</code>.
</p><p>
In your site's constructor, call the method <code class="code">addMember(String message, Object value)</code> once for each
message you wish the site to respond to. The call <code class="code">addMember(m, v)</code> instructs the site to return the value
<code class="code">v</code> when it is called with the message <code class="code">m</code>.
</p><p>
Any object can be used as a member value, even another site.  Anonymous inner
classes extending <code class="code">Site</code> are often used as member
values which behave like  methods of the enclosing <code class="code">DotSite</code>.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1171A"></a>3.3.3.&nbsp;Tutorial Example</h3></div></div></div><p>
We will implement a simplified version of Orc's <code class="code"><span class="hl-variable">Buffer</span></code> site,
called <code class="code">ExampleBuffer</code>. The goal will be to be able
to run this Orc program:
</p><pre class="programlisting">
<span class="hl-comment">-- Import the site definition</span>
<span class="hl-keyword">site</span> <span class="hl-variable">ExampleBuffer</span> = <span class="hl-variable">ExampleBuffer</span>
<span class="hl-comment">-- Create a new buffer site</span>
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">ExampleBuffer</span>()
<span class="hl-comment">-- wait for a value in the buffer</span>
<span class="hl-variable">b</span>.<span class="hl-site">get</span>()
<span class="hl-comment">-- put a value in the buffer</span>
<span class="hl-combinator">|</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-literal">3</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-comment">-- Publishes: 3</span></pre><p>
The first step is to create <code class="filename">ExampleBuffer.java</code>. The <code class="code">ExampleBuffer</code> site is actually a <em class="firstterm">discovery site</em>: all
it does when called is create and return a reference to a new site (the buffer
instance).
</p><pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBuffer <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ExampleBufferInstance();
  }
}</pre><p>
Next we must implement <code class="code">ExampleBufferInstance</code>,
which defines the behavior of an individual buffer. We can put this class
either in its own file or in <code class="filename">ExampleBuffer.java</code>, since
that is the only class which refers to it directly. How does an instance
behave? If we write <code class="code"><span class="hl-variable">b</span>.<span class="hl-site">get</span>()</code>, that means that <code class="code"><span class="hl-variable">b</span></code>
responds to the message <code class="code"><span class="hl-variable">get</span></code> with a site which we call to get a
value from the buffer. So we'll extend <code class="code">DotSite</code>,
telling it to respond to the message "get" with a <code class="code">GetMethod</code> site, and likewise for "put". We'll use a
linked list to store the actual contents of the buffer.
</p><pre class="programlisting">
<span class="hl-keyword">class</span> ExampleBufferInstance <span class="hl-keyword">extends</span> DotSite {
  <span class="hl-keyword">private</span> LinkedList&lt;Object&gt; contents = <span class="hl-keyword">new</span> LinkedList&lt;Object&gt;();
  <span class="hl-keyword">public</span> ExampleBufferInstance() {
    addMember(<span class="hl-string">"get"</span>, <span class="hl-keyword">new</span> GetMethod());
    addMember(<span class="hl-string">"put"</span>, <span class="hl-keyword">new</span> PutMethod());
  }
}</pre><p>
The <code class="code">GetMethod</code> site is implemented as an inner
class so it has easy access to the contents of the buffer. In the
implementation we first check if there is an item in the buffer. If so, we
return it. Otherwise, we must store the token in a queue to be notified when
the next item is put in the buffer. We synchronize on the outer object to
protect against concurrent modification.
</p><pre class="programlisting">
<span class="hl-keyword">private</span> LinkedList&lt;Token&gt; waiters = <span class="hl-keyword">new</span> LinkedList&lt;Token&gt;();
<span class="hl-keyword">private</span> <span class="hl-keyword">class</span> GetMethod <span class="hl-keyword">extends</span> Site {
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> callSite(Args args, Token token) {
    <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) {
      <span class="hl-keyword">if</span> (!contents.isEmpty()) {
        token.resume(contents.removeFirst());
      } <span class="hl-keyword">else</span> {
        waiters.add(token);
      } 
    }
  }
}</pre><p>
<code class="code">PutMethod</code> is even simpler since it doesn't need to
block. If there is a token waiting for an item, we give it the item. Otherwise
we put the item in the buffer. We synchronize on the outer object to protect
against concurrent modification. When done we return a dummy "signal" value.
</p><pre class="programlisting">
<span class="hl-keyword">private</span> <span class="hl-keyword">class</span> PutMethod <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    Object item = args.getArg(<span class="hl-number">0</span>);
    <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) { 
      <span class="hl-keyword">if</span> (!waiters.isEmpty()) {
        waiters.removeFirst().resume(item);
      } <span class="hl-keyword">else</span> {
        contents.add(item);
      } 
    }
    <span class="hl-keyword">return</span> signal();
  }
}</pre><p>
Putting it all together, here is the entire implementation:
</p><pre class="programlisting">
<span class="hl-keyword">import</span> java.util.LinkedList;

<span class="hl-keyword">import</span> orc.runtime.sites.EvalSite;
<span class="hl-keyword">import</span> orc.runtime.sites.DotSite;
<span class="hl-keyword">import</span> orc.runtime.sites.Site;
<span class="hl-keyword">import</span> orc.runtime.Token;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBuffer <span class="hl-keyword">extends</span> EvalSite {
  <span class="hl-keyword">public</span> Object evaluate(Args args) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ExampleBufferInstance();
  }
}

<span class="hl-keyword">class</span> ExampleBufferInstance <span class="hl-keyword">extends</span> DotSite {
  <span class="hl-keyword">private</span> LinkedList&lt;Object&gt; contents = <span class="hl-keyword">new</span> LinkedList&lt;Object&gt;();
  <span class="hl-keyword">private</span> LinkedList&lt;Token&gt; waiters = <span class="hl-keyword">new</span> LinkedList&lt;Token&gt;();
    
  <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> GetMethod <span class="hl-keyword">extends</span> Site {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> callSite(Args args, Token token) {
      <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) {
        <span class="hl-keyword">if</span> (!contents.isEmpty()) {
          token.resume(contents.removeFirst());
        } <span class="hl-keyword">else</span> {
          waiters.add(token);
        } 
      }
    }
  }

  <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> PutMethod <span class="hl-keyword">extends</span> EvalSite {
    <span class="hl-keyword">public</span> Object evaluate(Args args) {
      Object item = args.getArg(<span class="hl-number">0</span>);
      <span class="hl-keyword">synchronized</span> (ExampleBufferInstance.<span class="hl-keyword">this</span>) { 
        <span class="hl-keyword">if</span> (!waiters.isEmpty()) {
          waiters.removeFirst().resume(item);
        } <span class="hl-keyword">else</span> {
          contents.add(item);
        } 
      }
      <span class="hl-keyword">return</span> signal();
    }
  }

  <span class="hl-keyword">public</span> ExampleBufferInstance() {
    addMember(<span class="hl-string">"get"</span>, <span class="hl-keyword">new</span> GetMethod());
    addMember(<span class="hl-string">"put"</span>, <span class="hl-keyword">new</span> PutMethod());
  }
}</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N1176B"></a>3.4.&nbsp;Web Services</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1176E"></a>3.4.1.&nbsp;Introduction</h3></div></div></div><p>
While we believe Orc is an excellent language for web service scripting,
currently the library support for such tasks is at a proof-of-concept level.
The web service libraries are not bundled with the core Orc distribution, do
not have stable APIs, and are not officially documented.  However this section
should provide you with enough information to get started.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11773"></a>3.4.2.&nbsp;Downloading and Running Examples</h3></div></div></div><p>All Orc sites related to web services are bundled in a separate
"OrcSites" library.  As with the core Orc distribution, you can either
download this library as a prepackaged JAR or check out the
source code from the "OrcSites" module in version control.  We generally recommend the latter
approach, since the source code provides several examples which can be used as
a basis for creating your own web service sites.
</p><p>
Within the OrcSites source code you will find:
</p><div class="itemizedlist"><ul type="disc"><li>Java source code for web service sites: <code class="filename">src/orc/lib/net/</code></li><li>Orc source code for programs using web services: <code class="filename">examples/</code></li></ul></div><p>Several of the examples require you to create
	<code class="filename">.properties</code> files and place them in your
	classpath. The simplest way to do this is to make sure the
	<code class="filename">examples/</code> directory is in your classpath, and
	place the necessary <code class="filename">.properties</code> files there.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1178E"></a>3.4.3.&nbsp;Protocols Supported</h3></div></div></div><p>
Web services use a variety of protocols, so there are a variety of ways to
contact them. All of them boil down to creating a Java proxy site for the
service and calling that.  Previous sections explain how to implement such Java
sites which can be called in Orc. Because web services tend to use blocking
I/O, Java wrappers make frequent use of <a class="link" href="#section.services.sites.ThreadedSite" title="3.3.2.2.&nbsp;ThreadedSite">ThreadedSite</a> and
<a class="link" href="#section.services.kilim" title="3.2.7.&nbsp;Cooperative Scheduling and Concurrency">Kilim</a> to ensure that web service calls don't block the Orc engine.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1179B"></a>3.4.3.1.&nbsp;Java APIs</h4></div></div></div><p>
Some web services provide Java APIs specifically for the service. For example,
Google Calendar. In these cases we just use the Java API from Orc, either
directly or via a small Java wrapper which simplifies the interface.
</p><p>OrcSites includes <code class="code"><span class="hl-keyword">class</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">GoogleCalendar</span></code> as an
	example of this type of web service.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N117A5"></a>3.4.3.2.&nbsp;SOAP RPC</h4></div></div></div></div><p>
OrcSites includes a generic <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">Webservice</span></code> which allows you to connect to any SOAP RPC (specifically
rpc/encoded) service, without writing Java wrappers.  Instead <a class="link" href="http://ws.apache.org/axis/" target="_top">Apache Axis</a> is used to
generate Java wrappers on-demand.
</p><p>
<a class="link" href="http://www.xmethods.net" target="_top">http://www.xmethods.net</a> is a good place to find examples
of SOAP RPC services:
</p><div class="orderedlist"><ol type="1"><li>Find the RPC "Style" service which does what you want.</li><li>Click on the name of the service.</li><li>Click on "View RPC Profile" for a summary of the methods available.</li><li>Construct instances of the service by passing the WSDL URL to the
	<code class="code"><span class="hl-variable">Webservice</span></code> site. E.g. <code class="code"><span class="hl-site">Webservice</span>(<span class="hl-literal">"http://site.com/wsdl"</span>)</code>.</li><li>Call methods on the service as you would with any Java object. The
	<a class="link" href="http://jcp.org/en/jsr/detail?id=101" target="_top">JAX-RPC
		specification</a> has complete details on how SOAP
	operations and data types are represented in Java.  Beware: method
	names always begin with a lower-case letter, even if the corresponding
	operation does not.</li></ol></div><p>
Example:
</p><pre class="orc">
<span class="hl-keyword">site</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">Webservice</span>
<span class="hl-comment">{-
Find documentation of this service at:
http://www.xmethods.net/ve2/WSDLRPCView.po?
key=uuid:BF3EFCDD-FCD4-8867-3AAC-068985E7CB89
-}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">service</span> = <span class="hl-site">Webservice</span>(
  <span class="hl-literal">"http://www.ebob42.com/cgi-bin/"</span>
  + <span class="hl-literal">"Romulan.exe/wsdl/IRoman"</span>)
<span class="hl-variable">service</span>.<span class="hl-site">intToRoman</span>(<span class="hl-literal">451</span>)
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N117D0"></a>3.4.4.&nbsp;REST</h3></div></div></div><p>
Many services use ad-hoc REST/XML protocols. Unfortunately, there is no REST
equivalent to WSDL, so there's no way to automatically generate an API for REST
services. We're not trying to solve this problem with Orc, but when the web
services community reaches some kind of consensus, Orc will support it.
</p><p>
For now you must write a Java wrapper for each service which handles
marshalling and unmarshalling the data. There's no reason such marshalling code
couldn't be written in Orc, calling low-level HTTP and XML libraries directly,
but there would be no advantage to doing so, so we let each language play to
its strengths. OrcSites includes utility classes to assist with submitting
requests and parsing responses.</p><p>OrcSites includes the following examples of this type of service:</p><div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-keyword">class</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">Upcoming</span></code></li><li><code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">TrueRandom</span></code></li><li><code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">net</span>.<span class="hl-variable">YahooSpellFactory</span></code></li></ul></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="chapter.typechecker"></a>Chapter&nbsp;4.&nbsp;Type Checking</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#N11821">4.1. Simple Typing</a></span></dt><dd><dl><dt><span class="section"><a href="#N11825">4.1.1. Values and Operators</a></span></dt><dt><span class="section"><a href="#N11864">4.1.2. 
                    Top and Bot
                </a></span></dt><dt><span class="section"><a href="#N1189F">4.1.3. Tuples</a></span></dt><dt><span class="section"><a href="#N118AC">4.1.4. Combinators</a></span></dt><dt><span class="section"><a href="#N11917">4.1.5. Conditionals</a></span></dt><dt><span class="section"><a href="#N11928">4.1.6. Defined Functions</a></span></dt><dt><span class="section"><a href="#N11984">4.1.7. Ascriptions</a></span></dt><dt><span class="section"><a href="#N11996">4.1.8. Aliasing</a></span></dt><dt><span class="section"><a href="#N119A4">4.1.9. Datatypes</a></span></dt><dt><span class="section"><a href="#N119B5">4.1.10. Interacting with External Services</a></span></dt><dt><span class="section"><a href="#N119DE">4.1.11. Assertions</a></span></dt></dl></dd><dt><span class="section"><a href="#N119EF">4.2. Polymorphism</a></span></dt><dd><dl><dt><span class="section"><a href="#N119F6">4.2.1. Parametric types</a></span></dt><dt><span class="section"><a href="#N11A30">4.2.2. Parametric functions</a></span></dt><dt><span class="section"><a href="#N11A42">4.2.3. Generic calls</a></span></dt><dt><span class="section"><a href="#N11A65">4.2.4. Polymorphic aliases</a></span></dt><dt><span class="section"><a href="#N11A77">4.2.5. Polymorphic datatypes</a></span></dt></dl></dd><dt><span class="section"><a href="#N11A86">4.3. Interacting with Java</a></span></dt><dt><span class="section"><a href="#N11AA7">4.4. Syntax of Typed Orc</a></span></dt></dl></div><p>
The Orc language, as it is described in <a class="link" href="#chapter.language" title="Chapter&nbsp;1.&nbsp;The Orc Programming Language">Chapter 1</a>, is
dynamically typed. If an operation occurs at runtime which is not type-correct, the call
which attempted that operation becomes silent, and produces a type error that is reported
on the console. 
</p><p>
Orc also has an optional static typechecker, which will guarantee that a program is
free of type errors before the program is run. For every expression in the program,
the typechecker tries to find the types of values that the expression could publish, 
and then checks that all such types are consistent. The typechecker performs a limited form of
<span class="emphasis"><em>type inference</em></span>, so it can discover many types automatically;
however, the programmer must provide additional type information for defined functions 
and for a few other specific cases.
</p><p>
The typechecker is disabled by default, though typed syntax is still permitted (and types are still
checked for syntax errors) even when the typechecker is not used. It may be enabled as a project
property in the Eclipse plugin, or by using the <code class="code">-<span class="hl-variable">typecheck</span></code> switch on the command line. 
</p><p>
If the typechecker can verify that a program is correctly typed, it will display the message
</p><p>
<code class="code">... :: </code>T
</p><p>
on the console. The symbol <code class="code">::</code> means "has type", and T is the type of any value that
the program might publish.
</p><p>
The typechecker uses the local type inference algorithm described by Pierce and Turner in the paper 
<a class="link" href="http://www.cis.upenn.edu/~bcpierce/papers/lti-toplas.pdf" target="_top">Local Type Inference</a>.
It extends this algorithm with polymorphic type constructors (e.g. <code class="code"><span class="hl-variable">List</span></code> and
<code class="code"><span class="hl-variable">Buffer</span></code>), user-defined datatypes (which may also be polymorphic),
and a typing discipline for external services. The typechecker supports both 
<span class="emphasis"><em>parametric polymorphism</em></span> (generics) and 
<span class="emphasis"><em>inclusion polymorphism</em></span> (subtyping), 
though it does not currently implement <span class="emphasis"><em>bounded polymorphism</em></span>, which combines the two. 
</p><p>
While almost all of the features of the Orc language are compatible with the typechecker, there are
still a few limitations, as of version 1.1:
</p><p>
The <code class="code"><span class="hl-variable">capsule</span></code> declaration is not fully compatible with the typechecker, in that it is not 
currently possible to write the type of a capsule explicitly. This means that a capsule cannot be 
used in a position that requires an explicit annotation, for example as a function argument, or as 
the return value of a recursive function. In particular, this means that it is not currently possible 
to typecheck recursive or mutually recursive capsule definitions.
</p><p>
The Orc typechecker interacts with the Java type system in a relatively sophisticated way. However, since
the Orc typechecker cannot currently express bounded polymorphism, it cannot interface with some Java
types that make use of Java's own bounded polymorphism. Orc's typechecker also does not handle
many cases related to Java intefaces. Lastly, Orc's type join operation on Java types does not currently
compute the full join of Java classes (i.e. the least common ancestor); it will handle limited cases,
such as when one class is a subtype of the other, but it does not compute the least upper bound.
</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N11821"></a>4.1.&nbsp;Simple Typing</h2></div></div></div>

In this section we will see how Orc programs are typechecked, starting with
simple expressions like constants and arithmetic operations, and working up to more interesting
cases such as defined functions, the concurrency combinators, and calls to external services.

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11825"></a>4.1.1.&nbsp;Values and Operators</h3></div></div></div><p>
Each of the Orc constants has the expected type:

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-literal">true</span> , <span class="hl-literal">false</span></code><code class="code"> :: </code><code class="code"><span class="hl-variable">Boolean</span></code></li><li> ... <code class="code"> -<span class="hl-literal">1</span>, <span class="hl-literal">0</span>, <span class="hl-literal">1</span> </code> ... <code class="code"> :: </code><code class="code"><span class="hl-variable">Integer</span></code></li><li> ... <code class="code"> <span class="hl-literal">"orc"</span> , <span class="hl-literal">"ceci n'est pas une |"</span></code> ... <code class="code"> :: </code><code class="code"><span class="hl-variable">String</span></code></li><li> ... <code class="code"> <span class="hl-literal">0.001</span>, -<span class="hl-literal">1.5</span>, <span class="hl-literal">2.71828</span> </code> ... <code class="code"> :: </code><code class="code"><span class="hl-variable">Number</span></code></li></ul></div>

The expression <code class="code"><span class="hl-keyword">signal</span></code> has its own unique type, <code class="code"><span class="hl-variable">Signal</span></code>.
</p><p>
Orc allows <span class="emphasis"><em>subtyping</em></span>: some types are included in other types. For example,
Integer is a subtype of Number, because all Integers are also Numbers. 
</p><p>
Each of the primitive operators typechecks in the obvious way; for example <code class="code">&amp;&amp;</code> requires
two Boolean operands and returns a Boolean result. Some of the arithmetic operators also support
<span class="emphasis"><em>ad-hoc polymorphism</em></span>; for example, a <code class="code">+</code> expression with two Integer 
operands has type Integer, but with one or more Number operands it instead has type Number. 


</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11864"></a>4.1.2.&nbsp;
                    <code class="code"><span class="hl-variable">Top</span></code> and <code class="code"><span class="hl-variable">Bot</span></code>
                </h3></div></div></div><p>
There are two other important types: <code class="code"><span class="hl-variable">Top</span></code> and <code class="code"><span class="hl-variable">Bot</span></code>. 
</p><p>
<code class="code"><span class="hl-variable">Top</span></code> is the universal type; it is the type of any value, and all other types are subtypes 
of it. 
</p><p>
<code class="code"><span class="hl-variable">Bot</span></code> is the empty type; no value has type <code class="code"><span class="hl-variable">Bot</span></code>. It is a subtype of all other
types. Expressions with type <code class="code"><span class="hl-variable">Bot</span></code> are expressions that the typechecker can verify will
never publish any values. In particular, <code class="code"><span class="hl-keyword">stop</span></code> will never publish, so it has type <code class="code"><span class="hl-variable">Bot</span></code>.
</p><p>
<code class="code"><span class="hl-variable">Bot</span></code> has an interesting status in Orc. In other typed languages, if an expression
has type <code class="code"><span class="hl-variable">Bot</span></code>, this usually indicates a guaranteed error, infinite loop, or other failure
to return a value. Since sequential programming rarely involves subexpressions that are guaranteed
never to return, <code class="code"><span class="hl-variable">Bot</span></code> is usually just a curiosity or a formal artifact of the type system,
and indeed many static type systems do not have a <code class="code"><span class="hl-variable">Bot</span></code> type at all. 
In Orc, however, <code class="code"><span class="hl-variable">Bot</span></code> is very useful, since it is frequently the case that Orc expressions 
are written to carry out ongoing concurrent activities but never publish any values, and the type system 
can use the type <code class="code"><span class="hl-variable">Bot</span></code> to indicate that no publications will ever be seen from such
expressions.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1189F"></a>4.1.3.&nbsp;Tuples</h3></div></div></div><p>
The type of a tuple is a tuple of the types of each of its elements.

<div class="itemizedlist"><ul type="disc"><li><code class="code">(<span class="hl-literal">3</span>+<span class="hl-literal">3</span>, <span class="hl-literal">true</span>) :: (<span class="hl-variable">Integer</span>, <span class="hl-variable">Boolean</span>)</code></li><li><code class="code">(<span class="hl-literal">"orc"</span>, (<span class="hl-literal">2</span>, <span class="hl-literal">"orc"</span>)) :: (<span class="hl-variable">String</span>, (<span class="hl-variable">Integer</span>, <span class="hl-variable">String</span>))</code></li></ul></div>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N118AC"></a>4.1.4.&nbsp;Combinators</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N118AF"></a>4.1.4.1.&nbsp;Parallel</h4></div></div></div><p>
The type of F <code class="code"><span class="hl-combinator">|</span></code> G is the <span class="emphasis"><em>join</em></span> of the types of F and G.
</p><p>
A <span class="emphasis"><em>common supertype</em></span> of two types S and T is any type U such that 
S and T are both subtypes of U. The join J is the <span class="emphasis"><em>least</em></span> common 
supertype of S and T, that is, J is a common supertype, and J is also a subtype of every other 
common supertype.
</p><p>
The most common case is the join of a type T with itself. Then the join is just T.
This happens when both parallel branches publish the same type of values.

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-literal">3</span>+<span class="hl-literal">4</span> <span class="hl-combinator">|</span> <span class="hl-literal">5</span>  ::  <span class="hl-variable">Integer</span></code></li></ul></div>
</p><p>
If S is a subtype of T, the join of S and T is T. This happens when one branch
is publishing a less specific type of value. To be safe, the whole expression
then has that less specific type.

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">3.1</span>  ::  <span class="hl-variable">Number</span></code></li></ul></div>

</p><p>
As a special case, the join of any type T with <code class="code"><span class="hl-variable">Bot</span></code> is T. This occurs
when one branch publishes values and the other one never publishes. Thus, it is
safe to use the type of values from the first branch, since the second branch
contributes no values at all.

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-literal">"all quiet on the western front"</span> <span class="hl-combinator">|</span> <span class="hl-site">EasternFront</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>  ::  <span class="hl-variable">String</span></code></li></ul></div>
 
</p><p>
In any other case, the typechecker will try to infer the join. However, it
may not always find the least supertype, and in some cases there may not
even be a useful common supertype. In these cases it will default to
the <code class="code"><span class="hl-variable">Top</span></code> type, which is a supertype of all other types, and is
therefore always a common supertype, if not a very useful one.

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">"three"</span>  ::  <span class="hl-variable">Top</span></code></li></ul></div>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N118E4"></a>4.1.4.2.&nbsp;Sequential</h4></div></div></div><p>
The type of F <code class="code">&gt;<span class="hl-variable">x</span>&gt;</code> G is the type of G using the assumption x :: T, where T is the type of F.
</p><p>
If a pattern is used instead of a variable, the structure of the pattern must match the structure
of the type of F, and the types for each variable bound in G are taken from the corresponding
pieces of the type of F. For example, in the expression F <code class="code">&gt;(<span class="hl-variable">x</span>,<span class="hl-variable">b</span>)&gt;</code> G,
where F <code class="code">:: (<span class="hl-variable">Integer</span>, <span class="hl-variable">Boolean</span>)</code>, G is typechecked with the assumptions <code class="code"><span class="hl-variable">x</span> :: <span class="hl-variable">Integer</span></code>
and <code class="code"><span class="hl-variable">b</span> :: <span class="hl-variable">Boolean</span></code>.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N118FA"></a>4.1.4.3.&nbsp;Pruning</h4></div></div></div><p>
The type of F <code class="code">&lt;<span class="hl-variable">x</span>&lt;</code> G is the type of F using the assumption x :: T, where T is the type of G.
</p><p>
When a declaration <code class="code"><span class="hl-keyword">val</span> <span class="hl-variable">x</span> = </code> F occurs, the expression in scope for the declaration
is typechecked using the assumption x :: T, where T is the type of F.
</p><p>
Patterns in the pruning combinator and in <code class="code"><span class="hl-keyword">val</span></code> declarations are typechecked in the same way as in the sequential combinator.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="N1190C"></a>4.1.4.4.&nbsp;Otherwise</h4></div></div></div><p>
The type of F <code class="code"><span class="hl-combinator">;</span></code> G is the <span class="emphasis"><em>join</em></span> of the types of F and G, as described for the parallel combinator.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11917"></a>4.1.5.&nbsp;Conditionals</h3></div></div></div><p>
In the conditional expression <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> F <code class="code"><span class="hl-keyword">else</span></code> G, the expression E must have type
<code class="code"><span class="hl-variable">Boolean</span></code>, and the type of the whole expression is the join of the types of F and G, as described for the
parallel combinator.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11928"></a>4.1.6.&nbsp;Defined Functions</h3></div></div></div><p>
Though the typechecker can infer the types of many expressions without additional information from the programmer, there are some
cases where the algorithm does need assistance. In particular, whenever a function is defined (using the <code class="code"><span class="hl-keyword">def</span></code> keyword),
the programmer must also include a <span class="emphasis"><em>signature</em></span> for that function, supplying its argument types and return type.
</p><p>
A signature immediately precedes a function definition, and is written as follows:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">magsq</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span>
<span class="hl-keyword">def</span> <span class="hl-site">magsq</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-variable">x</span>*<span class="hl-variable">x</span> + <span class="hl-variable">y</span>*<span class="hl-variable">y</span>
</pre>

Argument types replace the arguments, <code class="code">::</code> replaces <code class="code">=</code>, and the return type (the type of the body expression)
replaces the body expression. If the function is not recursive, then the return type is optional, because the typechecker can infer it from
the body expression without additional information. So, in this case, we could have just written:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">magsq</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>)
<span class="hl-keyword">def</span> <span class="hl-site">magsq</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-variable">x</span>*<span class="hl-variable">x</span> + <span class="hl-variable">y</span>*<span class="hl-variable">y</span>
</pre>
</p><p>
It is also possible to include the argument types and return type directly in a definition, rather than as a separate signature. 
The signature and definition above could be written together as:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">magsq</span>(<span class="hl-variable">x</span> :: <span class="hl-variable">Number</span>, <span class="hl-variable">y</span> :: <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span> = <span class="hl-variable">x</span>*<span class="hl-variable">x</span> + <span class="hl-variable">y</span>*<span class="hl-variable">y</span>
</pre>

An argument <code class="code"><span class="hl-variable">x</span></code> with type <code class="code"><span class="hl-variable">T</span></code> is replaced by <code class="code"><span class="hl-variable">x</span> :: <span class="hl-variable">T</span></code> in the argument list. The return type is inserted
between the argument list and the <code class="code">=</code> sign. This form is not typically used for functions with multiple clauses or pattern
matches, though it is allowed in those cases so long as only one clause has the type information.
</p><p>
<code class="code"><span class="hl-keyword">lambda</span></code> expressions are a special case: the type information must be included directly in this way,
since there is no way to declare the signature separately. Specifying the return type of a lambda is always optional,
since it is not possible for an anonymous function to make a recursive call. Written as a typed lambda function, the <code class="code"><span class="hl-variable">magsq</span></code>
definition looks like:

<pre class="programlisting">
<span class="hl-keyword">lambda</span> (<span class="hl-variable">x</span> :: <span class="hl-variable">Number</span>, <span class="hl-variable">y</span> :: <span class="hl-variable">Number</span>) = <span class="hl-variable">x</span>*<span class="hl-variable">x</span> + <span class="hl-variable">y</span>*<span class="hl-variable">y</span>
</pre>

When the typechecker has enough information to check the type of a lambda against a given function type, rather than needing to infer it, 
the argument types of the lambda are also optional. This occurs, for example, when a lambda is given as an argument to a defined higher-order function.
</p><p>
Once defined, functions are values, and thus have a special type of their own. The type of a function is written
very much like a signature, but using the <code class="code"><span class="hl-keyword">lambda</span></code> keyword instead of <code class="code"><span class="hl-keyword">def</span></code> and the function
name.

<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-variable">magsq</span></code>, defined earlier, has type <code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code></li><li><code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">x</span> :: <span class="hl-variable">Integer</span>) = <span class="hl-variable">x</span>+<span class="hl-literal">1</span></code>  has type  <code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span></code></li><li><code class="code"><span class="hl-keyword">lambda</span> () = <span class="hl-keyword">signal</span></code> has type <code class="code"><span class="hl-keyword">lambda</span> () :: <span class="hl-variable">Top</span></code></li><li><code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">a</span> :: <span class="hl-variable">Boolean</span>, <span class="hl-variable">b</span> :: <span class="hl-variable">Boolean</span>) = (<span class="hl-variable">b</span>,<span class="hl-variable">a</span>)</code> has type <code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">Boolean</span>,<span class="hl-variable">Boolean</span>) :: (<span class="hl-variable">Boolean</span>,<span class="hl-variable">Boolean</span>)</code></li></ul></div>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11984"></a>4.1.7.&nbsp;Ascriptions</h3></div></div></div><p>
In addition to annotation defined functions with a signature, the typechecker can also accept programmer-supplied type
information for any expression. An <span class="emphasis"><em>ascription</em></span>, written E <code class="code">::</code> T, asks the typechecker 
to verify that expression E has type T.
</p><p>
Normally, the typechecker would simply find the type of E by inference, but in certain situations it is easier to check
a given type. For example, the typechecker may not be able to infer the correct join type for a parallel combinator,
but it is always able to check that both branches are subtypes of an already provided type. Furthermore, adding extra
type information makes it easier to pinpoint the source of a typechecking failure.
</p><p>
Ascriptions are also allowed in patterns; P <code class="code">::</code> T is a valid pattern, instructing the typechecker to verify
that the value fragment bound by the pattern P will always be of type T.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11996"></a>4.1.8.&nbsp;Aliasing</h3></div></div></div>

When adding function signatures and ascriptions, it is often helpful to have simpler names for
complex types that frequently occur. In the same way that variable binding can be used to give
a name to a complex value, there is a type declaration that binds a complex type to a type variable.
This is called <span class="emphasis"><em>aliasing</em></span>, and it is accomplished using the <code class="code"><span class="hl-keyword">type</span></code>
definition. 

<pre class="programlisting">
<span class="hl-comment">-- A rectangle is defined by its lower left and upper right coordinates.</span>
<span class="hl-keyword">type</span> <span class="hl-variable">Rect</span> = ((<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>), (<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>))

<span class="hl-comment">-- Transpose such a rectangle, rotating it around an x=y axis</span>
<span class="hl-keyword">def</span> <span class="hl-site">flip</span>(<span class="hl-variable">Rect</span>) :: <span class="hl-variable">Rect</span>
<span class="hl-keyword">def</span> <span class="hl-site">flip</span>( ((<span class="hl-variable">a</span>, <span class="hl-variable">b</span>), (<span class="hl-variable">c</span>, <span class="hl-variable">d</span>)) ) = ((<span class="hl-variable">a</span>, <span class="hl-variable">b</span>), (<span class="hl-variable">d</span>, <span class="hl-variable">c</span>))
</pre>

While it does not change the behavior of the typing algorithm, aliasing can substantially improve
readability and make the intention of one's code much clearer.

</div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N119A4"></a>4.1.9.&nbsp;Datatypes</h3></div></div></div>

We have already seen user-defined datatypes in the untyped Orc language. In the typed language, they are
declared in the same way, except that the slots in the datatype, which previously were always <code class="code"><span class="hl-variable">_</span></code>,
now contain the actual types that go in those slots. As an example, here is a datatype for geometric
shapes.

<pre class="programlisting">
<span class="hl-comment">{- 
  Rect(w,h): A rectangle with width w and height h. 
  Circle(r): A circle with radius r.
  RegularPolygon(n,l): A regular polygon with n sides, each of length l.
-}</span>
<span class="hl-keyword">type</span> <span class="hl-variable">Shape</span> = <span class="hl-site">Rect</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) <span class="hl-combinator">|</span> <span class="hl-site">Circle</span>(<span class="hl-variable">Number</span>) <span class="hl-combinator">|</span> <span class="hl-site">RegularPolygon</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">Number</span>)
</pre>

We will see how to declare generic datatypes, like <code class="code"><span class="hl-variable">Tree</span></code> or <code class="code"><span class="hl-variable">Option</span></code>, in the next section.

</div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N119B5"></a>4.1.10.&nbsp;Interacting with External Services</h3></div></div></div>

In addition to verifying the correctness of code written within Orc itself, the typechecker must also ensure that
external services are used correctly in the context of the Orc program. 

<p>
When an external site is made available to Orc with the <code class="code"><span class="hl-keyword">site</span></code> declaration, its type is also
made available to the Orc typechecker. The type of a site is itself treated like a service; it is passed
the types of its arguments, and responds with a return type for those arguments. Thus, a site call can typecheck
in ways not possible for function calls or other expressions. For example, sites can support ad-hoc polymorphism.
Also, sites can respond to messages sent using the dot operator. In fact, Orc has no native record type, because
the dot operator only applies to sites, so the type of the site can interpret the message internally
and determine the correct type to return, if any. 
</p><p>
Additionally, a site can introduce new types into Orc. For example, the <code class="code"><span class="hl-variable">Semaphore</span></code> site responds with
new instances of semaphores. And just as sites can be declared using <code class="code"><span class="hl-keyword">site</span></code>, these types can be
declared using <code class="code"><span class="hl-keyword">type</span></code>. Typically they are represented as Java classes, just as sites are. As an example,
here is a program which declares the <code class="code"><span class="hl-variable">Semaphore</span></code> type, and then defines a function which "toggles" a pair 
of semaphores by acquiring the first and releasing the second.

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-variable">Semaphore</span> = <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">state</span>.<span class="hl-variable">types</span>.<span class="hl-variable">SemaphoreType</span>

<span class="hl-keyword">def</span> <span class="hl-site">toggle</span>(<span class="hl-variable">Semaphore</span>, <span class="hl-variable">Semaphore</span>) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">toggle</span>(<span class="hl-variable">s</span>, <span class="hl-variable">t</span>) = <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">t</span>.<span class="hl-site">release</span>()
</pre>

Notice that it is not possible to typecheck <code class="code"><span class="hl-variable">toggle</span></code> without first giving a name to the Semaphore type,
because it is used in the signature of <code class="code"><span class="hl-variable">toggle</span></code>.
</p><p>
<code class="code"><span class="hl-keyword">type</span></code> definitions occur alongside <code class="code"><span class="hl-keyword">site</span></code> definitions in the standard library, so the
types returned by many of the library functions are already available.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N119DE"></a>4.1.11.&nbsp;Assertions</h3></div></div></div><p>
While the typechecker can be helpful, it will not accept programs that are not safe according to
its algorithm, which can be burdensome when the programmer knows that an expression will have a
certain type but the typechecker cannot verify it.
</p><p>
Since the typechecker is optional, it can always be turned off in these cases. But this is often
too drastic a solution: typechecking difficulties often arise from small segments of a much larger
program, and the rest of the program still benefits from typechecking. 
</p><p>
Fortunately, the typechecker can be selectively disabled for parts of a program. For this purpose,
the typechecker supports a special operation called an <span class="emphasis"><em>assertion</em></span>, written 
E <code class="code"> :!: </code> T, where E is an expression and T is its asserted type. An assertion 
is used like an ascription, but rather than verifying that E has type T, the typechecker instead
assumes that E has type T, without inspecting E at all. Thus, the programmer can supply the correct
type T without being restricted by the typechecking algorithm.
</p><p>
This feature should be used sparingly, with the knowledge that it does compromise the integrity
of the typechecking algorithm. If the supplied type is wrong, runtime type errors could propagate to any
part of the program that depends on that type. Assertions are useful for rapid prototyping, but
they are not recommended for production code.
</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N119EF"></a>4.2.&nbsp;Polymorphism</h2></div></div></div>

In this section we examine a powerful feature of Orc's typechecker: <span class="emphasis"><em>parametric polymorphism</em></span>.
This allows us to define types that take other types as parameters; the same theory underlies Java's generics.


 
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N119F6"></a>4.2.1.&nbsp;Parametric types</h3></div></div></div><p>
What is the type of <code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>]</code>? It is a list, containing Integers. What about <code class="code">[<span class="hl-literal">true</span>, <span class="hl-literal">true</span>]</code>?
Again a list, but it contains Booleans instead. It would be very cumbersome to have separate types such
as <code class="code"><span class="hl-variable">IntegerList</span></code> and <code class="code"><span class="hl-variable">BooleanList</span></code> for each of these possibilities, and in fact
infinitely many such types are possible. What we would like instead is one <code class="code"><span class="hl-variable">List</span></code> type, with
a parameter which gives us the types contained in the list.
</p><p>
Such a type is called a parametric, or generic, type. It contains two parts: a type operator, such as
<code class="code"><span class="hl-variable">List</span></code>, followed by a sequence of paramemters enclosed in brackets <code class="code">[...]</code>. 
For example, <code class="code">[<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>] :: <span class="hl-site">List</span>[<span class="hl-variable">Integer</span>]</code>, and <code class="code">[<span class="hl-literal">true</span>,<span class="hl-literal">true</span>] :: <span class="hl-site">List</span>[<span class="hl-variable">Boolean</span>]</code>.
</p><p>
Lists are not the only parametric type. The standard library includes other parametric types, such as
<code class="code"><span class="hl-variable">Option</span></code>, <code class="code"><span class="hl-variable">Buffer</span></code>, and <code class="code"><span class="hl-variable">Cell</span></code>. Type operators, such as <code class="code"><span class="hl-variable">List</span></code>,
are declared using the same <code class="code"><span class="hl-keyword">type</span></code> declarations as any other type. For example, the
declaration

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-variable">Buffer</span> = <span class="hl-variable">orc</span>.<span class="hl-variable">lib</span>.<span class="hl-variable">state</span>.<span class="hl-variable">types</span>.<span class="hl-variable">BufferType</span>
</pre>

is part of the standard library; it declares the <code class="code"><span class="hl-variable">Buffer</span></code> type operator. 
 
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11A30"></a>4.2.2.&nbsp;Parametric functions</h3></div></div></div><p>
How do we write functions that use parametric types? Consider the following definition
of the <code class="code"><span class="hl-variable">append</span></code> function, which appends two lists:

<pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">append</span>[<span class="hl-variable">T</span>](<span class="hl-site">List</span>[<span class="hl-variable">T</span>], <span class="hl-site">List</span>[<span class="hl-variable">T</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">T</span>]
<span class="hl-keyword">def</span> <span class="hl-site">append</span>([], <span class="hl-variable">l</span>) = <span class="hl-variable">l</span>
<span class="hl-keyword">def</span> <span class="hl-site">append</span>(<span class="hl-variable">h</span>::<span class="hl-variable">t</span>, <span class="hl-variable">l</span>) = <span class="hl-variable">h</span>::<span class="hl-site">append</span>(<span class="hl-variable">t</span>,<span class="hl-variable">l</span>)
</pre>

The function <code class="code"><span class="hl-variable">append</span></code> has a <span class="emphasis"><em>type argument</em></span>, T, in its
signature. The type T is the type of elements in the lists that we are appending. Notice that both argument
lists must contain the same type of elements. The resulting list contains elements of that same type.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11A42"></a>4.2.3.&nbsp;Generic calls</h3></div></div></div><p>
When calling the <code class="code"><span class="hl-variable">append</span></code> function, in addition to providing its normal arguments, we must
also provide its type argument:

<pre class="programlisting">
<span class="hl-site">append</span>[<span class="hl-variable">Integer</span>]([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>], [<span class="hl-literal">4</span>,<span class="hl-literal">5</span>])
</pre>

However, it would be very burdensome and verbose to provide type arguments to all such calls. Fortunately,
in most cases, the type checker can infer the correct type arguments, in the same way that it infers
the correct type for many expressions without any additional information. So in this case, we can
simply write:

<pre class="programlisting">
<span class="hl-site">append</span>([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>], [<span class="hl-literal">4</span>,<span class="hl-literal">5</span>])
</pre>

and the typechecker infers that the parameter T is <code class="code"><span class="hl-variable">Integer</span></code>, since both argument lists are
of type <code class="code"><span class="hl-site">List</span>[<span class="hl-variable">Integer</span>]</code>. For a more thorough explanation of how this inference occurs, please
refer to Pierce and Turner's paper.
</p><p>
Inference of type arguments will always fail on certain kinds of calls, because the typechecker does
not have enough information to infer the correct type. The most common case is a site call which
constructs a parametric type without taking any arguments. For example:

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">Buffer</span>()
</pre>

will never typecheck, since there is no way for the typechecker to know what type of elements the
buffer should contain. In other languages such as ML, the typechecker might be able to infer this information
from the rest of the program, but Orc's typechecker is based on <span class="emphasis"><em>local</em></span> type inference,
which must find the information locally, such as from the types of the arguments. So, to construct
a buffer that will contain Numbers, a type parameter must be given:

<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">Buffer</span>[<span class="hl-variable">Number</span>]()
</pre>

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11A65"></a>4.2.4.&nbsp;Polymorphic aliases</h3></div></div></div><p>
A type alias may have type parameters. For example, here is a type alias for triples:

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-site">Triple</span>[<span class="hl-variable">T</span>] = (<span class="hl-variable">T</span>,<span class="hl-variable">T</span>,<span class="hl-variable">T</span>)
</pre>

<code class="code"><span class="hl-variable">Triple</span></code> is now a type operator that takes one parameter. Any occurrence of
<code class="code"><span class="hl-site">Triple</span>[<span class="hl-variable">T</span>]</code> is equivalent to <code class="code">(<span class="hl-variable">T</span>,<span class="hl-variable">T</span>,<span class="hl-variable">T</span>)</code>.

</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N11A77"></a>4.2.5.&nbsp;Polymorphic datatypes</h3></div></div></div><p>
Datatypes can also have type parameters. This allows a programmer to
define very useful generic data structures. For example, this is necessary
to define a reasonable datatype for trees:

<pre class="programlisting">
<span class="hl-keyword">type</span> <span class="hl-site">Tree</span>[<span class="hl-variable">T</span>] = <span class="hl-site">Node</span>(<span class="hl-site">Tree</span>[<span class="hl-variable">T</span>], <span class="hl-site">Tree</span>[<span class="hl-variable">T</span>], <span class="hl-variable">T</span>) <span class="hl-combinator">|</span> <span class="hl-site">Leaf</span>()
</pre>

Notice that the datatype is recursive, and the type parameter <code class="code"><span class="hl-variable">T</span></code> is
passed recursively to <code class="code"><span class="hl-variable">Tree</span></code> to define the type of the subtrees. 

</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N11A86"></a>4.3.&nbsp;Interacting with Java</h2></div></div></div><p>
When a Java class is made accessible to Orc using the <code class="code"><span class="hl-keyword">class</span></code> declaration,
the Orc typechecker interacts with the Java type system to make Java types available
in Orc. This feature is experimental and does not allow access to all of Java's typing
features (for example, interfaces are not fully supported), but it does allow
the typechecker to handle many of the common cases.
</p><p>
The type returned by the constructor of a class has the same name in Orc as the class.
It is the Orc type of Java objects of that class.

<pre class="programlisting">
<span class="hl-keyword">class</span> <span class="hl-variable">File</span> = <span class="hl-variable">java</span>.<span class="hl-variable">io</span>.<span class="hl-variable">File</span>
<span class="hl-site">File</span>(<span class="hl-literal">"test.orc"</span>) :: <span class="hl-variable">File</span>
</pre>
</p><p>
If a <code class="code"><span class="hl-keyword">class</span></code> declaration binds a generic Java class, that type shows up
in Orc as a parametric type, and its constructor takes type arguments. For example:

<pre class="programlisting">
<span class="hl-keyword">class</span> <span class="hl-variable">TreeSet</span> = <span class="hl-variable">java</span>.<span class="hl-variable">util</span>.<span class="hl-variable">TreeSet</span>
<span class="hl-site">TreeSet</span>[<span class="hl-variable">String</span>]() :: <span class="hl-site">TreeSet</span>[<span class="hl-variable">String</span>]
</pre>
</p><p>
There is a correspondence between Orc's primitive types and the equivalent classes
in Java; they are interchangeable. For example, a call expecting a <code class="code"><span class="hl-variable">java</span>.<span class="hl-variable">lang</span>.<span class="hl-variable">Integer</span></code>
can be given an Orc <code class="code"><span class="hl-variable">Integer</span></code>.
</p><p>
Subtyping between Java object types is determined by Java's subtyping relation: if
one class is a subclass of the other, then one type will be a subtype of the other.
The typechecker does not implement support a full join operation for Java types; it will
not find the least common ancestor of two classes as the join.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N11AA7"></a>4.4.&nbsp;Syntax of Typed Orc</h2></div></div></div><p>
The following figure summarizes the syntax of typed Orc as an extension of untyped Orc. 
The original Orc grammar rules are abbreviated by ellipses (...). 
</p><p>
<div class="table"><a name="types-ebnf-table"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;Typed Orc</b></p><div class="table-contents"><table summary="Typed Orc" border="0" width="80%"><colgroup><col align="right"><col align="center"><col align="left"><col align="left"><col align="left"></colgroup><tbody><tr><td align="right">T</td><td align="center">::=</td><td align="left"> </td><td align="left">
                                    <span class="emphasis"><em>Type</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Type variable</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-variable">Integer</span></code> | <code class="code"><span class="hl-variable">Boolean</span></code> | <code class="code"><span class="hl-variable">String</span></code> | <code class="code"><span class="hl-variable">Number</span></code> | <code class="code"><span class="hl-variable">Signal</span></code> | <code class="code"><span class="hl-variable">Top</span></code> | <code class="code"><span class="hl-variable">Bot</span></code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Ground type</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Tuple type</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">lambda</span></code> <code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code>
                                    <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code> <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Function type</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X<code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>Type application</em></span>
                                </td></tr><tr><td align="right">D</td><td align="center">::=</td><td align="left"> ... </td><td align="left">
                                    <span class="emphasis"><em>Declaration</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">type</span></code> X <code class="code">=</code> <span class="emphasis"><em>classname</em></span>
                                </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type import</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">type</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code> <code class="code">=</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type alias</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">type</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code> <code class="code">=</code> TC | ... | TC </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>datatype declaration (typed)</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">def</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code>
                                    <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code> <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>function signature</em></span>
                                </td></tr><tr><td align="right">TC</td><td align="center">::=</td><td align="left"> X<code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code>  </td><td align="left">
                                    <span class="emphasis"><em>Constructor (typed)</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">E</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Expression</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type ascription</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code">:!:</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type assertion</em></span>
                                </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                    <code class="code"><span class="hl-keyword">lambda</span></code>
                                    <code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code>
                                    <code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                                    <code class="code">::</code> T <code class="code">=</code> E </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>closure (typed)</em></span>
                                </td></tr><tr><td align="right">G</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Argument group</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left"> <code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code> <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code> </td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type parameters plus arguments</em></span>
                                </td></tr><tr><td align="right">P</td><td align="center">::=</td><td align="left">...</td><td align="left">
                                    <span class="emphasis"><em>Pattern</em></span>
                                </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">P <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                    <span class="emphasis"><em>type ascription</em></span>
                                </td></tr></tbody></table></div></div><br class="table-break">
</p></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="N11CAC"></a>Appendix&nbsp;A.&nbsp;Complete Syntax of Orc</h2></div></div></div><p>

<div class="table"><a name="full-ebnf-grammar"></a><p class="title"><b>Table&nbsp;A.1.&nbsp;Complete Syntax of Orc</b></p><div class="table-contents"><table summary="Complete Syntax of Orc" border="0" width="80%"><colgroup><col align="right"><col align="center"><col align="left"><col align="left"><col align="left"></colgroup><tbody><tr><td align="right">E</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Expression</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">C</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>constant value</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>variable</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">stop</span></code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>silent expression</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>tuple</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">[</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">]</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>list</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E G+</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>call</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <span class="emphasis"><em>op</em></span> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>prefix operator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <span class="emphasis"><em>op</em></span> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>infix operator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E<code class="code"> <span class="hl-combinator">&gt;</span></code>P<code class="code"><span class="hl-combinator">&gt;</span> </code>E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>sequential combinator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code"><span class="hl-combinator">|</span></code> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>parallel combinator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E<code class="code"> <span class="hl-combinator">&lt;</span></code>P<code class="code"><span class="hl-combinator">&lt;</span> </code>E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>pruning combinator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code"><span class="hl-combinator">;</span></code> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>otherwise combinator</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">lambda</span> (</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code> <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>closure (untyped)</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">lambda</span></code>
                                <code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code>
                                <code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                                <code class="code">::</code> T <code class="code">=</code> E </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>closure (typed)</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">if</span></code> E <code class="code"><span class="hl-keyword">then</span></code> E <code class="code"><span class="hl-keyword">else</span></code> E </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>conditional</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">D E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>scoped declaration</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type ascription</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">E <code class="code">:!:</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type assertion</em></span>
                            </td></tr><tr><td align="right">G</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Argument group</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left"> <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code> </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>arguments</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left"> <code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code> <code class="code">(</code> E <code class="code">,</code> ... <code class="code">,</code> E <code class="code">)</code> </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type parameters plus arguments</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left"> <code class="code">.</code>
                                <span class="emphasis"><em>field</em></span> </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>field access</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left"> <code class="code"><span class="hl-site">?</span></code> </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>dereference</em></span>
                            </td></tr><tr><td align="right">C</td><td align="center">::=</td><td align="left">
                                <span class="emphasis"><em>Boolean</em></span> | <span class="emphasis"><em>Number</em></span> | <span class="emphasis"><em>String</em></span> | <code class="code"><span class="hl-keyword">signal</span></code> | <code class="code"><span class="hl-literal">null</span></code>
                            </td><td align="left">
                                <span class="emphasis"><em>Constant</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">X</td><td align="center">::=</td><td align="left">
                                <span class="emphasis"><em>identifier</em></span>
                            </td><td align="left">
                                <span class="emphasis"><em>Variable</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">D</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Declaration</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">
                                <code class="code"><span class="hl-keyword">val</span></code> P <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>value declaration</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">site</span></code> X <code class="code">=</code> <span class="emphasis"><em>address</em></span>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>site declaration</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">class</span></code> X <code class="code">=</code> <span class="emphasis"><em>classname</em></span>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>class declaration</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">include</span></code> <code class="code"><span class="hl-literal">"</span></code> <span class="emphasis"><em>filename</em></span> <code class="code"><span class="hl-literal">"</span></code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>inclusion</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">def</span></code> X<code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code> <code class="code">=</code> E</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>function declaration</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">def</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code>
                                <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code> <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>function signature</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">type</span></code> X <code class="code">=</code> <span class="emphasis"><em>classname</em></span>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type import</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">type</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code> <code class="code">=</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type alias</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">type</span></code> X <code class="code">=</code> UC | ... | UC </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>datatype declaration (untyped)</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">type</span></code> X<code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code> <code class="code">=</code> TC | ... | TC </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>datatype declaration (typed)</em></span>
                            </td></tr><tr><td align="right">UC</td><td align="center">::=</td><td align="left"> X<code class="code">(<span class="hl-variable">_</span>,</code> ... <code class="code">,<span class="hl-variable">_</span>)</code> </td><td align="left">
                                <span class="emphasis"><em>Constructor (untyped)</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">TC</td><td align="center">::=</td><td align="left"> X<code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code>  </td><td align="left">
                                <span class="emphasis"><em>Constructor (typed)</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">P</td><td align="center">::=</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Pattern</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>variable</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">C</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>constant</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-variable">_</span></code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>wildcard</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X <code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>datatype pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">(</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">)</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>tuple pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">[</code> P <code class="code">,</code> ... <code class="code">,</code> P <code class="code">]</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>list pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">P <code class="code">:</code> P</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>cons pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">P <code class="code"><span class="hl-keyword">as</span></code> X</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>as pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">=</code>X</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>equality pattern</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">P <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>type ascription</em></span>
                            </td></tr><tr><td align="right">T</td><td align="center">::=</td><td align="left">  </td><td align="left">
                                <span class="emphasis"><em>Type</em></span>
                            </td><td align="left">&nbsp;</td></tr><tr><td align="right">&nbsp;</td><td align="center">&nbsp;</td><td align="left">X</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Type variable</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-variable">Integer</span></code> | <code class="code"><span class="hl-variable">Boolean</span></code> | <code class="code"><span class="hl-variable">String</span></code> | <code class="code"><span class="hl-variable">Number</span></code> | <code class="code"><span class="hl-variable">Signal</span></code> | <code class="code"><span class="hl-variable">Top</span></code> | <code class="code"><span class="hl-variable">Bot</span></code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Ground type</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Tuple type</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">
                                <code class="code"><span class="hl-keyword">lambda</span></code> <code class="code">[</code> X <code class="code">,</code> ... <code class="code">,</code> X <code class="code">]</code> <code class="code">(</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">)</code> <code class="code">::</code> T</td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Function type</em></span>
                            </td></tr><tr><td align="right">&nbsp;</td><td align="center">|</td><td align="left">X<code class="code">[</code> T <code class="code">,</code> ... <code class="code">,</code> T <code class="code">]</code>
                            </td><td align="left">&nbsp;</td><td align="left">
                                <span class="emphasis"><em>Type application</em></span>

                            </td></tr></tbody></table></div></div><br class="table-break">
</p><p>
Where relevant, syntactic constructs are ordered by precedence, from highest to lowest. For example, among expressions, calls have higher precedence than
any of the combinators, which in turn have higher precedence than conditionals.
</p></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix.library"></a>Appendix&nbsp;B.&nbsp;Standard Library</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#N12140">B.1. Overview</a></span></dt><dt><span class="section"><a href="#N1214A">B.2. Types and Notation</a></span></dt><dt><span class="section"><a href="#N12166">B.3. Reference</a></span></dt><dd><dl><dt><span class="section"><a href="#N1216A">B.3.1. core.inc: Fundamental sites and operators.</a></span></dt><dt><span class="section"><a href="#N123F9">B.3.2. state.inc: General-purpose supplemental data structures.</a></span></dt><dt><span class="section"><a href="#N12AA2">B.3.3. idioms.inc: Higher-order Orc programming idioms.</a></span></dt><dt><span class="section"><a href="#N12CD7">B.3.4. list.inc: Operations on lists.</a></span></dt><dt><span class="section"><a href="#N130B9">B.3.5. reflect.inc: Metalanguage operations.</a></span></dt><dt><span class="section"><a href="#N130E5">B.3.6. text.inc: Operations on strings.</a></span></dt><dt><span class="section"><a href="#N131E6">B.3.7. time.inc: Real and logical time.</a></span></dt><dt><span class="section"><a href="#N1326B">B.3.8. util.inc: Miscellaneous utility functions.</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N12140"></a>B.1.&nbsp;Overview</h2></div></div></div><p>
The standard library is a set of declarations implicitly available to all Orc
programs.  In this section we give an informal description of the standard library,
including the type of each declaration and a short explanation of its use.
</p><p>
Orc programs are expected to rely on the host language and environment for
all but the most essential sites.  For example, in the Java implementation of
Orc, the entire Java standard library is available to Orc programs via
<code class="code"><span class="hl-keyword">class</span></code> declarations. Therefore the Orc standard library aims only
to provide convenience for the most common Orc idioms, not the complete set of
features needed for general-purpose programming.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N1214A"></a>B.2.&nbsp;Types and Notation</h2></div></div></div><p>
The standard library is fully compatible with the static type checker; all
library declarations have associated type declarations, which also serve as
helpful documentation. 
</p><p>
The documentation of library functions uses special notation for parametric 
types that have dot-accessible members.
Member names are written in the form Type.member, e.g.  <code class="code"><span class="hl-variable">Foo</span>.<span class="hl-variable">get</span></code>
refers to the <code class="code"><span class="hl-variable">get</span></code> member of an object of type <code class="code"><span class="hl-variable">Foo</span></code>.
The object type can include type variables which are referenced by the member
type, so for example <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">get</span>() :: <span class="hl-variable">A</span></code> means that
when the <code class="code"><span class="hl-variable">get</span></code> method is called on a <code class="code"><span class="hl-variable">Buffer</span></code> holding an
arbitrary element type <code class="code"><span class="hl-variable">A</span></code>, it will return a value of the same type.
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N12166"></a>B.3.&nbsp;Reference</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1216A"></a>B.3.1.&nbsp;core.inc: Fundamental sites and operators.</h3></div></div></div><p>Fundamental sites and operators.</p><p>These declarations include both prefix and infix sites (operators).  For
consistency, all declarations are written in prefix form, with the site name
followed by the operands.  When the site name is surrounded in parentheses, as
in <code class="code">(+)</code>, it denotes an infix operator.</p><p>For a more complete description of the built-in operators and their syntax, see
the <a class="link" href="#language.base.operators" title="1.2.2.&nbsp;Operators">Operators</a> section of the
User Guide.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">let</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">let</span>() :: <span class="hl-variable">Top</span></code>
                            </p><p>When applied to no arguments, return a signal.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">let</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">let</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>When applied to a single argument, return that argument (behaving as the identity function).</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">let</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">let</span>[<span class="hl-variable">A</span>, ...](<span class="hl-variable">A</span>, ...) :: (<span class="hl-variable">A</span>, ...)</code>
                            </p><p>When applied to two or more arguments, return the arguments in a tuple.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-keyword">if</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-keyword">if</span>(<span class="hl-variable">Boolean</span>) :: <span class="hl-variable">Top</span></code>

                            </p><p>Fail silently if the argument is false. Otherwise return a signal.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: "Always publishes"</span>
  <span class="hl-keyword">if</span>(<span class="hl-literal">false</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Never publishes"</span>
<span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-literal">true</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Always publishes"</span></pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">error</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">error</span>(<span class="hl-variable">String</span>) :: <span class="hl-variable">Bot</span></code>

                            </p><p>Halt with the given error message.</p><p>Example, using <code class="code"><span class="hl-variable">error</span></code> to implement assertions:
<pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">assert</span>(<span class="hl-variable">b</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">b</span> <span class="hl-keyword">then</span> <span class="hl-keyword">signal</span> <span class="hl-keyword">else</span> <span class="hl-site">error</span>(<span class="hl-literal">"assertion failed"</span>)

<span class="hl-comment">-- Fail with the error message: "assertion failed"</span>
<span class="hl-site">assert</span>(<span class="hl-literal">false</span>)</pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code">(+)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (+)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span>+<span class="hl-variable">b</span></code> returns the sum of <code class="code"><span class="hl-variable">a</span></code> and <code class="code"><span class="hl-variable">b</span></code>.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(-)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (-)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span>-<span class="hl-variable">b</span></code> returns the value of <code class="code"><span class="hl-variable">a</span></code> minus the value of <code class="code"><span class="hl-variable">b</span></code>.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-literal">0</span>-)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (<span class="hl-literal">0</span>-)(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>Return the additive inverse of the argument.
When this site appears as an operator, it is written in prefix form without the
zero, i.e. <code class="code">(-<span class="hl-variable">a</span>)</code>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code">(*)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (*)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span>*<span class="hl-variable">b</span></code> returns the product of <code class="code"><span class="hl-variable">a</span></code> and <code class="code"><span class="hl-variable">b</span></code>.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(**)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (**)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span> ** <span class="hl-variable">b</span></code> returns
<span class="mathphrase">a<sup>b</sup>
                                    </span>,
i.e. <code class="code"><span class="hl-variable">a</span></code> raised to the <code class="code"><span class="hl-variable">b</span></code>th power.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(/)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (/)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>

                                <code class="code"><span class="hl-variable">a</span>/<span class="hl-variable">b</span></code> returns <code class="code"><span class="hl-variable">a</span></code> divided by <code class="code"><span class="hl-variable">b</span></code>.
If both arguments have integral types, <code class="code">(/)</code> performs integral
division, rounding towards zero. Otherwise, it performs floating-point
division. If <code class="code"><span class="hl-variable">b</span>=<span class="hl-literal">0</span></code>, <code class="code"><span class="hl-variable">a</span>/<span class="hl-variable">b</span></code> halts with an error.</p><p>Example:
<pre class="orc">
  <span class="hl-literal">7</span>/<span class="hl-literal">3</span>   <span class="hl-comment">-- publishes 2</span>
<span class="hl-combinator">|</span> <span class="hl-literal">7</span>/<span class="hl-literal">3.0</span> <span class="hl-comment">-- publishes 2.333...</span></pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code">(%)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (%)(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>

                                <code class="code"><span class="hl-variable">a</span>%<span class="hl-variable">b</span></code> computes the remainder of <code class="code"><span class="hl-variable">a</span>/<span class="hl-variable">b</span></code>. If <code class="code"><span class="hl-variable">a</span></code>
and <code class="code"><span class="hl-variable">b</span></code> have integral types, then the remainder is given by
the expression <code class="code"><span class="hl-variable">a</span> - (<span class="hl-variable">a</span>/<span class="hl-variable">b</span>)*<span class="hl-variable">b</span></code>. For a full description, see the
<a class="link" href="http://java.sun.com/docs/books/jls/third_edition/html/expressions.html#15.17.3" target="_top">Java Language Specification, 3rd edition</a>.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(&lt;)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (&lt;)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span> &lt; <span class="hl-variable">b</span></code> returns true if <code class="code"><span class="hl-variable">a</span></code> is less than <code class="code"><span class="hl-variable">b</span></code>, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-site">&lt;=</span>)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (<span class="hl-site">&lt;=</span>)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span> <span class="hl-site">&lt;=</span> <span class="hl-variable">b</span></code> returns true if <code class="code"><span class="hl-variable">a</span></code> is less than or equal to <code class="code"><span class="hl-variable">b</span></code>, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(&gt;)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (&gt;)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span> &gt; <span class="hl-variable">b</span></code> returns true if <code class="code"><span class="hl-variable">a</span></code> is greater than <code class="code"><span class="hl-variable">b</span></code>, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-site">&gt;=</span>)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (<span class="hl-site">&gt;=</span>)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span> <span class="hl-site">&gt;=</span> <span class="hl-variable">b</span></code> returns true if <code class="code"><span class="hl-variable">a</span></code> is greater than or equal to <code class="code"><span class="hl-variable">b</span></code>, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(=)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (=)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>

                                <code class="code"><span class="hl-variable">a</span> = <span class="hl-variable">b</span></code> returns true if <code class="code"><span class="hl-variable">a</span></code> is equal to <code class="code"><span class="hl-variable">b</span></code>,
and false otherwise.  The precise definition of "equal" depends on the values
being compared, but always obeys the rule that if two values are considered
equal, then one may be substituted locally for the other without affecting the
behavior of the program.</p><p>Two values with the same object identity are always considered equal.
In addition, Cor <a class="link" href="#cor.constants" title="1.2.1.&nbsp;Constants">constant values</a> and <a class="link" href="#cor.data" title="1.2.5.&nbsp;Data Structures">data structures</a> are considered equal if their
contents are equal. Other types are free to implement their own equality
relationship provided it conforms to the rules given here.</p><p>Note that although values of different types may be compared with
<code class="code">=</code>, the substitutability principle requires that such values are
always considered inequal, i.e. the comparison will return <code class="code"><span class="hl-literal">false</span></code>.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(/=)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (/=)(<span class="hl-variable">Top</span>, <span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>
                                <code class="code"><span class="hl-variable">a</span>/=<span class="hl-variable">b</span></code> returns false if <code class="code"><span class="hl-variable">a</span>=<span class="hl-variable">b</span></code>, and true otherwise.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(~)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (~)(<span class="hl-variable">Boolean</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return the logical negation of the argument.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(&amp;&amp;)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (&amp;&amp;)(<span class="hl-variable">Boolean</span>, <span class="hl-variable">Boolean</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return the logical conjunction of the arguments. This is not a short-circuiting
operator; both arguments must be evaluated and available before the result is
computed.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-site">||</span>)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (<span class="hl-site">||</span>)(<span class="hl-variable">Boolean</span>, <span class="hl-variable">Boolean</span>) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return the logical disjunction of the arguments. This is not a short-circuiting
operator; both arguments must be evaluated and available before the result is
computed.</p></td></tr><tr><td><p><span class="term">
                            <code class="code">(:)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> (:)[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>The list <code class="code"><span class="hl-variable">a</span>:<span class="hl-variable">b</span></code> is formed by prepending the element <code class="code"><span class="hl-variable">a</span></code> to
the list <code class="code"><span class="hl-variable">b</span></code>.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: (3, [4, 5])</span>
<span class="hl-literal">3</span>:<span class="hl-literal">4</span>:<span class="hl-literal">5</span>:[] <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span>:<span class="hl-variable">xs</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span>,<span class="hl-variable">xs</span>)</pre>
                            </p><p>In patterns, the <code class="code">(:)</code> deconstructor can be applied to a variety of
list-like values such as <code class="code"><span class="hl-variable">Array</span></code>s and Java <code class="code"><span class="hl-variable">Iterable</span></code>s,
in which case it returns the first element of the list-like value, and a new
list-like value (not necessarily of the same type as the original list-like
value) representing the tail.  Modifying the structure of the original
value (e.g. adding an element to an <code class="code"><span class="hl-variable">Iterable</span></code>) may render
old "tail"s unusable, so you should refrain from modifying a value
while you are deconstructing it.  This feature is highly experimental
and will probably change in future versions of the implementation.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">abs</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">abs</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>Return the absolute value of the argument.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">abs</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span>
<span class="hl-keyword">def</span> <span class="hl-site">abs</span>(<span class="hl-variable">x</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">x</span> &lt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> -<span class="hl-variable">x</span> <span class="hl-keyword">else</span> <span class="hl-variable">x</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">signum</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">signum</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span></code>
                            </p><p>
                                <code class="code"><span class="hl-site">signum</span>(<span class="hl-variable">a</span>)</code> returns <code class="code">-<span class="hl-literal">1</span></code> if <code class="code"><span class="hl-variable">a</span>&lt;<span class="hl-literal">0</span></code>,
<code class="code"><span class="hl-literal">1</span></code> if <code class="code"><span class="hl-variable">a</span>&gt;<span class="hl-literal">0</span></code>, and <code class="code"><span class="hl-literal">0</span></code> if <code class="code"><span class="hl-variable">a</span>=<span class="hl-literal">0</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">signum</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span>
<span class="hl-keyword">def</span> <span class="hl-site">signum</span>(<span class="hl-variable">x</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">x</span> &lt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> -<span class="hl-literal">1</span>
  <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> <span class="hl-variable">x</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-literal">1</span>
  <span class="hl-keyword">else</span> <span class="hl-literal">0</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">min</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">min</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the lesser of the arguments. If the arguments
are equal, return the first argument.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">min</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">min</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">y</span> &lt; <span class="hl-variable">x</span> <span class="hl-keyword">then</span> <span class="hl-variable">y</span> <span class="hl-keyword">else</span> <span class="hl-variable">x</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">max</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">max</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the greater of the arguments. If the arguments
are equal, return the second argument.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">max</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">max</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">x</span> &gt; <span class="hl-variable">y</span> <span class="hl-keyword">then</span> <span class="hl-variable">x</span> <span class="hl-keyword">else</span> <span class="hl-variable">y</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">floor</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">floor</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Integer</span></code>
                            </p><p>Return the greatest integer less than
or equal to this number.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">ceil</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">ceil</span>(<span class="hl-variable">Number</span>) :: <span class="hl-variable">Integer</span></code>
                            </p><p>Return the least integer greater than
or equal to this number.</p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N123F9"></a>B.3.2.&nbsp;state.inc: General-purpose supplemental data structures.</h3></div></div></div><p>General-purpose supplemental data structures.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Some</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Some</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>) :: <span class="hl-site">Option</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>An optional value which is available.
This site may also be used in a pattern.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: (3,4)</span>
<span class="hl-site">Some</span>((<span class="hl-literal">3</span>,<span class="hl-literal">4</span>)) <span class="hl-combinator">&gt;</span><span class="hl-variable">s</span><span class="hl-combinator">&gt;</span> (
    <span class="hl-variable">s</span> <span class="hl-combinator">&gt;</span><span class="hl-site">Some</span>((<span class="hl-variable">x</span>,<span class="hl-variable">y</span>))<span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
  <span class="hl-combinator">|</span> <span class="hl-variable">s</span> <span class="hl-combinator">&gt;</span><span class="hl-site">None</span>()<span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>
)</pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">None</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">None</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Option</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>An optional value which is not available.
This site may also be used in a pattern.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Semaphore</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Semaphore</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Semaphore</span></code>

                            </p><p>Return a semaphore with the given value. The semaphore maintains the invariant
that its value is always non-negative.</p><p>An example using a semaphore as a lock for a critical section:
<pre class="orc">
<span class="hl-comment">-- Prints:</span>
<span class="hl-comment">-- Entering critical section</span>
<span class="hl-comment">-- Leaving critical section</span>
<span class="hl-keyword">val</span> <span class="hl-variable">lock</span> = <span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>)
<span class="hl-variable">lock</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">println</span>(<span class="hl-literal">"Entering critical section"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">println</span>(<span class="hl-literal">"Leaving critical section"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-variable">lock</span>.<span class="hl-site">release</span>()</pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">acquire</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Semaphore</span>.<span class="hl-site">acquire</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If the semaphore's value is greater than <code class="code"><span class="hl-literal">0</span></code>, decrement the semaphore and return a signal.
If the semaphore's value is <code class="code"><span class="hl-literal">0</span></code>, block until it becomes greater than <code class="code"><span class="hl-literal">0</span></code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">acquirenb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Semaphore</span>.<span class="hl-site">acquirenb</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If the semaphore's value is greater than <code class="code"><span class="hl-literal">0</span></code>, decrement the semaphore and return a signal.
If the semaphore's value is <code class="code"><span class="hl-literal">0</span></code>, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">release</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Semaphore</span>.<span class="hl-site">release</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If any calls to <code class="code"><span class="hl-variable">acquire</span></code> are blocked, allow the oldest such call
to return.  Otherwise, increment the value of the semaphore.  This may
increment the value beyond that with which the semaphore was constructed.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">snoop</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Semaphore</span>.<span class="hl-site">snoop</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If any calls to <code class="code"><span class="hl-variable">acquire</span></code> are blocked, return a signal.
Otherwise, block until some call to <code class="code"><span class="hl-variable">acquire</span></code> blocks.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">snoopnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Semaphore</span>.<span class="hl-site">snoopnb</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If any calls to <code class="code"><span class="hl-variable">acquire</span></code> are blocked, return a signal.
Otherwise, halt.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Buffer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>
<p><a name="orc.lib.Buffer.close"></a>
Create a new buffer (FIFO channel) of unlimited size. A buffer supports
get, put and close operations.
</p>

                            </p><p>A buffer may be either empty or non-empty, and either open or closed.  When
empty and open, calls to <code class="code"><span class="hl-variable">get</span></code> block.  When empty and closed, calls
to <code class="code"><span class="hl-variable">get</span></code> halt.  When closed, calls to <code class="code"><span class="hl-variable">put</span></code> halt.  In all
other cases, calls return normally.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 10</span>
<span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">Buffer</span>()
  <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-literal">10</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-variable">b</span>.<span class="hl-site">get</span>()</pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">get</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">get</span>() :: <span class="hl-variable">A</span></code>

                                    </p><p>Get an item from the buffer. If the buffer is open and no items are available,
block until one becomes available. If the buffer is <a class="link" href="#orc.lib.Buffer.close">closed</a> and no items are available, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getnb</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Get an item from the buffer. If no items are available, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">put</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">put</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>

                                    </p><p>Put an item in the buffer. If the buffer is <a class="link" href="#orc.lib.Buffer.close">closed</a>, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">close</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">close</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Close the buffer and block until it is empty.
This has the effect of immediately causing any blocked calls to
<code class="code"><span class="hl-variable">get</span></code> to halt. In addition, any subsequent calls to <code class="code"><span class="hl-variable">put</span></code>
will halt, and once the buffer becomes empty, any subsequent calls to
<code class="code"><span class="hl-variable">get</span></code> will halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">closenb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">closenb</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Close the buffer and return a signal immediately.
This has the effect of immediately causing any blocked calls to
<code class="code"><span class="hl-variable">get</span></code> to halt. In addition, any subsequent calls to <code class="code"><span class="hl-variable">put</span></code>
will halt, and once the buffer becomes empty, any subsequent calls to
<code class="code"><span class="hl-variable">get</span></code> will halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isClosed</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">isClosed</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>If the buffer is currently closed, return true, otherwise return false.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getAll</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getAll</span>() :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Get all of the items currently in the buffer, emptying the buffer and returning
a list of the items in the order they were added. If there are no items in the
buffer, return an empty list.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">BoundedBuffer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>) :: <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Create a new buffer (FIFO channel) with the given number of slots.
Putting an item into the buffer fills a slot, and getting an item opens a slot.
A buffer with zero slots is equivalent to a
<a class="link" href="#orc.lib.state.SyncChannel">synchronous channel</a>.</p><p>A bounded buffer may be empty, partly filled, or full, and either open or
closed.  When empty and open, calls to <code class="code"><span class="hl-variable">get</span></code> block.  When empty and
closed, calls to <code class="code"><span class="hl-variable">get</span></code> halt. When full and open, calls to
<code class="code"><span class="hl-variable">put</span></code> block. When closed, calls to <code class="code"><span class="hl-variable">put</span></code> halt.  In all
other cases, calls return normally.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: "Put 1" "Got 1" "Put 2" "Got 2"</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">BoundedBuffer</span>(<span class="hl-literal">1</span>)
  <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Put "</span> + <span class="hl-literal">1</span>
<span class="hl-combinator">|</span> <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Put "</span> + <span class="hl-literal">2</span>
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> (
    <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Got "</span> + <span class="hl-variable">n</span>
  <span class="hl-combinator">|</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">n</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">"Got "</span> + <span class="hl-variable">n</span>
  )</pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">get</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">get</span>() :: <span class="hl-variable">A</span></code>

                                    </p><p>Get an item from the buffer. If the buffer is open and no items are available,
block until one becomes available. If the buffer is <a class="link" href="#orc.lib.BoundedBuffer.close">closed</a> and no items are available, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getnb</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Get an item from the buffer. If no items are available, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">put</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">put</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>

                                    </p><p>Put an item in the buffer. If no slots are open, block until one becomes open.
If the buffer is <a class="link" href="#orc.lib.BoundedBuffer.close">closed</a>, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">putnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">putnb</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>

                                    </p><p>Put an item in the buffer. If no slots are open, halt.
If the buffer is <a class="link" href="#orc.lib.BoundedBuffer.close">closed</a>, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">close</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">close</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>
<p><a name="orc.lib.BoundedBuffer.close"></a>
Close the buffer and block until it is empty.
This has the effect of immediately causing any blocked calls to
<code class="code"><span class="hl-variable">get</span></code> to halt. In addition, any subsequent calls to <code class="code"><span class="hl-variable">put</span></code>
will halt, and once the buffer becomes empty, any subsequent calls to
<code class="code"><span class="hl-variable">get</span></code> will halt. Note that any blocked calls to <code class="code"><span class="hl-variable">put</span></code>
initiated prior to closing the buffer may still be allowed to return as usual.
</p>
                                    </p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">closenb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">closenb</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Close the buffer and return a signal immediately.
This has the effect of immediately causing any blocked calls to
<code class="code"><span class="hl-variable">get</span></code> to halt. In addition, any subsequent calls to <code class="code"><span class="hl-variable">put</span></code>
will halt, and once the buffer becomes empty, any subsequent calls to
<code class="code"><span class="hl-variable">get</span></code> will halt. Note that any blocked calls to <code class="code"><span class="hl-variable">put</span></code>
initiated prior to closing the buffer may still be allowed to return as usual.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isClosed</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">isClosed</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>If the buffer is currently closed, return true, otherwise return false.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getOpen</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getOpen</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the number of open slots in the buffer. Because of concurrency
this value may become out-of-date so it should only be used for debugging
or statistical measurements.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getBound</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getBound</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the total number of slots (open or filled) in the buffer.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">getAll</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">BoundedBuffer</span>[<span class="hl-variable">A</span>].<span class="hl-site">getAll</span>() :: [<span class="hl-variable">A</span>]</code>
                                    </p><p>Get all of the items currently in the buffer or waiting to be added, emptying
the buffer and returning a list of the items in the order they were added. If
there are no items in the buffer or waiting to be added, return an empty list.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">SyncChannel</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">SyncChannel</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">SyncChannel</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>
<p><a name="orc.lib.state.SyncChannel"></a>
Create a synchronous channel, or rendezvous.
</p>
                            </p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publish: 10</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">SyncChannel</span>()
  <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-literal">10</span>)
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>()</pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">get</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">SyncChannel</span>[<span class="hl-variable">A</span>].<span class="hl-site">get</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Receive an item over the channel. If no sender is available, block until one becomes available.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">put</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">SyncChannel</span>[<span class="hl-variable">A</span>].<span class="hl-site">put</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>
                                    </p><p>Send an item over the channel. If no receiver is available, block until one becomes available.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Cell</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Cell</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Cell</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Create a write-once storage location.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 5 5</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Cell</span>()
  <span class="hl-variable">c</span>.<span class="hl-site">write</span>(<span class="hl-literal">5</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">read</span>()
<span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> ( <span class="hl-variable">c</span>.<span class="hl-site">write</span>(<span class="hl-literal">10</span>) <span class="hl-combinator">;</span> <span class="hl-variable">c</span>.<span class="hl-site">read</span>() )</pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">read</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Cell</span>[<span class="hl-variable">A</span>].<span class="hl-site">read</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Read a value from the cell. If the cell does not yet have a value, block until it receives one.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">readnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Cell</span>[<span class="hl-variable">A</span>].<span class="hl-site">readnb</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Read a value from the cell. If the cell does not yet have a value, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">write</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Cell</span>[<span class="hl-variable">A</span>].<span class="hl-site">write</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Write a value to the cell. If the cell already has a value, halt.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Ref</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>
                                <p><a name="orc.lib.state.Ref"></a>
Create a rewritable storage location without an initial value.
</p>
                            </p><p>Example:
<pre class="orc">
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Ref</span>()
<span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span> <span class="hl-site">:=</span> <span class="hl-literal">5</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">println</span>(<span class="hl-variable">r</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">r</span> <span class="hl-site">:=</span> <span class="hl-literal">10</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">println</span>(<span class="hl-variable">r</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-keyword">stop</span></pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">Ref</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>) :: <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Create a rewritable storage location initialized to the provided value.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">read</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>].<span class="hl-site">read</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Read the value of the ref. If the ref does not yet have a value, block until it receives one.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">readnb</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>].<span class="hl-site">readnb</span>() :: <span class="hl-variable">A</span></code>
                                    </p><p>Read the value of the ref. If the ref does not yet have a value, halt.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">write</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>].<span class="hl-site">write</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>
                                    </p><p>Write a value to the ref.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-site">?</span>)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> (<span class="hl-site">?</span>)[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Get the value held by a reference.
<code class="code"><span class="hl-variable">x</span><span class="hl-site">?</span></code> is equivalent to <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">read</span>()</code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> (<span class="hl-site">?</span>)[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> (<span class="hl-site">?</span>)(<span class="hl-variable">r</span>) = <span class="hl-variable">r</span>.<span class="hl-site">read</span>()</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code">(<span class="hl-site">:=</span>)</code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> (<span class="hl-site">:=</span>)[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>], <span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>
                            </p><p>Set the value held by a reference.
<code class="code"><span class="hl-variable">x</span> <span class="hl-site">:=</span> <span class="hl-variable">y</span></code> is equivalent to <code class="code"><span class="hl-variable">x</span>.<span class="hl-site">write</span>(<span class="hl-variable">y</span>)</code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> (<span class="hl-site">:=</span>)[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>], <span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> (<span class="hl-site">:=</span>)(<span class="hl-variable">r</span>,<span class="hl-variable">v</span>) = <span class="hl-variable">r</span>.<span class="hl-site">write</span>(<span class="hl-variable">v</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">swap</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">swap</span>[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>], <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span></code>
                            </p><p>Swap the values in two references.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">swap</span>[<span class="hl-variable">A</span>](<span class="hl-site">Ref</span>[<span class="hl-variable">A</span>], <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">swap</span>(<span class="hl-variable">r</span>,<span class="hl-variable">s</span>) = (<span class="hl-variable">r</span><span class="hl-site">?</span>,<span class="hl-variable">s</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span>(<span class="hl-variable">rval</span>,<span class="hl-variable">sval</span>)<span class="hl-combinator">&gt;</span> (<span class="hl-variable">r</span> <span class="hl-site">:=</span> <span class="hl-variable">sval</span>, <span class="hl-variable">s</span> <span class="hl-site">:=</span> <span class="hl-variable">rval</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Array</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>) :: <span class="hl-site">Array</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Create a new native array of the given size. The array is initialized
to contain <code class="code"><span class="hl-literal">null</span></code>s.</p><p>The resulting array can be called directly with an index, as if
its type were <code class="code"><span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-site">Ref</span>[<span class="hl-variable">A</span>]</code>.
In this case, it returns a <a class="link" href="#orc.lib.state.Ref">Ref</a>
pointing to the element of the array specified by an index,
counting from 0. Changes to the array are reflected immediately
in the ref and visa versa.</p><p>Simple example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 3</span>
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">Array</span>(<span class="hl-literal">1</span>)
<span class="hl-site">a</span>(<span class="hl-literal">0</span>) <span class="hl-site">:=</span> <span class="hl-literal">3</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">a</span>(<span class="hl-literal">0</span>)<span class="hl-site">?</span></pre>

                            </p><p>More complex example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 0 1 2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">Array</span>(<span class="hl-literal">3</span>)
<span class="hl-site">for</span>(<span class="hl-literal">0</span>, <span class="hl-variable">a</span>.<span class="hl-site">length</span>()) <span class="hl-combinator">&gt;</span><span class="hl-variable">i</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">a</span>(<span class="hl-variable">i</span>) <span class="hl-site">:=</span> <span class="hl-variable">i</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-keyword">stop</span>
<span class="hl-combinator">;</span> <span class="hl-site">a</span>(<span class="hl-literal">0</span>)<span class="hl-site">?</span> <span class="hl-combinator">|</span> <span class="hl-site">a</span>(<span class="hl-literal">1</span>)<span class="hl-site">?</span> <span class="hl-combinator">|</span> <span class="hl-site">a</span>(<span class="hl-literal">2</span>)<span class="hl-site">?</span></pre>
                            </p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">Array</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-variable">String</span>) :: <span class="hl-site">Array</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Create a new primitive array of the given size with the given primitive type.
The initial values in the array depend on the primitive type: for numeric types,
it is <code class="code"><span class="hl-literal">0</span></code>; for booleans, <code class="code"><span class="hl-literal">false</span></code>; for chars, the character
with codepoint <code class="code"><span class="hl-literal">0</span></code>.</p><p>The element type of the array should be the appropriate wrapper type for the given
primitive type, although a typechecker may not be able to verify this. This
constructor is only necessary when interfacing with certain Java libraries; most
programs will just use the  <code class="code"><span class="hl-site">Array</span>(<span class="hl-variable">Integer</span>)</code> constructor.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">get</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>].<span class="hl-site">get</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span></code>
                                    </p><p>Get the element of the array given by the index, counting from 0.
<code class="code"><span class="hl-variable">a</span>.<span class="hl-site">get</span>(<span class="hl-variable">i</span>)</code> is equivalent to <code class="code"><span class="hl-site">a</span>(<span class="hl-variable">i</span>)<span class="hl-site">?</span></code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">set</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>].<span class="hl-site">set</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>
                                    </p><p>Set the element of the array given by the index, counting from 0.
<code class="code"><span class="hl-variable">a</span>.<span class="hl-site">set</span>(<span class="hl-variable">i</span>,<span class="hl-variable">v</span>)</code> is equivalent to <code class="code"><span class="hl-site">a</span>(<span class="hl-variable">i</span>) <span class="hl-site">:=</span> <span class="hl-variable">v</span></code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">slice</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>].<span class="hl-site">slice</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">Integer</span>) :: <span class="hl-site">Array</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Return a copy of the portion of the array with indices covered by the given
half-open range. The result array is still indexed counting from 0.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">length</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>].<span class="hl-site">length</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the size of the array.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">fill</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Array</span>[<span class="hl-variable">A</span>].<span class="hl-site">fill</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span></code>

                                    </p><p>Set every element of the array to the given value. The given value is not
copied, but is shared by every element of the array, so for example
<code class="code"><span class="hl-variable">a</span>.<span class="hl-site">fill</span>(<span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>))</code> would allow you to access the same semaphore
from every element <code class="code"><span class="hl-variable">a</span></code>.</p><p>This method is primarily useful to initialize or reset an array to a constant
value,
for example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 0 0 0</span>
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">Array</span>(<span class="hl-literal">3</span>)
<span class="hl-variable">a</span>.<span class="hl-site">fill</span>(<span class="hl-literal">0</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">each</span>(<span class="hl-variable">a</span>)</pre>
                                    </p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">IArray</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">IArray</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>)(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>The call <code class="code"><span class="hl-site">IArray</span>(<span class="hl-variable">n</span>,<span class="hl-variable">f</span>)</code>, where <code class="code"><span class="hl-variable">n</span></code> is a
natural number and <code class="code"><span class="hl-variable">f</span></code> a total function over natural numbers,
creates and returns a partial, pre-computed version of <code class="code"><span class="hl-variable">f</span></code>
restricted to the range (0, <code class="code"><span class="hl-variable">n</span></code>-1). If <code class="code"><span class="hl-variable">f</span></code> halts
on any number in this range, the call to <code class="code"><span class="hl-variable">IArray</span></code> will halt.</p><p>The user may also think of the call as returning an array whose
<code class="code"><span class="hl-variable">i</span></code>th element is <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">i</span>)</code>.</p><p>This function provides a simple form of memoisation; we avoid recomputing
the value of <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">i</span>)</code> by storing the result in an array.</p><p>Example:
<pre class="programlisting">
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">IArray</span>(<span class="hl-literal">5</span>, <span class="hl-variable">fib</span>)
<span class="hl-comment">-- Publishes the 4th number of the fibonnaci sequence: 5</span>
<span class="hl-site">a</span>(<span class="hl-literal">3</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">IArray</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>)(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">IArray</span>(<span class="hl-variable">n</span>, <span class="hl-variable">f</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">Array</span>[<span class="hl-variable">A</span>](<span class="hl-variable">n</span>)
  <span class="hl-keyword">def</span> <span class="hl-site">fill</span>(<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>) :: <span class="hl-variable">Top</span>
  <span class="hl-keyword">def</span> <span class="hl-site">fill</span>(<span class="hl-variable">i</span>, <span class="hl-variable">f</span>) =
    <span class="hl-keyword">if</span> <span class="hl-variable">i</span> &lt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-keyword">signal</span>
    <span class="hl-keyword">else</span> (<span class="hl-variable">a</span>.<span class="hl-site">set</span>(<span class="hl-variable">i</span>, <span class="hl-site">f</span>(<span class="hl-variable">i</span>)), <span class="hl-site">fill</span>(<span class="hl-variable">i</span>-<span class="hl-literal">1</span>, <span class="hl-variable">f</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span>
  <span class="hl-site">fill</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>, <span class="hl-variable">f</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">a</span>.<span class="hl-variable">get</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Set</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Set</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Construct an empty mutable set. The set considers two
values <code class="code"><span class="hl-variable">a</span></code> and <code class="code"><span class="hl-variable">b</span></code> to be the same if
and only if <code class="code"><span class="hl-variable">a</span>=<span class="hl-variable">b</span></code>. This site conforms to the Java interface
<code class="code"><span class="hl-variable">java</span>.<span class="hl-variable">util</span>.<span class="hl-variable">Set</span></code>, except that it obeys Orc rules for equality of
elements rather than Java rules.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">add</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">add</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Add a value to the set, returning true if the set did not already contain the value,
and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">remove</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">remove</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Remove a value from the set, returning true if the set contained the value,
and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">contains</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">contains</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the set contains the given value, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isEmpty</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">isEmpty</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the set contains no values.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">clear</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">clear</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Remove all values from the set.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">size</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Set</span>[<span class="hl-variable">A</span>].<span class="hl-site">size</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the number of unique values currently contained in the set.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Map</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>]() :: <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>]</code>
                            </p><p>Construct an empty mutable map from keys to values.  Each key contained in the
map is associated with exactly one value.  The mapping considers two keys
<code class="code"><span class="hl-variable">a</span></code> and <code class="code"><span class="hl-variable">b</span></code> to be the same if and only if
<code class="code"><span class="hl-variable">a</span>=<span class="hl-variable">b</span></code>. This site conforms to the Java interface
<code class="code"><span class="hl-variable">java</span>.<span class="hl-variable">util</span>.<span class="hl-variable">Map</span></code>, except that it obeys Orc rules for equality of keys
rather than Java rules.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">put</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">put</span>(<span class="hl-variable">K</span>, <span class="hl-variable">V</span>) :: <span class="hl-variable">V</span></code>
                                    </p><p>
                                    <code class="code"><span class="hl-variable">map</span>.<span class="hl-site">put</span>(<span class="hl-variable">k</span>,<span class="hl-variable">v</span>)</code> associates the value <code class="code"><span class="hl-variable">v</span></code> with the key
<code class="code"><span class="hl-variable">k</span></code> in <code class="code"><span class="hl-variable">map</span></code>, such that <code class="code"><span class="hl-variable">map</span>.<span class="hl-site">get</span>(<span class="hl-variable">k</span>)</code> returns
<code class="code"><span class="hl-variable">v</span></code>. Return the value previously associated with the key,
if any, otherwise return <code class="code"><span class="hl-site">Null</span>()</code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">get</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">get</span>(<span class="hl-variable">K</span>) :: <span class="hl-variable">V</span></code>
                                    </p><p>Return the value currently associated with the given key, if any, otherwise
return <code class="code"><span class="hl-site">Null</span>()</code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">remove</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">remove</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">V</span></code>
                                    </p><p>Remove the given key from the map. Return the value previously associated with the key,
if any, otherwise return <code class="code"><span class="hl-site">Null</span>()</code>.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">containsKey</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">containsKey</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the map contains the given key, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isEmpty</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">isEmpty</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the map contains no keys.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">clear</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">clear</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Remove all keys from the map.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">size</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Map</span>[<span class="hl-variable">K</span>,<span class="hl-variable">V</span>].<span class="hl-site">size</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the number of unique keys currently contained in the map.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Counter</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Counter</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Counter</span></code>
                            </p><p>Create a new counter initialized to the given value.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">Counter</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Counter</span>() :: <span class="hl-variable">Counter</span></code>
                                    </p><p>Create a new counter initialized to zero.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">inc</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Counter</span>.<span class="hl-site">inc</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>Increment the counter.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">dec</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Counter</span>.<span class="hl-site">dec</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If the counter is already at zero, halt. Otherwise, decrement
the counter and return a signal.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">onZero</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Counter</span>.<span class="hl-site">onZero</span>() :: <span class="hl-variable">Top</span></code>
                                    </p><p>If the counter is at zero, return a signal. Otherwise
block until the counter reaches zero.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">value</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Counter</span>.<span class="hl-site">value</span>() :: <span class="hl-variable">Integer</span></code>

                                    </p><p>Return the current value of the counter.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes five signals</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Counter</span>(<span class="hl-literal">5</span>)
<span class="hl-site">repeat</span>(<span class="hl-variable">c</span>.<span class="hl-variable">dec</span>)</pre>
                                    </p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Dictionary</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Dictionary</span>() :: <span class="hl-variable">Dictionary</span></code>

                            </p><p>Create a new dictionary (a mutable map from field names to values), initially
empty.  The first time each field of the dictionary is accessed (using dot
notation), the dictionary creates and returns a new empty <a class="link" href="#orc.lib.state.Ref">Ref</a> which will also be returned on
subsequent accesses of the same field.  Dictionaries allow you to easily create
object-like data structures.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Prints: 1 2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">d</span> = <span class="hl-site">Dictionary</span>()
  <span class="hl-site">println</span>(<span class="hl-variable">d</span>.<span class="hl-variable">one</span>.<span class="hl-site">read</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">println</span>(<span class="hl-variable">d</span>.<span class="hl-variable">two</span>.<span class="hl-site">read</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-variable">d</span>.<span class="hl-variable">one</span>.<span class="hl-site">write</span>(<span class="hl-literal">1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">d</span>.<span class="hl-variable">two</span>.<span class="hl-site">write</span>(<span class="hl-literal">2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-keyword">stop</span></pre>

                            </p><p>Here is the same example rewritten using Orc's reference syntax to improve
clarity:
<pre class="orc">
<span class="hl-comment">-- Prints: 1 2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">d</span> = <span class="hl-site">Dictionary</span>()
  <span class="hl-site">println</span>(<span class="hl-variable">d</span>.<span class="hl-variable">one</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-site">println</span>(<span class="hl-variable">d</span>.<span class="hl-variable">two</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-variable">d</span>.<span class="hl-variable">one</span> <span class="hl-site">:=</span> <span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-variable">d</span>.<span class="hl-variable">two</span> <span class="hl-site">:=</span> <span class="hl-literal">2</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
  <span class="hl-keyword">stop</span></pre>

                            </p><p>To create a multi-level dictionary, you must explicitly create sub-dictionaries
for each field. For example:
<pre class="orc">
<span class="hl-comment">-- Prints: 2</span>
<span class="hl-keyword">val</span> <span class="hl-variable">d</span> = <span class="hl-site">Dictionary</span>()
<span class="hl-variable">d</span>.<span class="hl-variable">one</span> <span class="hl-site">:=</span> <span class="hl-site">Dictionary</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-variable">d</span>.<span class="hl-variable">one</span><span class="hl-site">?</span>.<span class="hl-variable">two</span> <span class="hl-site">:=</span> <span class="hl-literal">2</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">println</span>(<span class="hl-variable">d</span>.<span class="hl-variable">one</span><span class="hl-site">?</span>.<span class="hl-variable">two</span><span class="hl-site">?</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-keyword">stop</span></pre>

                            </p><p>Note that you cannot write <code class="code"><span class="hl-variable">d</span>.<span class="hl-variable">one</span>.<span class="hl-variable">two</span></code>: because <code class="code"><span class="hl-variable">d</span>.<span class="hl-variable">one</span></code>
is a reference to a dictionary, and not simply a dictionary, you must
dereference before accessing its fields, as in <code class="code"><span class="hl-variable">d</span>.<span class="hl-variable">one</span><span class="hl-site">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>.<span class="hl-variable">two</span></code>.
For readers familiar with the C language, this is the same reason you must
write <code class="code">s-&gt;field</code> instead of <code class="code"><span class="hl-variable">s</span>.<span class="hl-variable">field</span></code> when
<code class="code"><span class="hl-variable">s</span></code> is a pointer to a struct.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Record</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Record</span>(<span class="hl-variable">String</span>, <span class="hl-variable">A</span>, <span class="hl-variable">String</span>, <span class="hl-variable">B</span>, ...) :: <span class="hl-site">Record</span>[<span class="hl-variable">A</span>, <span class="hl-variable">B</span>, ...]</code>

                            </p><p>Create a new record (an immutable map from field names to values).
Arguments are consumed in pairs; the first argument of each pair
is the key, and the second is the value for that key.</p><p>To access the value in record <code class="code"><span class="hl-variable">r</span></code> for key <code class="code"><span class="hl-literal">"x"</span></code>,
use the syntax <code class="code"><span class="hl-variable">r</span>.<span class="hl-variable">x</span></code>. For example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 1</span>
<span class="hl-keyword">val</span> <span class="hl-variable">r</span> = <span class="hl-site">Record</span>(
  <span class="hl-literal">"one"</span>, <span class="hl-literal">1</span>,
  <span class="hl-literal">"two"</span>, <span class="hl-literal">2</span>)
<span class="hl-variable">r</span>.<span class="hl-variable">one</span></pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">fst</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">fst</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>]((<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the first element of a pair.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">fst</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>]((<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">fst</span>((<span class="hl-variable">x</span>,<span class="hl-variable">_</span>)) = <span class="hl-variable">x</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">snd</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">snd</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>]((<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)) :: <span class="hl-variable">B</span></code>
                            </p><p>Return the second element of a pair.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">snd</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>]((<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">snd</span>((<span class="hl-variable">_</span>,<span class="hl-variable">y</span>)) = <span class="hl-variable">y</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Interval</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>
                                <code class="code"><span class="hl-site">Interval</span>(<span class="hl-variable">a</span>,<span class="hl-variable">b</span>)</code> returns an object representing the half-open
interval [<code class="code"><span class="hl-variable">a</span></code>,<code class="code"><span class="hl-variable">b</span></code>).</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isEmpty</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">isEmpty</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if this interval is empty.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">spans</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">spans</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the interval spans the given point, false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">intersects</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">intersects</span>(<span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the given interval has a non-empty intersection with this one,
and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">intersect</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">intersect</span>(<span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Return the intersection of this interval with another. If
the two intervals do not intersect, returns an empty interval.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">contiguous</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">contiguous</span>(<span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if the given interval is contiguous with this one
(overlaps or abuts), and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">union</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>].<span class="hl-site">union</span>(<span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Return the union of this interval with another. Halts with an error if
the two intervals are not contiguous.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Intervals</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>]() :: <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return an empty set of intervals. An Intervals object is iterable;
iterating over the set returns disjoint intervals in increasing order.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">isEmpty</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>].<span class="hl-site">isEmpty</span>() :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if this set of intervals is empty.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">spans</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>].<span class="hl-site">spans</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span></code>
                                    </p><p>Return true if this set of intervals spans the given point, and false otherwise.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">intersect</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>].<span class="hl-site">intersect</span>(<span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Return the intersection of this set of intervals with another.</p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">union</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>].<span class="hl-site">union</span>(<span class="hl-site">Interval</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">Intervals</span>[<span class="hl-variable">A</span>]</code>
                                    </p><p>Return the union of this set of intervals with the given interval.
This method is most efficient when the given interval is before
most of the intervals in the set.</p></td></tr></tbody></table></div></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N12AA2"></a>B.3.3.&nbsp;idioms.inc: Higher-order Orc programming idioms.</h3></div></div></div><p>Higher-order Orc programming idioms.
Many of these are standard functional-programming
combinators borrowed from Haskell or Scheme.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">apply</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">apply</span>[<span class="hl-variable">A</span>, ..., <span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, ...) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span></code>
                            </p><p>Apply a function to a list of arguments.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">curry</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">curry</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span></code>
                            </p><p>Curry a function of two arguments.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">curry</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">curry</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">x</span>)(<span class="hl-variable">y</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">curry3</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">curry3</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>,<span class="hl-variable">D</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>)(<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>)(<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span></code>
                            </p><p>Curry a function of three arguments.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">curry3</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>,<span class="hl-variable">D</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>)(<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>)(<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>
<span class="hl-keyword">def</span> <span class="hl-site">curry3</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">x</span>)(<span class="hl-variable">y</span>)(<span class="hl-variable">z</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>,<span class="hl-variable">z</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">uncurry</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">uncurry</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span></code>
                            </p><p>Uncurry a function of two arguments.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">uncurry</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">uncurry</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>)(<span class="hl-variable">y</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">uncurry3</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">uncurry3</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>,<span class="hl-variable">D</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>)(<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>)(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span></code>
                            </p><p>Uncurry a function of three arguments.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">uncurry3</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>,<span class="hl-variable">D</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>)(<span class="hl-variable">B</span>)(<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>)(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>) :: <span class="hl-variable">D</span>
<span class="hl-keyword">def</span> <span class="hl-site">uncurry3</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>,<span class="hl-variable">z</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>)(<span class="hl-variable">y</span>)(<span class="hl-variable">z</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">flip</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">flip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">B</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">C</span></code>
                            </p><p>Flip the order of parameters of a two-argument function.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">flip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>)(<span class="hl-variable">B</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">flip</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>) = <span class="hl-site">f</span>(<span class="hl-variable">y</span>,<span class="hl-variable">x</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">constant</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">constant</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>)() :: <span class="hl-variable">A</span></code>
                            </p><p>Create a function which returns a constant value.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">constant</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>)() :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">constant</span>(<span class="hl-variable">x</span>)() = <span class="hl-variable">x</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">defer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">defer</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">A</span>)() :: <span class="hl-variable">B</span></code>
                            </p><p>Given a function and its argument, return a thunk which applies the function.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">defer</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">A</span>)() :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">defer</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>)() = <span class="hl-site">f</span>(<span class="hl-variable">x</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">defer2</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">defer2</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>, <span class="hl-variable">A</span>, <span class="hl-variable">B</span>)() :: <span class="hl-variable">C</span></code>
                            </p><p>Given a function and its arguments, return a thunk which applies the function.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">defer2</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>, <span class="hl-variable">A</span>, <span class="hl-variable">B</span>)() :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">defer2</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>, <span class="hl-variable">y</span>)() = <span class="hl-site">f</span>(<span class="hl-variable">x</span>, <span class="hl-variable">y</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">ignore</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">ignore</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">B</span>)(<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span></code>
                            </p><p>From a function of no arguments, create a function
of one argument, which is ignored.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">ignore</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">B</span>)(<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">ignore</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">_</span>) = <span class="hl-site">f</span>()</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">ignore2</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">ignore2</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span></code>
                            </p><p>From a function of no arguments, create a function
of two arguments, which are ignored.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">ignore2</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">C</span>)(<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">ignore2</span>(<span class="hl-variable">f</span>)(<span class="hl-variable">_</span>, <span class="hl-variable">_</span>) = <span class="hl-site">f</span>()</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">compose</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">compose</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>)(<span class="hl-variable">A</span>) :: <span class="hl-variable">C</span></code>
                            </p><p>Compose two single-argument functions.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">compose</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>,<span class="hl-variable">C</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">B</span>) :: <span class="hl-variable">C</span>,
                   <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>)(<span class="hl-variable">A</span>) :: <span class="hl-variable">C</span>
<span class="hl-keyword">def</span> <span class="hl-site">compose</span>(<span class="hl-variable">f</span>,<span class="hl-variable">g</span>)(<span class="hl-variable">x</span>) = <span class="hl-site">f</span>(<span class="hl-site">g</span>(<span class="hl-variable">x</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">while</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">while</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>)(<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Iterate a function while a predicate is satisfied, publishing
each value passed to the function. The exact behavior is specified
by the following implementation:</p><p>
                                <pre class="programlisting">
<span class="hl-keyword">def</span> <span class="hl-site">while</span>(<span class="hl-variable">p</span>,<span class="hl-variable">f</span>) = 
  <span class="hl-keyword">def</span> <span class="hl-site">loop</span>(<span class="hl-variable">x</span>) = <span class="hl-keyword">if</span>(<span class="hl-site">p</span>(<span class="hl-variable">x</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> ( <span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">loop</span>(<span class="hl-site">f</span>(<span class="hl-variable">x</span>)) )
  <span class="hl-variable">loop</span></pre>
                            </p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 0 1 2 3 4 5</span>
<span class="hl-site">while</span>(
  <span class="hl-keyword">lambda</span> (<span class="hl-variable">n</span>) = (<span class="hl-variable">n</span> <span class="hl-site">&lt;=</span> <span class="hl-literal">5</span>),
  <span class="hl-keyword">lambda</span> (<span class="hl-variable">n</span>) = <span class="hl-variable">n</span>+<span class="hl-literal">1</span>
)(<span class="hl-literal">0</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">while</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
             <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>)(<span class="hl-variable">A</span>)
  :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">while</span>(<span class="hl-variable">p</span>,<span class="hl-variable">f</span>) = 
  <span class="hl-keyword">def</span> <span class="hl-site">loop</span>(<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
  <span class="hl-keyword">def</span> <span class="hl-site">loop</span>(<span class="hl-variable">x</span>) = <span class="hl-keyword">if</span>(<span class="hl-site">p</span>(<span class="hl-variable">x</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> ( <span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">loop</span>(<span class="hl-site">f</span>(<span class="hl-variable">x</span>)) )
  <span class="hl-variable">loop</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">repeat</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">repeat</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Call a function sequentially, publishing each value returned by the function.
The expression <code class="code"><span class="hl-site">repeat</span>(<span class="hl-variable">f</span>)</code> is equivalent to
the infinite expression <code class="code"><span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> ( <span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> ( <span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> ... ) )</code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">repeat</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">repeat</span>(<span class="hl-variable">f</span>) = <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-variable">x</span> <span class="hl-combinator">|</span> <span class="hl-site">repeat</span>(<span class="hl-variable">f</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">fork</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">fork</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Call a list of functions in parallel, publishing
all values published by the functions.</p><p>The expression <code class="code"><span class="hl-site">fork</span>([<span class="hl-variable">f</span>,<span class="hl-variable">g</span>,<span class="hl-variable">h</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>() <span class="hl-combinator">|</span> <span class="hl-site">g</span>() <span class="hl-combinator">|</span> <span class="hl-site">h</span>()</code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">fork</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">fork</span>([]) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">fork</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) = <span class="hl-site">p</span>() <span class="hl-combinator">|</span> <span class="hl-site">fork</span>(<span class="hl-variable">ps</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">forkMap</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">forkMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span></code>
                            </p><p>Apply a function to a list in parallel, publishing all values published
by the applications.</p><p>The expression <code class="code"><span class="hl-site">forkMap</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">a</span>,<span class="hl-variable">b</span>,<span class="hl-variable">c</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">a</span>) <span class="hl-combinator">|</span> <span class="hl-site">f</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">|</span> <span class="hl-site">f</span>(<span class="hl-variable">c</span>)</code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">forkMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">forkMap</span>(<span class="hl-variable">f</span>, []) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">forkMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">|</span> <span class="hl-site">forkMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">seq</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">seq</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span></code>
                            </p><p>Call a list of functions in sequence, publishing
a signal whenever the last function publishes. The
actual publications of the given functions are not
published.</p><p>The expression <code class="code"><span class="hl-site">seq</span>([<span class="hl-variable">f</span>,<span class="hl-variable">g</span>,<span class="hl-variable">h</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">g</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">h</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">seq</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">seq</span>([]) = <span class="hl-keyword">signal</span>
<span class="hl-keyword">def</span> <span class="hl-site">seq</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) = <span class="hl-site">p</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">seq</span>(<span class="hl-variable">ps</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">seqMap</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">seqMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span></code>
                            </p><p>Apply a function to a list in in sequence, publishing
a signal whenever the last application publishes. The
actual publications of the given functions are not
published.</p><p>The expression <code class="code"><span class="hl-site">seqMap</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">a</span>,<span class="hl-variable">b</span>,<span class="hl-variable">c</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">a</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">f</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">f</span>(<span class="hl-variable">c</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">seqMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">seqMap</span>(<span class="hl-variable">f</span>, []) = <span class="hl-keyword">signal</span>
<span class="hl-keyword">def</span> <span class="hl-site">seqMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">seqMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">join</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">join</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span></code>
                            </p><p>Call a list of functions in parallel and publish
a signal once all functions have completed.</p><p>The expression <code class="code"><span class="hl-site">join</span>([<span class="hl-variable">f</span>,<span class="hl-variable">g</span>,<span class="hl-variable">h</span>])</code> is equivalent to
the expression <code class="code">(<span class="hl-site">f</span>(), <span class="hl-site">g</span>(), <span class="hl-site">h</span>()) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">join</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">join</span>([]) = <span class="hl-keyword">signal</span>
<span class="hl-keyword">def</span> <span class="hl-site">join</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) = (<span class="hl-site">p</span>(), <span class="hl-site">join</span>(<span class="hl-variable">ps</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">joinMap</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">joinMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span></code>
                            </p><p>Apply a function to a list in parallel and publish
a signal once all applications have completed.</p><p>The expression <code class="code"><span class="hl-site">joinMap</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">a</span>,<span class="hl-variable">b</span>,<span class="hl-variable">c</span>])</code> is equivalent to
the expression <code class="code">(<span class="hl-site">f</span>(<span class="hl-variable">a</span>), <span class="hl-site">f</span>(<span class="hl-variable">b</span>), <span class="hl-site">f</span>(<span class="hl-variable">c</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">joinMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">joinMap</span>(<span class="hl-variable">f</span>, []) = <span class="hl-keyword">signal</span>
<span class="hl-keyword">def</span> <span class="hl-site">joinMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = (<span class="hl-site">f</span>(<span class="hl-variable">x</span>), <span class="hl-site">joinMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">signal</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">alt</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">alt</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Call each function in the list until one publishes.</p><p>The expression <code class="code"><span class="hl-site">alt</span>([<span class="hl-variable">f</span>,<span class="hl-variable">g</span>,<span class="hl-variable">h</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>() <span class="hl-combinator">;</span> <span class="hl-site">g</span>() <span class="hl-combinator">;</span> <span class="hl-site">h</span>()</code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">alt</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">alt</span>([]) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">alt</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) = <span class="hl-site">p</span>() <span class="hl-combinator">;</span> <span class="hl-site">alt</span>(<span class="hl-variable">ps</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">altMap</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">altMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span></code>
                            </p><p>Apply the function to each element in the list until one publishes.</p><p>The expression <code class="code"><span class="hl-site">altMap</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">a</span>,<span class="hl-variable">b</span>,<span class="hl-variable">c</span>])</code> is equivalent to
the expression <code class="code"><span class="hl-site">f</span>(<span class="hl-variable">a</span>) <span class="hl-combinator">;</span> <span class="hl-site">f</span>(<span class="hl-variable">b</span>) <span class="hl-combinator">;</span> <span class="hl-site">f</span>(<span class="hl-variable">c</span>)</code>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">altMap</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">altMap</span>(<span class="hl-variable">f</span>, []) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">altMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">;</span> <span class="hl-site">altMap</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">por</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">por</span>(<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Parallel or. Evaluate a list of boolean functions in parallel, publishing
a value as soon as possible, and terminating any unnecessary ongoing
computation.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">por</span>(<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">por</span>([]) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">por</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) =
  <span class="hl-site">let</span>(
    <span class="hl-keyword">val</span> <span class="hl-variable">b1</span> = <span class="hl-site">p</span>()
    <span class="hl-keyword">val</span> <span class="hl-variable">b2</span> = <span class="hl-site">por</span>(<span class="hl-variable">ps</span>)
    <span class="hl-keyword">if</span>(<span class="hl-variable">b1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-variable">b2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> <span class="hl-combinator">|</span> (<span class="hl-variable">b1</span> <span class="hl-site">||</span> <span class="hl-variable">b2</span>)
  )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">pand</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">pand</span>(<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Parallel and. Evaluate a list of boolean functions in parallel, publishing
a value as soon as possible, and terminating any unnecessary ongoing
computation.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">pand</span>(<span class="hl-site">List</span>[<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">pand</span>([]) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">pand</span>(<span class="hl-variable">p</span>:<span class="hl-variable">ps</span>) =
  <span class="hl-site">let</span>(
    <span class="hl-keyword">val</span> <span class="hl-variable">b1</span> = <span class="hl-site">p</span>()
    <span class="hl-keyword">val</span> <span class="hl-variable">b2</span> = <span class="hl-site">pand</span>(<span class="hl-variable">ps</span>)
    <span class="hl-keyword">if</span>(~<span class="hl-variable">b1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">false</span> <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(~<span class="hl-variable">b2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">false</span> <span class="hl-combinator">|</span> (<span class="hl-variable">b1</span> &amp;&amp; <span class="hl-variable">b2</span>)
  )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">collect</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">collect</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Run a function, collecting all publications in a list.
Return the list when the function terminates.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [signal, signal, signal, signal, signal]</span>
<span class="hl-site">collect</span>(<span class="hl-site">defer</span>(<span class="hl-variable">signals</span>, <span class="hl-literal">5</span>))</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">collect</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">collect</span>(<span class="hl-variable">p</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">b</span> = <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>]()
  <span class="hl-site">p</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
  <span class="hl-combinator">;</span> <span class="hl-variable">b</span>.<span class="hl-site">getAll</span>()</pre></p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N12CD7"></a>B.3.4.&nbsp;list.inc: Operations on lists.</h3></div></div></div><p>Operations on lists.
Many of these functions are similar to those in the Haskell prelude, but
operate on the elements of a list in parallel.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">each</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">each</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Publish every value in a list, simultaneously.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">each</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">each</span>([]) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">each</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-variable">h</span> <span class="hl-combinator">|</span> <span class="hl-site">each</span>(<span class="hl-variable">t</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">map</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">map</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">B</span>]</code>
                            </p><p>Apply a function to every element of a list (in parallel),
returning a list of the results.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">map</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">B</span>]
<span class="hl-keyword">def</span> <span class="hl-site">map</span>(<span class="hl-variable">f</span>,[]) = []
<span class="hl-keyword">def</span> <span class="hl-site">map</span>(<span class="hl-variable">f</span>,<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-site">f</span>(<span class="hl-variable">h</span>):<span class="hl-site">map</span>(<span class="hl-variable">f</span>,<span class="hl-variable">t</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">reverse</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">reverse</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return the reverse of the given list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">reverse</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">reverse</span>(<span class="hl-variable">l</span>) = 
  <span class="hl-keyword">def</span> <span class="hl-site">tailrev</span>(<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>] 
  <span class="hl-keyword">def</span> <span class="hl-site">tailrev</span>([],<span class="hl-variable">x</span>) = <span class="hl-variable">x</span>
  <span class="hl-keyword">def</span> <span class="hl-site">tailrev</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>,<span class="hl-variable">x</span>) = <span class="hl-site">tailrev</span>(<span class="hl-variable">t</span>,<span class="hl-variable">h</span>:<span class="hl-variable">x</span>)
  <span class="hl-site">tailrev</span>(<span class="hl-variable">l</span>,[])</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">filter</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">filter</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return a list containing only those elements which satisfy the predicate.
The filter is applied to all list elements in parallel.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">filter</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">filter</span>(<span class="hl-variable">p</span>,[]) = []
<span class="hl-keyword">def</span> <span class="hl-site">filter</span>(<span class="hl-variable">p</span>,<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">fxs</span> = <span class="hl-site">filter</span>(<span class="hl-variable">p</span>, <span class="hl-variable">xs</span>)
  <span class="hl-keyword">if</span> <span class="hl-site">p</span>(<span class="hl-variable">x</span>) <span class="hl-keyword">then</span> <span class="hl-variable">x</span>:<span class="hl-variable">fxs</span> <span class="hl-keyword">else</span> <span class="hl-variable">fxs</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">head</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">head</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the first element of a list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">head</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">head</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-variable">x</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">tail</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">tail</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return all but the first element of a list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">tail</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">tail</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-variable">xs</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">init</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">init</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return all but the last element of a list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">init</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">init</span>([<span class="hl-variable">x</span>]) = []
<span class="hl-keyword">def</span> <span class="hl-site">init</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-variable">x</span>:<span class="hl-site">init</span>(<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">last</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">last</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the last element of a list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">last</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">last</span>([<span class="hl-variable">x</span>]) = <span class="hl-variable">x</span>
<span class="hl-keyword">def</span> <span class="hl-site">last</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">last</span>(<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">empty</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">empty</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Is the list empty?</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">empty</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">empty</span>([]) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">empty</span>(<span class="hl-variable">_</span>) = <span class="hl-literal">false</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">index</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">index</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the nth element of a list, counting from 0.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">index</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">index</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>, <span class="hl-literal">0</span>) = <span class="hl-variable">h</span>
<span class="hl-keyword">def</span> <span class="hl-site">index</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>, <span class="hl-variable">n</span>) = <span class="hl-site">index</span>(<span class="hl-variable">t</span>, <span class="hl-variable">n</span>-<span class="hl-literal">1</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">append</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">append</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Return the first list concatenated with the second.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">append</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">append</span>([],<span class="hl-variable">l</span>) = <span class="hl-variable">l</span>
<span class="hl-keyword">def</span> <span class="hl-site">append</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>,<span class="hl-variable">l</span>) = <span class="hl-variable">h</span>:<span class="hl-site">append</span>(<span class="hl-variable">t</span>,<span class="hl-variable">l</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">foldl</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">foldl</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">B</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span></code>
                            </p><p>Reduce a list using the given left-associative binary operation and initial value.
Given the list <code class="code">[<span class="hl-variable">x1</span>, <span class="hl-variable">x2</span>, <span class="hl-variable">x3</span>, ...]</code> and initial value <code class="code"><span class="hl-variable">x0</span></code>,
returns <code class="code"><span class="hl-site">f</span>(... <span class="hl-site">f</span>(<span class="hl-site">f</span>(<span class="hl-site">f</span>(<span class="hl-variable">x0</span>, <span class="hl-variable">x1</span>), <span class="hl-variable">x2</span>), <span class="hl-variable">x3</span>) ...)</code>

                            </p><p>Example using <code class="code"><span class="hl-variable">foldl</span></code> to reverse a list:
<pre class="orc">
<span class="hl-comment">-- Publishes: [3, 2, 1]</span>
<span class="hl-site">foldl</span>(<span class="hl-site">flip</span>((:)), [], [<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">foldl</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">B</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-variable">z</span>,[]) = <span class="hl-variable">z</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-variable">z</span>,<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-site">f</span>(<span class="hl-variable">z</span>,<span class="hl-variable">x</span>),<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">foldl1</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">foldl1</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>A special case of <code class="code"><span class="hl-variable">foldl</span></code> which uses the last element of the list as the
initial value. It is an error to call this on an empty list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">foldl1</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldl1</span>(<span class="hl-variable">f</span>,<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">foldl</span>(<span class="hl-variable">f</span>,<span class="hl-variable">x</span>,<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">foldr</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">foldr</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span></code>
                            </p><p>Reduce a list using the given right-associative binary operation and initial value.
Given the list <code class="code">[..., <span class="hl-variable">x3</span>, <span class="hl-variable">x2</span>, <span class="hl-variable">x1</span>]</code> and initial value <code class="code"><span class="hl-variable">x0</span></code>,
returns <code class="code"><span class="hl-site">f</span>(... <span class="hl-site">f</span>(<span class="hl-variable">x3</span>, <span class="hl-site">f</span>(<span class="hl-variable">x2</span>, <span class="hl-site">f</span>(<span class="hl-variable">x1</span>, <span class="hl-variable">x0</span>))) ...)</code>

                            </p><p>Example summing the numbers in a list:
<pre class="orc">
<span class="hl-comment">-- Publishes: 6</span>
<span class="hl-site">foldr</span>((+), <span class="hl-literal">0</span>, [<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">foldr</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">B</span>) :: <span class="hl-variable">B</span>, <span class="hl-variable">B</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">B</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldr</span>(<span class="hl-variable">f</span>,<span class="hl-variable">z</span>,<span class="hl-variable">xs</span>) = <span class="hl-site">foldl</span>(<span class="hl-site">flip</span>(<span class="hl-variable">f</span>),<span class="hl-variable">z</span>,<span class="hl-site">reverse</span>(<span class="hl-variable">xs</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">foldr1</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">foldr1</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>A special case of <code class="code"><span class="hl-variable">foldr</span></code> which uses the last element of the list as the
initial value. It is an error to call this on an empty list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">foldr1</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">foldr1</span>(<span class="hl-variable">f</span>,<span class="hl-variable">xs</span>) = <span class="hl-site">foldl1</span>(<span class="hl-site">flip</span>(<span class="hl-variable">f</span>),<span class="hl-site">reverse</span>(<span class="hl-variable">xs</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">afold</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">afold</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Reduce a non-empty list using the given associative binary operation.
This function reduces independent subexpressions in parallel; the
calls exhibit a balanced tree structure, so the number of sequential 
reductions performed is O(log n).  For expensive reductions, this
is much more efficient than <code class="code"><span class="hl-variable">foldl</span></code> or <code class="code"><span class="hl-variable">foldr</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">afold</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">afold</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">x</span>]) = <span class="hl-variable">x</span>
<span class="hl-comment">{- Here's the interesting part -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">afold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">xs</span>) =
  <span class="hl-keyword">def</span> <span class="hl-variable">afold</span>'(<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
  <span class="hl-keyword">def</span> <span class="hl-variable">afold</span>'([]) = []
  <span class="hl-keyword">def</span> <span class="hl-variable">afold</span>'([<span class="hl-variable">x</span>]) = [<span class="hl-variable">x</span>]
  <span class="hl-keyword">def</span> <span class="hl-variable">afold</span>'(<span class="hl-variable">x</span>:<span class="hl-variable">y</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>):<span class="hl-variable">afold</span>'(<span class="hl-variable">xs</span>)
  <span class="hl-site">afold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">afold</span>'(<span class="hl-variable">xs</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">cfold</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">cfold</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Reduce a non-empty list using the given associative and commutative binary operation.
This function opportunistically reduces independent subexpressions in parallel, so the number of
sequential reductions performed is as small as possible.  For expensive reductions, this
is much more efficient than <code class="code"><span class="hl-variable">foldl</span></code> or <code class="code"><span class="hl-variable">foldr</span></code>. In cases
where the reduction does not always take the same amount of time to complete, it 
is also more efficient than <code class="code"><span class="hl-variable">afold</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">cfold</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>, <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">cfold</span>(<span class="hl-variable">f</span>, []) = <span class="hl-keyword">stop</span>
<span class="hl-keyword">def</span> <span class="hl-site">cfold</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">x</span>]) = <span class="hl-variable">x</span>
<span class="hl-keyword">def</span> <span class="hl-site">cfold</span>(<span class="hl-variable">f</span>, [<span class="hl-variable">x</span>,<span class="hl-variable">y</span>]) = <span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
<span class="hl-keyword">def</span> <span class="hl-site">cfold</span>(<span class="hl-variable">f</span>, <span class="hl-variable">L</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>]()
  <span class="hl-keyword">def</span> <span class="hl-site">work</span>(<span class="hl-variable">Number</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
  <span class="hl-keyword">def</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>, <span class="hl-variable">x</span>:<span class="hl-variable">y</span>:<span class="hl-variable">rest</span>) =
    <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>+<span class="hl-literal">1</span>, <span class="hl-variable">rest</span>)
  <span class="hl-keyword">def</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>, [<span class="hl-variable">x</span>]) = <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>+<span class="hl-literal">1</span>, [])
  <span class="hl-keyword">def</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>, []) =
    <span class="hl-keyword">if</span> (<span class="hl-variable">i</span> &lt; <span class="hl-literal">2</span>) <span class="hl-keyword">then</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>() 
    <span class="hl-keyword">else</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">y</span><span class="hl-combinator">&gt;</span>
         ( <span class="hl-variable">c</span>.<span class="hl-site">put</span>(<span class="hl-site">f</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">work</span>(<span class="hl-variable">i</span>-<span class="hl-literal">1</span>,[]) ) 
  <span class="hl-site">work</span>(<span class="hl-literal">0</span>, <span class="hl-variable">L</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">zip</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">zip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">B</span>]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]</code>
                            </p><p>Combine two lists into a list of pairs.
The length of the shortest list determines the length of the result.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">zip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">B</span>]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]
<span class="hl-keyword">def</span> <span class="hl-site">zip</span>([],<span class="hl-variable">_</span>) = []
<span class="hl-keyword">def</span> <span class="hl-site">zip</span>(<span class="hl-variable">_</span>,[]) = []
<span class="hl-keyword">def</span> <span class="hl-site">zip</span>(<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>,<span class="hl-variable">y</span>:<span class="hl-variable">ys</span>) = (<span class="hl-variable">x</span>,<span class="hl-variable">y</span>):<span class="hl-site">zip</span>(<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">unzip</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">unzip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: (<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">B</span>])</code>
                            </p><p>Split a list of pairs into a pair of lists.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">unzip</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: (<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">B</span>])
<span class="hl-keyword">def</span> <span class="hl-site">unzip</span>([]) = ([],[])
<span class="hl-keyword">def</span> <span class="hl-site">unzip</span>((<span class="hl-variable">x</span>,<span class="hl-variable">y</span>):<span class="hl-variable">z</span>) = (<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>,<span class="hl-variable">y</span>:<span class="hl-variable">ys</span>) <span class="hl-combinator">&lt;</span>(<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>)<span class="hl-combinator">&lt;</span> <span class="hl-site">unzip</span>(<span class="hl-variable">z</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">concat</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">concat</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-site">List</span>[<span class="hl-variable">A</span>]]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Concatenate a list of lists into a single list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">concat</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-site">List</span>[<span class="hl-variable">A</span>]]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">concat</span>([]) = []
<span class="hl-keyword">def</span> <span class="hl-site">concat</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-site">append</span>(<span class="hl-variable">h</span>,<span class="hl-site">concat</span>(<span class="hl-variable">t</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">length</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">length</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Integer</span></code>
                            </p><p>Return the number of elements in a list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">length</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Integer</span>
<span class="hl-keyword">def</span> <span class="hl-site">length</span>([]) = <span class="hl-literal">0</span>
<span class="hl-keyword">def</span> <span class="hl-site">length</span>(<span class="hl-variable">h</span>:<span class="hl-variable">t</span>) = <span class="hl-literal">1</span> + <span class="hl-site">length</span>(<span class="hl-variable">t</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">take</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">take</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Given a number <code class="code"><span class="hl-variable">n</span></code> and a list <code class="code"><span class="hl-variable">l</span></code>,
return the first <code class="code"><span class="hl-variable">n</span></code> elements of <code class="code"><span class="hl-variable">l</span></code>.
If <code class="code"><span class="hl-variable">n</span></code> exceeds the length of <code class="code"><span class="hl-variable">l</span></code>,
or <code class="code"><span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span></code>, take halts with an error.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">take</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">take</span>(<span class="hl-literal">0</span>, <span class="hl-variable">_</span>) = []
<span class="hl-keyword">def</span> <span class="hl-site">take</span>(<span class="hl-variable">n</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-variable">x</span>:<span class="hl-site">take</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>, <span class="hl-variable">xs</span>)
  <span class="hl-keyword">else</span> <span class="hl-site">error</span>(<span class="hl-literal">"Cannot take("</span> + <span class="hl-variable">n</span> + <span class="hl-literal">", _)"</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">drop</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">drop</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Given a number <code class="code"><span class="hl-variable">n</span></code> and a list <code class="code"><span class="hl-variable">l</span></code>,
return the elements of <code class="code"><span class="hl-variable">l</span></code> after the first <code class="code"><span class="hl-variable">n</span></code>.
If <code class="code"><span class="hl-variable">n</span></code> exceeds the length of <code class="code"><span class="hl-variable">l</span></code>,
or <code class="code"><span class="hl-variable">n</span> &lt; <span class="hl-literal">0</span></code>, drop halts with an error.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">drop</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">drop</span>(<span class="hl-literal">0</span>, <span class="hl-variable">xs</span>) = <span class="hl-variable">xs</span>
<span class="hl-keyword">def</span> <span class="hl-site">drop</span>(<span class="hl-variable">n</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> <span class="hl-site">drop</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>, <span class="hl-variable">xs</span>)
  <span class="hl-keyword">else</span> <span class="hl-site">error</span>(<span class="hl-literal">"Cannot drop("</span> + <span class="hl-variable">n</span> + <span class="hl-literal">", _)"</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">member</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">member</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return true if the given item is a member of the given list, and false
otherwise.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">member</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">member</span>(<span class="hl-variable">item</span>, []) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">member</span>(<span class="hl-variable">item</span>, <span class="hl-variable">h</span>:<span class="hl-variable">t</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">item</span> = <span class="hl-variable">h</span> <span class="hl-keyword">then</span> <span class="hl-literal">true</span>
  <span class="hl-keyword">else</span> <span class="hl-site">member</span>(<span class="hl-variable">item</span>, <span class="hl-variable">t</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">merge</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">merge</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Merge two sorted lists.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [1, 2, 2, 3, 4, 5]</span>
<span class="hl-site">merge</span>([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>], [<span class="hl-literal">2</span>,<span class="hl-literal">4</span>,<span class="hl-literal">5</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">merge</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">merge</span>(<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>) = <span class="hl-site">mergeBy</span>((&lt;), <span class="hl-variable">xs</span>, <span class="hl-variable">ys</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">mergeBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">mergeBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Merge two lists using the given less-than relation.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">mergeBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
               <span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>, <span class="hl-variable">xs</span>, []) = <span class="hl-variable">xs</span>
<span class="hl-keyword">def</span> <span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>, [], <span class="hl-variable">ys</span>) = <span class="hl-variable">ys</span>
<span class="hl-keyword">def</span> <span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>, <span class="hl-variable">y</span>:<span class="hl-variable">ys</span>) =
  <span class="hl-keyword">if</span> <span class="hl-site">lt</span>(<span class="hl-variable">y</span>,<span class="hl-variable">x</span>) <span class="hl-keyword">then</span> <span class="hl-variable">y</span>:<span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>,<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>)
  <span class="hl-keyword">else</span> <span class="hl-variable">x</span>:<span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>,<span class="hl-variable">xs</span>,<span class="hl-variable">y</span>:<span class="hl-variable">ys</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">sort</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">sort</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Sort a list.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [1, 2, 3]</span>
<span class="hl-site">sort</span>([<span class="hl-literal">1</span>,<span class="hl-literal">3</span>,<span class="hl-literal">2</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">sort</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sort</span>(<span class="hl-variable">xs</span>) = <span class="hl-site">sortBy</span>((&lt;), <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">sortBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">sortBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Sort a list using the given less-than relation.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">sortBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sortBy</span>(<span class="hl-variable">lt</span>, []) = []
<span class="hl-keyword">def</span> <span class="hl-site">sortBy</span>(<span class="hl-variable">lt</span>, [<span class="hl-variable">x</span>]) = [<span class="hl-variable">x</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sortBy</span>(<span class="hl-variable">lt</span>, <span class="hl-variable">xs</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">half</span> = <span class="hl-site">floor</span>(<span class="hl-site">length</span>(<span class="hl-variable">xs</span>)/<span class="hl-literal">2</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">front</span> = <span class="hl-site">take</span>(<span class="hl-variable">half</span>, <span class="hl-variable">xs</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">back</span> = <span class="hl-site">drop</span>(<span class="hl-variable">half</span>, <span class="hl-variable">xs</span>)
  <span class="hl-site">mergeBy</span>(<span class="hl-variable">lt</span>, <span class="hl-site">sortBy</span>(<span class="hl-variable">lt</span>, <span class="hl-variable">front</span>), <span class="hl-site">sortBy</span>(<span class="hl-variable">lt</span>, <span class="hl-variable">back</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">mergeUnique</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">mergeUnique</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Merge two sorted lists, discarding duplicates.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [1, 2, 3, 4, 5]</span>
<span class="hl-site">mergeUnique</span>([<span class="hl-literal">1</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>], [<span class="hl-literal">2</span>,<span class="hl-literal">4</span>,<span class="hl-literal">5</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">mergeUnique</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">mergeUnique</span>(<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>) = <span class="hl-site">mergeUniqueBy</span>((=), (&lt;), <span class="hl-variable">xs</span>, <span class="hl-variable">ys</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">mergeUniqueBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">mergeUniqueBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Merge two lists, discarding duplicates, using the given equality and less-than relations.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">mergeUniqueBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
                     <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
                      <span class="hl-site">List</span>[<span class="hl-variable">A</span>], <span class="hl-site">List</span>[<span class="hl-variable">A</span>])
  :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">xs</span>, []) = <span class="hl-variable">xs</span>
<span class="hl-keyword">def</span> <span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, [], <span class="hl-variable">ys</span>) = <span class="hl-variable">ys</span>
<span class="hl-keyword">def</span> <span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>, <span class="hl-variable">y</span>:<span class="hl-variable">ys</span>) =
  <span class="hl-keyword">if</span> <span class="hl-site">eq</span>(<span class="hl-variable">y</span>,<span class="hl-variable">x</span>) <span class="hl-keyword">then</span> <span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">xs</span>, <span class="hl-variable">y</span>:<span class="hl-variable">ys</span>)
  <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> <span class="hl-site">lt</span>(<span class="hl-variable">y</span>,<span class="hl-variable">x</span>) <span class="hl-keyword">then</span> <span class="hl-variable">y</span>:<span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>,<span class="hl-variable">lt</span>,<span class="hl-variable">x</span>:<span class="hl-variable">xs</span>,<span class="hl-variable">ys</span>)
  <span class="hl-keyword">else</span> <span class="hl-variable">x</span>:<span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>,<span class="hl-variable">lt</span>,<span class="hl-variable">xs</span>,<span class="hl-variable">y</span>:<span class="hl-variable">ys</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">sortUnique</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">sortUnique</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Sort a list, discarding duplicates.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [1, 2, 3]</span>
<span class="hl-site">sortUnique</span>([<span class="hl-literal">1</span>,<span class="hl-literal">3</span>,<span class="hl-literal">2</span>,<span class="hl-literal">3</span>])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">sortUnique</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sortUnique</span>(<span class="hl-variable">xs</span>) = <span class="hl-site">sortUniqueBy</span>((=), (&lt;), <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">sortUniqueBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">sortUniqueBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]</code>
                            </p><p>Sort a list, discarding duplicates, using the given equality and less-than relations.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">sortUniqueBy</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
                    <span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
                    <span class="hl-site">List</span>[<span class="hl-variable">A</span>])
  :: <span class="hl-site">List</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sortUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, []) = []
<span class="hl-keyword">def</span> <span class="hl-site">sortUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, [<span class="hl-variable">x</span>]) = [<span class="hl-variable">x</span>]
<span class="hl-keyword">def</span> <span class="hl-site">sortUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">xs</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">half</span> = <span class="hl-site">floor</span>(<span class="hl-site">length</span>(<span class="hl-variable">xs</span>)/<span class="hl-literal">2</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">front</span> = <span class="hl-site">take</span>(<span class="hl-variable">half</span>, <span class="hl-variable">xs</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">back</span> = <span class="hl-site">drop</span>(<span class="hl-variable">half</span>, <span class="hl-variable">xs</span>)
  <span class="hl-site">mergeUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>,
    <span class="hl-site">sortUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">front</span>),
    <span class="hl-site">sortUniqueBy</span>(<span class="hl-variable">eq</span>, <span class="hl-variable">lt</span>, <span class="hl-variable">back</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">group</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">group</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-site">List</span>[<span class="hl-variable">B</span>])]</code>

                            </p><p>Given a list of pairs, group together the second
elements of consecutive pairs with equal first elements.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: [(1, [1, 2]), (2, [3]), (3, [4]), (1, [3])]</span>
<span class="hl-site">group</span>([(<span class="hl-literal">1</span>,<span class="hl-literal">1</span>), (<span class="hl-literal">1</span>,<span class="hl-literal">2</span>), (<span class="hl-literal">2</span>,<span class="hl-literal">3</span>), (<span class="hl-literal">3</span>,<span class="hl-literal">4</span>), (<span class="hl-literal">1</span>,<span class="hl-literal">3</span>)])</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">group</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-site">List</span>[<span class="hl-variable">B</span>])]
<span class="hl-keyword">def</span> <span class="hl-site">group</span>(<span class="hl-variable">xs</span>) = <span class="hl-site">groupBy</span>((=), <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">groupBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">groupBy</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-site">List</span>[<span class="hl-variable">B</span>])]</code>
                            </p><p>Given a list of pairs, group together the second
elements of consecutive pairs with equal first elements,
using the given equality relation.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">groupBy</span>[<span class="hl-variable">A</span>,<span class="hl-variable">B</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>,<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>,
                 <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)])
  :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-site">List</span>[<span class="hl-variable">B</span>])]
<span class="hl-keyword">def</span> <span class="hl-site">groupBy</span>(<span class="hl-variable">eq</span>, []) = []
<span class="hl-keyword">def</span> <span class="hl-site">groupBy</span>(<span class="hl-variable">eq</span>, (<span class="hl-variable">k</span>,<span class="hl-variable">v</span>):<span class="hl-variable">kvs</span>) =
  <span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">A</span>, <span class="hl-site">List</span>[<span class="hl-variable">B</span>], <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-variable">B</span>)]) :: <span class="hl-site">List</span>[(<span class="hl-variable">A</span>,<span class="hl-site">List</span>[<span class="hl-variable">B</span>])]
  <span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">k</span>,<span class="hl-variable">vs</span>, []) = [(<span class="hl-variable">k</span>,<span class="hl-variable">vs</span>)]
  <span class="hl-keyword">def</span> <span class="hl-site">helper</span>(<span class="hl-variable">k</span>,<span class="hl-variable">vs</span>, (<span class="hl-variable">k2</span>,<span class="hl-variable">v</span>):<span class="hl-variable">kvs</span>) =
    <span class="hl-keyword">if</span> <span class="hl-site">eq</span>(<span class="hl-variable">k2</span>,<span class="hl-variable">k</span>) <span class="hl-keyword">then</span> <span class="hl-site">helper</span>(<span class="hl-variable">k</span>, <span class="hl-variable">v</span>:<span class="hl-variable">vs</span>, <span class="hl-variable">kvs</span>)
    <span class="hl-keyword">else</span> (<span class="hl-variable">k</span>,<span class="hl-variable">vs</span>):<span class="hl-site">helper</span>(<span class="hl-variable">k2</span>, [<span class="hl-variable">v</span>], <span class="hl-variable">kvs</span>)
  <span class="hl-site">helper</span>(<span class="hl-variable">k</span>,[<span class="hl-variable">v</span>], <span class="hl-variable">kvs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">rangeBy</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">rangeBy</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">Number</span>]</code>
                            </p><p>
                                <code class="code"><span class="hl-site">rangeBy</span>(<span class="hl-variable">low</span>, <span class="hl-variable">high</span>, <span class="hl-variable">skip</span>)</code> returns a sorted list of
numbers <code class="code"><span class="hl-variable">n</span></code> which satisfy <code class="code"><span class="hl-variable">n</span> = <span class="hl-variable">low</span> + <span class="hl-variable">skip</span>*<span class="hl-variable">i</span></code> (for some
integer <code class="code"><span class="hl-variable">i</span></code>), <code class="code"><span class="hl-variable">n</span> <span class="hl-site">&gt;=</span> <span class="hl-variable">low</span></code>, and <code class="code"><span class="hl-variable">n</span> &lt; <span class="hl-variable">high</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">rangeBy</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">Number</span>]
<span class="hl-keyword">def</span> <span class="hl-site">rangeBy</span>(<span class="hl-variable">low</span>, <span class="hl-variable">high</span>, <span class="hl-variable">skip</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">low</span> &lt; <span class="hl-variable">high</span>
  <span class="hl-keyword">then</span> <span class="hl-variable">low</span>:<span class="hl-site">rangeBy</span>(<span class="hl-variable">low</span>+<span class="hl-variable">skip</span>, <span class="hl-variable">high</span>, <span class="hl-variable">skip</span>)
  <span class="hl-keyword">else</span> []</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">range</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">range</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">Number</span>]</code>
                            </p><p>Generate a list of numbers in the given half-open range.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">range</span>(<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">Number</span>]
<span class="hl-keyword">def</span> <span class="hl-site">range</span>(<span class="hl-variable">low</span>, <span class="hl-variable">high</span>) = <span class="hl-site">rangeBy</span>(<span class="hl-variable">low</span>, <span class="hl-variable">high</span>, <span class="hl-literal">1</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">any</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">any</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return true if any of the elements of the list match the predicate, and false otherwise.
The predicate is applied to all elements of the list in parellel; the result
is returned as soon as it is known and any unnecessary evaluation of the predicate
terminated.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">any</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">any</span>(<span class="hl-variable">p</span>, []) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">any</span>(<span class="hl-variable">p</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) =
  <span class="hl-site">let</span>(
    <span class="hl-keyword">val</span> <span class="hl-variable">b1</span> = <span class="hl-site">p</span>(<span class="hl-variable">x</span>)
    <span class="hl-keyword">val</span> <span class="hl-variable">b2</span> = <span class="hl-site">any</span>(<span class="hl-variable">p</span>, <span class="hl-variable">xs</span>)
    <span class="hl-keyword">if</span>(<span class="hl-variable">b1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(<span class="hl-variable">b2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span> <span class="hl-combinator">|</span> (<span class="hl-variable">b1</span> <span class="hl-site">||</span> <span class="hl-variable">b2</span>)
  )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">all</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">all</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return true if all of the elements of the list match the predicate, and false otherwise.
The predicate is applied to all elements of the list in parellel; the result
is returned as soon as it is known and any unnecessary evaluation of the predicate
terminated.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">all</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> (<span class="hl-variable">A</span>) :: <span class="hl-variable">Boolean</span>, <span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">all</span>(<span class="hl-variable">p</span>, []) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">all</span>(<span class="hl-variable">p</span>, <span class="hl-variable">x</span>:<span class="hl-variable">xs</span>) =
  <span class="hl-site">let</span>(
    <span class="hl-keyword">val</span> <span class="hl-variable">b1</span> = <span class="hl-site">p</span>(<span class="hl-variable">x</span>)
    <span class="hl-keyword">val</span> <span class="hl-variable">b2</span> = <span class="hl-site">all</span>(<span class="hl-variable">p</span>, <span class="hl-variable">xs</span>)
    <span class="hl-keyword">if</span>(~<span class="hl-variable">b1</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">false</span> <span class="hl-combinator">|</span> <span class="hl-keyword">if</span>(~<span class="hl-variable">b2</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">false</span> <span class="hl-combinator">|</span> (<span class="hl-variable">b1</span> &amp;&amp; <span class="hl-variable">b2</span>)
  )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">sum</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-site">List</span>[<span class="hl-variable">Number</span>]) :: <span class="hl-variable">Number</span></code>
                            </p><p>Return the sum of all numbers in a list.
The sum of an empty list is 0.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-site">List</span>[<span class="hl-variable">Number</span>]) :: <span class="hl-variable">Number</span>
<span class="hl-keyword">def</span> <span class="hl-site">sum</span>(<span class="hl-variable">xs</span>) = <span class="hl-site">foldl</span>(
  (+) :: <span class="hl-keyword">lambda</span> (<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span>,
  <span class="hl-literal">0</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">product</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">product</span>(<span class="hl-site">List</span>[<span class="hl-variable">Number</span>]) :: <span class="hl-variable">Number</span></code>
                            </p><p>Return the product of all numbers in a list.
The product of an empty list is 1.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">product</span>(<span class="hl-site">List</span>[<span class="hl-variable">Number</span>]) :: <span class="hl-variable">Number</span>
<span class="hl-keyword">def</span> <span class="hl-site">product</span>(<span class="hl-variable">xs</span>) = <span class="hl-site">foldl</span>(
  (*) :: <span class="hl-keyword">lambda</span> (<span class="hl-variable">Number</span>, <span class="hl-variable">Number</span>) :: <span class="hl-variable">Number</span>,
  <span class="hl-literal">1</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">and</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">and</span>(<span class="hl-site">List</span>[<span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return the boolean conjunction of all boolean values in the list.
The conjunction of an empty list is <code class="code"><span class="hl-literal">true</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">and</span>(<span class="hl-site">List</span>[<span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">and</span>([]) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">and</span>(<span class="hl-literal">false</span>:<span class="hl-variable">xs</span>) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">and</span>(<span class="hl-literal">true</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">and</span>(<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">or</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">or</span>(<span class="hl-site">List</span>[<span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span></code>
                            </p><p>Return the boolean disjunction of all boolean values in the list.
The disjunction of an empty list is <code class="code"><span class="hl-literal">false</span></code>.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">or</span>(<span class="hl-site">List</span>[<span class="hl-variable">Boolean</span>]) :: <span class="hl-variable">Boolean</span>
<span class="hl-keyword">def</span> <span class="hl-site">or</span>([]) = <span class="hl-literal">false</span>
<span class="hl-keyword">def</span> <span class="hl-site">or</span>(<span class="hl-literal">true</span>:<span class="hl-variable">xs</span>) = <span class="hl-literal">true</span>
<span class="hl-keyword">def</span> <span class="hl-site">or</span>(<span class="hl-literal">false</span>:<span class="hl-variable">xs</span>) = <span class="hl-site">or</span>(<span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">minimum</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">minimum</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the minimum element of a non-empty list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">minimum</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">minimum</span>(<span class="hl-variable">xs</span>) =
  <span class="hl-comment">-- this def appeases the typechecker</span>
  <span class="hl-keyword">def</span> <span class="hl-site">minA</span>(<span class="hl-variable">x</span>::<span class="hl-variable">A</span>,<span class="hl-variable">y</span>::<span class="hl-variable">A</span>) = <span class="hl-site">min</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
  <span class="hl-site">foldl1</span>(<span class="hl-variable">minA</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">maximum</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">maximum</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span></code>
                            </p><p>Return the maximum element of a non-empty list.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">maximum</span>[<span class="hl-variable">A</span>](<span class="hl-site">List</span>[<span class="hl-variable">A</span>]) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">maximum</span>(<span class="hl-variable">xs</span>) =
  <span class="hl-comment">-- this def appeases the typechecker</span>
  <span class="hl-keyword">def</span> <span class="hl-site">maxA</span>(<span class="hl-variable">x</span>::<span class="hl-variable">A</span>,<span class="hl-variable">y</span>::<span class="hl-variable">A</span>) = <span class="hl-site">max</span>(<span class="hl-variable">x</span>,<span class="hl-variable">y</span>)
  <span class="hl-site">foldl1</span>(<span class="hl-variable">maxA</span>, <span class="hl-variable">xs</span>)</pre></p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N130B9"></a>B.3.5.&nbsp;reflect.inc: Metalanguage operations.</h3></div></div></div><p>Metalanguage operations.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Site</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Site</span>[<span class="hl-variable">A</span>](<span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>This site promotes an Orc closure to a site; when the site is called, the
closure is executed on those arguments. These executions behave
like site calls; in particular, the following four properties hold:</p><p>
                                <div class="itemizedlist"><ul type="disc"><li> The site, like all sites, is strict in its arguments. </li><li> The site returns only the first value published by the executed closure. The closure continues to run, but its subsequent publications are discarded. </li><li> The execution of the closure is protected from termination. If the site call is terminated, the closure still runs, and its publications are simply ignored. </li><li> If the execution of the closure halts, so does the site call. </li></ul></div>
                            </p><p>The typical usage of Site looks like:</p><p>
                                <pre class="orc">
<span class="hl-keyword">def</span> <span class="hl-site">foo</span>(...) = ...
<span class="hl-keyword">val</span> <span class="hl-variable">Foo</span> = <span class="hl-site">Site</span>(<span class="hl-variable">foo</span>)</pre>
                            </p><p>The typing of Site will enforce the side condition that the type A is an arrow
type.</p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N130E5"></a>B.3.6.&nbsp;text.inc: Operations on strings.</h3></div></div></div><p>Operations on strings.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">String</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">String</span></code>
                            </p><p>Strings themselves have a set of methods associated with them. These methods can
be invoked on any string literal or any variable bound to a string.</p><p>The methods documented here are only a subset of those available in the Java
implementation. In practice, strings in the Java implementation support all 
methods provided by Java's <code class="code"><span class="hl-variable">String</span></code> class.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">length</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">String</span>.<span class="hl-site">length</span>() :: <span class="hl-variable">Integer</span></code>

                                    </p><p>Return the length of the string.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 4</span>
<span class="hl-literal">"four"</span>.<span class="hl-site">length</span>()</pre>
                                    </p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">substring</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">String</span>.<span class="hl-site">substring</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">Integer</span>) :: <span class="hl-variable">String</span></code>

                                    </p><p>Return the substring of this string covered by the given half-open range.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: "orc"</span>
<span class="hl-keyword">val</span> <span class="hl-variable">s</span> = <span class="hl-literal">"apple orchard"</span>
<span class="hl-variable">s</span>.<span class="hl-site">substring</span>(<span class="hl-literal">6</span>,<span class="hl-literal">9</span>)</pre>
                                    </p></td></tr><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">indexOf</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">String</span>.<span class="hl-site">indexOf</span>(<span class="hl-variable">String</span>) :: <span class="hl-variable">Integer</span></code>

                                    </p><p>Return the starting index of the first occurrence of the given string.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 6</span>
<span class="hl-literal">"apple orchard"</span>.<span class="hl-site">indexOf</span>(<span class="hl-literal">"orc"</span>)</pre>
                                    </p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">cat</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">cat</span>(<span class="hl-variable">Top</span>, ...) :: <span class="hl-variable">String</span></code>
                            </p><p>Return the string representation of one or more values, concatenated.
For Java objects, this will call <code class="code"><span class="hl-site">toString</span>()</code> to convert
the object to a String.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">print</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">print</span>(<span class="hl-variable">Top</span>, ...) :: <span class="hl-variable">Top</span></code>
                            </p><p>Print one or more values as strings, concatenated, to standard output.
For Java objects, this will call <code class="code"><span class="hl-site">toString</span>()</code> to convert
the object to a String.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">println</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">println</span>(<span class="hl-variable">Top</span>, ...) :: <span class="hl-variable">Top</span></code>
                            </p><p>Print one or more values as strings, concatenated,
to standard output, with each value followed by a newline.
For Java objects, this will call <code class="code"><span class="hl-site">toString</span>()</code> to convert
the object to a String.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">read</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">read</span>[<span class="hl-variable">A</span>](<span class="hl-variable">String</span>) :: <span class="hl-variable">A</span></code>

                            </p><p>Given a string representing an Orc value (using standard
Orc literal syntax), return the corresponding value. If
the argument does not conform to Orc literal syntax,
halt with an error.</p><p>Example:
<pre class="orc">
  <span class="hl-site">read</span>(<span class="hl-literal">"true"</span>) <span class="hl-comment">-- publishes the boolean true</span>
<span class="hl-combinator">|</span> <span class="hl-site">read</span>(<span class="hl-literal">"1"</span>) <span class="hl-comment">-- publishes the integer 1</span>
<span class="hl-combinator">|</span> <span class="hl-site">read</span>(<span class="hl-literal">"(3.0, [])"</span>) <span class="hl-comment">-- publishes the tuple (3.0, [])</span>
<span class="hl-combinator">|</span> <span class="hl-site">read</span>(<span class="hl-literal">"\"hi\""</span>) <span class="hl-comment">-- publishes the string "hi"</span></pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">write</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">write</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">String</span></code>

                            </p><p>Given an Orc value, return its string representation
using standard Orc literal syntax.  If the value is
of a type with no literal syntax,
(for example, it is a site), return an arbitrary string
representation which is intended to be human-readable.</p><p>Example:
<pre class="orc">
  <span class="hl-site">write</span>(<span class="hl-literal">true</span>) <span class="hl-comment">-- publishes "true"</span>
<span class="hl-combinator">|</span> <span class="hl-site">write</span>(<span class="hl-literal">1</span>) <span class="hl-comment">-- publishes "1"</span>
<span class="hl-combinator">|</span> <span class="hl-site">write</span>((<span class="hl-literal">3.0</span>, [])) <span class="hl-comment">-- publishes "(3.0, [])"</span>
<span class="hl-combinator">|</span> <span class="hl-site">write</span>(<span class="hl-literal">"hi"</span>) <span class="hl-comment">-- publishes "\"hi\""</span></pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">lines</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">lines</span>(<span class="hl-variable">String</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]</code>
                            </p><p>Split a string into lines, which are substrings
terminated by an endline or the end of the string.
DOS, Mac, and Unix endline conventions are all accepted.
Endline characters are not included in the result.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">lines</span>(<span class="hl-variable">String</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]
<span class="hl-keyword">def</span> <span class="hl-site">lines</span>(<span class="hl-variable">text</span>) =
  (
  <span class="hl-keyword">val</span> <span class="hl-variable">out</span> = <span class="hl-variable">text</span>.<span class="hl-site">split</span>(<span class="hl-literal">"\n|\r\n|\r"</span>)
  <span class="hl-keyword">if</span> <span class="hl-variable">out</span>.<span class="hl-site">get</span>(<span class="hl-variable">out</span>.<span class="hl-site">length</span>()-<span class="hl-literal">1</span>) = <span class="hl-literal">""</span> <span class="hl-keyword">then</span>
    <span class="hl-variable">out</span>.<span class="hl-site">split</span>(<span class="hl-literal">0</span>, <span class="hl-variable">out</span>.<span class="hl-site">length</span>()-<span class="hl-literal">1</span>)
  <span class="hl-keyword">else</span> <span class="hl-variable">out</span>
  ) :!: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">unlines</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">unlines</span>(<span class="hl-site">List</span>[<span class="hl-variable">String</span>]) :: <span class="hl-variable">String</span></code>
                            </p><p>Append a linefeed, "\n", to each string in the sequence
and concatenate the results.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">unlines</span>(<span class="hl-site">List</span>[<span class="hl-variable">String</span>]) :: <span class="hl-variable">String</span>
<span class="hl-keyword">def</span> <span class="hl-site">unlines</span>(<span class="hl-variable">line</span>:<span class="hl-variable">lines</span>) = <span class="hl-site">cat</span>(<span class="hl-variable">line</span>, <span class="hl-literal">"\n"</span>, <span class="hl-site">unlines</span>(<span class="hl-variable">lines</span>))
<span class="hl-keyword">def</span> <span class="hl-site">unlines</span>([]) = <span class="hl-literal">""</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">words</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">words</span>(<span class="hl-variable">String</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]</code>
                            </p><p>Split a string into words, which are sequences of non-whitespace characters separated by whitespace.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">words</span>(<span class="hl-variable">String</span>) :: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]
<span class="hl-keyword">def</span> <span class="hl-site">words</span>(<span class="hl-variable">text</span>) = (<span class="hl-variable">text</span>.<span class="hl-site">trim</span>().<span class="hl-site">split</span>(<span class="hl-literal">"\\s+"</span>)) :!: <span class="hl-site">List</span>[<span class="hl-variable">String</span>]</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">unwords</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">unwords</span>(<span class="hl-site">List</span>[<span class="hl-variable">String</span>]) :: <span class="hl-variable">String</span></code>
                            </p><p>Concatenate a sequence of strings with a single space between
each string.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">unwords</span>(<span class="hl-site">List</span>[<span class="hl-variable">String</span>]) :: <span class="hl-variable">String</span>
<span class="hl-keyword">def</span> <span class="hl-site">unwords</span>([]) = <span class="hl-literal">""</span>
<span class="hl-keyword">def</span> <span class="hl-site">unwords</span>([<span class="hl-variable">word</span>]) = <span class="hl-variable">word</span>
<span class="hl-keyword">def</span> <span class="hl-site">unwords</span>(<span class="hl-variable">word</span>:<span class="hl-variable">words</span>) = <span class="hl-site">cat</span>(<span class="hl-variable">word</span>, <span class="hl-literal">" "</span>, <span class="hl-site">unwords</span>(<span class="hl-variable">words</span>))</pre></p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N131E6"></a>B.3.7.&nbsp;time.inc: Real and logical time.</h3></div></div></div><p>Real and logical time.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Rtimer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Rtimer</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Top</span></code>
                            </p><p>Publish a signal after the given number of milliseconds.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">time</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Rtimer</span>.<span class="hl-site">time</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the current real time in milliseconds, as
measured from midnight January 1, 1970 UTC.
Ranges from 0 to <code class="code"><span class="hl-variable">Long</span>.<span class="hl-variable">MAX_VALUE</span></code>.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Clock</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">Clock</span>()() :: <span class="hl-variable">Number</span></code>

                            </p><p>A call to <code class="code"><span class="hl-variable">Clock</span></code> creates a new relative real-time clock.
Calling a relative clock returns the number
of milliseconds which have elapsed since the
clock was created.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes a value near 1000</span>
<span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Clock</span>()
<span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">c</span>()</pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Ltimer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Ltimer</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Top</span></code>
                            </p><p>Publish a signal after the given number of logical timesteps,
as measured by the current logical clock.
The logical time advances whenever the computation controlled
by the logical clock is quiescent (i.e. cannot advance on its own).</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                                    <code class="code"><span class="hl-variable">time</span></code>
                                    </span></p></td><td><p>
                                    <code class="code"><span class="hl-keyword">site</span> <span class="hl-variable">Ltimer</span>.<span class="hl-site">time</span>() :: <span class="hl-variable">Integer</span></code>
                                    </p><p>Return the current logical time, as measured by logical
clock which was current when <code class="code"><span class="hl-variable">Ltimer</span>.<span class="hl-variable">time</span></code> was evaluated.
Ranges from 0 to <code class="code"><span class="hl-variable">Integer</span>.<span class="hl-variable">MAX_VALUE</span></code>.</p></td></tr></tbody></table></div></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">withLtimer</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">withLtimer</span>[<span class="hl-variable">A</span>](<span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Run the given thunk in the context of a new inner logical clock.
Within the computation represented by the thunk, calls to
<code class="code"><span class="hl-variable">Ltimer</span></code> refer to the new clock. The
outer clock can only advance when the inner clock becomes
quiescent.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">metronome</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">metronome</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Top</span></code>
                            </p><p>Publish a signal at regular intervals, indefinitely. The period is given by the
argument, in milliseconds.</p></td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1326B"></a>B.3.8.&nbsp;util.inc: Miscellaneous utility functions.</h3></div></div></div><p>Miscellaneous utility functions.</p><div class="variablelist"><table border="0"><col valign="top" align="left"><tbody><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">random</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">random</span>() :: <span class="hl-variable">Integer</span></code>
                            </p><p>Return a random Integer value
chosen from the range of all possible 32-bit Integer values.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">random</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">random</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span></code>
                            </p><p>Return a pseudorandom, uniformly distributed Integer value
between 0 (inclusive) and the specified value (exclusive).
If the argument is 0, halt.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">urandom</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">urandom</span>() :: <span class="hl-variable">Number</span></code>
                            </p><p>Returns a pseudorandom, uniformly distributed Double value
between 0 and 1, inclusive.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">UUID</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">UUID</span>() :: <span class="hl-variable">String</span></code>
                            </p><p>Return a random (type 4) UUID represented as a string.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Thread</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Thread</span>(<span class="hl-variable">Top</span>) :: <span class="hl-variable">Bot</span></code>
                            </p><p>Given a site, return a new site which calls the original site
in a separate thread.  This is necessary when calling
a Java site which does not cooperate with Orc's scheduler
and may block for an unpredictable amount of time.</p><p>A limited number of threads are reserved in a pool for use
by this site, so there is a limit to the number of blocking,
uncooperative sites that can be called simultaneously.</p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">Prompt</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">site</span> <span class="hl-site">Prompt</span>(<span class="hl-variable">String</span>) :: <span class="hl-variable">String</span></code>

                            </p><p>Prompt the user for some input. The user may cancel the prompt,
in which case the site fails silently. Otherwise their response
is returned as soon as it is received.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes the user's name</span>
<span class="hl-site">Prompt</span>(<span class="hl-literal">"What is your name?"</span>)</pre>
                            </p><p>The user response is always taken to be a string. Thus, integer 
3 as a response will be treated as "3". To convert the response 
to its appropriate data type, use the library function
<code class="code"><span class="hl-variable">read</span></code>:</p><p>
                                <pre class="orc">
<span class="hl-comment">-- Prompts the user to enter an integer, then parses the response.</span>
<span class="hl-site">Prompt</span>(<span class="hl-literal">"Enter an integer:"</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">r</span><span class="hl-combinator">&gt;</span> <span class="hl-site">read</span>(<span class="hl-variable">r</span>)</pre>
                            </p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">signals</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">signals</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Top</span></code>

                            </p><p>Publish the given number of signals, simultaneously.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes five signals</span>
<span class="hl-site">signals</span>(<span class="hl-literal">5</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">signals</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Top</span>
<span class="hl-keyword">def</span> <span class="hl-site">signals</span>(<span class="hl-variable">n</span>) = <span class="hl-keyword">if</span> <span class="hl-variable">n</span> &gt; <span class="hl-literal">0</span> <span class="hl-keyword">then</span> (<span class="hl-keyword">signal</span> <span class="hl-combinator">|</span> <span class="hl-site">signals</span>(<span class="hl-variable">n</span>-<span class="hl-literal">1</span>))</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">for</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">for</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span></code>

                            </p><p>Publish all values in the given half-open range, simultaneously.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 1 2 3 4 5</span>
<span class="hl-site">for</span>(<span class="hl-literal">1</span>,<span class="hl-literal">6</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">for</span>(<span class="hl-variable">Integer</span>, <span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span>
<span class="hl-keyword">def</span> <span class="hl-site">for</span>(<span class="hl-variable">low</span>, <span class="hl-variable">high</span>) =
  <span class="hl-keyword">if</span> <span class="hl-variable">low</span> <span class="hl-site">&gt;=</span> <span class="hl-variable">high</span> <span class="hl-keyword">then</span> <span class="hl-keyword">stop</span>
  <span class="hl-keyword">else</span> ( <span class="hl-variable">low</span> <span class="hl-combinator">|</span> <span class="hl-site">for</span>(<span class="hl-variable">low</span>+<span class="hl-literal">1</span>, <span class="hl-variable">high</span>) )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">upto</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">upto</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span></code>
                            </p><p>

                                <code class="code"><span class="hl-site">upto</span>(<span class="hl-variable">n</span>)</code> publishes all values in the range <code class="code">(<span class="hl-literal">0.</span>.<span class="hl-variable">n</span>-<span class="hl-literal">1</span>)</code>
simultaneously.</p><p>Example:
<pre class="orc">
<span class="hl-comment">-- Publishes: 0 1 2 3 4</span>
<span class="hl-site">upto</span>(<span class="hl-literal">5</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">upto</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">Integer</span>
<span class="hl-keyword">def</span> <span class="hl-site">upto</span>(<span class="hl-variable">high</span>) = <span class="hl-site">for</span>(<span class="hl-literal">0</span>, <span class="hl-variable">high</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">fillArray</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">fillArray</span>[<span class="hl-variable">A</span>](<span class="hl-site">Array</span>[<span class="hl-variable">A</span>], <span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>) :: <span class="hl-site">Array</span>[<span class="hl-variable">A</span>]</code>

                            </p><p>Given an array and a function from indices to values, populate the array
by calling the function for each index in the array.</p><p>For example, to set all elements of an array to zero:
<pre class="orc">
<span class="hl-comment">-- Publishes: 0 0 0</span>
<span class="hl-keyword">val</span> <span class="hl-variable">a</span> = <span class="hl-site">fillArray</span>(<span class="hl-site">Array</span>(<span class="hl-literal">3</span>), <span class="hl-keyword">lambda</span> (<span class="hl-variable">_</span>) = <span class="hl-literal">0</span>)
<span class="hl-variable">a</span>.<span class="hl-site">get</span>(<span class="hl-literal">0</span>) <span class="hl-combinator">|</span> <span class="hl-variable">a</span>.<span class="hl-site">get</span>(<span class="hl-literal">1</span>) <span class="hl-combinator">|</span> <span class="hl-variable">a</span>.<span class="hl-site">get</span>(<span class="hl-literal">2</span>)</pre>
                            </p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">fillArray</span>[<span class="hl-variable">A</span>](<span class="hl-site">Array</span>[<span class="hl-variable">A</span>], <span class="hl-keyword">lambda</span> (<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>)
  :: <span class="hl-site">Array</span>[<span class="hl-variable">A</span>]
<span class="hl-keyword">def</span> <span class="hl-site">fillArray</span>(<span class="hl-variable">a</span>, <span class="hl-variable">f</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">n</span> = <span class="hl-variable">a</span>.<span class="hl-site">length</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">fill</span>(<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span>(<span class="hl-variable">Integer</span>) :: <span class="hl-variable">A</span>) :: <span class="hl-variable">Bot</span>
  <span class="hl-keyword">def</span> <span class="hl-site">fill</span>(<span class="hl-variable">i</span>, <span class="hl-variable">f</span>) =
    <span class="hl-keyword">if</span> <span class="hl-variable">i</span> = <span class="hl-variable">n</span> <span class="hl-keyword">then</span> <span class="hl-keyword">stop</span>
    <span class="hl-keyword">else</span> ( <span class="hl-variable">a</span>.<span class="hl-site">set</span>(<span class="hl-variable">i</span>, <span class="hl-site">f</span>(<span class="hl-variable">i</span>)) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
         <span class="hl-combinator">|</span> <span class="hl-site">fill</span>(<span class="hl-variable">i</span>+<span class="hl-literal">1</span>, <span class="hl-variable">f</span>) )
  <span class="hl-site">fill</span>(<span class="hl-literal">0</span>, <span class="hl-variable">f</span>) <span class="hl-combinator">;</span> <span class="hl-variable">a</span></pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">takePubs</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">takePubs</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>
                                <code class="code"><span class="hl-site">takePubs</span>(<span class="hl-variable">n</span>, <span class="hl-variable">f</span>)</code> calls <code class="code"><span class="hl-site">f</span>()</code>,
publishes the first <code class="code"><span class="hl-variable">n</span></code> values published
by <code class="code"><span class="hl-site">f</span>()</code> (as they are published), and then
halts.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">takePubs</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Integer</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">takePubs</span>(<span class="hl-variable">n</span>, <span class="hl-variable">f</span>) =
  <span class="hl-keyword">val</span> <span class="hl-variable">out</span> = <span class="hl-site">Buffer</span>[<span class="hl-variable">A</span>]()
  <span class="hl-keyword">val</span> <span class="hl-variable">c</span> = <span class="hl-site">Counter</span>(<span class="hl-variable">n</span>)
  <span class="hl-site">let</span>(
    <span class="hl-site">f</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>
    <span class="hl-keyword">if</span>(<span class="hl-variable">c</span>.<span class="hl-site">dec</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">out</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">false</span>
       <span class="hl-combinator">;</span> <span class="hl-variable">out</span>.<span class="hl-site">closenb</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-literal">true</span>)
  ) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span> <span class="hl-combinator">|</span> <span class="hl-site">repeat</span>(<span class="hl-variable">out</span>.<span class="hl-variable">get</span>)</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">withLock</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">withLock</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Semaphore</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span></code>
                            </p><p>Acquire the semaphore and run a thunk which is expected to publish
no more than one value. Publishes the value published by the
thunk and releases the semaphore.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">withLock</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Semaphore</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>) :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">withLock</span>(<span class="hl-variable">s</span>, <span class="hl-variable">f</span>) =
  <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> (
    <span class="hl-site">let</span>(<span class="hl-site">f</span>()) <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">x</span>
    <span class="hl-combinator">;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
  )</pre></p></td></tr><tr><td><p><span class="term">
                            <code class="code"><span class="hl-variable">synchronized</span></code>
                        </span></p></td><td><p>
                                <code class="code"><span class="hl-keyword">def</span> <span class="hl-site">synchronized</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Semaphore</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>)() :: <span class="hl-variable">A</span></code>
                            </p><p>Given a lock and thunk, return a new thunk which is serialized
on the lock. Similar to Java's synchronized keyword.</p><p><b>Implementation.&nbsp;</b><pre class="programlisting"><span class="hl-keyword">def</span> <span class="hl-site">synchronized</span>[<span class="hl-variable">A</span>](<span class="hl-variable">Semaphore</span>, <span class="hl-keyword">lambda</span> () :: <span class="hl-variable">A</span>)() :: <span class="hl-variable">A</span>
<span class="hl-keyword">def</span> <span class="hl-site">synchronized</span>(<span class="hl-variable">s</span>,<span class="hl-variable">f</span>)() = <span class="hl-site">withLock</span>(<span class="hl-variable">s</span>, <span class="hl-variable">f</span>)</pre></p></td></tr></tbody></table></div></div></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="N13389"></a>Appendix&nbsp;C.&nbsp;Experimental Features</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#N1338C">C.1. Exceptions in Orc</a></span></dt><dd><dl><dt><span class="section"><a href="#N133FC">C.1.1. Catching Java exceptions</a></span></dt><dt><span class="section"><a href="#N1340F">C.1.2. Catching Orc Engine Errors</a></span></dt><dt><span class="section"><a href="#N1342A">C.1.3. Exceptions in Practice</a></span></dt><dt><span class="section"><a href="#N1343C">C.1.4. Typechecking Exceptions</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N1338C"></a>C.1.&nbsp;Exceptions in Orc</h2></div></div></div><p>
We have added an experimental implementation of <span class="emphasis"><em>exceptions</em></span> to the Orc language,
which allows exceptions to be raised, caught, and handled.  Exceptions
are currently off by default, and can be enabled by adding the <code class="code">-<span class="hl-variable">exceptions</span></code> flag
on the command line.  It should also be noted that exception handling in Orc are currently experimental, and may be
removed in a future release.
</p><p>
Exceptions introduce three new keywords to the Orc syntax: 
<code class="code"><span class="hl-keyword">throw</span></code>, <code class="code"><span class="hl-keyword">try</span></code>, and <code class="code"><span class="hl-keyword">catch</span></code>, which are defined as follows:

<p>
<code class="code"><span class="hl-keyword">throw</span></code> E: for each publication x by expression E, raise an exception with value x.
</p>

<p>
<code class="code"><span class="hl-keyword">try</span> </code> E: Defines E to be a block, possibly containing throw expressions.
</p>

<p>
<code class="code"><span class="hl-keyword">catch</span> (</code> P <code class="code">) </code>E: Given pattern P and expression E, any exception
with value x that matches pattern P causes execution of E under the binding of P to x.
For each corresponding try expression, one or more catch statements are defined.  Catch
statements are executed in order, and the first to match is the statement executed.
</p>

<p>
Examples of throw expressions:

<p>
<pre class="programlisting">
<span class="hl-keyword">throw</span> <span class="hl-literal">3</span>
<span class="hl-keyword">throw</span> <span class="hl-literal">"error"</span>
<span class="hl-keyword">throw</span> (<span class="hl-literal">3</span> <span class="hl-combinator">|</span> <span class="hl-literal">4</span>)    <span class="hl-comment">{- throws two exceptions -}</span>
<span class="hl-keyword">throw</span> <span class="hl-keyword">stop</span>       <span class="hl-comment">{- throws no exceptions -}</span>
</pre>
</p>

</p>

Below we combine both exception raising and handling:

<p>
<pre class="programlisting">
<span class="hl-comment">{- simple exception expressions -}</span>
<span class="hl-keyword">try</span>(<span class="hl-literal">0</span> <span class="hl-combinator">|</span> <span class="hl-keyword">throw</span> <span class="hl-literal">1</span> <span class="hl-combinator">|</span> <span class="hl-keyword">throw</span> <span class="hl-literal">2</span>) 
<span class="hl-keyword">catch</span> (<span class="hl-literal">1</span>) <span class="hl-literal">"one"</span>
<span class="hl-keyword">catch</span> (<span class="hl-variable">x</span>) <span class="hl-variable">x</span>               
<span class="hl-keyword">catch</span> (<span class="hl-literal">2</span>) <span class="hl-literal">"two"</span>           

<span class="hl-comment">{- Output: 0, "one", 2 -}</span>
</pre>
</p>

The value <code class="code"><span class="hl-literal">0</span></code> is published by the expression directly, while <code class="code"><span class="hl-literal">"one"</span></code> is
published by <code class="code"><span class="hl-keyword">catch</span> (<span class="hl-literal">1</span>) <span class="hl-literal">"one"</span></code>, and <code class="code"><span class="hl-literal">2</span></code> is published by <code class="code"><span class="hl-keyword">catch</span>(<span class="hl-variable">x</span>) <span class="hl-variable">x</span></code>.
The handler <code class="code"><span class="hl-keyword">catch</span> (<span class="hl-literal">2</span>) <span class="hl-literal">"two"</span></code> is not executed.

</p><p>
Exception handlers can also be nested; if the immediately enclosing
try/catch block has no handler that matches the thrown exception, the
Orc interpreter attempts to match against the next enclosing handler.  If
no handler matches the exception (or no enclosing handler exists) the exception
is dropped (for example, it is treated as a <code class="code"><span class="hl-keyword">stop</span></code>) 
and an error is reported to the interpreter.
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- a contrived nested handler example -}</span>
<span class="hl-keyword">try</span>(
  <span class="hl-keyword">try</span>(<span class="hl-keyword">throw</span> <span class="hl-literal">3</span>)
  <span class="hl-keyword">catch</span> (<span class="hl-literal">1</span>) <span class="hl-literal">"one"</span>
)
<span class="hl-keyword">catch</span> (<span class="hl-variable">x</span>) <span class="hl-variable">x</span>
</pre>
</p><p>
When combining exceptions with the combinators, i.e., the pruning or
otherwise combinators, exceptions are silent, that is, they do not publish any value.
For example, in the following expression, both <code class="code"><span class="hl-literal">0</span></code> and
<code class="code"><span class="hl-literal">1</span></code> are published; <code class="code"><span class="hl-keyword">throw</span> <span class="hl-literal">0</span></code> is silent, not publishing
any value, causing the otherwise combinator to also execute its alternate expression:
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- the throw expression is treated as a silent by the combinators -}</span>
<span class="hl-keyword">try</span> (<span class="hl-keyword">throw</span> <span class="hl-literal">0</span><span class="hl-combinator">;</span> <span class="hl-literal">1</span>) <span class="hl-keyword">catch</span>(<span class="hl-variable">x</span>) <span class="hl-variable">x</span>

<span class="hl-comment">{- output: 
0
1
-}</span>
</pre>
</p><p>
Similarly, exceptions thrown within a pruning combinator do not terminate 
the expression (since the throw is treated as a silent), and throwing a silent expression
(i.e., <code class="code"><span class="hl-keyword">throw</span> <span class="hl-keyword">stop</span></code>) results in no exception being thrown; the entire
expression functions as a stop.  Unlike other languages, an uncaught exception
only kills the process that threw it, and the other processes in the system
will continue running.  In the example below, the entire expression publishes no value
(because the expression inside the pruning combinator does not publish).  Instead,
the exception thrown is uncaught and results in a runtime error:
</p><p>
<pre class="programlisting">
<span class="hl-variable">x</span> <span class="hl-combinator">&lt;</span><span class="hl-variable">x</span><span class="hl-combinator">&lt;</span> <span class="hl-keyword">throw</span> <span class="hl-literal">2</span>

<span class="hl-comment">{- output:
Error: uncaught exception:
Backtrace:
OrcJava/examples/uncaught.orc:1:8-15:  x &lt;x&lt; throw 2
-}</span>
</pre>
</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N133FC"></a>C.1.1.&nbsp;Catching Java exceptions</h3></div></div></div><p>
Orc also allows Java exceptions thrown by sites 
to be matched against by Orc exception
handlers.  This is especially useful when calling Java code directly,
which might throw exceptions in cases of failure, seen here in this 
short example.  Attemping to create a <code class="code"><span class="hl-variable">FileInputSteam</span></code> with
a nonexistent file path returns an error by throwing a <code class="code"><span class="hl-variable">FileNotFoundException</span></code>.
By pattern matching for a <code class="code"><span class="hl-variable">FileNotFoundException</span></code>, the
error can be detected and handled by the Orc program.

</p><p>
<pre class="programlisting">
<span class="hl-comment">{- catching exceptions thrown by Java sites via pattern matching -}</span>
<span class="hl-keyword">class</span> <span class="hl-variable">FileInputStream</span> = <span class="hl-variable">java</span>.<span class="hl-variable">io</span>.<span class="hl-variable">FileInputStream</span>
<span class="hl-keyword">class</span> <span class="hl-variable">FileNotFoundException</span> = <span class="hl-variable">java</span>.<span class="hl-variable">io</span>.<span class="hl-variable">FileNotFoundException</span>

...

<span class="hl-keyword">try</span>(
<span class="hl-site">FileInputStream</span>(<span class="hl-literal">"non/existent/file/path"</span>)
) <span class="hl-keyword">catch</span> (<span class="hl-site">FileNotFoundException</span>(<span class="hl-variable">e</span>)) <span class="hl-variable">e</span>

...
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1340F"></a>C.1.2.&nbsp;Catching Orc Engine Errors</h3></div></div></div><p>
This functionality also allows certain Orc runtime errors to be caught.
Here are a few examples of runtime errors which might occur, and a full
list can be found in the 
<a class="link" href="http://orc.csres.utexas.edu/javadoc/STABLE/orc/error/runtime/TokenException.html" target="_top">Javadoc</a>.
</p><p>
<div class="itemizedlist"><ul type="disc"><li><code class="code"><span class="hl-variable">ArgumentTypeMismatchException</span></code></li><li><code class="code"><span class="hl-variable">ArityMismatchException</span></code></li><li><code class="code"><span class="hl-variable">MessageNotUnderstoodException</span></code></li></ul></div>
</p><p>
<pre class="programlisting">
<span class="hl-comment">{- Detecting runtime errors using exceptions -}</span>
<span class="hl-keyword">class</span> <span class="hl-variable">ArgumentTypeMismatchException</span> = <span class="hl-variable">orc</span>.<span class="hl-variable">error</span>.<span class="hl-variable">runtime</span>.<span class="hl-variable">ArgumentTypeMismatchException</span>

<span class="hl-keyword">try</span>(
  <span class="hl-keyword">if</span> <span class="hl-literal">3</span> <span class="hl-keyword">then</span> <span class="hl-literal">"foo"</span>
) <span class="hl-keyword">catch</span> (<span class="hl-site">ArgumentTypeMismatchException</span>(<span class="hl-variable">e</span>)) <span class="hl-literal">"error"</span>
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1342A"></a>C.1.3.&nbsp;Exceptions in Practice</h3></div></div></div>
Exceptions add two important capabilities to the Orc language.  First, they allow 
Java exceptions thrown by Java based sites, as well the Orc engine itself, to be
caught, allowing previously undetectable errors to be handled by the programmer.  Additionally,
they simplify error handling significantly, by removing error handling code from the body of
the program.  This is especially helpful when propagating error information across 
function calls or various parts of the program.  In the examples below, let <code class="code"><span class="hl-variable">request</span></code> be
a function that will return a single value eventually:

<p>
<pre class="programlisting">
<span class="hl-comment">{- error handling without exceptions: -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">makeRequest</span>() = 
  <span class="hl-site">let</span>(<span class="hl-site">request</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> (<span class="hl-literal">true</span>, <span class="hl-variable">x</span>) <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> (<span class="hl-literal">false</span>, <span class="hl-literal">"timeout"</span>))

<span class="hl-keyword">def</span> <span class="hl-site">call</span>() =
  <span class="hl-site">makeRequest</span>() <span class="hl-combinator">&gt;</span>(<span class="hl-variable">success</span>, <span class="hl-variable">result</span>)<span class="hl-combinator">&gt;</span> <span class="hl-keyword">if</span> <span class="hl-variable">success</span> <span class="hl-keyword">then</span> <span class="hl-variable">result</span> <span class="hl-keyword">else</span> <span class="hl-literal">"failed"</span>
</pre>
</p>

Compare this to using exceptions, where error handling is made explicit and
the program as a whole is simplified.  (Note the improvement would be more marked if
a deeper layer of function nesting was used.)

<p>
<pre class="programlisting">
<span class="hl-comment">{- error handling with exceptions -}</span>
<span class="hl-keyword">def</span> <span class="hl-site">makeRequest</span>() = 
  <span class="hl-site">request</span>() <span class="hl-combinator">|</span> <span class="hl-site">Rtimer</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">throw</span>(<span class="hl-literal">"timeout"</span>)

<span class="hl-keyword">def</span> <span class="hl-site">call</span>() =
  <span class="hl-keyword">try</span>( <span class="hl-site">makeRequest</span>() ) <span class="hl-keyword">catch</span> (<span class="hl-variable">_</span>) <span class="hl-literal">"failed"</span>
</pre>
</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="N1343C"></a>C.1.4.&nbsp;Typechecking Exceptions</h3></div></div></div><p>
The Orc typechecker currently provides only partial support for the typechecking of exceptions.
</p><p>
The expression <code class="code"><span class="hl-keyword">throw</span></code> E always has type <code class="code"><span class="hl-variable">Bot</span></code>. E is typechecked
to ensure that it does indeed have some type, but that type is ignored, since a throw expression
will raise exceptions rather than publish values.
</p><p>
In the expression <code class="code"><span class="hl-keyword">try</span></code> E <code class="code"><span class="hl-keyword">catch</span>(</code>P<code class="code">)</code> F, the type of the
whole expression is the type of E. The type of the handler body F must be the same as, or
some subtype of, the type of E.
</p><p>
The expression F is checked without information about the
type of the exception value bound by <code class="code"><span class="hl-variable">P</span></code>; the typechecker uses the type <code class="code"><span class="hl-variable">Bot</span></code>.
This is a hole in the typechecker; it is possible to write an exception handler which uses
its argument inappropriately and generates a runtime type error. For the moment, it is the
programmer's responsibility to ensure that a handler uses its argument appropriately; we are
currently investigating possible solutions to this problem. 
</p><p>
In practice this weakness is rarely a problem, because the common use case for <code class="code"><span class="hl-keyword">catch</span></code>
handler arguments is to match against a Java exception class:

<pre class="programlisting">
<span class="hl-keyword">class</span> <span class="hl-variable">FileNotFoundException</span> = <span class="hl-variable">java</span>.<span class="hl-variable">io</span>.<span class="hl-variable">FileNotFoundException</span>
<span class="hl-keyword">try</span>
  ...
<span class="hl-keyword">catch</span> (<span class="hl-site">FileNotFoundException</span>(<span class="hl-variable">e</span>))
  ...
</pre>

Since this effectively performs a cast, the variable <code class="code"><span class="hl-variable">e</span></code> is given the appropriate type
<code class="code"><span class="hl-variable">FileNotFoundException</span></code>, and the typechecker behaves correctly in this case.

</p></div></div></div></div><script type="text/javascript" src="/orchard/orc.js"></script></body></html>